
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.poppy &#8212; SpacePy v0.4.0 Manual</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" accesskey="U">spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.poppy</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.poppy</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;PoPPy -- Point Processes in Python.</span>

<span class="sd">This module contains point process class types and a variety of functions for</span>
<span class="sd">association analysis. The routines given here grew from work presented by</span>
<span class="sd">Morley and Freeman (Geophysical Research Letters, 34, L08104, doi:10.1029/</span>
<span class="sd">2006GL028891, 2007), which were originally written in IDL. This module is</span>
<span class="sd">intended for application to discrete time series of events to assess</span>
<span class="sd">statistical association between the series and to calculate confidence limits.</span>
<span class="sd">Any mis-application or mis-interpretation by the user is the user&#39;s own fault.</span>

<span class="sd">&gt;&gt;&gt; import datetime as dt</span>
<span class="sd">&gt;&gt;&gt; import spacepy.time as spt</span>

<span class="sd">Since association analysis is rather computationally expensive, this example</span>
<span class="sd">shows timing.</span>

<span class="sd">&gt;&gt;&gt; t0 = dt.datetime.now()</span>
<span class="sd">&gt;&gt;&gt; onsets = spt.Ticktock(onset_epochs, &#39;CDF&#39;)</span>
<span class="sd">&gt;&gt;&gt; ticksR1 = spt.Ticktock(tr_list, &#39;CDF&#39;)</span>

<span class="sd">Each instance must be initialized</span>

<span class="sd">&gt;&gt;&gt; lags = [dt.timedelta(minutes=n) for n in range(-400,401,2)]</span>
<span class="sd">&gt;&gt;&gt; halfwindow = dt.timedelta(minutes=10)</span>
<span class="sd">&gt;&gt;&gt; pp1 = poppy.PPro(onsets.UTC, ticksR1.UTC, lags, halfwindow)</span>

<span class="sd">To perform association analysis</span>

<span class="sd">&gt;&gt;&gt; pp1.assoc()</span>
<span class="sd">Starting association analysis</span>
<span class="sd">calculating association for series of length [3494, 1323] at 401 lags</span>
<span class="sd">&gt;&gt;&gt; t1 = dt.datetime.now()</span>
<span class="sd">&gt;&gt;&gt; print(&quot;Elapsed:  &quot; + str(t1-t0))</span>
<span class="sd">Elapsed:  0:35:46.927138</span>

<span class="sd">Note that for calculating associations between long series at a large number of</span>
<span class="sd">lags is SLOW!!</span>

<span class="sd">To plot</span>

<span class="sd">&gt;&gt;&gt; pp1.plot(dpi=80)</span>
<span class="sd">Error: No confidence intervals to plot - skipping</span>

<span class="sd">To add 95% confidence limits (using 4000 bootstrap samples)</span>

<span class="sd">&gt;&gt;&gt; pp1.aa_ci(95, n_boots=4000)</span>

<span class="sd">The plot method will then add the 95% confidence intervals as a semi-</span>
<span class="sd">transparent patch.</span>


<span class="sd">Authors: Steve Morley and Jon Niehof</span>
<span class="sd">Institution: Los Alamos National Laboratory</span>
<span class="sd">Contact: smorley@lanl.gov, jniehof@lanl.gov</span>

<span class="sd">Copyright 2010 Los Alamos National Security, LLC.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">help</span>
<span class="c1">#Try to pull in the C version. Assumption is that if you import this module,</span>
<span class="c1">#you want to do some association analysis, so the overhead in the import</span>
<span class="c1">#is OK.</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">spacepy.toolbox</span> <span class="k">as</span> <span class="nn">tb</span>
<span class="kn">import</span> <span class="nn">spacepy.datamodel</span> <span class="k">as</span> <span class="nn">dm</span>

<span class="n">__contact__</span> <span class="o">=</span> <span class="s1">&#39;Steve Morley, smorley@lanl.gov&#39;</span>

<div class="viewcode-block" id="PPro"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro">[docs]</a><span class="k">class</span> <span class="nc">PPro</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PoPPy point process object</span>

<span class="sd">    Initialize object with series1 and series2. These should be timeseries of</span>
<span class="sd">    events, given as lists, arrays, or lists of datetime objects.</span>
<span class="sd">    Includes method to perform association analysis of input series</span>

<span class="sd">    Output can be nicely plotted with :py:meth:`plot`.</span>

<span class="sd">    .. currentmodule:: spacepy.poppy</span>
<span class="sd">    </span>
<span class="sd">    .. autosummary::</span>
<span class="sd">        ~PPro.aa_ci</span>
<span class="sd">        ~PPro.assoc</span>
<span class="sd">        ~PPro.assoc_mult</span>
<span class="sd">        ci</span>
<span class="sd">        conf_above</span>
<span class="sd">        ~PPro.plot</span>
<span class="sd">        ~PPro.plot_mult</span>
<span class="sd">        ~PPro.swap</span>

<span class="sd">    .. automethod:: aa_ci</span>
<span class="sd">    .. automethod:: assoc</span>
<span class="sd">    .. automethod:: assoc_mult</span>

<span class="sd">    .. attribute:: ci</span>
<span class="sd">    </span>
<span class="sd">       Contains the upper and lower confidence limits for the association</span>
<span class="sd">       number as a function of lag. The first element is the array of lower</span>
<span class="sd">       limits; the second, the array of upper limits. Not available until</span>
<span class="sd">       after calling :meth:`aa_ci`.</span>

<span class="sd">    .. attribute:: conf_above</span>
<span class="sd">    </span>
<span class="sd">       Contains the confidence that the association number, as a function</span>
<span class="sd">       of lag, is above the asymptotic association number. (The confidence</span>
<span class="sd">       of being below is 100 - ``conf_above``.)  Not available until</span>
<span class="sd">       after calling :meth:`aa_ci`.</span>

<span class="sd">    .. automethod:: plot</span>
<span class="sd">    .. automethod:: plot_mult</span>
<span class="sd">    .. automethod:: swap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#NB: P2 is the &quot;master&quot; timescale, P1 gets shifted by lags</span>
    <span class="c1">#Add lag to p1 to reach p2&#39;s timescale, subtract lag from p2 to reach p1&#39;s</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process1</span><span class="p">,</span> <span class="n">process2</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">winhalf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process1</span> <span class="o">=</span> <span class="n">process1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process2</span> <span class="o">=</span> <span class="n">process2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lags</span> <span class="o">=</span> <span class="n">lags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span> <span class="o">=</span> <span class="n">winhalf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String Representation of PoPPy object&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">asy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">asy</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>

        <span class="c1"># TODO this is broken not enough values for the format statement</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;Point Process Object:</span>
<span class="s2">        Points in process #1 - </span><span class="si">%d</span><span class="s2"> ; Points in process #2 - </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">        Peak association number - </span><span class="si">%s</span><span class="s2"> ; Asymptotic association - </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process2</span><span class="p">),</span> <span class="n">pk</span><span class="p">,</span> <span class="n">asy</span><span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calling len(obj) will return the number of points in process 1&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">)</span>

<div class="viewcode-block" id="PPro.swap"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.swap">[docs]</a>    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Swaps process 1 and process 2&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process1</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PPro.assoc"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.assoc">[docs]</a>    <span class="k">def</span> <span class="nf">assoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform association analysis on input series</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        u : list, optional</span>
<span class="sd">            the time lags to use</span>
<span class="sd">        h :</span>
<span class="sd">            association window half-width, same type as process1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#check for existence of lags and winhalf</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lags</span> <span class="o">=</span> <span class="n">u</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span>
            <span class="k">if</span> <span class="n">h</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span> <span class="o">=</span> <span class="n">h</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span> <span class="o">!=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calculating association for series of length </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%d</span><span class="s1"> lags&#39;</span> \
                    <span class="o">%</span> <span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process2</span><span class="p">)],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;assoc error: attributes lags and winhalf must be populated&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mpd</span>
        <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;int64&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>

        <span class="c1">##Method 1 - use tb.tOverlap</span>
        <span class="c1">#create list for association number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">)),</span>
                                <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process2</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">winhalf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span>
            <span class="n">lags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p1</span><span class="p">]</span>
            <span class="n">stops</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p1</span><span class="p">]</span>
            <span class="n">nss_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ilag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)):</span>
                <span class="n">last_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">stops</span><span class="p">[</span><span class="n">nss</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">ilag</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">nss</span> <span class="ow">in</span> <span class="n">nss_list</span><span class="p">]</span>
                <span class="n">first_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">starts</span><span class="p">[</span><span class="n">nss</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">ilag</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">nss</span> <span class="ow">in</span> <span class="n">nss_list</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span><span class="p">[</span><span class="n">ilag</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">last_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nss_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">fracday</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;turn a timedelta into a fractional day&#39;&#39;&#39;</span>
                <span class="c1">#NOTE: If 2.6 compatibility is ever dropped, can use dd.total_seconds()/86400</span>
                <span class="k">return</span> <span class="n">dd</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mf">86400.0</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">microseconds</span><span class="o">/</span><span class="p">(</span><span class="mf">86400.0</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>
            <span class="c1">#test for datetime input and try to convert to numeric</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpd</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpd</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p2</span><span class="p">]</span>
            <span class="c1">#TODO: convert lags and winhalf from timedelta to fractional days</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">lags</span> <span class="o">=</span> <span class="p">[</span><span class="n">fracday</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
                <span class="n">winhalf</span> <span class="o">=</span> <span class="n">fracday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">winhalf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p2</span><span class="p">))(</span><span class="o">*</span><span class="n">p2</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">))(</span><span class="o">*</span><span class="n">p1</span><span class="p">)</span>
            <span class="c1">#prctile_rank dies on some versions if this is a ctypes array</span>
            <span class="n">lags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
            <span class="n">n_assoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">lptr</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">assoc</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">lags</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">dptr</span><span class="p">),</span> <span class="n">n_assoc</span><span class="p">,</span>
                      <span class="n">winhalf</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">))</span>
        <span class="n">left20perc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">)))</span>
        <span class="n">right20perc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">valsL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[:</span><span class="n">left20perc</span><span class="p">]</span>
        <span class="n">valsR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">right20perc</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valsL</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valsR</span><span class="p">)])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">-</span> <span class="n">winhalf</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">winhalf</span>
            <span class="k">if</span> <span class="n">start_time</span> <span class="o">!=</span> <span class="n">stop_time</span><span class="p">:</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">stop_time</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> \
                     <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">n2</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">)</span> <span class="o">-</span> \
                     <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span> <span class="o">*</span> <span class="n">winhalf</span> <span class="o">/</span> \
                                       <span class="p">(</span><span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PPro.assoc_mult"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.assoc_mult">[docs]</a>    <span class="k">def</span> <span class="nf">assoc_mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">inter</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">n_boots</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Association analysis w/confidence interval on multiple windows</span>

<span class="sd">        Using the time sequence and lags stored in this object, perform</span>
<span class="sd">        full association analysis, including bootstrapping of confidence</span>
<span class="sd">        intervals, for every listed window half-size</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        windows : sequence</span>
<span class="sd">            window half-size for each analysis</span>
<span class="sd">        inter : float, optional</span>
<span class="sd">            desired confidence interval, default 95</span>
<span class="sd">        n_boots : int, optional</span>
<span class="sd">            number of bootstrap iterations, default 1000</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Random number generator seed. It is STRONGLY</span>
<span class="sd">            recommended not to specify (i.e. leave None) to permit</span>
<span class="sd">            multithreading.</span>

<span class="sd">        Warnings</span>
<span class="sd">        ========</span>
<span class="sd">        This function is likely to take a LOT of time.</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        out : three numpy array</span>
<span class="sd">            Three numpy arrays, (windows x lags), containing (in order)</span>
<span class="sd">            low values of confidence interval, high values of ci,</span>
<span class="sd">            percentage confidence above the asymptotic association number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_lags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)</span>
        <span class="n">ci_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span> <span class="n">n_lags</span><span class="p">])</span>
        <span class="n">ci_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span> <span class="n">n_lags</span><span class="p">])</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span> <span class="n">n_lags</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assoc</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_ci</span><span class="p">(</span><span class="n">inter</span><span class="p">,</span> <span class="n">n_boots</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
            <span class="n">ci_low</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ci_high</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">percentiles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_above</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span></div>

<div class="viewcode-block" id="PPro.plot_mult"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.plot_mult">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                  <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Lag&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Window Size&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots a 2D function of window size and lag</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        windows : list</span>
<span class="sd">            list of window sizes (y axis)</span>
<span class="sd">        data : list</span>
<span class="sd">            list of data, dimensioned (windows x lags)</span>
<span class="sd">        min : float, optional</span>
<span class="sd">            clip L{data} to this minimum value</span>
<span class="sd">        max : float, optional</span>
<span class="sd">            clip L{data} to this maximum value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">bin_center_to_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">bin_center_to_edges</span><span class="p">(</span><span class="n">windows</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
                             <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cbar_label</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]:</span>
                <span class="n">cbar_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\</span><span class="si">% c</span><span class="s1">onfident above asymptotic association&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbar_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">% c</span><span class="s1">onfident above asymptotic association&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cbar_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PPro.plot"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">asympt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time lag&#39;</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create basic plot of association analysis.</span>

<span class="sd">        Uses object attributes created by :py:meth:`assoc` and,</span>
<span class="sd">        optionally, :py:meth:`aa_ci`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        figsize : , optional</span>
<span class="sd">            passed through to matplotlib.pyplot.figure</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            passed through to matplotlib.pyplot.figure</span>
<span class="sd">        asympt : boolean, optional</span>
<span class="sd">            True to overplot the line of asymptotic association number</span>
<span class="sd">        show : boolean, optional</span>
<span class="sd">            Show the plot? (if false, will create without showing)</span>
<span class="sd">        norm : boolean, optional</span>
<span class="sd">            Normalize plot to the asymptotic association number</span>
<span class="sd">        title : string, optional</span>
<span class="sd">            label/title for the plot</span>
<span class="sd">        xlabel : string, optional</span>
<span class="sd">            label to put on the X axis of the resulting plot</span>
<span class="sd">        xscale : float, optional</span>
<span class="sd">            scale x-axis by this factor (e.g. 60.0 to convert seconds to minutes)</span>
<span class="sd">        ylabel : string, optional</span>
<span class="sd">            label to put on the Y axis of the resulting plot</span>
<span class="sd">        transparent : boolean, optional</span>
<span class="sd">            make c.i. patch transparent (default)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Error: No association analysis results to plot&#39;</span>

        <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="c1">#fix such that self.lags (a timedelta) are converted to a time</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mi">60</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mf">1440.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span>
        <span class="k">if</span> <span class="n">xscale</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">xscale</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">ci</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ci&#39;</span><span class="p">):</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="p">[[</span><span class="n">j</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">asympt_assoc</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">assoc_total</span> <span class="o">=</span> <span class="p">[</span><span class="n">assoc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span>
                           <span class="k">for</span> <span class="n">assoc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">asympt_assoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span>
            <span class="n">assoc_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assoc_total</span>

        <span class="k">if</span> <span class="n">ci</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transparent</span><span class="p">:</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#ABABFF&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No confidence intervals to plot - skipping&#39;</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">assoc_total</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asympt</span><span class="p">:</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">asympt_assoc</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span>
                    <span class="s1">&#39;Normalized Association Number n(u, h=</span><span class="si">{0}</span><span class="s1">) / n(</span><span class="si">{1}</span><span class="s1">, h=</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span><span class="p">,</span>
                    <span class="s1">&#39;$\mathrm{u</span><span class="se">\r</span><span class="s1">ightarrow\infty}$&#39;</span>
                    <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;u-&gt;Inf&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Association Number n(u, h=</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">winhalf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="PPro.aa_ci"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.PPro.html#spacepy.poppy.PPro.aa_ci">[docs]</a>    <span class="k">def</span> <span class="nf">aa_ci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">n_boots</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get bootstrap confidence intervals for association number</span>

<span class="sd">        Requires input of desired confidence interval, e.g.:</span>
<span class="sd">            &gt;&gt;&gt; obj.aa_ci(95)</span>

<span class="sd">        Upper and lower confidence limits are added to :attr:`~PPro.ci`.</span>

<span class="sd">        After calling, :attr:`~PPro.conf_above` will contain the confidence</span>
<span class="sd">        (in percent) that</span>
<span class="sd">        the association number at that lag is *above* the asymptotic</span>
<span class="sd">        association number. (The confidence of being below is 100 - conf_above)</span>
<span class="sd">        For minor variations in conf_above to be meaningful, a *large* number</span>
<span class="sd">        of bootstraps is required. (Rougly, 1000 to be meaningful to the</span>
<span class="sd">        nearest percent; 10000 to be meaningful to a tenth of a percent.) A</span>
<span class="sd">        conf_above of 100 usually indicates an insufficient sample size to</span>
<span class="sd">        resolve, *not* perfect certainty.</span>

<span class="sd">        Note also that a 95% chance of being above indicates an exclusion</span>
<span class="sd">        from the *90%* confidence interval!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        inter : float</span>
<span class="sd">            percentage confidence interval to calculate</span>
<span class="sd">        n_boots : int, optional</span>
<span class="sd">            number of bootstrap iterations to run</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            seed for the random number generator. If not specified,</span>
<span class="sd">            Python code will use numpy&#39;s RNG and its current seed;</span>
<span class="sd">            C code will seed from the clock.</span>

<span class="sd">        Warnings</span>
<span class="sd">        ========</span>
<span class="sd">        If ``seed`` is specified, results may not be reproducible between</span>
<span class="sd">        systems with different sizes for C long type. Note that 64-bit</span>
<span class="sd">        Windows uses a 32-bit long and so results will be the same between</span>
<span class="sd">        64 and 32-bit Windows, but not between 64-bit Windows and other 64-bit</span>
<span class="sd">        operating systems. If ``seed`` is not specified, results are</span>
<span class="sd">        not reproducible anyhow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lags</span>

        <span class="n">ci_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)])</span>
        <span class="n">ci_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)])</span>
        <span class="n">conf_above</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)])</span>
        <span class="n">long_size</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">minseed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">long_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">maxseed</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">long_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1">#randint used to be system-size signed integer only.</span>
            <span class="c1">#so used that and cast to the required unsigned later</span>
            <span class="c1">#cast does not lose entropy: negative numbers map to high positives.</span>
            <span class="c1">#For reproducibility, keep doing that even though dtype</span>
            <span class="c1">#kwarg now available.</span>
            <span class="n">lag_seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">minseed</span><span class="p">,</span> <span class="n">maxseed</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)])</span>
            <span class="n">newtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;u&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lag_seeds</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">lag_seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">lag_seeds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">newtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">lag_seeds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ci_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci_high</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">conf_above</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">boots_ci</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">n_boots</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perc_low</span> <span class="o">=</span> <span class="p">(</span><span class="mf">100.</span><span class="o">-</span><span class="n">inter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="c1">#set confidence interval</span>
            <span class="n">perc_high</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">perc_low</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">long_size</span><span class="p">)</span>
            <span class="n">assoc_totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">),</span> <span class="n">n_boots</span><span class="p">],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clock_seed</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">lag_seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clock_seed</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">thread_targ</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">aa_ci</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_assoc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">ulptr</span><span class="p">),</span>
                    <span class="n">assoc_totals</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">ulptr</span><span class="p">),</span>
                    <span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process1</span><span class="p">),</span> <span class="n">n_boots</span><span class="p">,</span>
                    <span class="n">lag_seeds</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">ulptr</span><span class="p">),</span>
                    <span class="n">clock_seed</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">thread_job</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thread_targ</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)):</span>
                <span class="n">assoc_totals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">ci_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci_high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                    <span class="n">assoc_totals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="n">perc_low</span><span class="p">,</span><span class="n">perc_high</span><span class="p">))</span>
                <span class="n">conf_above</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">value_percentile</span><span class="p">(</span><span class="n">assoc_totals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">asympt_assoc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="p">[</span><span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_above</span> <span class="o">=</span> <span class="n">conf_above</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<span class="c1">#Functions outside class</span>

<div class="viewcode-block" id="plot_two_ppro"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.plot_two_ppro.html#spacepy.poppy.plot_two_ppro">[docs]</a><span class="k">def</span> <span class="nf">plot_two_ppro</span><span class="p">(</span><span class="n">pprodata</span><span class="p">,</span> <span class="n">pproref</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                  <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overplots two PPro objects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    pprodata : PPro</span>
<span class="sd">        first point process to plot (in blue)</span>
<span class="sd">    pproref : PPro</span>
<span class="sd">        second process to plot (in red)</span>
<span class="sd">    ratio : float</span>
<span class="sd">        multiply L{pprodata} by this ratio before plotting,</span>
<span class="sd">        useful for comparing processes of different magnitude</span>
<span class="sd">    norm : boolean</span>
<span class="sd">        normalize everything to L{pproref}, i.e. the association</span>
<span class="sd">        number for L{pproref} will always plot as 1.</span>
<span class="sd">    title : string</span>
<span class="sd">        title to put on the plot</span>
<span class="sd">    xscale : float</span>
<span class="sd">        scale x-axis by this factor (e.g. 60.0 to convert</span>
<span class="sd">        seconds to minutes)</span>
<span class="sd">    figsize :</span>
<span class="sd">        passed through to matplotlib.pyplot.figure</span>
<span class="sd">    dpi : int</span>
<span class="sd">        passed through to matplotlib.pyplot.figure</span>
<span class="sd">    ylim : list</span>
<span class="sd">        [minimum, maximum] values of y for the axis</span>
<span class="sd">    log : bollean</span>
<span class="sd">        True for a log plot</span>
<span class="sd">    xticks : sequence or float</span>
<span class="sd">        if provided, a list of tickmarks for the X axis</span>
<span class="sd">    yticks : sequance or float</span>
<span class="sd">        if provided, a list of tickmarks for the Y axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pproref</span><span class="o">.</span><span class="n">asympt_assoc</span><span class="p">)</span> <span class="o">/</span> <span class="n">pprodata</span><span class="o">.</span><span class="n">asympt_assoc</span>
    <span class="n">lags</span> <span class="o">=</span> <span class="n">pproref</span><span class="o">.</span><span class="n">lags</span>
    <span class="n">nlags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">lags</span><span class="p">[:]</span> <span class="o">==</span> <span class="n">pprodata</span><span class="o">.</span><span class="n">lags</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">xscale</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">xscale</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">scaleddata</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span>
                      <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledhi</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledlo</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledref</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">refhi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pproref</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="o">/</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">reflo</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pproref</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="o">/</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaleddata</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">assoc_total</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledhi</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledlo</span> <span class="o">=</span> <span class="p">[</span><span class="n">ratio</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">pprodata</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)]</span>
        <span class="n">scaledref</span> <span class="o">=</span> <span class="n">pproref</span><span class="o">.</span><span class="n">assoc_total</span>
        <span class="n">refhi</span> <span class="o">=</span> <span class="n">pproref</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">reflo</span> <span class="o">=</span> <span class="n">pproref</span><span class="o">.</span><span class="n">ci</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">reflo</span><span class="p">,</span> <span class="n">refhi</span><span class="p">,</span>
                     <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#FFABAB&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">scaledlo</span><span class="p">,</span> <span class="n">scaledhi</span><span class="p">,</span>
                     <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#ABABFF&#39;</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="nb">max</span><span class="p">([</span><span class="n">scaledlo</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reflo</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="nb">min</span><span class="p">([</span><span class="n">scaledhi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">refhi</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlags</span><span class="p">)),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="n">top</span><span class="p">),</span>
                     <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#AB81D5&#39;</span><span class="p">,</span>
                     <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">scaleddata</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">scaledref</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xticks</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yticks</span><span class="p">:</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>


<div class="viewcode-block" id="boots_ci"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.boots_ci.html#spacepy.poppy.boots_ci">[docs]</a><span class="k">def</span> <span class="nf">boots_ci</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usepy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nretvals</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct bootstrap confidence interval</span>

<span class="sd">    The bootstrap is a statistical tool that uses multiple samples derived from</span>
<span class="sd">    the original data (called surrogates) to estimate a parameter of the</span>
<span class="sd">    population from which the sample was drawn. This assumes that the sample is</span>
<span class="sd">    randomly drawn and hence is representative of the underlying distribution.</span>
<span class="sd">    The benefit of the bootstrap is that it is non-parametric and can be</span>
<span class="sd">    applied in situations where there is reasonable doubt about the</span>
<span class="sd">    characteristics of the underlying distribution. This routine uses the boot-</span>
<span class="sd">    strap for its most common application - the estimation of confidence</span>
<span class="sd">    intervals.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; data, n = numpy.random.lognormal(mean=5.1, sigma=0.3, size=3000), 4000.</span>
<span class="sd">    &gt;&gt;&gt; myfunc = lambda x: numpy.median(x)</span>
<span class="sd">    &gt;&gt;&gt; ci_low, ci_high = poppy.boots_ci(data, n, 95, myfunc)</span>
<span class="sd">    &gt;&gt;&gt; ci_low, numpy.median(data), ci_high</span>
<span class="sd">    (163.96354196633686, 165.2393331896551, 166.60491435416566) iter. 1</span>
<span class="sd">    ... repeat</span>
<span class="sd">    (162.50379144492726, 164.15218265100233, 165.42840588032755) iter. 2</span>

<span class="sd">    For comparison</span>

<span class="sd">    &gt;&gt;&gt; data = numpy.random.lognormal(mean=5.1, sigma=0.3, size=90000)</span>
<span class="sd">    &gt;&gt;&gt; numpy.median(data)</span>
<span class="sd">    163.83888237895815</span>

<span class="sd">    Note that the true value of the desired quantity may lie outside the</span>
<span class="sd">    95% confidence interval one time in 20 realizations. This occurred</span>
<span class="sd">    for the first iteration here.</span>

<span class="sd">    For the lognormal distribution, the median is found exactly by taking</span>
<span class="sd">    the exponential of the &quot;mean&quot; parameter. Thus here, the theoretical</span>
<span class="sd">    median is 164.022 (6 s.f.) and this is well captured by the above</span>
<span class="sd">    bootstrap confidence interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    data : array like</span>
<span class="sd">        data to bootstrap</span>
<span class="sd">    n : int</span>
<span class="sd">        number of surrogate series to select, i.e. number of bootstrap iterations.</span>
<span class="sd">    inter : numerical</span>
<span class="sd">        desired percentage confidence interval</span>
<span class="sd">    func : callable</span>
<span class="sd">        Function to apply to each surrogate series</span>
<span class="sd">    sample_size : int</span>
<span class="sd">        number of samples in the surrogate series, default</span>
<span class="sd">        length of L{data}. This will change the statistical</span>
<span class="sd">        properties of the bootstrap and should only be used</span>
<span class="sd">        for good reason!</span>
<span class="sd">    seed : int</span>
<span class="sd">        Optional seed for the random number generator. If not</span>
<span class="sd">        specified, numpy generator will not be reseeded;</span>
<span class="sd">        C generator will be seeded from the clock.</span>
<span class="sd">    target : same as data</span>
<span class="sd">        a &#39;target&#39; value. If specified, will also calculate</span>
<span class="sd">        percentage confidence of being at or above this value.</span>
<span class="sd">    nretvals : int</span>
<span class="sd">        number of return values from input function</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : sequence of float</span>
<span class="sd">        inter percent confidence interval on value derived from</span>
<span class="sd">        func applied to the population sampled by data.</span>
<span class="sd">        If target is specified, also the percentage confidence of</span>
<span class="sd">        being above that value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perc_low</span> <span class="o">=</span> <span class="p">(</span><span class="mf">100.</span><span class="o">-</span><span class="n">inter</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="c1">#set confidence interval</span>
    <span class="n">perc_high</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">perc_low</span>

    <span class="n">n_els</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_els</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">sample_size</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="n">n_els</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">usepy</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nretvals</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">surr_quan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n</span><span class="p">,</span><span class="n">nretvals</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">surr_quan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ran_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n_els</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span> <span class="c1">#compute n bootstrapped series</span>
            <span class="n">surr_ser</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">rec</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">ran_el</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]])</span> <span class="c1">#resample w/ replace</span>
            <span class="n">surr_quan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">surr_ser</span><span class="p">)</span> <span class="c1">#get desired quantity from surrogates</span>
        <span class="n">surr_quan</span> <span class="o">=</span> <span class="n">surr_quan</span><span class="p">[</span><span class="n">surr_quan</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1">#surr_quan.sort()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">n_els</span><span class="p">)(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
        <span class="n">surr_ser</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">))()</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">clock_seed</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clock_seed</span><span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">boots</span><span class="p">(</span><span class="n">surr_ser</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="n">n_els</span><span class="p">),</span>
                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span>
                  <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span> <span class="n">clock_seed</span><span class="p">)</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">surr_ser</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">:(</span><span class="n">i</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_size</span><span class="p">])</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="c1">#Can&#39;t sort if more than one return value</span>
        <span class="n">surr_quan</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="k">if</span> <span class="n">nretvals</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="c1">#get confidence interval</span>
    <span class="k">if</span> <span class="n">nretvals</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">pul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">nretvals</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nretvals</span><span class="p">):</span>
            <span class="n">pul</span><span class="p">[:,</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">surr_quan</span><span class="p">[:,</span><span class="n">nn</span><span class="p">],</span> <span class="p">(</span><span class="n">perc_low</span><span class="p">,</span><span class="n">perc_high</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">surr_quan</span><span class="p">,</span> <span class="p">(</span><span class="n">perc_low</span><span class="p">,</span><span class="n">perc_high</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pul</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">value_percentile</span><span class="p">(</span><span class="n">surr_quan</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pul</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pul</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="n">vp</span></div>


<div class="viewcode-block" id="value_percentile"><a class="viewcode-back" href="../../autosummary/spacepy.poppy.value_percentile.html#spacepy.poppy.value_percentile">[docs]</a><span class="k">def</span> <span class="nf">value_percentile</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the percentile of a particular value in a sequence</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    sequence : sequence</span>
<span class="sd">        a sequence of values, sorted in ascending order</span>
<span class="sd">    target : same type as sequence</span>
<span class="sd">         a target value</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : float</span>
<span class="sd">        the percentile of target in sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">min</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="c1">#first value &gt;= x</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lo</span><span class="o">=</span><span class="nb">min</span><span class="p">)</span> <span class="c1">#first value &gt; x</span>
    <span class="c1">#min:max, in Python syntax, will include all values that are target</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#everything is bigger</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="nb">min</span> <span class="o">==</span> <span class="n">count</span><span class="p">:</span> <span class="c1">#everything is smaller</span>
        <span class="k">return</span> <span class="mf">100.0</span>
    <span class="c1">#Index 0 is 0th percentile (by definition); count-1 is 100th</span>
    <span class="c1">#so index n is (n * 100.0) / (count - 1)</span>
    <span class="c1">#find a &#39;virtual&#39; index</span>
    <span class="k">if</span> <span class="nb">min</span> <span class="o">==</span> <span class="nb">max</span><span class="p">:</span> <span class="c1">#Not equal to any, between min-1 and min</span>
        <span class="c1">#interpolate between two points based on value.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">sequence</span><span class="p">[</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> \
              <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span> <span class="o">-</span> <span class="n">sequence</span><span class="p">[</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#Equal to one or more values (min...max-1), average them</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span> <span class="o">+</span> <span class="nb">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">idx</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">applyRefractory</span><span class="p">(</span><span class="n">process1</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Apply a refractory period to an input discrete event time sequence</span>

<span class="sd">    All events in the refractory period are removed from the point process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    process1 : iterable</span>
<span class="sd">        an iterable of datetimes, or a spacepy.time.Ticktock</span>
<span class="sd">    period : datetime.timedelta</span>
<span class="sd">        length of refractory period</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    keep : iterable</span>
<span class="sd">        returns pruned set of datetimes with same type as input</span>
<span class="sd">        NOTE: array subclasses will be lost</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">spacepy.time</span> <span class="k">as</span> <span class="nn">spt</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process1</span><span class="p">,</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">):</span>
        <span class="c1">#SpacePy Ticktock</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">process1</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">tickt</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="c1">#iterable containing datetimes</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">process1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">wasArr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wasArr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tickt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Input process must be a list/array of datetimes, or a spacepy.time.Ticktock&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">period</span><span class="o">.</span><span class="n">seconds</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;period must be a datetime.timedelta&#39;</span><span class="p">)</span>

    <span class="n">done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span>
    <span class="n">keep</span><span class="p">,</span> <span class="n">discard</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">period</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tOverlapHalf</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">:</span>
            <span class="n">discard</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># put test element into keep array</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">tickt</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wasArr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">keep</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" >spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.poppy</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2022, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>