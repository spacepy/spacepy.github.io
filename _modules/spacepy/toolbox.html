
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.toolbox &#8212; SpacePy v0.2.2 Manual</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" accesskey="U">spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.toolbox</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.toolbox</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Toolbox of various functions and generic utilities.</span>

<span class="sd">Authors: Steve Morley, Jon Niehof, Brian Larsen, Josef Koller, Dan Welling</span>
<span class="sd">Institution: Los Alamos National Laboratory</span>
<span class="sd">Contact: smorley@lanl.gov, jniehof@lanl.gov, balarsen@lanl.gov, jkoller@lanl.gov, dwelling@lanl.gov</span>
<span class="sd">Los Alamos National Laboratory</span>

<span class="sd">Copyright 2010 Los Alamos National Security, LLC.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#If you add functions here, be sure to:</span>
<span class="c1">#1) add to the __all__ list</span>
<span class="c1">#2) add to functions in Doc/source/toolbox.rst so it goes in the docs</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">html.parser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1">#python2</span>
    <span class="kn">import</span> <span class="nn">HTMLParser</span> <span class="k">as</span> <span class="nn">html</span>
    <span class="n">html</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">html</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">http.client</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1"># Python2</span>
    <span class="kn">import</span> <span class="nn">httplib</span> <span class="k">as</span> <span class="nn">http</span>
    <span class="n">http</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">http</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c1">#python2</span>
    <span class="kn">import</span> <span class="nn">urllib2</span> <span class="k">as</span> <span class="nn">urllib</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">help</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">spacepy</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">spt</span>

<span class="c1">#Try to pull in the C version. Assumption is that if you import this module,</span>
<span class="c1">#you want to do some association analysis, so the overhead in the import</span>
<span class="c1">#is OK.</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>

<span class="c1">#Py3k compatibility renamings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">xrange</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">xrange</span> <span class="o">=</span> <span class="nb">range</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tOverlap&#39;</span><span class="p">,</span> <span class="s1">&#39;tOverlapHalf&#39;</span><span class="p">,</span> <span class="s1">&#39;tCommon&#39;</span><span class="p">,</span> <span class="s1">&#39;loadpickle&#39;</span><span class="p">,</span> <span class="s1">&#39;savepickle&#39;</span><span class="p">,</span> <span class="s1">&#39;assemble&#39;</span><span class="p">,</span>
           <span class="s1">&#39;human_sort&#39;</span><span class="p">,</span> <span class="s1">&#39;feq&#39;</span><span class="p">,</span> <span class="s1">&#39;dictree&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;progressbar&#39;</span><span class="p">,</span>
           <span class="s1">&#39;windowMean&#39;</span><span class="p">,</span> <span class="s1">&#39;medAbsDev&#39;</span><span class="p">,</span> <span class="s1">&#39;binHisto&#39;</span><span class="p">,</span> <span class="s1">&#39;bootHisto&#39;</span><span class="p">,</span>
           <span class="s1">&#39;logspace&#39;</span><span class="p">,</span> <span class="s1">&#39;geomspace&#39;</span><span class="p">,</span> <span class="s1">&#39;linspace&#39;</span><span class="p">,</span> <span class="s1">&#39;arraybin&#39;</span><span class="p">,</span> <span class="s1">&#39;mlt2rad&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rad2mlt&#39;</span><span class="p">,</span> <span class="s1">&#39;pmm&#39;</span><span class="p">,</span> <span class="s1">&#39;getNamedPath&#39;</span><span class="p">,</span> <span class="s1">&#39;query_yes_no&#39;</span><span class="p">,</span>
           <span class="s1">&#39;quaternionNormalize&#39;</span><span class="p">,</span> <span class="s1">&#39;quaternionRotateVector&#39;</span><span class="p">,</span> <span class="s1">&#39;quaternionMultiply&#39;</span><span class="p">,</span>
           <span class="s1">&#39;quaternionConjugate&#39;</span><span class="p">,</span>
           <span class="s1">&#39;interpol&#39;</span><span class="p">,</span> <span class="s1">&#39;normalize&#39;</span><span class="p">,</span> <span class="s1">&#39;intsolve&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_to_list&#39;</span><span class="p">,</span>
           <span class="s1">&#39;bin_center_to_edges&#39;</span><span class="p">,</span> <span class="s1">&#39;bin_edges_to_center&#39;</span><span class="p">,</span> <span class="s1">&#39;thread_job&#39;</span><span class="p">,</span> <span class="s1">&#39;thread_map&#39;</span><span class="p">,</span>
           <span class="s1">&#39;eventTimer&#39;</span><span class="p">,</span> <span class="s1">&#39;isview&#39;</span><span class="p">,</span> <span class="s1">&#39;interweave&#39;</span><span class="p">,</span> <span class="s1">&#39;indsFromXrange&#39;</span><span class="p">,</span> <span class="s1">&#39;hypot&#39;</span><span class="p">,</span>
           <span class="s1">&#39;do_with_timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;TimeoutError&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout_check_call&#39;</span><span class="p">,</span>
           <span class="s1">&#39;poisson_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_columns&#39;</span><span class="p">]</span>

<span class="n">__contact__</span> <span class="o">=</span> <span class="s1">&#39;Brian Larsen: balarsen@lanl.gov&#39;</span>

<span class="k">def</span> <span class="nf">unique_columns</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a multidimensional input return the unique rows or columns along the given axis.</span>
<span class="sd">    Based largely on http://stackoverflow.com/questions/16970982/find-unique-rows-in-numpy-array</span>
<span class="sd">    axis=0 is unique rows, axis=1 is unique columns</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    inval :  array-like</span>
<span class="sd">        array to find unique columns or rows of</span>

<span class="sd">    Optional Parameters</span>
<span class="sd">    ===================</span>
<span class="sd">    axis : int</span>
<span class="sd">        The axis to find unique over, default: 0</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : array</span>
<span class="sd">        N-dimensional array of the unique values along the axis</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is a nice trick taking advantage of structed arrays where each row or column</span>
    <span class="c1">#   is the value, so returl unique works</span>
    <span class="c1"># np.ascontiguousarray() is to be really sure it will work</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">inval</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">void</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">unique_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">unique_a</span>

    
<div class="viewcode-block" id="hypot"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.hypot.html#spacepy.toolbox.hypot">[docs]</a><span class="k">def</span> <span class="nf">hypot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute the N-dimensional hypot of an iterable or many arguments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    args : many numbers or array-like</span>
<span class="sd">        array like or many inputs to compute from</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : float</span>
<span class="sd">        N-dimensional hypot of a number</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    This function has a complicated speed function.</span>
<span class="sd">     - if a numpy array of floats is input this is passed off to C</span>
<span class="sd">     - if iterables are passed in they are made into numpy arrays and comptaton is done local</span>
<span class="sd">     - if many scalar agruments are passed in calculation is done in a loop</span>
<span class="sd">    For max speed:</span>
<span class="sd">     - &lt;20 elements expand them into scalars</span>
<span class="sd">         &gt;&gt;&gt; tb.hypot(*vals)</span>
<span class="sd">         &gt;&gt;&gt; tb.hypot(vals[0], vals[1]...) #alternate</span>
<span class="sd">     - &gt;20 elements premake them into a numpy array of doubles</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; from spacepy import toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; print tb.hypot([3,4])</span>
<span class="sd">    5.0</span>
<span class="sd">    &gt;&gt;&gt; print tb.hypot(3,4)</span>
<span class="sd">    5.0</span>
<span class="sd">    &gt;&gt;&gt; # Benchmark ####</span>
<span class="sd">    &gt;&gt;&gt; from spacepy import toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import timeit</span>
<span class="sd">    &gt;&gt;&gt; num_list = []</span>
<span class="sd">    &gt;&gt;&gt; num_np = []</span>
<span class="sd">    &gt;&gt;&gt; num_np_double = []</span>
<span class="sd">    &gt;&gt;&gt; num_scalar = []</span>
<span class="sd">    &gt;&gt;&gt; tot = 500</span>
<span class="sd">    &gt;&gt;&gt; for num in tb.logspace(1, tot, 10):</span>
<span class="sd">    &gt;&gt;&gt;     print num</span>
<span class="sd">    &gt;&gt;&gt;     num_list.append(timeit.timeit(stmt=&#39;tb.hypot(a)&#39;,</span>
<span class="sd">                            setup=&#39;from spacepy import toolbox as tb;</span>
<span class="sd">                            import numpy as np; a = [3]*{0}&#39;.format(int(num)), number=10000))</span>
<span class="sd">    &gt;&gt;&gt;     num_np.append(timeit.timeit(stmt=&#39;tb.hypot(a)&#39;,</span>
<span class="sd">                          setup=&#39;from spacepy import toolbox as tb;</span>
<span class="sd">                          import numpy as np; a = np.asarray([3]*{0})&#39;.format(int(num)), number=10000))</span>
<span class="sd">    &gt;&gt;&gt;     num_scalar.append(timeit.timeit(stmt=&#39;tb.hypot(*a)&#39;,</span>
<span class="sd">                              setup=&#39;from spacepy import toolbox as tb;</span>
<span class="sd">                              import numpy as np; a = [3]*{0}&#39;.format(int(num)), number=10000))</span>
<span class="sd">    &gt;&gt;&gt; from pylab import *</span>
<span class="sd">    &gt;&gt;&gt; loglog(tb.logspace(1, tot, 10),  num_list, lw=2, label=&#39;list&#39;)</span>
<span class="sd">    &gt;&gt;&gt; loglog(tb.logspace(1, tot, 10),  num_np, lw=2, label=&#39;numpy-&gt;ctypes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; loglog(tb.logspace(1, tot, 10),  num_scalar, lw=2, label=&#39;scalar&#39;)</span>
<span class="sd">    &gt;&gt;&gt; legend(shadow=True, fancybox=1, loc=&#39;upper left&#39;)</span>
<span class="sd">    &gt;&gt;&gt; title(&#39;Different hypot times for 10000 runs&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ylabel(&#39;Time [s]&#39;)</span>
<span class="sd">    &gt;&gt;&gt; xlabel(&#39;Size&#39;)</span>

<span class="sd">    .. image:: ../../source/images/hypot_no_extension_speeds_3cases.png</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">have_libspacepy</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>  <span class="c1"># it is an array</span>
            <span class="c1"># make sure everything is C-ready</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">hypot_tb</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ans</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">ans</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span></div>

<div class="viewcode-block" id="tOverlap"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.tOverlap.html#spacepy.toolbox.tOverlap">[docs]</a><span class="k">def</span> <span class="nf">tOverlap</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the overlapping elements in two lists of datetime objects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    ts1 : datetime</span>
<span class="sd">        first set of datetime object</span>
<span class="sd">    ts2 : datetime</span>
<span class="sd">        datatime object</span>
<span class="sd">    args :</span>
<span class="sd">        additional arguments passed to tOverlapHalf</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        indices of ts1 within interval of ts2, &amp; vice versa</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    Given two series of datetime objects, event_dates and omni[&#39;Time&#39;]:</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; from spacepy import omni</span>
<span class="sd">    &gt;&gt;&gt; import datetime</span>
<span class="sd">    &gt;&gt;&gt; event_dates = st.tickrange(datetime.datetime(2000, 1, 1), datetime.datetime(2000, 10, 1), deltadays=3)</span>
<span class="sd">    &gt;&gt;&gt; onni_dates = st.tickrange(datetime.datetime(2000, 1, 1), datetime.datetime(2000, 10, 1), deltadays=0.5)</span>
<span class="sd">    &gt;&gt;&gt; omni = omni.get_omni(onni_dates)</span>
<span class="sd">    &gt;&gt;&gt; [einds,oinds] = tb.tOverlap(event_dates, omni[&#39;ticks&#39;])</span>
<span class="sd">    &gt;&gt;&gt; omni_time = omni[&#39;ticks&#39;][oinds[0]:oinds[-1]+1]</span>
<span class="sd">    &gt;&gt;&gt; print omni_time</span>
<span class="sd">    [datetime.datetime(2000, 1, 1, 0, 0), datetime.datetime(2000, 1, 1, 12, 0),</span>
<span class="sd">    ... , datetime.datetime(2000, 9, 30, 0, 0)]</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    tOverlapHalf</span>
<span class="sd">    tCommon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx_1in2</span> <span class="o">=</span> <span class="n">tOverlapHalf</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">idx_2in1</span> <span class="o">=</span> <span class="n">tOverlapHalf</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_2in1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx_2in1</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_1in2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx_1in2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">idx_1in2</span><span class="p">,</span> <span class="n">idx_2in1</span></div>

<div class="viewcode-block" id="tOverlapHalf"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.tOverlapHalf.html#spacepy.toolbox.tOverlapHalf">[docs]</a><span class="k">def</span> <span class="nf">tOverlapHalf</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find overlapping elements in two lists of datetime objects</span>

<span class="sd">    This is one-half of tOverlap, i.e. it finds only occurrences where</span>
<span class="sd">    ts2 exists within the bounds of ts1, or the second element</span>
<span class="sd">    returned by tOverlap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    ts1 : list</span>
<span class="sd">        first set of datetime object</span>
<span class="sd">    ts2 : list</span>
<span class="sd">        datatime object</span>
<span class="sd">    presort : bool</span>
<span class="sd">        Set to use a faster algorithm which assumes ts1 and</span>
<span class="sd">                   ts2 are both sorted in ascending order. This speeds up</span>
<span class="sd">                   the overlap comparison by about 50x, so it is worth sorting</span>
<span class="sd">                   the list if one sort can be done for many calls to tOverlap</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        indices of ts2 within interval of ts1</span>

<span class="sd">        **note:** Returns empty list if no overlap found</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    tOverlap</span>
<span class="sd">    tCommon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">presort</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">bisect</span>
        <span class="n">t_lower</span><span class="p">,</span> <span class="n">t_upper</span> <span class="o">=</span> <span class="n">ts1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xrange</span><span class="p">(</span><span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">t_lower</span><span class="p">),</span>
                     <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_right</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">t_upper</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_lower</span><span class="p">,</span> <span class="n">t_upper</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ts1</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ts1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ts2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">t_lower</span> <span class="ow">and</span> <span class="n">ts2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t_upper</span><span class="p">]</span></div>

<div class="viewcode-block" id="tCommon"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.tCommon.html#spacepy.toolbox.tCommon">[docs]</a><span class="k">def</span> <span class="nf">tCommon</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">mask_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the elements in a list of datetime objects present in another</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    ts1 : list or array-like</span>
<span class="sd">        first set of datetime objects</span>
<span class="sd">    ts2 : list or array-like</span>
<span class="sd">        second set of datetime objects</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : tuple</span>
<span class="sd">        Two element tuple of truth tables (of 1 present in 2, &amp; vice versa)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    tOverlapHalf</span>
<span class="sd">    tOverlap</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import datetime as dt</span>
<span class="sd">    &gt;&gt;&gt; ts1 = np.array([dt.datetime(2001,3,10)+dt.timedelta(hours=a) for a in range(20)])</span>
<span class="sd">    &gt;&gt;&gt; ts2 = np.array([dt.datetime(2001,3,10,2)+dt.timedelta(hours=a*0.5) for a in range(20)])</span>
<span class="sd">    &gt;&gt;&gt; common_inds = tb.tCommon(ts1, ts2)</span>
<span class="sd">    &gt;&gt;&gt; common_inds[0] #mask of values in ts1 common with ts2</span>
<span class="sd">    array([False, False,  True,  True,  True,  True,  True,  True,  True,</span>
<span class="sd">            True,  True,  True, False, False, False, False, False, False,</span>
<span class="sd">           False, False], dtype=bool)</span>
<span class="sd">    &gt;&gt;&gt; ts2[common_inds[1]] #values of ts2 also in ts1</span>

<span class="sd">    The latter can be found more simply by setting the mask_only keyword to False</span>

<span class="sd">    &gt;&gt;&gt; common_vals = tb.tCommon(ts1, ts2, mask_only=False)</span>
<span class="sd">    &gt;&gt;&gt; common_vals[1]</span>
<span class="sd">    array([2001-03-10 02:00:00, 2001-03-10 03:00:00, 2001-03-10 04:00:00,</span>
<span class="sd">           2001-03-10 05:00:00, 2001-03-10 06:00:00, 2001-03-10 07:00:00,</span>
<span class="sd">           2001-03-10 08:00:00, 2001-03-10 09:00:00, 2001-03-10 10:00:00,</span>
<span class="sd">           2001-03-10 11:00:00], dtype=object)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="kn">import</span> <span class="n">date2num</span><span class="p">,</span> <span class="n">num2date</span>

    <span class="n">tn1</span><span class="p">,</span> <span class="n">tn2</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">ts1</span><span class="p">),</span> <span class="n">date2num</span><span class="p">(</span><span class="n">ts2</span><span class="p">)</span>

    <span class="n">el1in2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">tn1</span><span class="p">,</span> <span class="n">tn2</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#makes mask of present/absent</span>
    <span class="n">el1in2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">tn1</span><span class="p">,</span> <span class="n">tn2</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#makes mask of present/absent</span>
    <span class="n">el2in1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">tn2</span><span class="p">,</span> <span class="n">tn1</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">el1in2</span><span class="p">,</span> <span class="n">el2in1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">truemask1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">el1in2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">truemask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">el2in1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">tn1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">truemask1</span><span class="p">)</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">tn2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">truemask2</span><span class="p">)</span>
        <span class="n">dum1</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">time1</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span>
        <span class="n">dum2</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">time2</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span>
        <span class="c1">#        dum1 = [val.replace(tzinfo=None) for val in dum1] # this hits ValueError: microsecond must be in 0..999999</span>
        <span class="c1">#        dum2 = [val.replace(tzinfo=None) for val in dum2]</span>
        <span class="n">dum11</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dum22</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dum1</span><span class="p">,</span> <span class="n">dum2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dum11</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># ValueError: microsecond must be in 0..999999</span>
                <span class="n">dum11</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dum22</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># ValueError: microsecond must be in 0..999999</span>
                <span class="n">dum22</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">dum1</span> <span class="o">=</span> <span class="n">dum11</span>
        <span class="n">dum2</span> <span class="o">=</span> <span class="n">dum22</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ts1</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ts2</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">dum1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dum1</span><span class="p">)</span>
            <span class="n">dum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dum2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dum1</span><span class="p">,</span> <span class="n">dum2</span></div>

<div class="viewcode-block" id="loadpickle"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.loadpickle.html#spacepy.toolbox.loadpickle">[docs]</a><span class="k">def</span> <span class="nf">loadpickle</span><span class="p">(</span><span class="n">fln</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load a pickle and return content as dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    fln : string</span>
<span class="sd">        filename</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : dict</span>
<span class="sd">        dictionary with content from file</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    savepickle</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    **note**: If fln is not found, but the same filename with &#39;.gz&#39;</span>
<span class="sd">           is found, will attempt to open the .gz as a gzipped file.</span>

<span class="sd">    &gt;&gt;&gt; d = loadpickle(&#39;test.pbin&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fln</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fln</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="n">gzip</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fln</span> <span class="o">+=</span> <span class="s1">&#39;.gz&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fln</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1">#Py3k</span>
                    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">:</span> <span class="c1">#maybe it&#39;s a gzip?</span>
            <span class="n">gzip</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gzip</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">gzip</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">zlib</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fln</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span> 
                <span class="k">try</span><span class="p">:</span> <span class="c1">#Py3k</span>
                    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gzip</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fln</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">gzh</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">fh</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1">#Py3k</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gzh</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gzh</span><span class="p">)</span>
                <span class="n">gzh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">contents</span></div>


<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="savepickle"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.savepickle.html#spacepy.toolbox.savepickle">[docs]</a><span class="k">def</span> <span class="nf">savepickle</span><span class="p">(</span><span class="n">fln</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save dictionary variable dict to a pickle with filename fln</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fln : string</span>
<span class="sd">        filename</span>
<span class="sd">    dict : dict</span>
<span class="sd">        container with stuff</span>
<span class="sd">    compress : bool</span>
<span class="sd">        write as a gzip-compressed file</span>
<span class="sd">                     (.gz will be added to ``fln``).</span>
<span class="sd">                     If not specified, defaults to uncompressed, unless the</span>
<span class="sd">                     compressed file exists and the uncompressed does not.</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    loadpickle</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; d = {&#39;grade&#39;:[1,2,3], &#39;name&#39;:[&#39;Mary&#39;, &#39;John&#39;, &#39;Chris&#39;]}</span>
<span class="sd">    &gt;&gt;&gt; savepickle(&#39;test.pbin&#39;, d)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">compress</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Guess at compression</span>
        <span class="c1"># Assume compressed if compressed already exists (and no uncompressed)</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fln</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fln</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">gzip</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fln</span> <span class="o">+</span> <span class="s1">&#39;.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">gzh</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fln</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">gzh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">gzh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fln</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2 ... fast binary</span></div>


<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="assemble"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.assemble.html#spacepy.toolbox.assemble">[docs]</a><span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">fln_pattern</span><span class="p">,</span> <span class="n">outfln</span><span class="p">,</span> <span class="n">sortkey</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    assembles all pickled files matching fln_pattern into single file and</span>
<span class="sd">    save as outfln. Pattern may contain simple shell-style wildcards \*? a la fnmatch</span>
<span class="sd">    file will be assembled along time axis given by Ticktock (key: &#39;ticks&#39;) in dictionary</span>
<span class="sd">    If sortkey = None, then nothing will be sorted</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fln_pattern : string</span>
<span class="sd">        pattern to match filenames</span>
<span class="sd">    outfln : string</span>
<span class="sd">        filename to save combined files to</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : dict</span>
<span class="sd">        dictionary with combined values</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; a, b, c = {&#39;ticks&#39;:[1,2,3]}, {&#39;ticks&#39;:[4,5,6]}, {&#39;ticks&#39;:[7,8,9]}</span>
<span class="sd">    &gt;&gt;&gt; tb.savepickle(&#39;input_files_2001.pkl&#39;, a)</span>
<span class="sd">    &gt;&gt;&gt; tb.savepickle(&#39;input_files_2002.pkl&#39;, b)</span>
<span class="sd">    &gt;&gt;&gt; tb.savepickle(&#39;input_files_2004.pkl&#39;, c)</span>
<span class="sd">    &gt;&gt;&gt; a = tb.assemble(&#39;input_files_*.pkl&#39;, &#39;combined_input.pkl&#39;)</span>
<span class="sd">    (&#39;adding &#39;, &#39;input_files_2001.pkl&#39;)</span>
<span class="sd">    (&#39;adding &#39;, &#39;input_files_2002.pkl&#39;)</span>
<span class="sd">    (&#39;adding &#39;, &#39;input_files_2004.pkl&#39;)</span>
<span class="sd">    (&#39;\\n writing: &#39;, &#39;combined_input.pkl&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(a)</span>
<span class="sd">    {&#39;ticks&#39;: array([1, 2, 3, 4, 5, 6, 7, 8, 9])}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># done this way so it works before install</span>
    <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">c</span>

    <span class="n">filelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fln_pattern</span><span class="p">)</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="n">human_sort</span><span class="p">(</span><span class="n">filelist</span><span class="p">)</span>
    <span class="c1"># read all files</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fln</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adding &quot;</span><span class="p">,</span> <span class="n">fln</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadpickle</span><span class="p">(</span><span class="n">fln</span><span class="p">)</span>

    <span class="c1"># combine them</span>
    <span class="n">dcomb</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># copy the first file over</span>
    <span class="k">for</span> <span class="n">fln</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
       <span class="c1"># check if sortkey is actually available</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">sortkey</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">]</span> <span class="ow">or</span> <span class="n">sortkey</span><span class="o">==</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;provided sortkey =&#39;</span><span class="o">+</span><span class="n">sortkey</span><span class="o">+</span><span class="s1">&#39; is not available&#39;</span>

        <span class="k">if</span> <span class="n">sortkey</span><span class="p">:</span>
            <span class="n">TAIcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span><span class="n">sortkey</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">TAIcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">]:</span>
            <span class="c1">#print fln, key</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dim</span><span class="o">==</span><span class="n">TAIcount</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># then match with TAI length is given (jump over otherwise like for &#39;parameters&#39;)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">):</span>
                    <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">Coords</span><span class="p">):</span>
                    <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">fln</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sortkey</span><span class="p">:</span>    <span class="c1">#  then sort</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">sortkey</span><span class="p">],</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">sortkey</span><span class="p">]</span><span class="o">.</span><span class="n">RDT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">sortkey</span><span class="p">])</span>
        <span class="n">TAIcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">sortkey</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dcomb</span><span class="p">:</span> <span class="c1"># iterates over keys by default</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dim</span><span class="o">==</span><span class="n">TAIcount</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># then match with length of TAI</span>
                <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dcomb</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># resort</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># do nothing</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> writing: &#39;</span><span class="p">,</span> <span class="n">outfln</span><span class="p">)</span>
    <span class="n">savepickle</span><span class="p">(</span><span class="n">outfln</span><span class="p">,</span> <span class="n">dcomb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dcomb</span></div>

<div class="viewcode-block" id="human_sort"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.human_sort.html#spacepy.toolbox.human_sort">[docs]</a><span class="k">def</span> <span class="nf">human_sort</span><span class="p">(</span> <span class="n">l</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort the given list in the way that humans expect.</span>
<span class="sd">    http://www.codinghorror.com/blog/2007/12/sorting-for-humans-natural-sort-order.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    l : list</span>
<span class="sd">        list of objects to human sort</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : list</span>
<span class="sd">        sorted list</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; dat = [&#39;r1.txt&#39;, &#39;r10.txt&#39;, &#39;r2.txt&#39;]</span>
<span class="sd">    &gt;&gt;&gt; dat.sort()</span>
<span class="sd">    &gt;&gt;&gt; print dat</span>
<span class="sd">    [&#39;r1.txt&#39;, &#39;r10.txt&#39;, &#39;r2.txt&#39;]</span>
<span class="sd">    &gt;&gt;&gt; tb.human_sort(dat)</span>
<span class="sd">    [&#39;r1.txt&#39;, &#39;r2.txt&#39;, &#39;r10.txt&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">convert</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">text</span>
    <span class="n">alphanum_key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="p">[</span> <span class="n">convert</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([0-9]+)&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">key</span><span class="o">=</span><span class="n">alphanum_key</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">l</span></div>

<div class="viewcode-block" id="feq"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.feq.html#spacepy.toolbox.feq">[docs]</a><span class="nd">@spacepy</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
    <span class="s1">&#39;0.2.2&#39;</span><span class="p">,</span> <span class="s1">&#39;use numpy.isclose&#39;</span><span class="p">,</span>
    <span class="s1">&#39;use :func:`numpy.isclose`; the ``rtol`` keyword is equivalent to&#39;</span>
    <span class="s1">&#39; ``precision``.&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">feq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">0.0000005</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compare two floating point values if they are equal</span>
<span class="sd">    after: http://www.lahey.com/float.htm</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    numpy.allclose</span>
<span class="sd">    numpy.isclose</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float</span>
<span class="sd">        a number</span>
<span class="sd">    y : float or array of floats</span>
<span class="sd">        other numbers to compare</span>
<span class="sd">    precision : float (optional)</span>
<span class="sd">        Relative precision for equal (default 0.0000005)</span>
<span class="sd">        Specified as a fraction of the sum of ``x`` and ``y``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : bool</span>
<span class="sd">        True (equal) or False (not equal)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; x = 1 + 1e-4</span>
<span class="sd">    &gt;&gt;&gt; y = 1 + 2e-4</span>
<span class="sd">    &gt;&gt;&gt; tb.feq(x, y)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; tb.feq(x, y, 1e-3)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">boolean</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">precision</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boolean</span></div>

<div class="viewcode-block" id="dictree"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.dictree.html#spacepy.toolbox.dictree">[docs]</a><span class="k">def</span> <span class="nf">dictree</span><span class="p">(</span><span class="n">in_dict</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    pretty print a dictionary tree</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_dict : dict</span>
<span class="sd">        a complex dictionary (with substructures)</span>
<span class="sd">    verbose : boolean (optional)</span>
<span class="sd">        print more info</span>
<span class="sd">    spaces : string (optional)</span>
<span class="sd">        string will added for every line</span>
<span class="sd">    levels : integer (optional)</span>
<span class="sd">        number of levels to recurse through (True means all)</span>
<span class="sd">    attrs : boolean (optional)</span>
<span class="sd">        display information for attributes</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; d = {&#39;grade&#39;:{&#39;level1&#39;:[4,5,6], &#39;level2&#39;:[2,3,4]}, &#39;name&#39;:[&#39;Mary&#39;, &#39;John&#39;, &#39;Chris&#39;]}</span>
<span class="sd">    &gt;&gt;&gt; tb.dictree(d)</span>
<span class="sd">    +</span>
<span class="sd">    |____grade</span>
<span class="sd">         |____level1</span>
<span class="sd">         |____level2</span>
<span class="sd">    |____name</span>

<span class="sd">    More complicated example using a datamodel:</span>

<span class="sd">    &gt;&gt;&gt; from spacepy import datamodel</span>
<span class="sd">    &gt;&gt;&gt; counts = datamodel.dmarray([2,4,6], attrs={&#39;units&#39;: &#39;cts/s&#39;})</span>
<span class="sd">    &gt;&gt;&gt; data = {&#39;counts&#39;: counts, &#39;PI&#39;: &#39;Dr Zog&#39;}</span>
<span class="sd">    &gt;&gt;&gt; tb.dictree(data)</span>
<span class="sd">    +</span>
<span class="sd">    |____PI</span>
<span class="sd">    |____counts</span>
<span class="sd">    &gt;&gt;&gt; tb.dictree(data, attrs=True, verbose=True)</span>
<span class="sd">    +</span>
<span class="sd">    |____PI (str [6])</span>
<span class="sd">    |____counts (spacepy.datamodel.dmarray (3,))</span>
<span class="sd">        :|____units (str [5])</span>

<span class="sd">    Attributes of, e.g., a CDF or a datamodel type object (obj.attrs)</span>
<span class="sd">    are denoted by a colon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">in_dict</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">in_dict</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;dictree: Input must be dictionary-like&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">spaces</span><span class="p">:</span>
        <span class="n">spaces</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;toplev&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">toplev</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;toplev&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toplev</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">toplev</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">dictree</span><span class="p">(</span><span class="n">in_dict</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">spaces</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">toplev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">toplev</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># TODO, if levels is True why check again?</span>
    <span class="k">if</span> <span class="n">levels</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">levels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">in_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;|____&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">typestr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#check entry for dict-like OR .attrs dict</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dimstr</span> <span class="o">=</span> <span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">dimstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimstr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dimstr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="n">dimstr</span> <span class="o">=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimstr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">dimstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">spaces</span> <span class="o">+</span> <span class="n">bar</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span><span class="o">+</span> <span class="n">typestr</span> <span class="o">+</span> <span class="n">dimstr</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">spaces</span> <span class="o">+</span> <span class="n">bar</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;attrs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">dictree</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">spaces</span> <span class="o">=</span> <span class="n">spaces</span> <span class="o">+</span> <span class="s1">&#39;    :&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">toplev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;keys&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">levels</span><span class="p">:</span>
                <span class="n">dictree</span><span class="p">(</span><span class="n">in_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">spaces</span> <span class="o">=</span> <span class="n">spaces</span> <span class="o">+</span> <span class="s1">&#39;     &#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">toplev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="k">def</span> <span class="nf">_crawl_yearly</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">startyear</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crawl files in a directory-by-year structure</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    base_url : str</span>
<span class="sd">        Base of the data. This URL should point to a directory containing</span>
<span class="sd">        yearly directories (YYYY).</span>
<span class="sd">    pattern : str</span>
<span class="sd">        Regular expression to match filenames. Will download files in each</span>
<span class="sd">        yearly directory that match the pattern.</span>
<span class="sd">    datadir : str</span>
<span class="sd">        Directory to store downloaded files. A mirror will be maintained in</span>
<span class="sd">        this directory. Note this is a &quot;flat&quot; mirror without the year</span>
<span class="sd">        directories.</span>
<span class="sd">    name : str (optional)</span>
<span class="sd">        Name of the data set, used only in status messages.</span>
<span class="sd">    cached : boolean (optional)</span>
<span class="sd">        Only update files if timestamp on server is newer than</span>
<span class="sd">        timestamp on local file (default). Set False to always</span>
<span class="sd">        download files.</span>
<span class="sd">    startyear : int (optional)</span>
<span class="sd">        First year to crawl, as four-digit number or four-character string.</span>
<span class="sd">        If not specified, will download all years. If specified, will delete</span>
<span class="sd">        years prior to this which have already been downloaded.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    list</span>
<span class="sd">        All the filenames that were mirrored, in order; or None if there</span>
<span class="sd">        were no updates. If there are any updates, all filenames are</span>
<span class="sd">        included.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1">#Find all the files to download</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding </span><span class="si">{}</span><span class="s2">files to download ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">progressbar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Listing files&#39;</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;keepalive&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">keepalive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span> <span class="c1">#Give up on keepalives</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">LinkExtracter</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">yearlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">links</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d</span><span class="si">{4}</span><span class="s1">/&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">startyear</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">str</span><span class="p">(</span><span class="n">startyear</span><span class="p">))]</span>
    <span class="n">downloadme</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yearlist</span><span class="p">):</span>
        <span class="n">yearurl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">yearurl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">yearurl</span><span class="p">,</span> <span class="n">keepalive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">LinkExtracter</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">downloadme</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">yearurl</span> <span class="o">+</span> <span class="n">f</span>
        <span class="n">progressbar</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">yearlist</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Listing files&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving </span><span class="si">{}</span><span class="s2">files ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">downloadme</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#Check for existing files (delete them if no longer on server)</span>
    <span class="n">have_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">have_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="c1">#File was removed, so need to reparse even if no new downloads</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#Download</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">downloadme</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                          <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">downloadme</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">,</span> <span class="n">keepalive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">progressbar</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">newdata</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_qindenton_daily</span><span class="p">(</span><span class="n">qd_daily_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">startyear</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download the Qin-Denton OMNI-like daily files</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    qd_daily_url : str (optional)</span>
<span class="sd">        Base of the Qin-Denton data, in hourly JSON-headed ASCII. This URL</span>
<span class="sd">        should point to the directory containing the yearly directories.</span>
<span class="sd">        Default from ``qd_daily_url`` in config file.</span>
<span class="sd">    cached : boolean (optional)</span>
<span class="sd">        Only update files if timestamp on server is newer than</span>
<span class="sd">        timestamp on local file (default). Set False to always</span>
<span class="sd">        download files.</span>
<span class="sd">    startyear : int (optional)</span>
<span class="sd">        If specified, start downloading files from the year given,</span>
<span class="sd">        rather than all years. This will delete older files!</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    SpaceData</span>
<span class="sd">        The data extracted from the Q-D dataset, fully processed for saving</span>
<span class="sd">        as SpacePy HDF5 OMNI data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">qd_daily_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qd_daily_url</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;qd_daily_url&#39;</span><span class="p">]</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">DOT_FLN</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;qindenton_daily_files&#39;</span><span class="p">)</span>
    <span class="n">_crawl_yearly</span><span class="p">(</span><span class="n">qd_daily_url</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;QinDenton_\d</span><span class="si">{8}</span><span class="s1">_hour.txt&#39;</span><span class="p">,</span>
                  <span class="n">datadir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Q-D daily&#39;</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">,</span> <span class="n">startyear</span><span class="o">=</span><span class="n">startyear</span><span class="p">)</span>
    <span class="c1">#Read and process</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing Q-D daily files ...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_assemble_qindenton_daily</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_assemble_qindenton_daily</span><span class="p">(</span><span class="n">qd_daily_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assemble Qin-Denton daily files into OMNI structure</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    qd_daily_dir : str</span>
<span class="sd">        Directory with Qin-Denton daily files.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    SpaceData</span>
<span class="sd">        The data extracted from the Q-D dataset, fully processed for saving</span>
<span class="sd">        as SpacePy HDF5 OMNI data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.datamodel</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qd_daily_dir</span><span class="p">,</span> <span class="s1">&#39;*_hour.txt&#39;</span><span class="p">)))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">readJSONheadedASCII</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">]</span>
    <span class="n">omnidata</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DateTime&#39;</span><span class="p">,</span> <span class="s1">&#39;Minute&#39;</span><span class="p">,</span> <span class="s1">&#39;OriginFile&#39;</span><span class="p">,</span> <span class="s1">&#39;Second&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">data</span>
    <span class="n">ntimes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">omnidata</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ntimes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Input Q-D daily file has different size for different variables&#39;</span><span class="p">)</span>
    <span class="n">ntimes</span> <span class="o">=</span> <span class="n">ntimes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="c1"># Renaming from the names in new file to old file names</span>
    <span class="k">for</span> <span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="s1">&#39;Den_P&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;velo&#39;</span><span class="p">,</span> <span class="s1">&#39;Vsw&#39;</span><span class="p">)):</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span> <span class="o">=</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_status&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">omnidata</span><span class="p">:</span>
            <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_status&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oldname</span><span class="p">)]</span> \
                <span class="o">=</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_status&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">)]</span>
            <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_status&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">)]</span>
    <span class="c1"># Quality flags</span>
    <span class="n">qbits</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">omnidata</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="c1"># Edit while iterate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_status&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">basename</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">):</span> <span class="c1"># Arrays</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">qbits</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qbits</span><span class="p">[</span><span class="n">basename</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qbits</span>
    <span class="c1"># Reformat some arrays to multi-variable</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="c1"># Make integers of integers</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Dst&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Hour&#39;</span><span class="p">):</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="c1"># Process time formats</span>
    <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">dmarray</span><span class="p">([</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                          <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                          <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Day&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                          <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Hour&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]))])</span>
    <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;DOY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">datamodel</span><span class="o">.</span><span class="n">dmarray</span><span class="p">([</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;RDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">],</span> <span class="s1">&#39;UTC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">RDT</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Hour&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">omnidata</span>


<span class="k">def</span> <span class="nf">_get_cdaweb_omni2</span><span class="p">(</span><span class="n">omni2url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download the OMNI2 data from SPDF</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    omni2url : str (optional)</span>
<span class="sd">        Base of the OMNI2 data at SPDF, in hourly CDF form. This URL</span>
<span class="sd">        should point to the directory containing the yearly directories.</span>
<span class="sd">        Default from ``omni2_url`` in config file.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    SpaceData</span>
<span class="sd">        The data extracted from the OMNI2 dataset, with variables renamed</span>
<span class="sd">        to match the old ViRBO combined OMNI2 CDF. Returns ``None``</span>
<span class="sd">        if there are no new data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.pycdf</span>
    <span class="kn">import</span> <span class="nn">spacepy.pycdf.istp</span>
    <span class="k">if</span> <span class="n">omni2url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">omni2url</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;omni2_url&#39;</span><span class="p">]</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">DOT_FLN</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;omni2cdfs&#39;</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">_crawl_yearly</span><span class="p">(</span><span class="n">omni2url</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;omni2_h0_mrg1hr_\d</span><span class="si">{8}</span><span class="s1">_v\d+\.cdf&#39;</span><span class="p">,</span>
                              <span class="n">datadir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;OMNI2&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1">#Read and process</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading OMNI2 files ...&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">concatCDF</span><span class="p">([</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">CDF</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">])</span>
    <span class="c1">#Map keyed by the variable names as in the OMNI2 data from CDAWeb,</span>
    <span class="c1">#valued by the variable names as in the OMNI2 data from ViRBO</span>
    <span class="c1">#i.e. this is from: to</span>
    <span class="c1">#None means not in VirBO, so delete.</span>
    <span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ABS_B&#39;</span><span class="p">:</span> <span class="s1">&#39;Field_mag_ave&#39;</span><span class="p">,</span> <span class="c1">#This is average of the magnitude</span>
        <span class="s1">&#39;AE&#39;</span><span class="p">:</span> <span class="s1">&#39;AE_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AL_INDEX&#39;</span><span class="p">:</span> <span class="s1">&#39;AL_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AP_INDEX&#39;</span><span class="p">:</span> <span class="s1">&#39;Ap_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AU_INDEX&#39;</span><span class="p">:</span> <span class="s1">&#39;AU_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BX_GSE&#39;</span><span class="p">:</span> <span class="s1">&#39;Bx_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BY_GSE&#39;</span><span class="p">:</span> <span class="s1">&#39;By_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BZ_GSE&#39;</span><span class="p">:</span> <span class="s1">&#39;Bz_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BY_GSM&#39;</span><span class="p">:</span> <span class="s1">&#39;By_GSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BZ_GSM&#39;</span><span class="p">:</span> <span class="s1">&#39;Bz_GSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Beta&#39;</span><span class="p">:</span> <span class="s1">&#39;Plasma_beta&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Day&#39;</span><span class="p">:</span> <span class="s1">&#39;Decimal_Day&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DST&#39;</span><span class="p">:</span> <span class="s1">&#39;Dst_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;Electric_field_GSM&#39;</span><span class="p">,</span>
        <span class="c1">#&#39;Epoch&#39;: &#39;Epoch&#39;, #same, do not change</span>
        <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s1">&#39;Mag_of_ave_field_vect&#39;</span><span class="p">,</span> <span class="c1">#Magnitude of average</span>
        <span class="s1">&#39;F10_INDEX&#39;</span><span class="p">:</span> <span class="s1">&#39;f10_7_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HR&#39;</span><span class="p">:</span> <span class="s1">&#39;Hour&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IMF&#39;</span><span class="p">:</span> <span class="s1">&#39;IMF_spacecraft_ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IMF_PTS&#39;</span><span class="p">:</span> <span class="s1">&#39;Num_pts_in_IMF_aves&#39;</span><span class="p">,</span>
        <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="s1">&#39;Kp_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mach_num&#39;</span><span class="p">:</span> <span class="s1">&#39;Alfven_mach_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MFLX&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_flag&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mgs_mach_num&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1">#magnetosonic mach number</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;Ion_density&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PC_N_INDEX&#39;</span><span class="p">:</span> <span class="s1">&#39;PC_N_index&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PHI-V&#39;</span><span class="p">:</span> <span class="s1">&#39;Plasma_bulk_flow_long_angle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PHI_AV&#39;</span><span class="p">:</span> <span class="s1">&#39;Long_angle_ave_field_vector&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PLS&#39;</span><span class="p">:</span> <span class="s1">&#39;SW_plasma_spacecraft_ID&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PLS_PTS&#39;</span><span class="p">:</span> <span class="s1">&#39;Num_pts_in_plasma_aves&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_1_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_10&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_10_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_2&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_2_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_30&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_30_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_4&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_4_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PR-FLX_60&#39;</span><span class="p">:</span> <span class="s1">&#39;Proton_flux_gt_60_MeV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pressure&#39;</span><span class="p">:</span> <span class="s1">&#39;Flow_pressure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;Sunspot_number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;Na_over_Np&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Rot#&#39;</span><span class="p">:</span> <span class="s1">&#39;Bartels_rotation_num&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-ABS_B&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_field_mag_ave&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-B&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_mag_of_ave_field_vect&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-Bx&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_Bx_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-By&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_By_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-Bz&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_Bz_GSE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-N&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_ion_density&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-PHI-V&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_plasma_flow_long_angle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-T&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_temp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-THETA-V&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_plasma_flow_lat_angle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-V&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_plasma_bulk_speed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SIGMA-ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;sigma_ratio&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Solar_Lyman_alpha&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;Plasma_temp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;THETA-V&#39;</span><span class="p">:</span> <span class="s1">&#39;Plasma_bulk_flow_lat_angle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;THETA_AV&#39;</span><span class="p">:</span> <span class="s1">&#39;Lat_angle_ave_field_vector&#39;</span><span class="p">,</span>
        <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;Plasma_bulk_speed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;YR&#39;</span><span class="p">:</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keymap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="c1">#The CDAWeb Epochs are erroneously tagged as START of collection,</span>
    <span class="c1">#not midpoint. So fix that</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="c1">#Castings to match ViRBO: everything is an int, and fill turns to NaN</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span> <span class="c1">#Skip epoch</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">istp</span><span class="o">.</span><span class="n">nanfill</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">class</span> <span class="nc">LinkExtracter</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds all links in a HTML page, useful for crawling.</span>

<span class="sd">    After HTML has been parsed, the ``links`` attribute contains</span>
<span class="sd">    a list of link targets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">LinkExtracter</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">LinkExtracter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#py2k, old-style class</span>
            <span class="n">html</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;List of link targets found in the page&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;href&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="get_url"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.get_url.html#spacepy.toolbox.get_url">[docs]</a><span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reporthook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">keepalive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read data from a URL</span>

<span class="sd">    Open an HTTP URL, honoring the user agent as specified in the</span>
<span class="sd">    SpacePy config file. Returns the data, optionally also writing</span>
<span class="sd">    out to a file.</span>

<span class="sd">    This is similar to the deprecated ``urlretrieve``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    url : str</span>
<span class="sd">        The URL to open</span>
<span class="sd">    outfile : str (optional)</span>
<span class="sd">        Full path to file to write data to</span>
<span class="sd">    reporthook : callable (optional)</span>
<span class="sd">        Function for reporting progress; takes arguments of block</span>
<span class="sd">        count, block size, and total size.</span>
<span class="sd">    cached : bool (optional)</span>
<span class="sd">        Compare modification time of the URL to the modification time</span>
<span class="sd">        of ``outfile``; do not retrieve (and return None) unless</span>
<span class="sd">        the URL is newer than the file.</span>
<span class="sd">    keepalive : bool (optional)</span>
<span class="sd">        Attempt to keep the connection open to retrieve more URLs.</span>
<span class="sd">        The return becomes a tuple of (data, conn) to return the</span>
<span class="sd">        connection used so it can be used again. This mode does not</span>
<span class="sd">        support proxies. (Default False)</span>
<span class="sd">    conn : http.client.HTTPConnection (optional)</span>
<span class="sd">        An established http connection (HTTPS is also okay) to use with</span>
<span class="sd">        ``keepalive``. If not provided, will attempt to make a connection.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    bytes</span>
<span class="sd">        The HTTP data from the server.</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    progressbar</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    This function honors proxy settings as described in</span>
<span class="sd">    :func:`urllib.request.getproxies`. Cryptic error messages (such as</span>
<span class="sd">    ``Network is unreachable``) may indicate that proxy settings</span>
<span class="sd">    should be defined as appropriate for your environment (e.g. with</span>
<span class="sd">    ``HTTP_PROXY`` or ``HTTPS_PROXY`` environment variables).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keepalive</span> <span class="ow">and</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot specify connection without keepalive&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keepalive</span><span class="p">:</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="c1"># Explicitly root on the server</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">readable</span><span class="p">,</span> <span class="n">writeable</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">sock</span><span class="p">],</span> <span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">sock</span><span class="p">],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Make sure no stale data to read on socket, and can write to it</span>
            <span class="k">if</span> <span class="n">readable</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">writeable</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPConnection</span> <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;http:&#39;</span>\
                    <span class="k">else</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">HTTPSConnection</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">ctype</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="n">clheaders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">clheaders</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user_agent&#39;</span><span class="p">]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span> <span class="k">if</span> <span class="n">cached</span> <span class="k">else</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">clheaders</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">checkresponse</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Get the response on a connection, return response and headers&quot;&quot;&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;HTTP status </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">getheaders</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">headers</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkresponse</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;user_agent&#39;</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;HTTP status </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="n">modified</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># strptime is affected by locale (including the month name) but the</span>
        <span class="c1"># header is a constant format, so massage</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">modified</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="c1"># Get rid of day of week and &#39;GMT&#39;</span>
        <span class="n">modified</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>\
                          <span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">modified</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Make month numerical</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modified</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> %m %Y %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">modified</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keepalive</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Must specify outfile if cached is True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Timestamp is truncated to second, so do same for local</span>
            <span class="n">local_mod</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">modified</span> <span class="o">&lt;=</span> <span class="n">local_mod</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keepalive</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span> <span class="k">if</span> <span class="n">keepalive</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">keepalive</span><span class="p">:</span> <span class="c1"># Replace previous header request with full get</span>
            <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">clheaders</span><span class="p">)</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">checkresponse</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">newdata</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newdata</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">reporthook</span><span class="p">:</span>
            <span class="n">reporthook</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keepalive</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#Copy web mtime to file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span> <span class="n">modified</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span> <span class="k">if</span> <span class="n">keepalive</span> <span class="k">else</span> <span class="n">data</span></div>


<div class="viewcode-block" id="update"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.update.html#spacepy.toolbox.update">[docs]</a><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">QDomni</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omni</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omni2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">leapsecs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">PSDdata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download and update local database for omni, leapsecs etc</span>

<span class="sd">    Web access is via :func:`get_url`; notes there may be helpful in</span>
<span class="sd">    debugging errors. See also the ``keepalive`` configuration option.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    all : boolean (optional)</span>
<span class="sd">        if True, update OMNI2, Qin-Denton and leapsecs</span>
<span class="sd">    omni : boolean (optional)</span>
<span class="sd">        if True. update only omni (Qin-Denton)</span>
<span class="sd">    omni2 : boolean (optional)</span>
<span class="sd">        if True, update only original OMNI2</span>
<span class="sd">    QDomni : boolean (optional)</span>
<span class="sd">        if True, update OMNI2 and Qin-Denton</span>
<span class="sd">    leapsecs : boolean (optional)</span>
<span class="sd">        if True, update only leapseconds</span>
<span class="sd">    cached : boolean (optional)</span>
<span class="sd">        Only update files if timestamp on server is newer than</span>
<span class="sd">        timestamp on local file (default). Set False to always</span>
<span class="sd">        download files.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : string</span>
<span class="sd">        data directory where things are saved</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_url</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.update(omni=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">spacepy.datamodel</span> <span class="kn">import</span> <span class="n">SpaceData</span><span class="p">,</span> <span class="n">dmarray</span><span class="p">,</span> <span class="n">fromCDF</span><span class="p">,</span> <span class="n">toHDF5</span>
    <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">DOT_FLN</span><span class="p">,</span> <span class="n">config</span>

    <span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOT_FLN</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datadir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>

    <span class="c1">#leapsec_url =&#39;ftp://maia.usno.navy.mil/ser7/tai-utc.dat&#39;</span>
    <span class="n">leapsec_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;tai-utc.dat&#39;</span><span class="p">)</span>

    <span class="c1"># define location for getting omni</span>
    <span class="c1">#omni_url = &#39;ftp://virbo.org/QinDenton/hour/merged/latest/WGhour-latest.d.zip&#39;</span>
    <span class="n">omni_fname_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;WGhour-latest.d.zip&#39;</span><span class="p">)</span>
    <span class="n">omni2_fname_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;omni2-latest.cdf.zip&#39;</span><span class="p">)</span>
    <span class="n">omni_fname_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;omnidata.pkl&#39;</span><span class="p">)</span>
    <span class="n">omni_fname_json</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;omnidata.txt&#39;</span><span class="p">)</span>
    <span class="n">omni_fname_h5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;omnidata.h5&#39;</span><span class="p">)</span>
    <span class="n">omni2_fname_h5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;omni2data.h5&#39;</span><span class="p">)</span>

    <span class="n">PSDdata_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;psd_dat.sqlite&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">omni</span> <span class="ow">or</span> <span class="n">omni2</span> <span class="ow">or</span> <span class="n">QDomni</span> <span class="ow">or</span> <span class="n">leapsecs</span> <span class="ow">or</span> <span class="n">PSDdata</span><span class="p">):</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#if an option is explicitly selected, turn &#39;all&#39; off</span>

    <span class="k">if</span> <span class="nb">all</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">omni</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">omni2</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">leapsecs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">QDomni</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">omni</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">omni2</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">omni</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># retrieve omni, unzip and save as table</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving initial Qin-Denton file ...&quot;</span><span class="p">)</span>
        <span class="n">get_url</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;qindenton_url&#39;</span><span class="p">],</span> <span class="n">omni_fname_zip</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span>
                <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">)</span>
        <span class="n">fh_zip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">omni_fname_zip</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fh_zip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fh_zip</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing initial Qin-Denton file ...&quot;</span><span class="p">)</span>

        <span class="c1"># create a keylist</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;8&#39;</span><span class="p">)</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;8_status&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;6_status&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;dst&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Dst&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;kp&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Kp&#39;</span>
        <span class="c1">#keys[keys.index(&#39;Hr&#39;)] = &#39;Hr&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;V_SW&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;velo&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Den_P&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;dens&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Day&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;DOY&#39;</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>

        <span class="c1"># remove keyword lines and empty lines as well</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># put it into a 2D table</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]]</span>
        <span class="n">stat8</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">]</span>
        <span class="n">stat6</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">]</span>

        <span class="n">tab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="c1"># take out where Dst not available ( = 99999) or year == 0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">tab</span><span class="p">[:,</span><span class="mi">12</span><span class="p">]</span> <span class="o">!=</span><span class="mf">99.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tab</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
        <span class="n">stat8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stat8</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">stat6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stat6</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">omnidata</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
        <span class="c1"># sort through and make an omni dictionary</span>
        <span class="c1"># extract keys from line above</span>
        <span class="k">for</span> <span class="n">ikey</span><span class="p">,</span> <span class="n">i</span>  <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;DOY&#39;</span><span class="p">,</span> <span class="s1">&#39;Hr&#39;</span><span class="p">,</span> <span class="s1">&#39;Dst&#39;</span><span class="p">):</span>
                <span class="n">omnidata</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">tab</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">omnidata</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">tab</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># add TAI to omnidata</span>
        <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;DOY&#39;</span><span class="p">])</span>

        <span class="c1"># add interpolation quality flags</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">stat8</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">stat8</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="n">nTAI</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;ByIMF&#39;</span><span class="p">,</span> <span class="s1">&#39;BzIMF&#39;</span><span class="p">,</span> <span class="s1">&#39;velo&#39;</span><span class="p">,</span> <span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="s1">&#39;Pdyn&#39;</span><span class="p">,</span> <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;G2&#39;</span><span class="p">,</span> <span class="s1">&#39;G3&#39;</span><span class="p">]):</span>
            <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ik</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">stat6</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;U6&#39;</span><span class="p">:</span>
            <span class="n">stat6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">stat6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S6&#39;</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">stat6</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">stat6</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">nTAI</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;W2&#39;</span><span class="p">,</span> <span class="s1">&#39;W3&#39;</span><span class="p">,</span> <span class="s1">&#39;W4&#39;</span><span class="p">,</span> <span class="s1">&#39;W5&#39;</span><span class="p">,</span> <span class="s1">&#39;W6&#39;</span><span class="p">]):</span>
            <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ik</span><span class="p">,:]</span>

        <span class="c1">#remove string status keys</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">omnidata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;6_status&#39;</span><span class="p">)</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">omnidata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;8_status&#39;</span><span class="p">)</span>

        <span class="c1"># add time information to omni pickle (long loop)</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                 <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;DOY&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Hr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)])</span>

        <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">],</span> <span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;RDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">RDT</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span> <span class="c1">#Can be quickly regenerated on import</span>
        <span class="n">startyear</span> <span class="o">=</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;Hr&#39;</span><span class="p">]</span>

        <span class="c1"># Supplement with daily files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Supplementing with latest Q-D daily files,&#39;</span>
              <span class="s1">&#39; this will take a while...&#39;</span><span class="p">)</span>
        <span class="n">dailyomnidata</span> <span class="o">=</span> <span class="n">_get_qindenton_daily</span><span class="p">(</span><span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">,</span> <span class="n">startyear</span><span class="o">=</span><span class="n">startyear</span><span class="p">)</span>
        <span class="c1"># Find where new files start</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">],</span> <span class="n">dailyomnidata</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">omnidata</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;Qbits&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">qk</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">qk</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                        <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">qk</span><span class="p">][:</span><span class="n">idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">dailyomnidata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">qk</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                    <span class="n">omnidata</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span><span class="n">idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">dailyomnidata</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now saving... &quot;</span><span class="p">)</span>
        <span class="c1">##for now, make one file -- think about whether monthly/annual files makes sense</span>
        <span class="n">toHDF5</span><span class="p">(</span><span class="n">omni_fname_h5</span><span class="p">,</span> <span class="n">omnidata</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Complete.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">omni2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">omni2_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;omni2_url&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">omni2_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
            <span class="c1"># adding missing values from original omni2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving OMNI2 file ...&quot;</span><span class="p">)</span>
            <span class="n">get_url</span><span class="p">(</span><span class="n">omni2_url</span><span class="p">,</span> <span class="n">omni2_fname_zip</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span> <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">)</span>
            <span class="n">fh_zip</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">omni2_fname_zip</span><span class="p">)</span>
            <span class="n">flist</span> <span class="o">=</span> <span class="n">fh_zip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to find OMNI2 file in zip file.&#39;</span><span class="p">)</span>
            <span class="n">file_to_read</span> <span class="o">=</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_to_read</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected contents of OMNI2 zip file.&#39;</span><span class="p">)</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh_zip</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">file_to_read</span><span class="p">,</span> <span class="n">td</span><span class="p">)</span>
                <span class="n">omnicdf</span> <span class="o">=</span> <span class="n">fromCDF</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">file_to_read</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">fh_zip</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">omni2_fname_zip</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omnicdf</span> <span class="o">=</span> <span class="n">_get_cdaweb_omni2</span><span class="p">(</span><span class="n">omni2_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">omnicdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#If no new data, skip all this</span>
            <span class="c1">#add RDT</span>
            <span class="n">omnicdf</span><span class="p">[</span><span class="s1">&#39;RDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">omnicdf</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">],</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">RDT</span>
            <span class="c1">#remove keys that get in the way</span>
            <span class="k">del</span> <span class="n">omnicdf</span><span class="p">[</span><span class="s1">&#39;Hour&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">omnicdf</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">omnicdf</span><span class="p">[</span><span class="s1">&#39;Decimal_Day&#39;</span><span class="p">]</span>

            <span class="c1"># save as HDF5</span>
            <span class="n">toHDF5</span><span class="p">(</span><span class="n">omni2_fname_h5</span><span class="p">,</span> <span class="n">omnicdf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">leapsecs</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving leapseconds file ... &quot;</span><span class="p">)</span>
        <span class="n">get_url</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;leapsec_url&#39;</span><span class="p">],</span> <span class="n">leapsec_fname</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span>
                <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">)</span>
        <span class="c1"># Reload leap seconds if they&#39;ve already been used.</span>
        <span class="k">if</span> <span class="s1">&#39;spacepy.time&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>\
           <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;spacepy.time&#39;</span><span class="p">],</span> <span class="s1">&#39;TAIleaps&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;spacepy.time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_read_leaps</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">PSDdata</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving PSD sql database&quot;</span><span class="p">)</span>
        <span class="n">get_url</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;psddata_url&#39;</span><span class="p">],</span> <span class="n">PSDdata_fname</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">,</span>
                <span class="n">cached</span><span class="o">=</span><span class="n">cached</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datadir</span></div>

<div class="viewcode-block" id="indsFromXrange"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.indsFromXrange.html#spacepy.toolbox.indsFromXrange">[docs]</a><span class="k">def</span> <span class="nf">indsFromXrange</span><span class="p">(</span><span class="n">inxrange</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return the start and end indices implied by an xrange, useful when xrange is zero-length</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    inxrange : xrange</span>
<span class="sd">        input xrange object to parse</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    list of int</span>
<span class="sd">       List of start, stop indices in the xrange. The return value is not</span>
<span class="sd">       defined if a stride is specified or if stop is before start (but</span>
<span class="sd">       will work when stop equals start).</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; foo = xrange(23, 39)</span>
<span class="sd">    &gt;&gt;&gt; foo[0]</span>
<span class="sd">    23</span>
<span class="sd">    &gt;&gt;&gt; tb.indsFromXrange(foo)</span>
<span class="sd">    [23, 39]</span>
<span class="sd">    &gt;&gt;&gt; foo1 = xrange(23, 23)</span>
<span class="sd">    &gt;&gt;&gt; tb.indsFromXrange(foo) #indexing won&#39;t work in this case</span>
<span class="sd">    [23, 23]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inxrange</span><span class="p">,</span> <span class="n">xrange</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="n">valstr</span> <span class="o">=</span> <span class="n">inxrange</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valstr</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="n">valstr</span><span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+), (\d+)&#39;</span><span class="p">,</span> <span class="n">valstr</span><span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="progressbar"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.progressbar.html#spacepy.toolbox.progressbar">[docs]</a><span class="k">def</span> <span class="nf">progressbar</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">totalsize</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Download Progress&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print a progress bar with urllib.urlretrieve reporthook functionality</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import urllib</span>
<span class="sd">    &gt;&gt;&gt; urllib.urlretrieve(config[&#39;psddata_url&#39;], PSDdata_fname, reporthook=tb.progressbar)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">totalsize</span>
    <span class="k">if</span> <span class="n">percent</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{}</span><span class="s2"> ...</span><span class="si">{:.0f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">percent</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">percent</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="windowMean"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.windowMean.html#spacepy.toolbox.windowMean">[docs]</a><span class="k">def</span> <span class="nf">windowMean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">[],</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">st_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Windowing mean function, window overlap is user defined</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    data : array_like</span>
<span class="sd">        1D series of points</span>
<span class="sd">    time : list (optional)</span>
<span class="sd">        series of timestamps, optional (format as numeric or datetime)</span>
<span class="sd">        For non-overlapping windows set overlap to zero.</span>
<span class="sd">    winsize : integer or datetime.timedelta (optional)</span>
<span class="sd">        window size</span>
<span class="sd">    overlap : integer or datetime.timedelta (optional)</span>
<span class="sd">        amount of window overlap</span>
<span class="sd">    st_time : datetime.datetime (optional)</span>
<span class="sd">        for time-based averaging, a start-time other than the first</span>
<span class="sd">        point can be specified</span>
<span class="sd">    op : callable (optional)</span>
<span class="sd">        the operator to be called, default numpy.mean</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : tuple</span>
<span class="sd">        the windowed mean of the data, and an associated reference time vector</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    For non-overlapping windows set overlap to zero.</span>
<span class="sd">    e.g. (time-based averaging)</span>
<span class="sd">    Given a data set of 100 points at hourly resolution (with the time tick in</span>
<span class="sd">    the middle of the sample), the daily average of this, with half-overlapping</span>
<span class="sd">    windows is calculated:</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; from datetime import datetime, timedelta</span>
<span class="sd">    &gt;&gt;&gt; wsize = datetime.timedelta(days=1)</span>
<span class="sd">    &gt;&gt;&gt; olap = datetime.timedelta(hours=12)</span>
<span class="sd">    &gt;&gt;&gt; data = [10, 20]*50</span>
<span class="sd">    &gt;&gt;&gt; time = [datetime.datetime(2001,1,1) + datetime.timedelta(hours=n, minutes = 30) for n in range(100)]</span>
<span class="sd">    &gt;&gt;&gt; outdata, outtime = tb.windowMean(data, time, winsize=wsize, overlap=olap, st_time=datetime.datetime(2001,1,1))</span>
<span class="sd">    &gt;&gt;&gt; outdata, outtime</span>
<span class="sd">    ([15.0, 15.0, 15.0, 15.0, 15.0, 15.0, 15.0],</span>
<span class="sd">     [datetime.datetime(2001, 1, 1, 12, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 2, 0, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 2, 12, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 3, 0, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 3, 12, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 4, 0, 0),</span>
<span class="sd">      datetime.datetime(2001, 1, 4, 12, 0)])</span>

<span class="sd">    When using time-based averaging, ensure that the time tick corresponds to</span>
<span class="sd">    the middle of the time-bin to which the data apply. That is, if the data</span>
<span class="sd">    are hourly, say for 00:00-01:00, then the time applied should be 00:30.</span>
<span class="sd">    If this is not done, unexpected behaviour can result.</span>

<span class="sd">    e.g. (pointwise averaging),</span>

<span class="sd">    &gt;&gt;&gt; outdata, outtime = tb.windowMean(data, winsize=24, overlap=12)</span>
<span class="sd">    &gt;&gt;&gt; outdata, outtime</span>
<span class="sd">    ([15.0, 15.0, 15.0, 15.0, 15.0, 15.0, 15.0], [12.0, 24.0, 36.0, 48.0, 60.0, 72.0, 84.0])</span>

<span class="sd">    where winsize and overlap are numeric,</span>
<span class="sd">    in this example the window size is 24 points (as the data are hourly) and</span>
<span class="sd">    the overlap is 12 points (a half day). The output vectors start at</span>
<span class="sd">    winsize/2 and end at N-(winsize/2), the output time vector</span>
<span class="sd">    is basically a reference to the nth point in the original series.</span>

<span class="sd">    **note** This is a quick and dirty function - it is NOT optimized, at all.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#check inputs and initialize</span>
    <span class="c1">#Set resolution to 1 if no times supplied</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startpt</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;windowmean error: data and time must have same length&#39;</span><span class="p">)</span>
        <span class="c1">#First check if datetime objects</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">winsize</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;windowmean error: winsize/overlap must be timedeltas&#39;</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#force time-based averaging</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">startpt</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#now actually do windowing mean</span>
    <span class="n">outdata</span><span class="p">,</span> <span class="n">outtime</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
        <span class="c1">#loop for fixed number of points in window</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inttypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">inttypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">winsize</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
            <span class="n">winsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">winsize</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;windowmean: non-integer windowsize, rounding to </span><span class="si">%d</span><span class="s1">&#39;</span> \
            <span class="o">%</span> <span class="n">winsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">winsize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">winsize</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;windowmean: window length &lt; 1, defaulting to 1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="n">winsize</span><span class="p">:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">winsize</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;windowmean: overlap longer than window, truncated to</span>
<span class="s1">            </span><span class="si">%d</span><span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">overlap</span><span class="p">)</span>
        <span class="n">lastpt</span> <span class="o">=</span> <span class="n">winsize</span><span class="o">-</span><span class="mi">1</span> <span class="c1">#set last point to end of window size</span>
        <span class="k">while</span> <span class="n">lastpt</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">datwin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">startpt</span><span class="p">:</span><span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span><span class="p">]),</span> \
                <span class="n">data</span><span class="p">[</span><span class="n">startpt</span><span class="p">:</span><span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span><span class="p">])</span>
            <span class="n">getmean</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">datwin</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span> <span class="c1">#mean of window, excl. NaNs</span>
            <span class="n">gettime</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="n">startpt</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span> \
                <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="n">startpt</span><span class="p">]</span><span class="c1">#new timestamp</span>
            <span class="n">startpt</span> <span class="o">=</span> <span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span><span class="o">-</span><span class="n">overlap</span>
            <span class="n">lastpt</span> <span class="o">=</span> <span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span>
            <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getmean</span><span class="p">)</span> <span class="c1">#construct output arrays</span>
            <span class="n">outtime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gettime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#loop with time-based window</span>
        <span class="n">lastpt</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">winsize</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#TODO: replace this with an explicit check for times on the boundary?</span>
        <span class="k">if</span> <span class="n">st_time</span><span class="p">:</span>
            <span class="n">startpt</span> <span class="o">=</span> <span class="n">st_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">startpt</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="n">winsize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Overlap requested greater than size of window&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">startpt</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">getinds</span> <span class="o">=</span> <span class="n">tOverlapHalf</span><span class="p">([</span><span class="n">startpt</span><span class="p">,</span><span class="n">startpt</span><span class="o">+</span><span class="n">winsize</span><span class="o">-</span><span class="n">delta</span><span class="p">],</span> <span class="n">time</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">getinds</span><span class="p">:</span> <span class="c1">#if not None</span>
                <span class="n">getdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">getinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">getinds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">data</span><span class="p">[</span><span class="n">getinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">getinds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">getmean</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">getdata</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span> <span class="c1">#find mean excluding NaNs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">getmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">gettime</span> <span class="o">=</span> <span class="n">startpt</span> <span class="o">+</span> <span class="n">winsize</span><span class="o">//</span><span class="mi">2</span> <span class="c1">#new timestamp -floordiv req&#39;d with future division</span>
            <span class="n">startpt</span> <span class="o">=</span> <span class="n">startpt</span> <span class="o">+</span> <span class="n">winsize</span> <span class="o">-</span> <span class="n">overlap</span> <span class="c1">#advance window start</span>
            <span class="n">lastpt</span> <span class="o">=</span> <span class="n">startpt</span> <span class="o">+</span> <span class="n">winsize</span>
            <span class="n">outdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getmean</span><span class="p">)</span> <span class="c1">#construct output arrays</span>
            <span class="n">outtime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gettime</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outdata</span><span class="p">,</span> <span class="n">outtime</span></div>

<div class="viewcode-block" id="medAbsDev"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.medAbsDev.html#spacepy.toolbox.medAbsDev">[docs]</a><span class="k">def</span> <span class="nf">medAbsDev</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate median absolute deviation of a given input series</span>

<span class="sd">    Median absolute deviation (MAD) is a robust and resistant measure of</span>
<span class="sd">    the spread of a sample (same purpose as standard deviation). The</span>
<span class="sd">    MAD is preferred to the inter-quartile range as the inter-quartile</span>
<span class="sd">    range only shows 50% of the data whereas the MAD uses all data but</span>
<span class="sd">    remains robust and resistant. See e.g. Wilks, Statistical methods</span>
<span class="sd">    for the Atmospheric Sciences, 1995, Ch. 3. For additional details on </span>
<span class="sd">    the scaling, see Rousseeuw and Croux, J. Amer. Stat. Assoc., 88 (424),</span>
<span class="sd">    pp. 1273-1283, 1993.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    series : array_like</span>
<span class="sd">        the input data series</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ================</span>
<span class="sd">    scale : bool</span>
<span class="sd">        if True (default: False), scale to standard deviation of a normal distribution</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : float</span>
<span class="sd">        the median absolute deviation</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    Find the median absolute deviation of a data set. Here we use the log-</span>
<span class="sd">    normal distribution fitted to the population of sawtooth intervals, see</span>
<span class="sd">    Morley and Henderson, Comment, Geophysical Research Letters, 2009.</span>

<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; numpy.random.seed(8675301)</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.random.lognormal(mean=5.1458, sigma=0.302313, size=30)</span>
<span class="sd">    &gt;&gt;&gt; print data</span>
<span class="sd">    array([ 181.28078923,  131.18152745, ... , 141.15455416, 160.88972791])</span>
<span class="sd">    &gt;&gt;&gt; tb.medAbsDev(data)</span>
<span class="sd">    28.346646721370192</span>

<span class="sd">    **note** This implementation is robust to presence of NaNs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#ensure input is numpy array (and make 1-D)</span>
    <span class="n">series</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="c1">#mask for NaNs</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">series</span><span class="p">),</span><span class="n">series</span><span class="p">)</span>
    <span class="c1">#get median absolute deviation of unmasked elements</span>
    <span class="n">perc50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">compressed</span><span class="p">())</span>
    <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span><span class="o">-</span><span class="n">perc50</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">mad</span> <span class="o">*=</span> <span class="mf">1.4826</span> <span class="c1">#scale so that MAD is same as SD for normal distr.</span>
    <span class="k">return</span> <span class="n">mad</span></div>

<div class="viewcode-block" id="binHisto"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.binHisto.html#spacepy.toolbox.binHisto">[docs]</a><span class="k">def</span> <span class="nf">binHisto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates bin width and number of bins for histogram using Freedman-Diaconis rule, if rule fails, defaults to square-root method</span>

<span class="sd">    The Freedman-Diaconis method is detailed in:</span>
<span class="sd">        Freedman, D., and P. Diaconis (1981), On the histogram as a density estimator: L2 theory, Z. Wahrscheinlichkeitstheor. Verw. Geb., 57, 453476</span>

<span class="sd">    and is also described by:</span>
<span class="sd">        Wilks, D. S. (2006), Statistical Methods in the Atmospheric Sciences, 2nd ed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    data : array_like</span>
<span class="sd">        list/array of data values</span>
<span class="sd">    verbose : boolean (optional)</span>
<span class="sd">        print out some more information</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : tuple</span>
<span class="sd">        calculated width of bins using F-D rule, number of bins (nearest integer) to use for histogram</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import numpy, spacepy</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; numpy.random.seed(8675301)</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.random.randn(1000)</span>
<span class="sd">    &gt;&gt;&gt; binw, nbins = spacepy.toolbox.binHisto(data)</span>
<span class="sd">    &gt;&gt;&gt; print(nbins)</span>
<span class="sd">    19</span>
<span class="sd">    &gt;&gt;&gt; p = plt.hist(data, bins=nbins, histtype=&#39;step&#39;, density=True)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    matplotlib.pyplot.hist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span> <span class="c1">#get confidence interval</span>
    <span class="n">ql</span><span class="p">,</span> <span class="n">qu</span> <span class="o">=</span> <span class="n">pul</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">qu</span><span class="o">-</span><span class="n">ql</span>
    <span class="n">binw</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">iqr</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">binw</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">/</span><span class="n">binw</span><span class="p">))</span>
    <span class="c1"># if nbins is 0, NaN or inf don&#39;t use the F-D rule just use sqrt(num) rule</span>
    <span class="k">if</span> <span class="n">binw</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nbins</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nbins</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))))</span>
        <span class="n">binw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="n">nbins</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Used sqrt rule&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Used F-D rule&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">binw</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span></div>

<div class="viewcode-block" id="bootHisto"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.bootHisto.html#spacepy.toolbox.bootHisto">[docs]</a><span class="k">def</span> <span class="nf">bootHisto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inter</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bootstrap confidence intervals for a histogram.</span>

<span class="sd">    All other keyword arguments are passed to :func:`numpy.histogram`</span>
<span class="sd">    or :func:`matplotlib.pyplot.bar`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>

<span class="sd">    data : array_like</span>
<span class="sd">        list/array of data values</span>
<span class="sd">    inter : float (optional; default 90)</span>
<span class="sd">        percentage confidence interval to return. Default 90% (i.e.</span>
<span class="sd">        lower CI will be 5% and upper will be 95%)</span>
<span class="sd">    n : int (optional; default 1000)</span>
<span class="sd">        number of bootstrap iterations</span>
<span class="sd">    seed : int (optional)</span>
<span class="sd">        Optional seed for the random number generator. If not</span>
<span class="sd">        specified; numpy generator will not be reseeded.</span>
<span class="sd">    plot : bool (optional)</span>
<span class="sd">        Plot the result. Plots if True or ``target``, ``figsize``,</span>
<span class="sd">        or ``loc`` specified.</span>
<span class="sd">    target : (optional)</span>
<span class="sd">        Target on which to plot the figure (figure or axes). See</span>
<span class="sd">        :func:`spacepy.plot.utils.set_target` for details.</span>
<span class="sd">    figsize : tuple (optional)</span>
<span class="sd">        Passed to :func:`spacepy.plot.utils.set_target`.</span>
<span class="sd">    loc : int (optional)</span>
<span class="sd">        Passed to :func:`spacepy.plot.utils.set_target`.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : tuple</span>
<span class="sd">      tuple of bin_edges, low, high, sample[, bars]. Where</span>
<span class="sd">      ``bin_edges`` is the edges of the bins used; ``low`` is the</span>
<span class="sd">      histogram with the value for each bin from the bottom of that</span>
<span class="sd">      bin&#39;s confidence interval; ``high`` similarly for the top;</span>
<span class="sd">      ``sample`` is the histogram of the input sample without</span>
<span class="sd">      resampling. If plotting, also returned is ``bars``, the</span>
<span class="sd">      container object returned from matplotlib.</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    The confidence intervals are calculated for each bin individually and thus</span>
<span class="sd">    the resulting low/high histograms may not have actually occurred in the</span>
<span class="sd">    calculation from the surrogates. If using a probability density histogram,</span>
<span class="sd">    this can have &quot;interesting&quot; implications for interpretation.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; import numpy.random</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.toolbox</span>
<span class="sd">        &gt;&gt;&gt; numpy.random.seed(0)</span>
<span class="sd">        &gt;&gt;&gt; data = numpy.random.randn(1000)</span>
<span class="sd">        &gt;&gt;&gt; bin_edges, low, high, sample, bars = spacepy.toolbox.bootHisto(</span>
<span class="sd">        ...     data, plot=True)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    binHisto</span>
<span class="sd">    plot.utils.set_target</span>
<span class="sd">    numpy.histogram</span>
<span class="sd">    matplotlib.pyplot.hist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.poppy</span>
    <span class="n">histogram_allowed_kwargs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;normed&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="s1">&#39;density&#39;</span><span class="p">)</span>
    <span class="n">histogram_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">histogram_allowed_kwargs</span><span class="p">}</span>
    <span class="n">bar_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">histogram_allowed_kwargs</span><span class="p">}</span>
    <span class="n">sample</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">histogram_kwargs</span><span class="p">)</span>
    <span class="n">histogram_kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_edges</span>
    <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">poppy</span><span class="o">.</span><span class="n">boots_ci</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">histogram_kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">nretvals</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">loc</span><span class="p">)]):</span>
        <span class="k">return</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">,</span> <span class="n">sample</span>
    <span class="kn">import</span> <span class="nn">spacepy.plot.utils</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_target</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">111</span> <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">loc</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;ecolor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bar_kwargs</span><span class="p">:</span>
        <span class="n">bar_kwargs</span><span class="p">[</span><span class="s1">&#39;ecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
        <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span>
        <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">sample</span> <span class="o">-</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span> <span class="o">-</span> <span class="n">sample</span><span class="p">)),</span>
        <span class="o">**</span><span class="n">bar_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_high</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">bars</span></div>


<div class="viewcode-block" id="logspace"><a class="viewcode-back" href="../../doc_standard.html#spacepy.toolbox.logspace">[docs]</a><span class="k">def</span> <span class="nf">logspace</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns log-spaced bins. Same as numpy.logspace except the min and max are the min and max</span>
<span class="sd">    not log10(min) and log10(max)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    min : float</span>
<span class="sd">        minimum value</span>
<span class="sd">    max : float</span>
<span class="sd">        maximum value</span>
<span class="sd">    num : integer</span>
<span class="sd">        number of log spaced bins</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ================</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        additional keywords passed into matplotlib.dates.num2date</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : array</span>
<span class="sd">        log-spaced bins from min to max in a numpy array</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    This function works on both numbers and datetime objects</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.logspace(1, 100, 5)</span>
<span class="sd">    array([   1.        ,    3.16227766,   10.        ,   31.6227766 ,  100.        ])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    geomspace</span>
<span class="sd">    linspace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="kn">import</span> <span class="n">date2num</span><span class="p">,</span> <span class="n">num2date</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">date2num</span><span class="p">(</span><span class="nb">min</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">date2num</span><span class="p">(</span><span class="nb">max</span><span class="p">)),</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">no_tzinfo</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="linspace"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.linspace.html#spacepy.toolbox.linspace">[docs]</a><span class="k">def</span> <span class="nf">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns linear-spaced bins. Same as numpy.linspace except works with datetime</span>
<span class="sd">    and is faster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    min : float, datetime</span>
<span class="sd">        minimum value</span>
<span class="sd">    max : float, datetime</span>
<span class="sd">        maximum value</span>
<span class="sd">    num : integer</span>
<span class="sd">        number of linear spaced bins</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ================</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        additional keywords passed into matplotlib.dates.num2date</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : array</span>
<span class="sd">        linear-spaced bins from min to max in a numpy array</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    This function works on both numbers and datetime objects</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.linspace(1, 10, 4)</span>
<span class="sd">    array([  1.,   4.,   7.,  10.])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    geomspace</span>
<span class="sd">    logspace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">min</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="nb">min</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">max</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="nb">max</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="kn">import</span> <span class="n">date2num</span><span class="p">,</span> <span class="n">num2date</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">num2date</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">date2num</span><span class="p">(</span><span class="nb">min</span><span class="p">),</span> <span class="n">date2num</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">no_tzinfo</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="geomspace"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.geomspace.html#spacepy.toolbox.geomspace">[docs]</a><span class="k">def</span> <span class="nf">geomspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns geometrically spaced numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    start : float</span>
<span class="sd">        The starting value of the sequence.</span>
<span class="sd">    ratio : float (optional)</span>
<span class="sd">        The ratio between subsequent points</span>
<span class="sd">    stop : float (optional)</span>
<span class="sd">        End value, if this is selected `num` is overridden</span>
<span class="sd">    num : int (optional)</span>
<span class="sd">        Number of samples to generate. Default is 50.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    seq : array</span>
<span class="sd">        geometrically spaced sequence</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    linspace</span>
<span class="sd">    logspace</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    To get a geometric progression between 0.01 and 3 in 10 steps</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.geomspace(0.01, stop=3, num=10)</span>
<span class="sd">    [0.01,</span>
<span class="sd">     0.018846716378431192,</span>
<span class="sd">     0.035519871824902655,</span>
<span class="sd">     0.066943295008216955,</span>
<span class="sd">     0.12616612944575134,</span>
<span class="sd">     0.23778172582285118,</span>
<span class="sd">     0.44814047465571644,</span>
<span class="sd">     0.84459764235318191,</span>
<span class="sd">     1.5917892219322083,</span>
<span class="sd">     2.9999999999999996]</span>

<span class="sd">    To get a geometric progression with a specified ratio, say 10</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.geomspace(0.01, ratio=10, num=5)</span>
<span class="sd">    [0.01, 0.10000000000000001, 1.0, 10.0, 100.0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ratio</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span><span class="o">/</span><span class="n">start</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">num</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">stop</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ratio</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">seq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="arraybin"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.arraybin.html#spacepy.toolbox.arraybin">[docs]</a><span class="k">def</span> <span class="nf">arraybin</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">bins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a sequence into subsequences based on value.</span>

<span class="sd">    Given a sequence of values and a sequence of values representing the</span>
<span class="sd">    division between bins, return the indices grouped by bin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    array : array_like</span>
<span class="sd">        the input sequence to slice, must be sorted in ascending order</span>
<span class="sd">    bins : array_like</span>
<span class="sd">        dividing lines between bins. Number of bins is len(bins)+1,</span>
<span class="sd">            value that exactly equal a dividing value are assigned</span>
<span class="sd">            to the higher bin</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        indices for each bin (list of lists)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.arraybin(range(10), [4.2])</span>
<span class="sd">    [[0, 1, 2, 3, 4], [5, 6, 7, 8, 9]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bin_it</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span> <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">bin_it</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">)</span>
            <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">splits</span><span class="p">,</span> <span class="n">splits</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)])]</span></div>

<div class="viewcode-block" id="mlt2rad"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.mlt2rad.html#spacepy.toolbox.mlt2rad">[docs]</a><span class="k">def</span> <span class="nf">mlt2rad</span><span class="p">(</span><span class="n">mlt</span><span class="p">,</span> <span class="n">midnight</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert mlt values to radians for polar plotting</span>
<span class="sd">    transform mlt angles to radians from -pi to pi</span>
<span class="sd">    referenced from noon by default</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    mlt : numpy array</span>
<span class="sd">        array of mlt values</span>
<span class="sd">    midnight : boolean (optional)</span>
<span class="sd">        reference to midnight instead of noon</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : numpy array</span>
<span class="sd">        array of radians</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; from numpy import array</span>
<span class="sd">    &gt;&gt;&gt; mlt2rad(array([3,6,9,14,22]))</span>
<span class="sd">    array([-2.35619449, -1.57079633, -0.78539816,  0.52359878,  2.61799388])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    rad2mlt</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">midnight</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mlt_arr</span> <span class="o">=</span>  <span class="p">[</span><span class="n">val</span> <span class="o">+</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mlt</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">mlt_arr</span> <span class="o">=</span> <span class="n">mlt</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mlt_arr</span> <span class="o">=</span> <span class="n">mlt</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rad_arr</span> <span class="o">=</span> <span class="p">[(</span><span class="n">val</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">12.</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mlt_arr</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">rad_arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlt_arr</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">12.</span>
    <span class="k">return</span> <span class="n">rad_arr</span></div>

<div class="viewcode-block" id="rad2mlt"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.rad2mlt.html#spacepy.toolbox.rad2mlt">[docs]</a><span class="k">def</span> <span class="nf">rad2mlt</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">midnight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert radians values to mlt</span>
<span class="sd">    transform radians from -pi to pi to mlt</span>
<span class="sd">    referenced from noon by default</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    rad : numpy array</span>
<span class="sd">        array of radian values</span>
<span class="sd">    midnight : boolean (optional)</span>
<span class="sd">        reference to midnight instead of noon</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : numpy array</span>
<span class="sd">        array of mlt values</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; rad2mlt(array([0,pi, pi/2.]))</span>
<span class="sd">    array([ 12.,  24.,  18.])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    mlt2rad</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">midnight</span><span class="p">:</span>
        <span class="n">rad_arr</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rad_arr</span> <span class="o">=</span> <span class="n">rad</span>
    <span class="n">mlt_arr</span><span class="o">=</span><span class="n">rad_arr</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="k">return</span> <span class="n">mlt_arr</span></div>

<div class="viewcode-block" id="pmm"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.pmm.html#spacepy.toolbox.pmm">[docs]</a><span class="k">def</span> <span class="nf">pmm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print min and max of input arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    a : array-like</span>
<span class="sd">        arbitrary number of input arrays (or lists)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        list of min, max for each array</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; from numpy import arange</span>
<span class="sd">    &gt;&gt;&gt; tb.pmm(arange(10), arange(10)+3)</span>
<span class="sd">    [[0, 9], [3, 12]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pmm: Unable to exclude non-finite values, results may be incorrect&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">ind</span><span class="p">])])</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">a_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a_tmp</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">]:</span>
                <span class="n">a_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">a_tmp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a_tmp</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a_tmp</span><span class="p">[</span><span class="n">ind</span><span class="p">])])</span>
    <span class="k">return</span> <span class="n">ans</span></div>

<div class="viewcode-block" id="getNamedPath"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.getNamedPath.html#spacepy.toolbox.getNamedPath">[docs]</a><span class="k">def</span> <span class="nf">getNamedPath</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the full path of a parent directory with name as the leaf</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    name : string</span>
<span class="sd">        the name of the parent directory to locate</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    Run from a directory</span>
<span class="sd">    /mnt/projects/dream/bin/Ephem</span>
<span class="sd">    with &#39;dream&#39; as the name, this function</span>
<span class="sd">    would return &#39;/mnt/projects/dream&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">findNamed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">findNamed</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">return</span> <span class="n">findNamed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span></div>

<div class="viewcode-block" id="query_yes_no"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.query_yes_no.html#spacepy.toolbox.query_yes_no">[docs]</a><span class="k">def</span> <span class="nf">query_yes_no</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask a yes/no question via raw_input() and return their answer.</span>

<span class="sd">    &quot;question&quot; is a string that is presented to the user.</span>
<span class="sd">    &quot;default&quot; is the presumed answer if the user just hits &lt;Enter&gt;.</span>
<span class="sd">    It must be &quot;yes&quot; (the default), &quot;no&quot; or None (meaning</span>
<span class="sd">    an answer is required of the user).</span>

<span class="sd">    The &quot;answer&quot; return value is one of &quot;yes&quot; or &quot;no&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    question : string</span>
<span class="sd">        the question to ask</span>
<span class="sd">    default : string (optional)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : string</span>
<span class="sd">        answer (&#39;yes&#39; or &#39;no&#39;)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.query_yes_no(&#39;Ready to go?&#39;)</span>
<span class="sd">    Ready to go? [Y/n] y</span>
<span class="sd">    &#39;yes&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;yes&quot;</span><span class="p">:</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span>   <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span>  <span class="s2">&quot;ye&quot;</span><span class="p">:</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span>
             <span class="s2">&quot;no&quot;</span><span class="p">:</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>     <span class="s2">&quot;n&quot;</span><span class="p">:</span><span class="s2">&quot;no&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">default</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot; [y/n] &quot;</span>
    <span class="k">elif</span> <span class="n">default</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot; [Y/n] &quot;</span>
    <span class="k">elif</span> <span class="n">default</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot; [y/N] &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid default answer: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">question</span> <span class="o">+</span> <span class="n">prompt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Please respond with &#39;yes&#39; or &#39;no&#39; &quot;</span>\
                             <span class="s2">&quot;(or &#39;y&#39; or &#39;n&#39;).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="interpol"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.interpol.html#spacepy.toolbox.interpol">[docs]</a><span class="k">def</span> <span class="nf">interpol</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1-D linear interpolation with interpolation of hours/longitude</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    newx : array_like</span>
<span class="sd">        x values where we want the interpolated values</span>
<span class="sd">    x : array_like</span>
<span class="sd">        x values of the original data (must be monotonically increasing or wrapping)</span>
<span class="sd">    y : array_like</span>
<span class="sd">        y values of the original data</span>
<span class="sd">    wrap : string, optional</span>
<span class="sd">        for continuous x data that wraps in y at &#39;hours&#39; (24), &#39;longitude&#39; (360),</span>
<span class="sd">        or arbitrary value (int, float)</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        additional keywords, currently accepts baddata that sets baddata for</span>
<span class="sd">        masked arrays</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : numpy.masked_array</span>
<span class="sd">        interpolated data values for new abscissa values</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    For a simple interpolation</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; x = numpy.arange(10)</span>
<span class="sd">    &gt;&gt;&gt; y = numpy.arange(10)</span>
<span class="sd">    &gt;&gt;&gt; tb.interpol(numpy.arange(5)+0.5, x, y)</span>
<span class="sd">    array([ 0.5,  1.5,  2.5,  3.5,  4.5])</span>

<span class="sd">    To use the wrap functionality, without the wrap keyword you get the wrong answer</span>

<span class="sd">    &gt;&gt;&gt; y = range(24)*2</span>
<span class="sd">    &gt;&gt;&gt; x = range(len(y))</span>
<span class="sd">    &gt;&gt;&gt; tb.interpol([1.5, 10.5, 23.5], x, y, wrap=&#39;hour&#39;).compressed() # compress removed the masked array</span>
<span class="sd">    array([  1.5,  10.5,  23.5])</span>
<span class="sd">    &gt;&gt;&gt; tb.interpol([1.5, 10.5, 23.5], x, y)</span>
<span class="sd">    array([  1.5,  10.5,  11.5])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;baddata&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;baddata&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mask</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="s1">&#39;baddata&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">!=</span><span class="n">tst</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">!=</span><span class="n">tst</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">newx</span><span class="p">)</span><span class="o">!=</span><span class="n">tst</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">newx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">newx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrap_interp</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">,</span> <span class="n">sect</span><span class="p">):</span>
        <span class="n">dpsect</span><span class="o">=</span><span class="mi">360</span><span class="o">/</span><span class="n">sect</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">dpsect</span><span class="p">))</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">dpsect</span><span class="p">))</span>
        <span class="n">new_yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">yc</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new_ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">new_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">newx</span><span class="p">)))</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">new_ys</span><span class="o">/</span><span class="n">new_yc</span><span class="p">))</span><span class="o">/</span><span class="n">dpsect</span>
        <span class="c1">#1st quadrant is O.K</span>
        <span class="c1">#2nd quadrant</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_yc</span><span class="p">))</span> <span class="k">if</span> <span class="n">new_yc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">new_ys</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sect</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1">#print(&#39;Sector 2 inds: %s&#39; % idx)</span>
        <span class="c1">#3rd quadrant</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_yc</span><span class="p">))</span> <span class="k">if</span> <span class="n">new_yc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">new_ys</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sect</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1">#print(&#39;Sector 3 inds: %s&#39; % idx)</span>
        <span class="c1">#4th quadrant</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_yc</span><span class="p">))</span> <span class="k">if</span> <span class="n">new_yc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">new_ys</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sect</span> <span class="o">+</span> <span class="n">newy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1">#print(&#39;Sector 4 inds: %s&#39; % idx)</span>
        <span class="n">new_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">make_mask</span><span class="p">(</span><span class="n">new_bad</span><span class="p">)</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">newy</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">new_bad</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newy</span>

    <span class="k">if</span> <span class="n">wrap</span><span class="o">==</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">wrap_interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="mi">24</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">wrap</span><span class="o">==</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">wrap_interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="mi">360</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrap</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">):</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">wrap_interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">wrap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newy</span></div>

<span class="c1"># -----------------------------------------------</span>

<div class="viewcode-block" id="quaternionNormalize"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.quaternionNormalize.html#spacepy.toolbox.quaternionNormalize">[docs]</a><span class="nd">@spacepy</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
    <span class="s1">&#39;0.2.2&#39;</span><span class="p">,</span> <span class="s1">&#39;moved to spacepy.coordinates&#39;</span><span class="p">,</span>
    <span class="s1">&#39;use :func:`spacepy.coordinates.quaternionNormalize`&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quaternionNormalize</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an input quaternion, return the unit quaternion.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.coordinates</span>
    <span class="k">return</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">quaternionNormalize</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="n">scalarPos</span><span class="p">)</span></div>

<div class="viewcode-block" id="quaternionRotateVector"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.quaternionRotateVector.html#spacepy.toolbox.quaternionRotateVector">[docs]</a><span class="nd">@spacepy</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
    <span class="s1">&#39;0.2.2&#39;</span><span class="p">,</span> <span class="s1">&#39;moved to spacepy.coordinates&#39;</span><span class="p">,</span>
    <span class="s1">&#39;use :func:`spacepy.coordinates.quaternionRotateVector`&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quaternionRotateVector</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">Vin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given quaternion and vector, return vector rotated by quaternion.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.coordinates</span>
    <span class="k">return</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">quaternionRotateVector</span><span class="p">(</span>
        <span class="n">Qin</span><span class="p">,</span> <span class="n">Vin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="n">scalarPos</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span></div>

<div class="viewcode-block" id="quaternionMultiply"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.quaternionMultiply.html#spacepy.toolbox.quaternionMultiply">[docs]</a><span class="nd">@spacepy</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
    <span class="s1">&#39;0.2.2&#39;</span><span class="p">,</span> <span class="s1">&#39;moved to spacepy.coordinates&#39;</span><span class="p">,</span>
    <span class="s1">&#39;use :func:`spacepy.coordinates.quaternionMultiply`&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quaternionMultiply</span><span class="p">(</span><span class="n">Qin1</span><span class="p">,</span> <span class="n">Qin2</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given quaternions, return the product.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.coordinates</span>
    <span class="k">return</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">quaternionMultiply</span><span class="p">(</span>
        <span class="n">Qin1</span><span class="p">,</span> <span class="n">Qin2</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="n">scalarPos</span><span class="p">)</span></div>

<div class="viewcode-block" id="quaternionConjugate"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.quaternionConjugate.html#spacepy.toolbox.quaternionConjugate">[docs]</a><span class="nd">@spacepy</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
    <span class="s1">&#39;0.2.2&#39;</span><span class="p">,</span> <span class="s1">&#39;moved to spacepy.coordinates&#39;</span><span class="p">,</span>
    <span class="s1">&#39;use :func:`spacepy.coordinates.quaternionConjugate`&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quaternionConjugate</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an input quaternion, return the conjugated.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">spacepy.coordinates</span>
    <span class="k">return</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">quaternionConjugate</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">scalarPos</span><span class="o">=</span><span class="n">scalarPos</span><span class="p">)</span></div>

<span class="c1"># -----------------------------------------------</span>

<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.normalize.html#spacepy.toolbox.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an input vector normalize the vector to a given range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    vec : array_like</span>
<span class="sd">        input vector to normalize</span>
<span class="sd">    low : float</span>
<span class="sd">        minimum value to scale to, default 0.0</span>
<span class="sd">    high : float</span>
<span class="sd">        maximum value to scale to, default 1.0</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : array_like</span>
<span class="sd">        normalized vector</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.normalize([1,2,3])</span>
<span class="sd">    [0.0, 0.5, 1.0]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vec</span><span class="p">)),</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span></div>


<div class="viewcode-block" id="intsolve"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.intsolve.html#spacepy.toolbox.intsolve">[docs]</a><span class="k">def</span> <span class="nf">intsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the function input such that definite integral is desired value.</span>

<span class="sd">    Given a function, integrate from an (optional) start point until the</span>
<span class="sd">    integral reached a desired value, and return the end point of the</span>
<span class="sd">    integration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    func : callable</span>
<span class="sd">        function to integrate, must take single parameter</span>
<span class="sd">    value : float</span>
<span class="sd">        desired final value of the integral</span>
<span class="sd">    start : float (optional)</span>
<span class="sd">        value at which to start integration, default -Infinity</span>
<span class="sd">    stop : float (optional)</span>
<span class="sd">        value at which to stop integration, default +Infinity</span>
<span class="sd">    maxit : integer</span>
<span class="sd">        maximum number of iterations</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : float</span>
<span class="sd">        x such that the integral of L{func} from L{start} to x is L{value}</span>

<span class="sd">    **Note:** Assumes func is everywhere positive, otherwise solution may</span>
<span class="sd">           be multi-valued.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">inf</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
    <span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">inf</span>
    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">start</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">stop</span>
    <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">maxit</span><span class="p">:</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">upper_bound</span> <span class="o">==</span> <span class="n">inf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lower_bound</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">test_bound</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">lower_bound</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">test_bound</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_bound</span> <span class="o">=</span> <span class="n">lower_bound</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lower_bound</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">upper_bound</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">test_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test_bound</span> <span class="o">=</span> <span class="n">upper_bound</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="o">+</span> <span class="n">upper_bound</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">(</span><span class="n">test_value</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">test_bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">test_value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">test_value</span><span class="p">:</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">test_bound</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">test_bound</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">test_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Difference between desired value and actual is &#39;</span> <span class="o">+</span>
             <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">test_value</span><span class="p">))</span> <span class="o">+</span>
             <span class="s1">&#39;, greater than integral error &#39;</span> <span class="o">+</span>
             <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_bound</span></div>

<div class="viewcode-block" id="dist_to_list"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.dist_to_list.html#spacepy.toolbox.dist_to_list">[docs]</a><span class="k">def</span> <span class="nf">dist_to_list</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a probability distribution function to a list of values</span>

<span class="sd">    This is a deterministic way to produce a known-length list of values</span>
<span class="sd">    matching a certain probability distribution. It is likely to be a closer</span>
<span class="sd">    match to the distribution function than a random sampling from the</span>
<span class="sd">    distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    func : callable</span>
<span class="sd">        function to call for each possible value, returning</span>
<span class="sd">            probability density at that value (does not need to be</span>
<span class="sd">            normalized.)</span>
<span class="sd">    length : int</span>
<span class="sd">        number of elements to return</span>
<span class="sd">    min : float</span>
<span class="sd">        minimum value to possibly include</span>
<span class="sd">    max : float</span>
<span class="sd">        maximum value to possibly include</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib</span>
<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; gauss = lambda x: math.exp(-(x ** 2) / (2 * 5 ** 2)) / (5 * math.sqrt(2 * math.pi))</span>
<span class="sd">    &gt;&gt;&gt; vals = tb.dist_to_list(gauss, 1000, -numpy.inf, numpy.inf)</span>
<span class="sd">    &gt;&gt;&gt; print vals[0]</span>
<span class="sd">    -16.45263...</span>
<span class="sd">    &gt;&gt;&gt; p1 = matplotlib.pyplot.hist(vals, bins=[i - 10 for i in range(21)], facecolor=&#39;green&#39;)</span>
<span class="sd">    &gt;&gt;&gt; matplotlib.pyplot.hold(True)</span>
<span class="sd">    &gt;&gt;&gt; x = [i / 100.0 - 10.0 for i in range(2001)]</span>
<span class="sd">    &gt;&gt;&gt; p2 = matplotlib.pyplot.plot(x, [gauss(i) * 1000 for i in x], &#39;red&#39;)</span>
<span class="sd">    &gt;&gt;&gt; matplotlib.pyplot.draw()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">inf</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
    <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="n">inf</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="o">/</span> <span class="n">length</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">intsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span></div>

<div class="viewcode-block" id="bin_center_to_edges"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.bin_center_to_edges.html#spacepy.toolbox.bin_center_to_edges">[docs]</a><span class="k">def</span> <span class="nf">bin_center_to_edges</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of bin centers to their edges</span>

<span class="sd">    Given a list of center values for a set of bins, finds the start and</span>
<span class="sd">    end value for each bin. (start of bin n+1 is assumed to be end of bin n).</span>
<span class="sd">    Useful for e.g. matplotlib.pyplot.pcolor.</span>

<span class="sd">    Edge between bins n and n+1 is arithmetic mean of the center of n</span>
<span class="sd">    and n+1; edge below bin 0 and above last bin are established to make</span>
<span class="sd">    these bins symmetric about their center value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    centers : list</span>
<span class="sd">        list of center values for bins</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        list of edges for bins</span>

<span class="sd">    **note:** returned list will be one element longer than centers</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.bin_center_to_edges([1,2,3])</span>
<span class="sd">    [0.5, 1.5, 2.5, 3.5]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">bin_edges_to_center</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">edges</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">edges</span></div>

<div class="viewcode-block" id="bin_edges_to_center"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.bin_edges_to_center.html#spacepy.toolbox.bin_edges_to_center">[docs]</a><span class="k">def</span> <span class="nf">bin_edges_to_center</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of bin edges to their centers</span>

<span class="sd">    Given a list of edge values for a set of bins, finds the center of each bin.</span>
<span class="sd">    (start of bin n+1 is assumed to be end of bin n).</span>

<span class="sd">    Center of bin n is arithmetic mean of the edges of the adjacent bins.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    edges : list</span>
<span class="sd">        list of edge values for bins</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">        array of centers for bins</span>

<span class="sd">    **note:** returned array will be one element shorter than edges</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.bin_center_to_edges([1,2,3])</span>
<span class="sd">    [0.5, 1.5, 2.5, 3.5]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="o">//</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="o">/</span><span class="mi">2</span></div>

<div class="viewcode-block" id="thread_job"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.thread_job.html#spacepy.toolbox.thread_job">[docs]</a><span class="k">def</span> <span class="nf">thread_job</span><span class="p">(</span><span class="n">job_size</span><span class="p">,</span> <span class="n">thread_count</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a job into subjobs and run a thread for each</span>

<span class="sd">    Each thread spawned will call L{target} to handle a slice of the job.</span>

<span class="sd">    This is only useful if a job:</span>
<span class="sd">      1. Can be split into completely independent subjobs</span>
<span class="sd">      2. Relies heavily on code that does not use the Python GIL, e.g.</span>
<span class="sd">         numpy or ctypes code</span>
<span class="sd">      3. Does not return a value. Either pass in a list/array to hold the</span>
<span class="sd">         result, or see L{thread_map}</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    squaring 100 million numbers:</span>

<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; numpy.random.seed(8675301)</span>
<span class="sd">    &gt;&gt;&gt; a = numpy.random.randint(0, 100, [100000000])</span>
<span class="sd">    &gt;&gt;&gt; b = numpy.empty([100000000], dtype=&#39;int64&#39;)</span>
<span class="sd">    &gt;&gt;&gt; def targ(in_array, out_array, start, count): \</span>
<span class="sd">             out_array[start:start + count] = in_array[start:start + count] ** 2</span>
<span class="sd">    &gt;&gt;&gt; tb.thread_job(len(a), 0, targ, a, b)</span>
<span class="sd">    &gt;&gt;&gt; print(b[0:5])</span>
<span class="sd">    [2704 7225  196 1521   36]</span>

<span class="sd">    This example:</span>
<span class="sd">      - Defines a target function, which will be called for each thread.</span>
<span class="sd">        It is usually necessary to define a simple &quot;wrapper&quot; function</span>
<span class="sd">        like this to provide the correct call signature.</span>
<span class="sd">      - The target function receives inputs C{in_array} and C{out_array},</span>
<span class="sd">        which are not touched directly by C{thread_job} but are passed</span>
<span class="sd">        through in the call. In this case, C{a} gets passed as</span>
<span class="sd">        C{in_array} and C{b} as C{out_array}</span>
<span class="sd">      - The target function also receives the start and number of elements</span>
<span class="sd">        it needs to process. For each thread where the target is called,</span>
<span class="sd">        these numbers are different.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    job_size : int</span>
<span class="sd">        Total size of the job. Often this is an array size.</span>
<span class="sd">    thread_count : int</span>
<span class="sd">        Number of threads to spawn. If =0 or None, will</span>
<span class="sd">            spawn as many threads as there are cores available on</span>
<span class="sd">            the system. (Each hyperthreading core counts as 2.)</span>
<span class="sd">            Generally this is the Right Thing to do.</span>
<span class="sd">            If NEGATIVE, will spawn abs(thread_count) threads,</span>
<span class="sd">            but will run them sequentially rather than in</span>
<span class="sd">            parallel; useful for debugging.</span>
<span class="sd">    target : callable</span>
<span class="sd">        Python callable (generally a function, may also be an</span>
<span class="sd">            imported ctypes function) to run in each thread. The</span>
<span class="sd">            *last* two positional arguments passed in will be a</span>
<span class="sd">            &quot;start&quot; and a &quot;subjob size,&quot; respectively;</span>
<span class="sd">            frequently this will be the start index and the number</span>
<span class="sd">            of elements to process in an array.</span>
<span class="sd">    args : sequence</span>
<span class="sd">        Arguments to pass to L{target}. If L{target} is an instance</span>
<span class="sd">            method, self must be explicitly passed in. start and</span>
<span class="sd">            subjob_size will be appended.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        keyword arguments to pass to L{target}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">threading</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">job_size</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">thread_count</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">thread_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">multiprocessing</span>
            <span class="n">thread_count</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1">#Do something not too stupid</span>
            <span class="n">thread_count</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">if</span> <span class="n">thread_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">thread_count</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">job_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">thread_count</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thread_count</span><span class="p">)]</span>
    <span class="n">subsize</span> <span class="o">=</span> <span class="p">[(</span><span class="n">starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">thread_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">job_size</span><span class="p">)</span> <span class="o">-</span>
               <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thread_count</span><span class="p">)]</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thread_count</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">subsize</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">seq</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">seq</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="thread_map"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.thread_map.html#spacepy.toolbox.thread_map">[docs]</a><span class="k">def</span> <span class="nf">thread_map</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">thread_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a function to every element of a list, in separate threads</span>

<span class="sd">    Interface is similar to multiprocessing.map, except it runs in threads</span>

<span class="sd">    This is made largely obsolete in python3 by from concurrent import futures </span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    find totals of several arrays</span>

<span class="sd">    &gt;&gt;&gt; import numpy</span>
<span class="sd">    &gt;&gt;&gt; from spacepy import toolbox</span>
<span class="sd">    &gt;&gt;&gt; inputs = range(100)</span>
<span class="sd">    &gt;&gt;&gt; totals = toolbox.thread_map(numpy.sum, inputs)</span>
<span class="sd">    &gt;&gt;&gt; print(totals[0], totals[50], totals[99])</span>
<span class="sd">    (0, 50, 99)</span>

<span class="sd">    &gt;&gt;&gt; # in python3</span>
<span class="sd">    &gt;&gt;&gt; from concurrent import futures</span>
<span class="sd">    &gt;&gt;&gt; with futures.ThreadPoolExecutor(max_workers=4) as executor:</span>
<span class="sd">    ...:     for ans in executor.map(numpy.sum, [0,50,99]):</span>
<span class="sd">    ...:         print ans</span>
<span class="sd">    #0</span>
<span class="sd">    #50</span>
<span class="sd">    #99</span>
<span class="sd">   </span>
<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    target : callable</span>
<span class="sd">        Python callable to run on each element of iterable.</span>
<span class="sd">            For each call, an element of iterable is appended to</span>
<span class="sd">            args and both args and kwargs are passed through.</span>
<span class="sd">            Note that this means the iterable element is always the</span>
<span class="sd">            *last* positional argument; this allows the specification</span>
<span class="sd">            of self as the first argument for method calls.</span>
<span class="sd">    iterable : iterable</span>
<span class="sd">        elements to pass to each call of L{target}</span>
<span class="sd">    args : sequence</span>
<span class="sd">        arguments to pass to target before each element of</span>
<span class="sd">            iterable</span>
<span class="sd">    thread_count : integer</span>
<span class="sd">        Number of threads to spawn; see L{thread_job}.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        keyword arguments to pass to L{target}.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : list</span>
<span class="sd">        return values of L{target} for each item from L{iterable}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jobsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="n">jobsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">array_targ</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">retvals</span><span class="p">,</span> <span class="n">arglist</span><span class="p">,</span> <span class="n">kwarglist</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">retvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arglist</span> <span class="o">+</span> <span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="n">i</span><span class="p">],)),</span> <span class="o">**</span><span class="n">kwarglist</span><span class="p">)</span>
    <span class="n">retvals</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">jobsize</span>
    <span class="n">thread_job</span><span class="p">(</span><span class="n">jobsize</span><span class="p">,</span> <span class="n">thread_count</span><span class="p">,</span> <span class="n">array_targ</span><span class="p">,</span>
               <span class="n">target</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">retvals</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retvals</span></div>

<div class="viewcode-block" id="eventTimer"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.eventTimer.html#spacepy.toolbox.eventTimer">[docs]</a><span class="k">def</span> <span class="nf">eventTimer</span><span class="p">(</span><span class="n">Event</span><span class="p">,</span> <span class="n">Time1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Times an event then prints out the time and the name of the event,</span>
<span class="sd">    nice for debugging and seeing that the code is progressing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    Event : str</span>
<span class="sd">        Name of the event, string is printed out by function</span>
<span class="sd">    Time1 : time.time</span>
<span class="sd">        the time to difference in the function</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    Time2 : time.time</span>
<span class="sd">        the new time for the next call to EventTimer</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import time</span>
<span class="sd">    &gt;&gt;&gt; t1 = time.time()</span>
<span class="sd">    &gt;&gt;&gt; t1 = tb.eventTimer(&#39;Test event finished&#39;, t1)</span>
<span class="sd">    (&#39;4.40&#39;, &#39;Test event finished&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%4.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Time2</span> <span class="o">-</span> <span class="n">Time1</span><span class="p">),</span> <span class="n">Event</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Time2</span></div>


<div class="viewcode-block" id="isview"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.isview.html#spacepy.toolbox.isview">[docs]</a><span class="k">def</span> <span class="nf">isview</span><span class="p">(</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns if an object is a view of another object.  More precisely if one array argument is specified</span>
<span class="sd">    True is returned is the arrays owns its data.  If two arrays arguments are specified a tuple is returned</span>
<span class="sd">    of if the first array owns its data and the the second if they point at the same memory location</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    array1 : numpy.ndarray</span>
<span class="sd">        array to query if it owns its data</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ================</span>
<span class="sd">    array2 : object (optional)</span>
<span class="sd">        array to query if array1 is a view of this object at the specified memory location</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : bool or tuple</span>
<span class="sd">        If one array is specified bool is returned, True is the array owns its data.  If two arrays</span>
<span class="sd">        are specified a tuple where the second element is a bool of if the array point at the same</span>
<span class="sd">        memory location</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    import numpy</span>
<span class="sd">    import spacepy.toolbox as tb</span>
<span class="sd">    a = numpy.arange(100)</span>
<span class="sd">    b = a[0:10]</span>
<span class="sd">    tb.isview(a)</span>
<span class="sd">    # False</span>
<span class="sd">    tb.isview(b)</span>
<span class="sd">    # True</span>
<span class="sd">    tb.isview(b, a)</span>
<span class="sd">    # (True, True)</span>
<span class="sd">    tb.isview(b, b)</span>
<span class="sd">    # (True, True)  # the conditions are met and numpy cannot tell this</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># deal with the one input case first</span>
    <span class="k">if</span> <span class="n">array2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">array1</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># if it is not an array then it is not a view</span>
    <span class="c1"># there are two arrays input</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">array1</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">array1</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">array2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># if it is not an array then it is not a view</span></div>

<div class="viewcode-block" id="interweave"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.interweave.html#spacepy.toolbox.interweave">[docs]</a><span class="k">def</span> <span class="nf">interweave</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given two array-like variables interweave them together.</span>
<span class="sd">    Discussed here: http://stackoverflow.com/questions/5347065/interweaving-two-numpy-arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    a : array-like</span>
<span class="sd">        first array</span>

<span class="sd">    b : array-like</span>
<span class="sd">        second array</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">        interweaved array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">ans</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="TimeoutError"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.TimeoutError.html#spacepy.toolbox.TimeoutError">[docs]</a><span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when a time-limited process times out&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="do_with_timeout"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.do_with_timeout.html#spacepy.toolbox.do_with_timeout">[docs]</a><span class="k">def</span> <span class="nf">do_with_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a function (or method) with a timeout.</span>

<span class="sd">    Call the function (or method) ``target``, with arguments ``args`` and</span>
<span class="sd">    keyword arguments ``kwargs``. Normally return the return value</span>
<span class="sd">    from ``target``, but if ``target`` takes more than ``timeout`` seconds</span>
<span class="sd">    to execute, raises ``TimeoutError``.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This is, at best, a blunt instrument. Exceptions from ``target`` may</span>
<span class="sd">        not propagate properly (tracebacks will be hard to follow.) The</span>
<span class="sd">        function which failed to time out may continue to execute until the</span>
<span class="sd">        interpreter exits; trapping the TimeoutError and continuing normally</span>
<span class="sd">        is not recommended.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; import time</span>
<span class="sd">    &gt;&gt;&gt; def time_me_out():</span>
<span class="sd">    ...     time.sleep(5)</span>
<span class="sd">    &gt;&gt;&gt; tb.do_with_timeout(0.5, time_me_out) #raises TimeoutError</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    timeout : float</span>
<span class="sd">        Timeout, in seconds.</span>
<span class="sd">    target : callable</span>
<span class="sd">        Python callable (generally a function, may also be an</span>
<span class="sd">            imported ctypes function) to run.</span>
<span class="sd">    args : sequence</span>
<span class="sd">        Arguments to pass to ``target``.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        keyword arguments to pass to ``target``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ======</span>
<span class="sd">    TimeoutError : If ``target`` does not return in ``timeout`` seconds.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out :</span>
<span class="sd">        return value of ``target``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">threading</span>
    <span class="k">class</span> <span class="nc">ReturningThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
            <span class="c1">#we&#39;re handling target, args, kwargs</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ReturningThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retval</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ReturningThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exception</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exception</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retval</span>
            
    <span class="n">t</span> <span class="o">=</span> <span class="n">ReturningThread</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">retval</span></div>


<div class="viewcode-block" id="timeout_check_call"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.timeout_check_call.html#spacepy.toolbox.timeout_check_call">[docs]</a><span class="k">def</span> <span class="nf">timeout_check_call</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call a subprocess with a timeout.</span>

<span class="sd">    Like :func:`subprocess.check_call`, but will terminate the process and</span>
<span class="sd">    raise :exc:`TimeoutError` if it runs for too long.</span>

<span class="sd">    This will only terminate the single process started; any child processes</span>
<span class="sd">    will remain running (this has implications for, say, spawing shells.)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; tb.timeout_check_call(1, &#39;sleep 30&#39;, shell=True) #raises TimeoutError</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    timeout : float</span>
<span class="sd">        Timeout, in seconds. Fractions are acceptable but the resolution is of</span>
<span class="sd">        order 100ms.</span>
<span class="sd">    args : sequence</span>
<span class="sd">        Arguments passed through to :class:`subprocess.Popen`</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        keyword arguments to pass to :class:`subprocess.Popen`</span>

<span class="sd">    Raises</span>
<span class="sd">    ======</span>
<span class="sd">    TimeoutError : If subprocess does not return in ``timeout`` seconds.</span>
<span class="sd">    CalledProcessError : if command has non-zero exit status</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : int</span>
<span class="sd">        0 on successful completion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">pro</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">pro</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span>
            <span class="n">pro</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pro</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pro</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;Timed out after </span><span class="si">{0:.1f}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pro</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">(</span>
            <span class="n">pro</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="poisson_fit"><a class="viewcode-back" href="../../autosummary/spacepy.toolbox.poisson_fit.html#spacepy.toolbox.poisson_fit">[docs]</a><span class="k">def</span> <span class="nf">poisson_fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Powell&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a Poisson distribution to data using the method and initial guess provided.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    data : array-like</span>
<span class="sd">        Data to fit a Poisson distribution to.</span>
<span class="sd">    initial : int or None</span>
<span class="sd">        initial guess for the fit, if None np.median(data) is used</span>
<span class="sd">    method : str</span>
<span class="sd">        method passed to scipy.optimize.minimize, default=&#39;Powell&#39;</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; from scipy.stats import poisson</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; data = poisson.rvs(20, size=1000)</span>
<span class="sd">    &gt;&gt;&gt; res = tb.poisson_fit(data)</span>
<span class="sd">    &gt;&gt;&gt; print(res.x)</span>
<span class="sd">    19.718000038769095</span>
<span class="sd">    &gt;&gt;&gt; xvals = np.arange(0, np.max(data)+5)</span>
<span class="sd">    &gt;&gt;&gt; plt.hist(data, bins=xvals, normed=True)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(xvals, poisson.pmf(xvals, np.round(res.x)))</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    result : scipy.optimize.optimize.OptimizeResult</span>
<span class="sd">        Resulting fit results from scipy.optimize, answer is result.x,</span>
<span class="sd">        user should likely round.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>

    <span class="k">def</span> <span class="nf">negLogLikelihood</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the negative log-Likelihood-Function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>

    <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">,</span>  <span class="c1"># function to minimize</span>
                   <span class="n">x0</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>  <span class="c1"># start value</span>
                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">,),</span>  <span class="c1"># additional arguments for function</span>
                   <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>  <span class="c1"># minimization method, see docs</span>
                   <span class="p">)</span>
    <span class="k">return</span> <span class="n">ans</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" >spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.toolbox</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0.
    </div>
  </body>
</html>