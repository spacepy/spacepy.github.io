
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.datamodel &#8212; SpacePy v0.2.2 Manual</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" accesskey="U">spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.datamodel</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.datamodel</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The datamodel classes constitute a data model implementation</span>
<span class="sd">meant to mirror the functionality of the data model output from pycdf, though</span>
<span class="sd">implemented slightly differently.</span>

<span class="sd">This contains the following classes:</span>
<span class="sd"> * :py:class:`dmarray` - numpy arrays that support .attrs for information about the data</span>
<span class="sd"> * :py:class:`SpaceData` - base class that extends dict, to be extended by others</span>

<span class="sd">Authors: Steve Morley and Brian Larsen</span>

<span class="sd">Additional Contributors: Charles Kiyanda and Miles Engel</span>

<span class="sd">Institution: Los Alamos National Laboratory</span>

<span class="sd">Contact: smorley@lanl.gov; balarsen@lanl.gov</span>

<span class="sd">Copyright 2010-2016 Los Alamos National Security, LLC.</span>


<span class="sd">About datamodel</span>
<span class="sd">---------------</span>

<span class="sd">The SpacePy datamodel module implements classes that are designed to make implementing a standard</span>
<span class="sd">data model easy. The concepts are very similar to those used in standards like HDF5, netCDF and</span>
<span class="sd">NASA CDF.</span>

<span class="sd">The basic container type is analogous to a folder (on a filesystem; HDF5 calls this a</span>
<span class="sd">group): Here we implement this as a dictionary-like object, a datamodel.SpaceData object, which</span>
<span class="sd">also carries attributes. These attributes can be considered to be global, i.e. relevant for the</span>
<span class="sd">entire folder. The next container type is for storing data and is based on a numpy array, this</span>
<span class="sd">class is datamodel.dmarray and also carries attributes. The dmarray class is analogous to an</span>
<span class="sd">HDF5 dataset.</span>

<span class="sd">In fact, HDF5 can be loaded directly into a SpacePy datamodel, carrying across all attributes,</span>
<span class="sd">using the function fromHDF5:</span>

<span class="sd">&gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">&gt;&gt;&gt; data = dm.fromHDF5(&#39;test.h5&#39;)</span>

<span class="sd">Functions are also available to directly load data and metadata into a SpacePy datamodel from</span>
<span class="sd">NASA CDF as well as JSON-headed ASCII. Writers also exist to output a SpacePy datamodel directly</span>
<span class="sd">to HDF5 or JSON-headed ASCII. See :py:func:`datamodel.fromCDF`, :py:func:`datamodel.readJSONheadedASCII`,</span>
<span class="sd">:py:func:`datamodel.toHDF5`, and :py:func:`datamodel.toJSONheadedASCII` for more details.</span>


<span class="sd">Examples</span>
<span class="sd">--------</span>

<span class="sd">Imagine representing some satellite data within the global attributes might be</span>
<span class="sd">the mission name and the instrument PI, the variables might be the</span>
<span class="sd">instrument counts [n-dimensional array], timestamps[1-dimensional array and an orbit number [scalar].</span>
<span class="sd">Each variable will have one attribute (for this example).</span>

<span class="sd">&gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">&gt;&gt;&gt; mydata = dm.SpaceData(attrs={&#39;MissionName&#39;: &#39;BigSat1&#39;})</span>
<span class="sd">&gt;&gt;&gt; mydata[&#39;Counts&#39;] = dm.dmarray([[42, 69, 77], [100, 200, 250]], attrs={&#39;Units&#39;: &#39;cnts/s&#39;})</span>
<span class="sd">&gt;&gt;&gt; mydata[&#39;Epoch&#39;] = dm.dmarray([1, 2, 3], attrs={&#39;units&#39;: &#39;minutes&#39;})</span>
<span class="sd">&gt;&gt;&gt; mydata[&#39;OrbitNumber&#39;] = dm.dmarray(16, attrs={&#39;StartsFrom&#39;: 1})</span>
<span class="sd">&gt;&gt;&gt; mydata.attrs[&#39;PI&#39;] &#39;Prof. Big Shot&#39;</span>

<span class="sd">This has now populated a structure that can map directly to a NASA CDF, HDF5 or JSON-headed ASCII file.</span>
<span class="sd">To visualize our datamodel, we can use tree method (which can be applied to any dictionary-like object</span>
<span class="sd">using :func:`~spacepy.toolbox.dictree`).</span>

<span class="sd">&gt;&gt;&gt; mydata.tree(attrs=True)</span>

<span class="sd">::</span>

<span class="sd">    +</span>
<span class="sd">    :|____MissionName</span>
<span class="sd">    :|____PI</span>
<span class="sd">    |____Counts</span>
<span class="sd">         :|____Units</span>
<span class="sd">    |____Epoch</span>
<span class="sd">         :|____units</span>
<span class="sd">    |____OrbitNumber</span>
<span class="sd">         :|____StartsFrom</span>


<span class="sd">Guide for NASA CDF users</span>
<span class="sd">------------------------</span>
<span class="sd">By definition, a NASA CDF only has a single &#39;layer&#39;. That is, a CDF contains a series of records</span>
<span class="sd">(stored variables of various types) and a set of attributes that are either global or local in</span>
<span class="sd">scope. Thus to use SpacePy&#39;s datamodel to capture the functionality of CDF the two basic data types</span>
<span class="sd">are all that is required, and the main constraint is that datamodel.SpaceData objects cannot be</span>
<span class="sd">nested (more on this later, if conversion from a nested datamodel to a flat datamodel is required).</span>


<span class="sd">Opening a CDF and working directly with the contents can be easily done using the PyCDF module, however,</span>
<span class="sd">if you wish to load the entire contents of a CDF directly into a datamodel (complete with attributes)</span>
<span class="sd">the following will make life easier:</span>

<span class="sd">&gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">&gt;&gt;&gt; data = dm.fromCDF(&#39;inFile.cdf&#39;)</span>


<span class="sd">A quick guide to JSON-headed ASCII</span>
<span class="sd">----------------------------------</span>
<span class="sd">In many cases it is preferred to have a human-readable ASCII file, rather than a binary file like CDF</span>
<span class="sd">or HDF5. To make it easier to carry all the same metadata that is available in HDF5 or CDF we have</span>
<span class="sd">developed an ASCII data storage format that encodes the metadata using JSON (JavaScript Object Notation).</span>
<span class="sd">This notation supports two basic datatypes: key/value collections (like a SpaceData) and ordered lists</span>
<span class="sd">(which can represent arrays). JSON is human-readable, but if large arrays are stored in metadata is quickly</span>
<span class="sd">becomes difficult to read. For this reason we use JSON to encode the metadata (usually smaller datasets)</span>
<span class="sd">and store the data in a standard flat-ASCII format. The metadata is provided as a header that describes</span>
<span class="sd">the contents of the file.</span>


<span class="sd">To use JSON for storing only metadata associated with the data to be written to an ASCII file a minimal</span>
<span class="sd">metadata standard must be implemented. We use the following attribute names: DIMENSION and START_COLUMN.</span>
<span class="sd">We also recommend using the NASA ISTP metadata standard to assign attribute names. The biggest limitation</span>
<span class="sd">of flat ASCII is that sensibly formatting datasets of more than 2-dimensions (i.e. ranks greater than 2)</span>
<span class="sd">is not possible. For this reason if you have datasets of rank 3 or greater then we recommend using HDF5.</span>
<span class="sd">If text is absolutely required then it is possible to encode multi-dimensional arrays in the JSON metadata,</span>
<span class="sd">but this is not recommended.</span>


<span class="sd">This format is best understood by illustration. The following example builds a toy SpacePy datamodel and</span>
<span class="sd">writes it to a JSON-headed ASCII file. The contents of the file are then shown.</span>

<span class="sd">&gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">&gt;&gt;&gt; data = dm.SpaceData()</span>
<span class="sd">&gt;&gt;&gt; data.attrs[&#39;Global&#39;] = &#39;A global attribute&#39;</span>
<span class="sd">&gt;&gt;&gt; data[&#39;Var1&#39;] = dm.dmarray([1,2,3,4,5], attrs={&#39;Local1&#39;: &#39;A local attribute&#39;})</span>
<span class="sd">&gt;&gt;&gt; data[&#39;Var2&#39;] = dm.dmarray([[8,9],[9,1],[3,4],[8,9],[7,8]])</span>
<span class="sd">&gt;&gt;&gt; data[&#39;MVar&#39;] = dm.dmarray([7.8], attrs={&#39;Note&#39;: &#39;Metadata&#39;})</span>
<span class="sd">&gt;&gt;&gt; dm.toJSONheadedASCII(&#39;outFile.txt&#39;, data, depend0=&#39;Var1&#39;, order=[&#39;Var1&#39;])</span>
<span class="sd">#Note that not all field names are required, those not given will be listed</span>
<span class="sd">#alphabetically after those that are specified</span>

<span class="sd">The file looks like:</span>

<span class="sd">.. code-block:: none</span>

<span class="sd">    #{</span>
<span class="sd">    #    &quot;MVar&quot;: {</span>
<span class="sd">    #        &quot;Note&quot;: &quot;Metadata&quot;,</span>
<span class="sd">    #        &quot;VALUES&quot;: [7.8]</span>
<span class="sd">    #    },</span>
<span class="sd">    #    &quot;Global&quot;: &quot;A global attribute&quot;,</span>
<span class="sd">    #    &quot;Var1&quot;: {</span>
<span class="sd">    #        &quot;Local1&quot;: &quot;A local attribute&quot;,</span>
<span class="sd">    #        &quot;DIMENSION&quot;: [1],</span>
<span class="sd">    #        &quot;START_COLUMN&quot;: 0</span>
<span class="sd">    #    },</span>
<span class="sd">    #    &quot;Var2&quot;: {</span>
<span class="sd">    #        &quot;DIMENSION&quot;: [2],</span>
<span class="sd">    #        &quot;START_COLUMN&quot;: 2</span>
<span class="sd">    #    }</span>
<span class="sd">    #}</span>
<span class="sd">    1 8 9</span>
<span class="sd">    2 9 1</span>
<span class="sd">    3 3 4</span>
<span class="sd">    4 8 9</span>
<span class="sd">    5 7 8</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">StringIO</span> <span class="c1"># can&#39;t use cStringIO as we might have unicode</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span> <span class="k">as</span> <span class="nn">StringIO</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="c1"># from . import toolbox # handled in functions that use it</span>


<span class="n">__contact__</span> <span class="o">=</span> <span class="s1">&#39;Steve Morley, smorley@lanl.gov&#39;</span>

<span class="c1"># python2 python3 string wrangling</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">str_classes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">str_classes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<div class="viewcode-block" id="DMWarning"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.DMWarning.html#spacepy.datamodel.DMWarning">[docs]</a><span class="k">class</span> <span class="nc">DMWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Warnings class for datamodel, subclassed so it can be set to always</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="n">DMWarning</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MetaMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin class that adds a &#39;meta&#39; attribute that acts like &#39;attrs&#39;</span>

<span class="sd">    Recommendation from the Python Heliophysics community is to allow</span>
<span class="sd">    access to metadata via either an ``attrs`` attribute or ``meta``.</span>
<span class="sd">    This mixin class supports that recommendation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Equivalent to ``attrs``</span>

<span class="sd">        Some APIs use ``attrs`` for metadata; some use ``meta``. This</span>
<span class="sd">        is a convenience property to make it easier for those familiar</span>
<span class="sd">        with the ``meta`` convention.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>

    <span class="nd">@meta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set meta as with attrs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@meta</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove meta (and thus attrs)</span>

<span class="sd">        This isn&#39;t a good idea but you can do it with attrs,</span>
<span class="sd">        so might as well support it in meta.</span>

<span class="sd">        This still leaves the meta property hanging around, but</span>
<span class="sd">        cannot delete a property from an instance (have to delete</span>
<span class="sd">        from the class).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>


<div class="viewcode-block" id="dmarray"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.dmarray.html#spacepy.datamodel.dmarray">[docs]</a><span class="k">class</span> <span class="nc">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">MetaMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for data within a SpaceData object</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NameError</span>
<span class="sd">        raised is the request name was not added to the allowed attributes list</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as datamodel</span>
<span class="sd">    &gt;&gt;&gt; position = datamodel.dmarray([1,2,3], attrs={&#39;coord_system&#39;:&#39;GSM&#39;})</span>
<span class="sd">    &gt;&gt;&gt; position</span>
<span class="sd">    dmarray([1, 2, 3])</span>
<span class="sd">    &gt;&gt;&gt; position.attrs</span>
<span class="sd">    {&#39;coord_system&#39;: &#39;GSM&#39;}a</span>

<span class="sd">    The dmarray, like a numpy ndarray, is versatile and can store</span>
<span class="sd">    any datatype; dmarrays are not just for arrays.</span>

<span class="sd">    &gt;&gt;&gt; name = datamodel.dmarray(&#39;TestName&#39;)</span>
<span class="sd">    dmarray(&#39;TestName&#39;)</span>

<span class="sd">    To extract the string (or scalar quantity), use the tolist method</span>

<span class="sd">    &gt;&gt;&gt; name.tolist()</span>
<span class="sd">    &#39;TestName&#39;</span>

<span class="sd">    .. currentmodule:: spacepy.datamodel</span>
<span class="sd">    .. autosummary::</span>
<span class="sd">        ~dmarray.addAttribute</span>
<span class="sd">    .. automethod:: addAttribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Allowed_Attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
       <span class="c1"># Input array is an already formed ndarray instance</span>
       <span class="c1"># We first cast to be our class type</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">dtype</span><span class="p">:</span>
           <span class="n">obj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">obj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
       <span class="c1"># add the new attribute to the created instance</span>
       <span class="k">if</span> <span class="n">attrs</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
           <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
       <span class="c1"># Finally, return the newly created object:</span>
       <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
       <span class="c1"># see InfoArray.__array_finalize__ for comments</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="p">{})))</span>

    <span class="k">def</span> <span class="nf">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_arr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#check for zero-dims (numpy bug means subclass behaviour isn&#39;t consistent with ndarray</span>
        <span class="c1">#this traps most of the bad behaviour ( std() and var() still problems)</span>
        <span class="k">if</span> <span class="n">out_arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_arr</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_arr</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called when pickling, see:</span>
<span class="sd">        http://www.mail-archive.com/numpy-discussion@scipy.org/msg02446.html</span>
<span class="sd">        for this particular example.</span>
<span class="sd">        Only the attributes in Allowed_Attributes can exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">object_state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">subclass_state</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">([</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">val</span><span class="p">)])</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="p">])</span>
        <span class="n">object_state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">object_state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">subclass_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">object_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used for unpickling after __reduce__ the self.attrs is recovered from</span>
<span class="sd">        the way it was saved and reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nd_state</span><span class="p">,</span> <span class="n">own_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nd_state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">own_state</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="p">:</span> <span class="c1"># this is attrs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">own_state</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">own_state</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">own_state</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure that .attrs is the only attribute that we are allowing</span>
<span class="sd">        dmarray_ne took 15.324803 s</span>
<span class="sd">        dmarray_eq took 15.665865 s</span>
<span class="sd">        dmarray_assert took 16.025478 s</span>
<span class="sd">        It looks like != is the fastest, but not by much over 10000000 __setattr__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#meta is special-handled because it should NOT be pickled</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Allowed_Attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only attribute listed in Allowed_Attributes can be set&quot;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">dmarray</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="dmarray.addAttribute"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.dmarray.html#spacepy.datamodel.dmarray.addAttribute">[docs]</a>    <span class="k">def</span> <span class="nf">addAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to add an attribute to a dmarray</span>
<span class="sd">        equivalent to</span>
<span class="sd">        a = datamodel.dmarray([1,2,3])</span>
<span class="sd">        a.Allowed_Attributes = a.Allowed_Attributes + [&#39;blabla&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is already an attribute cannot add again&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srchval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equivalent to count method on list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">srchval</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">_saveAttrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Allowed_Attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Allowed_Attributes</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atr</span> <span class="ow">in</span> <span class="n">Allowed_Attributes</span><span class="p">:</span>
            <span class="n">backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">atr</span><span class="p">,</span> <span class="n">dmcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">atr</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">backup</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_replaceAttrs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">backup</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;attrs&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arr</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">arr</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        append data to an existing dmarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_saveAttrs</span><span class="p">()</span>
        <span class="n">outarr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_replaceAttrs</span><span class="p">(</span><span class="n">outarr</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">vstack</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        vstack data to an existing dmarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_saveAttrs</span><span class="p">()</span>
        <span class="n">outarr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_replaceAttrs</span><span class="p">(</span><span class="n">outarr</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">hstack</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        hstack data to an existing dmarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_saveAttrs</span><span class="p">()</span>
        <span class="n">outarr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_replaceAttrs</span><span class="p">(</span><span class="n">outarr</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dstack</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        dstack data to an existing dmarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_saveAttrs</span><span class="p">()</span>
        <span class="n">outarr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_replaceAttrs</span><span class="p">(</span><span class="n">outarr</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        concatenate data to an existing dmarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backup</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_saveAttrs</span><span class="p">()</span>
        <span class="n">outarr</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_replaceAttrs</span><span class="p">(</span><span class="n">outarr</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span></div>

<div class="viewcode-block" id="dmfilled"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.dmfilled.html#spacepy.datamodel.dmfilled">[docs]</a><span class="k">def</span> <span class="nf">dmfilled</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">fillval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a new dmarray of given shape and type, filled with a specified value (default=0).</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    numpy.ones</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; dm.dmfilled(5, attrs={&#39;units&#39;: &#39;nT&#39;})</span>
<span class="sd">    dmarray([ 0.,  0.,  0.,  0.,  0.])</span>

<span class="sd">    &gt;&gt;&gt; dm.dmfilled((5,), fillval=1, dtype=np.int)</span>
<span class="sd">    dmarray([1, 1, 1, 1, 1])</span>

<span class="sd">    &gt;&gt;&gt; dm.dmfilled((2, 1), fillval=np.nan)</span>
<span class="sd">    dmarray([[ nan],</span>
<span class="sd">           [ nan]])</span>

<span class="sd">    &gt;&gt;&gt; a = dm.dmfilled((2, 1), np.nan, attrs={&#39;units&#39;: &#39;nT&#39;})</span>
<span class="sd">    &gt;&gt;&gt; a</span>
<span class="sd">    dmarray([[ nan],</span>
<span class="sd">           [ nan]])</span>
<span class="sd">    &gt;&gt;&gt; a.attrs</span>
<span class="sd">    {&#39;units&#39;: &#39;nT&#39;}</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">order</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fillval</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="SpaceData"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.SpaceData.html#spacepy.datamodel.SpaceData">[docs]</a><span class="k">class</span> <span class="nc">SpaceData</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">MetaMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Datamodel class extending dict by adding attributes.</span>

<span class="sd">    .. currentmodule:: spacepy.datamodel</span>
<span class="sd">    .. autosummary::</span>
<span class="sd">        ~SpaceData.flatten</span>
<span class="sd">        ~SpaceData.tree</span>
<span class="sd">        ~SpaceData.toCDF</span>
<span class="sd">        ~SpaceData.toHDF5</span>
<span class="sd">        ~SpaceData.toJSONheadedASCII</span>
<span class="sd">    .. automethod:: flatten</span>
<span class="sd">    .. automethod:: tree</span>
<span class="sd">    .. automethod:: toCDF</span>
<span class="sd">    .. automethod:: toHDF5</span>
<span class="sd">    .. automethod:: toJSONheadedASCII</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This allows one to make a SpaceData indexed with an iterable of keys to return a new spacedata</span>
<span class="sd">        made of the subset of keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SpaceData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="c1"># make a new SpaceData from these keys</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
                <span class="n">out</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base class for &quot;Data Model&quot; representation data</span>

<span class="sd">        Abstract method, reimplement</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs : dict</span>
<span class="sd">            dictionary of the attributes of the SpaceData object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#raise(ValueError(&quot;Abstract method called, reimplement __init__&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;attrs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">],</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SpaceData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toCDF</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">toCDF</span><span class="p">,</span> <span class="n">SDobject</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toCDF</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">toCDF</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toHDF5</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">toHDF5</span><span class="p">,</span> <span class="n">SDobject</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toHDF5</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">toHDF5</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toJSONheadedASCII</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">toJSONheadedASCII</span><span class="p">,</span> <span class="n">insd</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toJSONheadedASCII</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">toJSONheadedASCII</span><span class="o">.</span><span class="vm">__doc__</span>

<span class="c1">## To enable string output of repr, instead of just printing, uncomment his block</span>
<span class="c1">#    def __repr__(self):</span>
<span class="c1">#        #redirect stdout to StringIO</span>
<span class="c1">#        import StringIO, sys</span>
<span class="c1">#        dum = StringIO.StringIO()</span>
<span class="c1">#        sys_stdout_save = sys.stdout</span>
<span class="c1">#        sys.stdout = dum</span>
<span class="c1">#        self.tree(verbose=True)</span>
<span class="c1">#        sys.stdout = sys_stdout_save</span>
<span class="c1">#        dum.seek(0)</span>
<span class="c1">#        return &#39;&#39;.join(dum.readlines())</span>
    
<div class="viewcode-block" id="SpaceData.tree"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.SpaceData.html#spacepy.datamodel.SpaceData.tree">[docs]</a>    <span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Print the contents of the SpaceData object in a visual tree</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        verbose : boolean (optional)</span>
<span class="sd">            print more info</span>
<span class="sd">        spaces : string (optional)</span>
<span class="sd">            string will added for every line</span>
<span class="sd">        levels : integer (optional)</span>
<span class="sd">            number of levels to recurse through (True means all)</span>
<span class="sd">        attrs : boolean (optional)</span>
<span class="sd">            display information for attributes</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">        &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;1&#39;] = dm.SpaceData(dog = 5)</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;4&#39;] = dm.SpaceData(cat = &#39;kitty&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;5&#39;] = 4</span>
<span class="sd">        &gt;&gt;&gt; a.tree()</span>
<span class="sd">        +</span>
<span class="sd">        |____1</span>
<span class="sd">             |____dog</span>
<span class="sd">        |____4</span>
<span class="sd">             |____cat</span>
<span class="sd">        |____5</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        toolbox.dictree</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">toolbox</span>
        <span class="n">toolbox</span><span class="o">.</span><span class="n">dictree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpaceData.flatten"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.SpaceData.html#spacepy.datamodel.SpaceData.flatten">[docs]</a>    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method to collapse datamodel to one level deep</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">        &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;1&#39;] = dm.SpaceData(dog = 5, pig = dm.SpaceData(fish=dm.SpaceData(a=&#39;carp&#39;, b=&#39;perch&#39;)))</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;4&#39;] = dm.SpaceData(cat = &#39;kitty&#39;)</span>
<span class="sd">        &gt;&gt;&gt; a[&#39;5&#39;] = 4</span>
<span class="sd">        &gt;&gt;&gt; a.tree()</span>
<span class="sd">        +</span>
<span class="sd">        |____1</span>
<span class="sd">             |____dog</span>
<span class="sd">             |____pig</span>
<span class="sd">                  |____fish</span>
<span class="sd">                       |____a</span>
<span class="sd">                       |____b</span>
<span class="sd">        |____4</span>
<span class="sd">             |____cat</span>
<span class="sd">        |____5</span>

<span class="sd">        &gt;&gt;&gt; b = dm.flatten(a)</span>
<span class="sd">        &gt;&gt;&gt; b.tree()</span>
<span class="sd">        +</span>
<span class="sd">        |____1&lt;--dog</span>
<span class="sd">        |____1&lt;--pig&lt;--fish&lt;--a</span>
<span class="sd">        |____1&lt;--pig&lt;--fish&lt;--b</span>
<span class="sd">        |____4&lt;--cat</span>
<span class="sd">        |____5</span>

<span class="sd">        &gt;&gt;&gt; a.flatten()</span>
<span class="sd">        &gt;&gt;&gt; a.tree()</span>
<span class="sd">        +</span>
<span class="sd">        |____1&lt;--dog</span>
<span class="sd">        |____1&lt;--pig&lt;--fish&lt;--a</span>
<span class="sd">        |____1&lt;--pig&lt;--fish&lt;--b</span>
<span class="sd">        |____4&lt;--cat</span>
<span class="sd">        |____5</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">flatobj</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">remkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remkeys</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">flatobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flatobj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div></div>

            

<div class="viewcode-block" id="convertKeysToStr"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.convertKeysToStr.html#spacepy.datamodel.convertKeysToStr">[docs]</a><span class="k">def</span> <span class="nf">convertKeysToStr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="n">SpaceData</span><span class="p">):</span>
        <span class="n">newSDobject</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
        <span class="n">newSDobject</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">SDobject</span><span class="o">.</span><span class="n">attrs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newSDobject</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">newSDobject</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">convertKeysToStr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newSDobject</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">newSDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">convertKeysToStr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newSDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">newSDobject</span></div>


<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.flatten.html#spacepy.datamodel.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">dobj</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Collapse datamodel to one level deep</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;1&#39;] = dm.SpaceData(dog = 5, pig = dm.SpaceData(fish=dm.SpaceData(a=&#39;carp&#39;, b=&#39;perch&#39;)))</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;4&#39;] = dm.SpaceData(cat = &#39;kitty&#39;)</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;5&#39;] = 4</span>
<span class="sd">    &gt;&gt;&gt; a.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1</span>
<span class="sd">         |____dog</span>
<span class="sd">         |____pig</span>
<span class="sd">              |____fish</span>
<span class="sd">                   |____a</span>
<span class="sd">                   |____b</span>
<span class="sd">    |____4</span>
<span class="sd">         |____cat</span>
<span class="sd">    |____5</span>

<span class="sd">    &gt;&gt;&gt; b = dm.flatten(a)</span>
<span class="sd">    &gt;&gt;&gt; b.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1&lt;--dog</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--a</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--b</span>
<span class="sd">    |____4&lt;--cat</span>
<span class="sd">    |____5</span>

<span class="sd">    &gt;&gt;&gt; a.flatten()</span>
<span class="sd">    &gt;&gt;&gt; a.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1&lt;--dog</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--a</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--b</span>
<span class="sd">    |____4&lt;--cat</span>
<span class="sd">    |____5</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    unflatten</span>
<span class="sd">    SpaceData.flatten</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">addme</span> <span class="o">=</span> <span class="n">dobj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">addme</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">remlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">:</span> <span class="c1">#iterate over keys in SpaceData</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">remlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">newname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;--&#39;</span>
            <span class="k">for</span> <span class="n">levkey</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">levkey</span><span class="p">],</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span>
                    <span class="n">retdict</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">levkey</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">retdict</span><span class="p">:</span>
                        <span class="n">addme</span><span class="p">[</span><span class="n">newname</span><span class="o">+</span><span class="n">levkey</span><span class="o">+</span><span class="s1">&#39;&lt;--&#39;</span><span class="o">+</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">retdict</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">addme</span><span class="p">[</span><span class="n">newname</span><span class="o">+</span><span class="n">levkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">levkey</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addme</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">addme</span></div>

<div class="viewcode-block" id="unflatten"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.unflatten.html#spacepy.datamodel.unflatten">[docs]</a><span class="k">def</span> <span class="nf">unflatten</span><span class="p">(</span><span class="n">dobj</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&lt;--&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Collapse datamodel to one level deep</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.toolbox as tb</span>
<span class="sd">    &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;1&#39;] = dm.SpaceData(dog = 5, pig = dm.SpaceData(fish=dm.SpaceData(a=&#39;carp&#39;, b=&#39;perch&#39;)))</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;4&#39;] = dm.SpaceData(cat = &#39;kitty&#39;)</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;5&#39;] = 4</span>
<span class="sd">    &gt;&gt;&gt; a.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1</span>
<span class="sd">         |____dog</span>
<span class="sd">         |____pig</span>
<span class="sd">              |____fish</span>
<span class="sd">                   |____a</span>
<span class="sd">                   |____b</span>
<span class="sd">    |____4</span>
<span class="sd">         |____cat</span>
<span class="sd">    |____5</span>

<span class="sd">    &gt;&gt;&gt; b = dm.flatten(a)</span>
<span class="sd">    &gt;&gt;&gt; b.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1&lt;--dog</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--a</span>
<span class="sd">    |____1&lt;--pig&lt;--fish&lt;--b</span>
<span class="sd">    |____4&lt;--cat</span>
<span class="sd">    |____5</span>

<span class="sd">    &gt;&gt;&gt; c = dm.unflatten(b)</span>
<span class="sd">    &gt;&gt;&gt; c.tree()</span>
<span class="sd">    +</span>
<span class="sd">    |____1</span>
<span class="sd">         |____dog</span>
<span class="sd">         |____pig</span>
<span class="sd">              |____fish</span>
<span class="sd">                   |____a</span>
<span class="sd">                   |____b</span>
<span class="sd">    |____4</span>
<span class="sd">         |____cat</span>
<span class="sd">    |____5</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#set up a new object for return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">addme</span> <span class="o">=</span> <span class="n">dobj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">addme</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="c1">#the input is assumed to be single level (i.e. it is flat)</span>

    <span class="c1">#find all keys that have at least one marker,</span>
    <span class="c1">#then unpack. Recurse over these until no more markers are found.</span>
    <span class="n">keydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Flat datamodel should not contain dict-likes&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="c1">#get &#39;group&#39;</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">marker</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">keydict</span><span class="p">:</span>
                    <span class="n">keydict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">keydict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#not nested, just copy key</span>
                <span class="n">addme</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">addme</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="c1">#now we have all the groups at this level</span>
    <span class="c1">#move members of groups into new SpaceDatas</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">keydict</span><span class="p">:</span>
        <span class="n">addme</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keydict</span><span class="p">[</span><span class="n">grp</span><span class="p">]:</span>
            <span class="n">newkey</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">marker</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">addme</span><span class="p">[</span><span class="n">grp</span><span class="p">][</span><span class="n">newkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">addme</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span> <span class="o">=</span> <span class="n">unflatten</span><span class="p">(</span><span class="n">addme</span><span class="p">[</span><span class="n">grp</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span> <span class="c1">#recurse to make sure everything inside is unpacked</span>
    <span class="k">return</span> <span class="n">addme</span></div>


<div class="viewcode-block" id="fromCDF"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.fromCDF.html#spacepy.datamodel.fromCDF">[docs]</a><span class="k">def</span> <span class="nf">fromCDF</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a SpacePy datamodel representation of a NASA CDF file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : string</span>
<span class="sd">        the name of the cdf file to be loaded into a datamodel</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; data = dm.fromCDF(&#39;test.cdf&#39;)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    spacepy.pycdf.CDF.copy</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: add unflatten keyword and restore flattened variables</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">pycdf</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;CDF converter requires NASA CDF library and SpacePy&#39;s pyCDF&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pycdf</span><span class="o">.</span><span class="n">CDF</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">cdfdata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cdfdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="toCDF"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.toCDF.html#spacepy.datamodel.toCDF">[docs]</a><span class="k">def</span> <span class="nf">toCDF</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a CDF file from a SpacePy datamodel representation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to write to</span>

<span class="sd">    SDobject : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    skeleton : str (optional)</span>
<span class="sd">        create new CDF from a skeleton file (default &#39;&#39;)</span>

<span class="sd">    flatten : bool (optional)</span>
<span class="sd">        flatten incoming datamodel - if SpaceData objects are nested (default False)</span>

<span class="sd">    overwrite : bool (optional)</span>
<span class="sd">        allow overwrite of an existing target file (default False)</span>

<span class="sd">    autoNRV : bool (optional)</span>
<span class="sd">        attempt automatic identification of non-record varying entries in CDF</span>

<span class="sd">    backward : bool (optional)</span>
<span class="sd">        create CDF in backward-compatible format (default is v3+ compatibility only)</span>

<span class="sd">    TT2000 : bool (optional)</span>
<span class="sd">        write variables beginning with &#39;Epoch&#39; as datatype CDF_TT2000 (default is automatic selection of EPOCH or EPOCH16)</span>

<span class="sd">    verbose : bool (optional)</span>
<span class="sd">        verbosity flag</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;skeleton&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;flatten&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;autoNRV&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;TT2000&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;flatten&#39;</span><span class="p">]:</span>
        <span class="n">SDobject</span> <span class="o">=</span> <span class="n">SDobject</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Overwriting CDFs is not currently enabled - please remove the file manually&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">pycdf</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;CDF converter requires NASA CDF library and SpacePy&#39;s pyCDF&quot;</span><span class="p">)</span>
    <span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">set_backward</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pycdf</span><span class="o">.</span><span class="n">CDF</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;skeleton&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">outdata</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">akey</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">outdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">akey</span><span class="p">])</span>
        <span class="n">varLengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="p">]</span>
        <span class="n">modeLength</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">((</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">varLengths</span><span class="p">)))))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;This data structure appears to be nested, please try spacepy.datamodel.flatten&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;skeleton&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">shape_tup</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape_tup</span> <span class="o">=</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="s1">&#39;Epoch&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="p">:</span>
                    <span class="n">NRVtest</span> <span class="o">=</span> <span class="n">modeLength</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">NRVtest</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="s1">&#39;Epoch&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">shape_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NRVtest</span><span class="p">:</span> <span class="c1">#naive check for &#39;should-be&#39; NRV</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">foo</span> <span class="o">=</span> <span class="n">outdata</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="n">recVary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is being made NRV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                        <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">foo</span> <span class="o">=</span> <span class="n">outdata</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">,</span> <span class="n">recVary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;TT2000&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;Epoch&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">foo</span> <span class="o">=</span> <span class="n">outdata</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">([</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> <span class="n">attrs</span><span class="o">=</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                            <span class="n">tmpAttrs</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">akey</span> <span class="ow">in</span> <span class="n">tmpAttrs</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span> <span class="c1">#strings</span>
                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">],</span> <span class="s1">&#39;encode&#39;</span><span class="p">):</span>
                                        <span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#probably a list of strings</span>
                                    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]):</span>
                                        <span class="n">tmpAttrs</span><span class="p">[</span><span class="n">akey</span><span class="p">][</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">akey</span> <span class="ow">in</span> <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">akey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">akey</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">outdata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">([</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> <span class="n">attrs</span><span class="o">=</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="fromHDF5"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.fromHDF5.html#spacepy.datamodel.fromHDF5">[docs]</a><span class="k">def</span> <span class="nf">fromHDF5</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a SpacePy datamodel representation of an HDF5 file or netCDF4 file which is HDF5 compliant</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : string</span>
<span class="sd">        the name of the HDF5/netCDF4 file to be loaded into a datamodel</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; data = dm.fromHDF5(&#39;test.hdf&#39;)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Zero-sized datasets will break in h5py. This is kluged by returning a</span>
<span class="sd">    dmarray containing a None.</span>

<span class="sd">    This function is expected to work with any HDF5-compliant files, including</span>
<span class="sd">    netCDF4 (not netCDF3) and MatLab save files from v7.3 or later, but some</span>
<span class="sd">    datatypes are not supported, e.g., non-string vlen datatypes, and will</span>
<span class="sd">    raise a warning.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">hdfcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">],</span><span class="s1">&#39;attrs&#39;</span><span class="p">):</span>
            <span class="c1">#for key, value in hfile[path].attrs.iteritems():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unsupported datatype in dataset </span><span class="si">{0}</span><span class="s1">.attrs[</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">SDobject</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The following key:value pair is not permitted</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;key = </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;value = </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="n">DMWarning</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">hdf</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;HDF5 converter requires h5py&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">str_classes</span><span class="p">:</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">hdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="c1">#should test here for HDF file object</span>

    <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

    <span class="n">SDobject</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">allowed_elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdf</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span> <span class="n">hdf</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span>
    <span class="c1">##carry over the attributes</span>
    <span class="n">hdfcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="c1">##carry over the groups and datasets</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#try:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">allowed_elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#if a group</span>
                <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
                <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromHDF5</span><span class="p">(</span><span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">allowed_elems</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1">#if a dataset</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span> <span class="c1">#ZeroDivisionError catches zero-sized DataSets</span>
                    <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">hdfcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)</span>
        <span class="c1">#except:</span>
        <span class="c1">#    raise ValueError(&#39;HDF5 file contains type other than Group or Dataset&#39;)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">hfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">SDobject</span></div>

<div class="viewcode-block" id="toHDF5"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.toHDF5.html#spacepy.datamodel.toHDF5">[docs]</a><span class="k">def</span> <span class="nf">toHDF5</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an HDF5 file from a SpacePy datamodel representation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to write to</span>

<span class="sd">    SDobject : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    overwrite : bool (optional)</span>
<span class="sd">        allow overwrite of an existing target file (default True)</span>
<span class="sd">    mode : str (optional)</span>
<span class="sd">        HDF5 file open mode (a, w, r) (default &#39;a&#39;)</span>
<span class="sd">    compression : str (optional)</span>
<span class="sd">        compress all the variables using this method (default None) (gzip, shuffle, fletcher32, szip, lzf)</span>
<span class="sd">    compression_opts : str (optional)</span>
<span class="sd">        options to the compression, see h5py documentation for more details</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;data&#39;] = dm.dmarray(range(100000), dtype=float)</span>
<span class="sd">    &gt;&gt;&gt; dm.toHDF5(&#39;test_gzip.h5&#39;, a, overwrite=True, compression=&#39;gzip&#39;)</span>
<span class="sd">    &gt;&gt;&gt; dm.toHDF5(&#39;test.h5&#39;, a, overwrite=True)</span>
<span class="sd">    &gt;&gt;&gt; # test_gzip.h5 was 118k, test.h5 was 785k</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">SDcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">allowed_attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dumval</span><span class="p">,</span> <span class="n">dumkey</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">allowed_attrs</span><span class="p">:</span>
                    <span class="c1">#test for datetimes in iterables</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
                        <span class="n">dumval</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                    <span class="n">truth</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">nbytes</span><span class="p">:</span> <span class="n">truth</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#empty arrays of any dimension are nbytes=0</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#not an array</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">truth</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">truth</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">bytes</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="n">unicode</span><span class="p">:</span>
                                <span class="n">dumkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">unicode</span><span class="p">:</span>
                                <span class="n">dumval</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">uni</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#No special unicode handling</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1">#Python 3</span>
                            <span class="n">dumval</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">dumval</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dumval</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">dumval</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                                <span class="n">uni</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#Unicode list, special handling</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">uni</span><span class="p">:</span>
                                <span class="c1">#Tell hdf5 this is unicode. Numpy is UCS-4, HDF5 is UTF-8</span>
                                <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">dumkey</span><span class="p">,</span> <span class="n">dumval</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">hdf</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="n">unicode</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">dumkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dumval</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">dumkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dumval</span><span class="p">)</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s1">&#39;The following value is not permitted</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;key, value, type = </span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">, </span><span class="si">{2}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">+</span>
                                <span class="s1">&#39;value has been converted to a string for output&#39;</span><span class="p">,</span>
                                <span class="n">DMWarning</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">dumkey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                    <span class="n">dumval</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">bytes</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="n">unicode</span><span class="p">:</span>
                        <span class="n">dumkey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">dumkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dumval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#TODO: add support for arrays(?) in attrs (convert to isoformat)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The following key:value pair is not permitted</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;key = </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;value type </span><span class="si">{0}</span><span class="s1"> is not in the allowed attribute list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span>
                                        <span class="n">DMWarning</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">hdf</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;h5py is required to use HDF5 files&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span> <span class="n">SpaceData</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input data is not of type SpaceData, check usage: toHDF5(fname, datamodel)&quot;</span><span class="p">)</span>
    <span class="c1">#mash these into a defaults dict...</span>
    <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">wr_mo</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wr_mo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;compression&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">h5_compr_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h5_compr_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">h5_compr_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="s1">&#39;szip&#39;</span><span class="p">,</span> <span class="s1">&#39;lzf&#39;</span><span class="p">,</span> <span class="s1">&#39;shuffle&#39;</span><span class="p">,</span> <span class="s1">&#39;fletcher32&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Specified compression type not supported&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;compression_opts&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">h5_compr_type</span> <span class="o">==</span> <span class="s1">&#39;lzf&#39;</span><span class="p">):</span>
        <span class="n">h5_compr_opts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h5_compr_opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compression_opts&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;overwrite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">str_classes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">]:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Cannot write HDF5, file exists (see overwrite) &quot;</span><span class="si">{0!s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">hdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">wr_mo</span><span class="p">)</span>
        <span class="n">must_close</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="c1">#should test here for HDF file object</span>
        <span class="n">must_close</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

    <span class="c1"># long is a type in python2 not in python3</span>
    <span class="c1"># unicode is a type in python2 not in python3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">allowed_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">string_</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">allowed_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span>       <span class="nb">float</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">string_</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllInteger&#39;</span><span class="p">]:</span>
        <span class="n">allowed_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">typeDict</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllFloat&#39;</span><span class="p">]:</span>
        <span class="n">allowed_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">typeDict</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

    <span class="n">allowed_elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">SpaceData</span><span class="p">,</span> <span class="n">dmarray</span><span class="p">]</span>

    <span class="c1">#first convert non-string keys to str</span>
    <span class="n">SDobject</span> <span class="o">=</span> <span class="n">convertKeysToStr</span><span class="p">(</span><span class="n">SDobject</span><span class="p">)</span>
    <span class="n">SDcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">,</span><span class="n">hfile</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">allowed_attrs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">SDobject</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allowed_elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">toHDF5</span><span class="p">(</span><span class="n">hfile</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">h5_compr_type</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="n">h5_compr_opts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allowed_elems</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">h5_compr_type</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="n">h5_compr_opts</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dumval</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="n">dumval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="n">hfile</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dumval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;|S35&#39;</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="n">h5_compr_type</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="n">h5_compr_opts</span><span class="p">)</span>
                    <span class="c1">#else:</span>
                    <span class="c1">#    hfile[path].create_dataset(key, data=value.astype(float))</span>
                <span class="n">SDcarryattrs</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">hfile</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">,</span> <span class="n">allowed_attrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The following data is not being written as is not of an allowed type</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;key = </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">+</span>
                                  <span class="s1">&#39;value type </span><span class="si">{0}</span><span class="s1"> is not in the allowed data type list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span>
                                      <span class="n">DMWarning</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">must_close</span><span class="p">:</span>
            <span class="n">hfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">fromNC3</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">netcdf</span> <span class="k">as</span> <span class="n">nc</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;SciPy is required to import netcdf3&#39;</span><span class="p">)</span>

    <span class="n">ncfile</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">netcdf_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">mmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">SDobject</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">ncfile</span><span class="o">.</span><span class="n">_attributes</span><span class="p">))</span>

    <span class="c1">##carry over the groups and datasets</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#try:</span>
            <span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">dmcopy</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_attributes</span><span class="p">))</span>
        <span class="c1">#except (TypeError, ZeroDivisionError): #ZeroDivisionError catches zero-sized DataSets</span>
        <span class="c1">#    SDobject[key] = dmarray(None)</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">SDobject</span>



<div class="viewcode-block" id="toHTML"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.toHTML.html#spacepy.datamodel.toHTML">[docs]</a><span class="k">def</span> <span class="nf">toHTML</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">SDobject</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">(),</span>
           <span class="n">varLinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linkFormat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tableTag</span><span class="o">=</span><span class="s1">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an HTML dump of the structure of a spacedata</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to write to</span>

<span class="sd">    SDobject : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    overwrite : bool (optional)</span>
<span class="sd">        allow overwrite of an existing target file (default True)</span>
<span class="sd">    mode : str (optional)</span>
<span class="sd">        HDF5 file open mode (a, w, r) (default &#39;a&#39;)</span>
<span class="sd">    echo : bool</span>
<span class="sd">        echo the html to the screen</span>
<span class="sd">    varLinks : bool</span>
<span class="sd">        make the variable name a link to a stub page</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="c1"># put the output into a StringIO</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">SDobject</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tableTag</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;th&gt;</span><span class="si">{0}</span><span class="s1">&lt;/th&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;th&gt;</span><span class="si">{0}</span><span class="s1">&lt;/th&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;tr class=&quot;alt&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">varLinks</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{0}</span><span class="s1">.html&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">varLinks</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">{0}</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_idl2html</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;</span><span class="si">{0}</span><span class="s1">&lt;/td&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_idl2html</span><span class="p">(</span><span class="n">SDobject</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">])))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;&lt;/td&gt;&#39;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">echo</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">_idl2html</span><span class="p">(</span><span class="n">idl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given an idl format string for text change it to html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    idl : str</span>
<span class="sd">        idl formated string</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    out : str</span>
<span class="sd">        html formatted string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">idl</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;!!&#39;</span><span class="p">:</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
            <span class="s1">&#39;!E&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;sup&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;!I&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;sub&gt;&#39;</span><span class="p">}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># hate it but for now</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">html</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">conv</span><span class="p">[</span><span class="n">code</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;!I&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;!N&#39;</span> <span class="ow">in</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!N&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/sub&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="c1"># just replace 1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">html</span> <span class="o">+</span> <span class="s1">&#39;&lt;/sub&gt;&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;!E&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;!N&#39;</span> <span class="ow">in</span> <span class="n">html</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!N&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/sup&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="c1"># just replace 1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">html</span> <span class="o">+</span> <span class="s1">&#39;&lt;/sup&gt;&#39;</span>
    <span class="k">return</span> <span class="n">html</span>

<div class="viewcode-block" id="readJSONMetadata"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.readJSONMetadata.html#spacepy.datamodel.readJSONMetadata">[docs]</a><span class="k">def</span> <span class="nf">readJSONMetadata</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read JSON metadata from an ASCII data file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to read metadata from</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    verbose : bool (optional)</span>
<span class="sd">        set verbose output so metadata tree prints on read (default False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdata: spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with the metadata from the file</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># isolate header</span>
    <span class="n">p_srch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#(.*)$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="n">hreg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">p_srch</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hreg</span><span class="p">)</span>

    <span class="c1"># isolate JSON field</span>
    <span class="n">srch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{\s*(.*)\s*\}&#39;</span><span class="p">,</span> <span class="n">header</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">srch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;The input file has no valid JSON header. Must be valid JSON bounded by braces &quot;{ }&quot;.&#39;</span><span class="p">)</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">srch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">inx</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;end JSON&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">))</span>
        <span class="n">mdatadict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">js</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="n">js</span><span class="p">[:</span><span class="n">inx</span><span class="p">]))</span>
        <span class="n">mdatadict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>

    <span class="n">mdata</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mdatadict</span><span class="p">:</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span> <span class="c1"># not dict-like, must be global attrs</span>
           <span class="n">mdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
       <span class="k">elif</span> <span class="s1">&#39;START_COLUMN&#39;</span> <span class="ow">in</span> <span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span> <span class="c1"># is a variable</span>
           <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
       <span class="k">elif</span> <span class="s1">&#39;VALUES&#39;</span> <span class="ow">in</span> <span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span> <span class="c1"># is global metadata</span>
           <span class="n">dum</span> <span class="o">=</span> <span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;VALUES&#39;</span><span class="p">)</span>
           <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">dum</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
       <span class="k">else</span><span class="p">:</span> <span class="c1"># don&#39;t know how to deal with this, store as global attrs</span>
           <span class="n">mdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdatadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="n">mdata</span><span class="o">.</span><span class="n">tree</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mdata</span></div>

<div class="viewcode-block" id="readJSONheadedASCII"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.readJSONheadedASCII.html#spacepy.datamodel.readJSONheadedASCII">[docs]</a><span class="k">def</span> <span class="nf">readJSONheadedASCII</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">restrict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read JSON-headed ASCII data files into a SpacePy datamodel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str or list</span>
<span class="sd">        Filename(s) to read data from</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    mdata : spacepy.datamodel.SpaceData (optional)</span>
<span class="sd">        supply metadata object, otherwise is read from fname (default None)</span>
<span class="sd">    comment: str (optional)</span>
<span class="sd">        comment string in file to be read; lines starting with comment are</span>
<span class="sd">        ignored (default &#39;#&#39;)</span>
<span class="sd">    convert: bool or dict-like (optional)</span>
<span class="sd">        If True, uses common names to try conversion from string. If a dict-</span>
<span class="sd">        like then uses the functions specified as the dict values to convert</span>
<span class="sd">        each element of &#39;key&#39; to a non-string</span>
<span class="sd">    restrict: list of strings (optional)</span>
<span class="sd">        If present, restrict the variables stored to only those on this list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdata: spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with the data and metadata from the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">dateutil.parser</span> <span class="k">as</span> <span class="nn">dup</span>
    <span class="n">filelike</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">=</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;readlines&#39;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="n">filelike</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mdata</span><span class="p">:</span>
        <span class="n">mdata</span> <span class="o">=</span> <span class="n">readJSONMetadata</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">restrict</span><span class="p">:</span>
        <span class="n">delkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">mdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">kk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrict</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">delkeys</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">mdata</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="c1">#remove undesired keys</span>
    <span class="n">mdata_copy</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">innerloop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span> <span class="n">mdata_copy</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">comment</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span> <span class="c1"># fixes the missing first data bug</span>
        <span class="n">alldata</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">alldata</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mdata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">alldata</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alldata</span><span class="p">]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alldata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="c1"># fixes None in the data from empty lines at the end</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alldata</span><span class="p">)):</span> <span class="c1"># reverse order</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">alldata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">():</span> <span class="c1"># blank line (or al white space)</span>
                <span class="n">alldata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alldata</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ridx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alldata</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cidx</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">ridx</span><span class="p">,</span> <span class="n">cidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mdata_copy</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;START_COLUMN&#39;</span> <span class="ow">in</span> <span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;START_COLUMN&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;DIMENSION&#39;</span> <span class="ow">in</span> <span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">varDims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">varDims</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span> <span class="n">varDims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">varDims</span><span class="p">])</span>
                    <span class="n">singleDim</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varDims</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">varDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">singleDim</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;DIMENSION&#39;</span> <span class="ow">in</span> <span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">singleDim</span><span class="p">:</span>
                    <span class="n">en</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">==</span><span class="p">{}</span>
                        <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">en</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">en</span><span class="p">)]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">==</span><span class="p">{}</span>
                        <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">)]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span><span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">mdata</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filelike</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span> <span class="c1"># fixes windows bug with seek()</span>
                <span class="n">mdata</span> <span class="o">=</span> <span class="n">innerloop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span> <span class="n">mdata_copy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdata</span> <span class="o">=</span> <span class="n">innerloop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">mdata</span><span class="p">,</span> <span class="n">mdata_copy</span><span class="p">)</span>
    <span class="c1">#now add the attributres to the variables</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mdata_copy</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">SpaceData</span><span class="p">):</span>
            <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">attrs</span><span class="o">=</span><span class="n">mdata_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">conversions</span><span class="o">=</span><span class="n">convert</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conversions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DateTime&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ignoretz</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                           <span class="s1">&#39;ExtModel&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">conkey</span> <span class="ow">in</span> <span class="n">conversions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">conkey</span><span class="p">))</span> <span class="c1">#remove from keylist</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">{0}</span><span class="s1"> for conversion not found in file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conkey</span><span class="p">),</span> <span class="ne">UserWarning</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">element</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="n">name</span><span class="p">]):</span>
                <span class="n">mdata</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversions</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">element</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">remkey</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mdata</span><span class="p">[</span><span class="n">remkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="n">remkey</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1">#this will skip any unspecified string fields</span>
    <span class="k">return</span> <span class="n">mdata</span></div>

<div class="viewcode-block" id="writeJSONMetadata"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.writeJSONMetadata.html#spacepy.datamodel.writeJSONMetadata">[docs]</a><span class="k">def</span> <span class="nf">writeJSONMetadata</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">insd</span><span class="p">,</span> <span class="n">depend0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Scrape metadata from SpaceData object and make a JSON header</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to write to (can also use a file-like object)</span>
<span class="sd">        None can be given in conjunction with the returnString keyword to skip writing output</span>

<span class="sd">    insd : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    depend0 : str (optional)</span>
<span class="sd">        variable name to use to indicate parameter on which other data depend (e.g. Time)</span>
<span class="sd">    order : list (optional)</span>
<span class="sd">        list of key names in order of start column in output JSON file</span>
<span class="sd">    verbose: bool (optional)</span>
<span class="sd">        verbose output</span>
<span class="sd">    returnString: bool (optional)</span>
<span class="sd">        return JSON header as string instead of returning None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None  (unless returnString keyword is True)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">js_out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">stripNL</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1">#if required, identify depend0 for deciding what&#39;s data/metadata</span>
    <span class="k">if</span> <span class="n">depend0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#search for DEPEND_0 in metadata</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">insd</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;attrs&#39;</span><span class="p">):</span>
                <span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;DEPEND_0&#39;</span> <span class="ow">in</span> <span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">depend0</span> <span class="o">=</span> <span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depend0</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
                    <span class="c1">#assume it&#39;s a singleton list</span>
                    <span class="n">depend0</span> <span class="o">=</span> <span class="n">depend0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depend0</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
                    <span class="n">depend0</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#Failed to get a depend0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span> <span class="c1">#we&#39;re done here</span>
        <span class="k">if</span> <span class="n">depend0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#fall back to most common var length</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">keylist</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">list</span><span class="p">(</span><span class="n">insd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">depend0</span> <span class="o">=</span> <span class="n">keylist</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">())]</span>
            <span class="c1">#TODO Set using Time, or Epoch, or similar...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">depend0</span> <span class="ow">in</span> <span class="n">insd</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Invalid key supplied for ordering metadata on write&#39;</span><span class="p">)</span>
    <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">depend0</span><span class="p">])</span>

    <span class="c1">#start with global attrs</span>
    <span class="c1">#TODO: check for datetime objs in attributes</span>
    <span class="k">if</span> <span class="n">insd</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">glattr</span> <span class="o">=</span> <span class="n">_dateToISO</span><span class="p">(</span><span class="n">insd</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">glattr</span><span class="p">:</span>
            <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">glattr</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="c1">#TODO Mark these as global somehow (by omission of some metadata?)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="c1">#collect keys and put in order for output</span>
    <span class="c1">#TODO first check for extant START_COLUMN</span>
    <span class="c1">#then check dimensionality so that start column and dims can be added, if not present</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="n">order</span>
        <span class="c1">#now make sure that all missing keys are added to end</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">insd</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span> <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">##TODO do we want to have DEPEND0 first in order by default?</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">insd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
        <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">_dateToISO</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">datalen</span><span class="p">:</span> <span class="c1">#is data</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">]:</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;START_COLUMN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="s1">&#39;The data cannot be properly represented in JSON-headed ASCII as it has too high a rank</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="s1">&#39;key = </span><span class="si">{0}</span><span class="s1"> (</span><span class="si">{1}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">l3</span> <span class="o">=</span> <span class="s1">&#39;Maximum allowed number of dimensions is 2</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l3</span><span class="p">]),</span> <span class="n">DMWarning</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#AttrErr if just metadata</span>
                <span class="c1">#js_out[key][&#39;DIMENSION&#39;] = insd[key].attrs[&#39;DIMENSION&#39;]</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#is metadata</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metadata: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">_dateToISO</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;VALUES&#39;</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">js_out</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">js_out</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reob</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.*?\]&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">reob</span><span class="p">,</span> <span class="n">stripNL</span><span class="p">,</span> <span class="n">json_str</span><span class="p">)</span> <span class="c1">#put lists back onto one line</span>
    <span class="c1">#add comment field for header</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">json_str</span><span class="p">])</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">json_str</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">str_classes</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;writelines&#39;</span><span class="p">):</span>
        <span class="n">fname</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">returnString</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json_str</span>

    <span class="k">if</span> <span class="n">returnString</span><span class="p">:</span> <span class="k">return</span> <span class="n">json_str</span></div>


<span class="k">def</span> <span class="nf">_dateToISO</span><span class="p">(</span><span class="n">indict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    covert datetimes to iso strings inside of datamodel attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retdict</span> <span class="o">=</span> <span class="n">dmcopy</span><span class="p">(</span><span class="n">indict</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">indict</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                <span class="n">retdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">retdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">indict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                        <span class="n">retdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indict</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">retdict</span> <span class="o">=</span> <span class="n">retdict</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">indict</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">retdict</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">retdict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">indict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                    <span class="n">retdict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">retdict</span>


<div class="viewcode-block" id="toJSONheadedASCII"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.toJSONheadedASCII.html#spacepy.datamodel.toJSONheadedASCII">[docs]</a><span class="k">def</span> <span class="nf">toJSONheadedASCII</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">insd</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depend0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write JSON-headed ASCII file of data with metadata from SpaceData object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename to write to (can also use a file-like object)</span>
<span class="sd">        None can be given in conjunction with the returnString keyword to skip writing output</span>

<span class="sd">    insd : spacepy.datamodel.SpaceData</span>
<span class="sd">        SpaceData with associated attributes and variables in dmarrays</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    depend0 : str (optional)</span>
<span class="sd">        variable name to use to indicate parameter on which other data depend (e.g. Time)</span>
<span class="sd">    order : list (optional)</span>
<span class="sd">        list of key names in order of start column in output JSON file</span>
<span class="sd">    metadata: str or file-like (optional)</span>
<span class="sd">        filename with JSON header to use (or file-like with JSON metadata)</span>
<span class="sd">    delimiter: str</span>
<span class="sd">        delimiter to use in ASCII output (default is whitespace), for tab, use &#39;\t&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; data = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; data.attrs[&#39;Global&#39;] = &#39;A global attribute&#39;</span>
<span class="sd">    &gt;&gt;&gt; data[&#39;Var1&#39;] = dm.dmarray([1,2,3,4,5], attrs={&#39;Local1&#39;: &#39;A local attribute&#39;})</span>
<span class="sd">    &gt;&gt;&gt; data[&#39;Var2&#39;] = dm.dmarray([[8,9],[9,1],[3,4],[8,9],[7,8]])</span>
<span class="sd">    &gt;&gt;&gt; data[&#39;MVar&#39;] = dm.dmarray([7.8], attrs={&#39;Note&#39;: &#39;Metadata&#39;})</span>
<span class="sd">    &gt;&gt;&gt; dm.toJSONheadedASCII(&#39;outFile.txt&#39;, data, depend0=&#39;Var1&#39;, order=[&#39;Var1&#39;])</span>
<span class="sd">    #Note that not all field names are required, those not given will be listed</span>
<span class="sd">    #alphabetically after those that are specified</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kwarg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delimiter&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwarg_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwarg_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writeJSONMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">insd</span><span class="p">,</span> <span class="n">depend0</span><span class="o">=</span><span class="n">depend0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#rewind StringIO object to start</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">readJSONMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="n">datlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;START_COLUMN&#39;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="c1">#add to list of (start_col, keyname) pairs</span>
            <span class="n">datlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;START_COLUMN&#39;</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">hdr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DIMENSION&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1">#also use for data length</span>
            <span class="n">datlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">datlen</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No data present to write: Use writeJSONmetadata&#39;</span><span class="p">)</span>
                <span class="c1">#TODO: Set this to just default to writing the header out and raise a warning</span>
    <span class="n">datlist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">datlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">datlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#now open file (file-like) and for each line in len(data)</span>
    <span class="c1">#write the line using start_column, name, dimension</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">datlen</span><span class="p">,</span><span class="n">ncols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stcol</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">datlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[:,</span> <span class="n">stcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dateToISO</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[:,</span> <span class="n">stcol</span><span class="p">:</span><span class="n">stcol</span><span class="o">+</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dateToISO</span><span class="p">(</span><span class="n">insd</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">hdstr</span> <span class="o">=</span> <span class="n">writeJSONMetadata</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">depend0</span><span class="o">=</span><span class="n">depend0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">hdstr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">prline</span> <span class="o">=</span> <span class="n">kwarg_dict</span><span class="p">[</span><span class="s1">&#39;delimiter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prline</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="fromRecArray"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.fromRecArray.html#spacepy.datamodel.fromRecArray">[docs]</a><span class="k">def</span> <span class="nf">fromRecArray</span><span class="p">(</span><span class="n">recarr</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Takes a numpy recarray and returns each field as a dmarray in a SpaceData container</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    recarr : numpy record array</span>
<span class="sd">        object to parse into SpaceData container</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sd: spacepy.datamodel.SpaceData</span>
<span class="sd">        dict-like containing arrays of named records in recarr</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; x = np.array([(1.0, 2), (3.0, 4)], dtype=[(&#39;x&#39;, float), (&#39;y&#39;, int)])</span>
<span class="sd">    &gt;&gt;&gt; print(x, x.dtype)</span>
<span class="sd">    array([(1.0, 2), (3.0, 4)], dtype=[(&#39;x&#39;, &#39;&lt;f8&#39;), (&#39;y&#39;, &#39;&lt;i4&#39;)])</span>
<span class="sd">    &gt;&gt;&gt; sd = dm.fromRecArray(x)</span>
<span class="sd">    &gt;&gt;&gt; sd.tree(verbose=1)</span>
<span class="sd">    +</span>
<span class="sd">    |____x (spacepy.datamodel.dmarray (2,))</span>
<span class="sd">    |____y (spacepy.datamodel.dmarray (2,))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">recarr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">recarr</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sd</span></div>

<div class="viewcode-block" id="toRecArray"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.toRecArray.html#spacepy.datamodel.toRecArray">[docs]</a><span class="k">def</span> <span class="nf">toRecArray</span><span class="p">(</span><span class="n">sdo</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Takes a SpaceData and creates a numpy recarray</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sdo : SpaceData</span>
<span class="sd">        SpaceData to change to a numpy recarray</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    recarr: numpy record array</span>
<span class="sd">        numpy.recarray object with the same values (attributes are lost)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; sd = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; sd[&#39;x&#39;] = dm.dmarray([1.0, 2.0])</span>
<span class="sd">    &gt;&gt;&gt; sd[&#39;y&#39;] = dm.dmarray([2,4])</span>
<span class="sd">    &gt;&gt;&gt; sd.tree(verbose=1)</span>
<span class="sd">    +</span>
<span class="sd">    |____x (spacepy.datamodel.dmarray (2,))</span>
<span class="sd">    |____y (spacepy.datamodel.dmarray (2,))</span>
<span class="sd">    &gt;&gt;&gt; ra = dm.toRecArray(sd)</span>
<span class="sd">    &gt;&gt;&gt; print(ra, ra.dtype)</span>
<span class="sd">    [(2, 1.0) (4, 2.0)] (numpy.record, [(&#39;y&#39;, &#39;&lt;i8&#39;), (&#39;x&#39;, &#39;&lt;f8&#39;)])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nametype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">sdo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sdo</span><span class="p">])</span>
    <span class="n">recarr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span> <span class="p">[</span><span class="n">sdo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sdo</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">nametype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">recarr</span></div>


<div class="viewcode-block" id="dmcopy"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.dmcopy.html#spacepy.datamodel.dmcopy">[docs]</a><span class="k">def</span> <span class="nf">dmcopy</span><span class="p">(</span><span class="n">dobj</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic copy utility to return a copy of a (datamodel) object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dobj : object</span>
<span class="sd">        object to return a copy of</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    copy_obj: object (same type as input)</span>
<span class="sd">        copy of input oibject</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; dat = dm.dmarray([2,3], attrs={&#39;units&#39;: &#39;T&#39;})</span>
<span class="sd">    &gt;&gt;&gt; dat1 = dm.dmcopy(dat)</span>
<span class="sd">    &gt;&gt;&gt; dat1.attrs[&#39;copy&#39;: True]</span>
<span class="sd">    &gt;&gt;&gt; dat is dat1</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; dat1.attrs</span>
<span class="sd">    {&#39;copy&#39;: True, &#39;units&#39;: &#39;T&#39;}</span>
<span class="sd">    &gt;&gt;&gt; dat.attrs</span>
<span class="sd">    {&#39;units&#39;: &#39;T&#39;}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dobj</span><span class="p">,</span> <span class="p">(</span><span class="n">SpaceData</span><span class="p">,</span> <span class="n">dmarray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dobj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dobj</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dobj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dobj</span><span class="p">)</span></div>

<div class="viewcode-block" id="createISTPattrs"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.createISTPattrs.html#spacepy.datamodel.createISTPattrs">[docs]</a><span class="k">def</span> <span class="nf">createISTPattrs</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vartype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">NRV</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return set of unpopulated attributes for ISTP compliant variable</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datatype : {&#39;data&#39;, &#39;support_data&#39;, &#39;metadata&#39;}</span>
<span class="sd">        datatype of variable to create metadata for.</span>
<span class="sd">    ndims : int</span>
<span class="sd">        number of dimensions, default=1</span>
<span class="sd">    vartype : {&#39;float&#39;, &#39;char&#39;, &#39;int&#39;, &#39;epoch&#39;, &#39;tt2000&#39;}</span>
<span class="sd">        The type of the variable, default=float</span>
<span class="sd">    units : str</span>
<span class="sd">        The units of the variable, default=&#39; &#39;</span>
<span class="sd">    NRV : bool</span>
<span class="sd">        Is the variable NRV (non-record varying), default=False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    attrs : dict</span>
<span class="sd">        dictionary of attributes for the variable</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; dm.createISTPattrs(&#39;data&#39;, ndims=2, vartype=&#39;float&#39;, units=&#39;MeV&#39;)</span>
<span class="sd">    {&#39;CATDESC&#39;: &#39;&#39;,</span>
<span class="sd">     &#39;DISPLAY_TYPE&#39;: &#39;spectrogram&#39;,</span>
<span class="sd">     &#39;FIELDNAM&#39;: &#39;&#39;,</span>
<span class="sd">     &#39;FILLVAL&#39;: -1e+31,</span>
<span class="sd">     &#39;FORMAT&#39;: &#39;F18.6&#39;,</span>
<span class="sd">     &#39;LABLAXIS&#39;: &#39;&#39;,</span>
<span class="sd">     &#39;SI_CONVERSION&#39;: &#39; &gt; &#39;,</span>
<span class="sd">     &#39;UNITS&#39;: &#39;MeV&#39;,</span>
<span class="sd">     &#39;VALIDMIN&#39;: &#39;&#39;,</span>
<span class="sd">     &#39;VALIDMAX&#39;: &#39;&#39;,</span>
<span class="sd">     &#39;VAR_TYPE&#39;: &#39;data&#39;,</span>
<span class="sd">     &#39;DEPEND_0&#39;: &#39;Epoch&#39;,</span>
<span class="sd">     &#39;DEPEND_1&#39;: &#39;&#39;}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fillvals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1e31</span><span class="p">,</span>
                <span class="s1">&#39;char&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483648</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0E31</span><span class="p">,</span> <span class="c1">#datetime.datetime(9999,12,31,23,59,59,999)}</span>
                <span class="s1">&#39;tt2000&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)}</span>
    <span class="n">formats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="s1">&#39;F18.6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;char&#39;</span><span class="p">:</span> <span class="s1">&#39;A30&#39;</span><span class="p">,</span>
               <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="s1">&#39;I11&#39;</span><span class="p">,</span>
               <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="s1">&#39;tt2000&#39;</span><span class="p">:</span> <span class="s1">&#39;I21&#39;</span><span class="p">}</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;time_series&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">vartype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fillvals</span><span class="p">:</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e31</span>
        <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;F15.6&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="n">fillvals</span><span class="p">[</span><span class="n">vartype</span><span class="p">]</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">vartype</span><span class="p">]</span>

    <span class="n">unit</span> <span class="o">=</span> <span class="n">units</span>

    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CATDESC&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DISPLAY_TYPE&#39;</span><span class="p">:</span> <span class="n">disp</span><span class="p">[</span><span class="n">ndims</span><span class="p">],</span>
            <span class="s1">&#39;FIELDNAM&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FILLVAL&#39;</span><span class="p">:</span> <span class="n">fill</span><span class="p">,</span>
            <span class="s1">&#39;FORMAT&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;LABLAXIS&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SI_CONVERSION&#39;</span><span class="p">:</span> <span class="s1">&#39; &gt; &#39;</span><span class="p">,</span>
            <span class="s1">&#39;UNITS&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;VALIDMIN&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;VALIDMAX&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;VAR_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Epoch&#39;</span>
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;support_data&#39;</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CATDESC&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FIELDNAM&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FORMAT&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;UNITS&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;VAR_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;support_data&#39;</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NRV</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMAX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Epoch&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CATDESC&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FIELDNAM&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FORMAT&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;UNITS&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;VAR_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;metadata&#39;</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NRV</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Epoch&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid datatype (data|support_data|metadata)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">attrs</span></div>

<span class="k">def</span> <span class="nf">_getVarLengths</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get the length of all the variables</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : SpaceData</span>
<span class="sd">        SpaceData object to return the length of the variables</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : dict</span>
<span class="sd">        dict of the names and lengths of a SpaceData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ans</span>

<div class="viewcode-block" id="resample"><a class="viewcode-back" href="../../autosummary/spacepy.datamodel.resample.html#spacepy.datamodel.resample">[docs]</a><span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="p">[],</span> <span class="n">winsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">st_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outtimename</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    resample a SpaceData to a new time interval</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : SpaceData or dmarray</span>
<span class="sd">        SpaceData with data to resample or dmarray with data to resample,</span>
<span class="sd">        variables can only be 1d or 2d, if time is specified only variables</span>
<span class="sd">        the same length as time are resampled, otherwise only variables</span>
<span class="sd">        with length equal to the longest length are resampled</span>

<span class="sd">    time : array-like</span>
<span class="sd">        dmarray of times the correspond to the data</span>

<span class="sd">    winsize : datetime.timedelta</span>
<span class="sd">        Time frame to average the data over</span>

<span class="sd">    overlap : datetime.timedelta</span>
<span class="sd">        Overlap in the moving average</span>

<span class="sd">    st_time : datetime.datetime</span>
<span class="sd">        Starting time for the resample, if not specified the time of the first</span>
<span class="sd">        data point is used (see spacepy.toolbox.windowMean)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ans : SpaceData </span>
<span class="sd">        Resampled data, included keys are in the input keys (with the data caveats above)</span>
<span class="sd">        and Epoch which contains the output time</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import datetime</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.datamodel as dm</span>
<span class="sd">    &gt;&gt;&gt; a = dm.SpaceData()</span>
<span class="sd">    &gt;&gt;&gt; a.attrs[&#39;foo&#39;] = &#39;bar&#39;</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;a&#39;] = dm.dmarray(range(10*2)).reshape(10,2)</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;b&#39;] = dm.dmarray(range(10)) + 4</span>
<span class="sd">    &gt;&gt;&gt; a[&#39;c&#39;] = dm.dmarray(range(3)) + 10</span>
<span class="sd">    &gt;&gt;&gt; times = [datetime.datetime(2010, 1, 1) + datetime.timedelta(hours=i) for i in range(10)]</span>
<span class="sd">    &gt;&gt;&gt; out = dm.resample(a, times, winsize=datetime.timedelta(hours=2), overlap=datetime.timedelta(hours=0))</span>
<span class="sd">    &gt;&gt;&gt; out.tree(verbose=1, attrs=1)</span>
<span class="sd">    # +</span>
<span class="sd">    # :|____foo (str [3])</span>
<span class="sd">    # |____Epoch (spacepy.datamodel.dmarray (4,))</span>
<span class="sd">    # |____a (spacepy.datamodel.dmarray (4, 2))</span>
<span class="sd">    # :|____DEPEND_0 (str [5])</span>
<span class="sd">    #</span>
<span class="sd">    # Things to note:</span>
<span class="sd">    #    - attributes are preserved</span>
<span class="sd">    #    - the output variables have their DEPEND_0 changed to Epoch (or outtimename)</span>
<span class="sd">    #    - each dimension of a 2d array is resampled individually </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">toolbox</span>
    <span class="c1"># check for SpaceData or dmarray input before going to a bunch of work</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">SpaceData</span><span class="p">,</span> <span class="n">dmarray</span><span class="p">)):</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must be a SpaceData or dmarray object&#39;</span><span class="p">))</span>

    <span class="c1"># can only resample variables that have the same length as time,</span>
    <span class="c1">#    if time is default then use all the vals that are the same</span>
    <span class="c1">#    as the longest var</span>
    <span class="n">lent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]))])</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="n">lent</span><span class="p">]</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
    <span class="c1"># what time are we starting at?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t_int</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">UTC</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">t_int</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_int</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="p">((</span><span class="n">st_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_int</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)):</span>
        <span class="n">st_time</span> <span class="o">=</span> <span class="n">t_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">ans</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span>
    
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Variables can only be 1d or 2d&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">d</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">windowMean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][:,</span><span class="n">i</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="n">t_int</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="n">winsize</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">st_time</span><span class="o">=</span><span class="n">st_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">:</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
            <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">windowMean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">time</span><span class="o">=</span><span class="n">t_int</span><span class="p">,</span> <span class="n">winsize</span><span class="o">=</span><span class="n">winsize</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">st_time</span><span class="o">=</span><span class="n">st_time</span><span class="p">)</span>
            <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1"># was not a dmarray</span>
            <span class="k">pass</span>
        <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outtimename</span>
    <span class="n">ans</span><span class="p">[</span><span class="n">outtimename</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">ans</span></div>


    
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" >spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.datamodel</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0.
    </div>
  </body>
</html>