
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.ctrans &#8212; SpacePy v0.4.0 Manual</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" accesskey="U">spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.ctrans</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.ctrans</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;CTrans: Module for backend coordinate transformations in SpacePy</span>

<span class="sd">This module is primarily intended to provide a backend for the standard</span>
<span class="sd">:class:`~spacepy.coordinates.Coords` class rather than direct use, and the</span>
<span class="sd">interface is subject to change.</span>

<span class="sd">The :class:`CTrans` class calculates all of the necessary information</span>
<span class="sd">to convert between different coordinate systems *at a single time*. By</span>
<span class="sd">using :class:`~spacepy.coordinates.Coords` the handling of multiple</span>
<span class="sd">times is built in, and the calling syntax is backwards compatible with</span>
<span class="sd">the legacy IRBEM-backed coordinate transforms.</span>

<span class="sd">Coordinate systems supported by this module can broadly be described</span>
<span class="sd">by two categories. The first category is a broad set of Earth-centered</span>
<span class="sd">coordinate systems that are specified by astronomical parameters.</span>
<span class="sd">If we consider the International Celestial Reference Frame to be our</span>
<span class="sd">starting point, then taking the origin as the center of the Earth</span>
<span class="sd">instead of the solar barycenter gives us the Geocentric Celestial</span>
<span class="sd">Reference Frame (GCRF). All coordinate systems described here are</span>
<span class="sd">right-handed Cartesian systems, except geodetic.</span>

<span class="sd">Systems and their relationships:</span>

<span class="sd">- ECI2000: Earth-Centered Inertial, J2000 epoch</span>
<span class="sd">    This system can be considered equivalent to the GCRF, to within 10s</span>
<span class="sd">    of milliarcseconds. The z-axis is aligned with the mean celestial pole</span>
<span class="sd">    at the J2000 epoch. The x-axis is aligned with the mean equinox at the</span>
<span class="sd">    J2000 epoch. The y-axis completes and lies in the plane of the</span>
<span class="sd">    celestial equator.</span>
<span class="sd">- ECIMOD: Earth-Centered Inertial, Mean-of-Date</span>
<span class="sd">    This system accounts for precession between the J2000 epoch and the</span>
<span class="sd">    date of interest: The coordinate system is time-dependent. The system</span>
<span class="sd">    is defined similarly to ECI2000, but uses the mean equinox and mean</span>
<span class="sd">    equator of the date of interest.</span>
<span class="sd">- ECITOD: Earth-Centered Inertial, True-of-Date</span>
<span class="sd">    This system builds on ECIMOD and accounts for the nutation (the short-</span>
<span class="sd">    period perturbations on the precession). This system is therefore</span>
<span class="sd">    considered to use the true equator and true equinox of date.</span>
<span class="sd">- TEME: Earth-Centered Inertial, True Equator Mean Equinox</span>
<span class="sd">    This system is poorly defined in the literature, despite being used in</span>
<span class="sd">    the SGP4 orbital propagator (note that multiple versions of SGP4 exist,</span>
<span class="sd">    see e.g. Vallado et al. 2006; AIAA 2006-6753-Rev2). The mean equinox here</span>
<span class="sd">    is not the same as the mean equinox used in, e.g., ECIMOD, but lies along</span>
<span class="sd">    the true equator between the origin of the Pseudo Earth Fixed and ECITOD</span>
<span class="sd">    frames. It is highly recommended that TEME coordinates are converted to a</span>
<span class="sd">    standard system (e.g., ECI2000) before passing to other users or to</span>
<span class="sd">    different software.</span>
<span class="sd">- GSE: Geocentric Solar Ecliptic</span>
<span class="sd">    This system is not inertial. It is Earth-centered, with the x-axis</span>
<span class="sd">    pointing towards the Sun. The y-axis lies in the mean ecliptic plane</span>
<span class="sd">    of date, pointing in the anti-orbit direction. The z-axis is parallel</span>
<span class="sd">    to the mean ecliptic pole.</span>
<span class="sd">- GEO: Geocentric Geographic</span>
<span class="sd">    This system is not inertial. It is Earth-Centered and Earth-Fixed (also</span>
<span class="sd">    called ECEF), so that the coordinates of a point fixed on (or relative</span>
<span class="sd">    to) the surface of the Earth do not change. The x-axis lies in the</span>
<span class="sd">    Earth&#39;s equatorial plane (zero latitude) and intersects the Prime</span>
<span class="sd">    Meridian (zero longitude; Greenwich, UK). The z-axis points to True</span>
<span class="sd">    North (which is roughly aligned with the instantaneous rotation axis).</span>
<span class="sd">- GDZ: Geodetic</span>
<span class="sd">    This system is not inertial and is defined in terms of altitude above</span>
<span class="sd">    a reference ellipsoid, the geodetic latitude, and geodetic longitude.</span>
<span class="sd">    Geodetic longitude is identical to GEO longitude. Both the altitude</span>
<span class="sd">    and latitude depend on the ellipsoid used. While geodetic latitude is</span>
<span class="sd">    close to geographic latitude, they are not the same. The default here is</span>
<span class="sd">    to use the WGS84 reference ellipsoid.</span>

<span class="sd">The remaining coordinate systems are also reference to Earth&#39;s magnetic field.</span>
<span class="sd">Different versions of these systems exist, but the most common (and those given</span>
<span class="sd">here) use a centered dipole axis.</span>

<span class="sd">- GSM: Geocentric Solar Magnetospheric</span>
<span class="sd">    This system is similar to GSE, but is defined such that the centered dipole</span>
<span class="sd">    lies in the x-z plane. As in all of these systems, z is positive northward.</span>
<span class="sd">    The y-axis is thus perpendicular to both the Sun-Earth line and the</span>
<span class="sd">    centered dipole axis (of date, defined using the first 3 coefficients of the</span>
<span class="sd">    IGRF/DGRF). GSM is therefore a rotation about the x-axis from the GSE system.</span>
<span class="sd">- SM: Solar Magnetic</span>
<span class="sd">    The z-axis is aligned with the centered dipole axis of date (positive</span>
<span class="sd">    northward), and the y-axis is perpendicular to both the Sun-Earth line and</span>
<span class="sd">    the dipole axis. As with GSE and GSM, y is positive in the anti-orbit</span>
<span class="sd">    direction. The x-axis therefore is not aligned with the Sun-Earth line and</span>
<span class="sd">    SM is a rotation about the y-axis from the GSM system.</span>
<span class="sd">- CDMAG: Geomagnetic</span>
<span class="sd">    This is a geomagnetic analog of the GEO system. The z-axis is aligned with</span>
<span class="sd">    the centered dipole axis of date. The y-axis is perpendicular to</span>
<span class="sd">    to both the dipole axis and True North, i.e., y is the cross product of</span>
<span class="sd">    the z-axis of the GEO system with the dipole axis. The x-axis completes.</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :template: clean_class.rst</span>
<span class="sd">    :toctree: autosummary</span>

<span class="sd">    CTrans</span>
<span class="sd">    Ellipsoid</span>

<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :template: clean_function.rst</span>
<span class="sd">    :toctree: autosummary</span>

<span class="sd">    convert_multitime</span>
<span class="sd">    gdz_to_geo</span>
<span class="sd">    geo_to_gdz</span>
<span class="sd">    geo_to_rll</span>
<span class="sd">    rll_to_geo</span>

<span class="sd">Submodules</span>
<span class="sd">----------</span>
<span class="sd">.. autosummary::</span>
<span class="sd">    :template: clean_module.rst</span>
<span class="sd">    :toctree: autosummary</span>

<span class="sd">    iau80n</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__contact__</span> <span class="o">=</span> <span class="s1">&#39;Steve Morley, smorley@lanl.gov&#39;</span>


<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">fmod</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span>

<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">datamodel</span> <span class="k">as</span> <span class="n">dm</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">spt</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">igrf</span>


<div class="viewcode-block" id="Ellipsoid"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.Ellipsoid.html#spacepy.ctrans.Ellipsoid">[docs]</a><span class="k">class</span> <span class="nc">Ellipsoid</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ellipsoid definition class for geodetic coordinates</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name for ellipsoid, stored in attrs of returned Ellipsoid instance.</span>
<span class="sd">        Default is &#39;WGS84&#39;</span>
<span class="sd">    A : float</span>
<span class="sd">        Semi-major axis (equatorial radius) of ellipsoid in km.</span>
<span class="sd">        Default is 6378.137km (WGS84_A)</span>
<span class="sd">    iFlat : float</span>
<span class="sd">        Inverse flattening of ellipsoid. Default is WGS84 value</span>
<span class="sd">        of 298.257223563.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : Ellipsoid</span>
<span class="sd">        Ellipsoid instance storing all relevant paramters for geodetic conversion</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. versionadded:: 0.3.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">6378.137</span><span class="p">,</span> <span class="n">iFlat</span><span class="o">=</span><span class="mf">298.257223563</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Ellipsoid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">iFlat</span><span class="o">=</span><span class="n">iFlat</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># [km^2]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Flat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;iFlat&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Flat&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Flat&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;E4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;1mE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;1mE2&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># [km^2]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A2mB2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span>  <span class="c1"># [km^2]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EP2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;A2mB2&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span>  <span class="c1"># 2nd eccentricity squared</span></div>


<span class="c1"># World Geodetic System 1984 (WGS84) parameters</span>
<span class="n">WGS84</span> <span class="o">=</span> <span class="n">Ellipsoid</span><span class="p">()</span>

<span class="n">magsys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;SM&#39;</span><span class="p">,</span> <span class="s1">&#39;CDMAG&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="CTrans"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans">[docs]</a><span class="k">class</span> <span class="nc">CTrans</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coordinate transformation class for a single instance in time</span>

<span class="sd">    A general coordinate conversion routine, which takes a numpy array (Nx3)</span>
<span class="sd">    of Cartesian vectors along with the names of the input and output</span>
<span class="sd">    coordinate systems and returns an array of the converted coordinates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ctime : (spacepy.time.Ticktock, datetime, float, string)</span>
<span class="sd">        Input time stamp. Must have one time only. Accepted input formats</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : CTrans</span>
<span class="sd">        instance with self.convert, etc.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    ephmodel : str, optional</span>
<span class="sd">        Select ephemerides model (e.g., for determining Sun direction).</span>
<span class="sd">        Currently only &#39;LGMDEFAULT&#39; is supported, for consistency with</span>
<span class="sd">        LANLGeoMag implementation.</span>
<span class="sd">    pnmodel : str, optional</span>
<span class="sd">        Select precession/nutation model set. Options are: &#39;IAU82&#39; (default),</span>
<span class="sd">        and &#39;IAU00&#39;.</span>
<span class="sd">    eop : bool, optional</span>
<span class="sd">        Use Earth Orientation Parameters</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    spacepy.coordinates.Coords</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. versionadded:: 0.3.0</span>


<span class="sd">    .. rubric:: Methods</span>

<span class="sd">    .. autosummary::</span>

<span class="sd">        ~CTrans.calcTimes</span>
<span class="sd">        ~CTrans.calcOrbitParams</span>
<span class="sd">        ~CTrans.calcCoreTransforms</span>
<span class="sd">        ~CTrans.calcMagTransforms</span>
<span class="sd">        ~CTrans.convert</span>
<span class="sd">        ~CTrans.getEOP</span>
<span class="sd">        ~CTrans.gmst</span>

<span class="sd">    .. automethod:: calcTimes</span>
<span class="sd">    .. automethod:: calcOrbitParams</span>
<span class="sd">    .. automethod:: calcCoreTransforms</span>
<span class="sd">    .. automethod:: calcMagTransforms</span>
<span class="sd">    .. automethod:: convert</span>
<span class="sd">    .. automethod:: getEOP</span>
<span class="sd">    .. automethod:: gmst</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span> <span class="n">ephmodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pnmodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CTrans</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ephmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s1">&#39;ephmodel&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ephmodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LGMDEFAULT&#39;</span>
        <span class="k">if</span> <span class="n">pnmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pnmodel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IAU82&#39;</span><span class="p">,</span> <span class="s1">&#39;IAU00&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s1">&#39;pnmodel&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pnmodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnmodel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pnmodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;IAU82&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">):</span>
            <span class="c1"># input time is ticktock</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Input time is Ticktock, but has a length &gt; 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;time_in&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># Input time is datetime</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ctime</span> <span class="o">=</span> <span class="n">ctime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ctime</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span>  <span class="c1"># Guess dtype</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;time_in&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s1">&#39;time_in&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span>

        <span class="c1"># Make key information immutable, but referenced by name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Constants&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;twopi, j2000_jd, j1900_jd, &#39;</span> <span class="o">+</span>
                                                            <span class="s1">&#39;j1990_jd, daysec, daycentury, &#39;</span> <span class="o">+</span>
                                                            <span class="s1">&#39;arcsec, AU, Re&#39;</span><span class="p">,</span>
                                                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">[</span><span class="s1">&#39;eop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;DUT1, xp, yp, ddPsi, ddEps&#39;</span><span class="p">,</span>
                                                      <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setconstants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getEOP</span><span class="p">(</span><span class="n">useEOP</span><span class="o">=</span><span class="n">eop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;orbital&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;transformCore&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;transformMag&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;timeInProgress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;coreInProgress&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="s1">&#39;useEOP&#39;</span><span class="p">:</span> <span class="n">eop</span>
                         <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_setconstants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set constants to be used in calculations</span>

<span class="sd">        Constants set through this method are immutable to ensure</span>
<span class="sd">        consistency in calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">](</span><span class="n">twopi</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
                                                       <span class="n">j2000_jd</span><span class="o">=</span><span class="mf">2451545.0</span><span class="p">,</span>
                                                       <span class="n">j1990_jd</span><span class="o">=</span><span class="mf">2447891.5</span><span class="p">,</span>
                                                       <span class="n">j1900_jd</span><span class="o">=</span><span class="mf">2415020.0</span><span class="p">,</span>
                                                       <span class="n">daysec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
                                                       <span class="n">daycentury</span><span class="o">=</span><span class="mf">36525.0</span><span class="p">,</span>
                                                       <span class="n">arcsec</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
                                                       <span class="n">AU</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">au</span><span class="o">/</span><span class="mf">1e3</span><span class="p">,</span>  <span class="c1"># 1AU in km</span>
                                                       <span class="n">Re</span><span class="o">=</span><span class="n">WGS84</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>  <span class="c1"># WGS84_A radius in km</span>
                                                       <span class="p">)</span>

<div class="viewcode-block" id="CTrans.getEOP"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.getEOP">[docs]</a>    <span class="k">def</span> <span class="nf">getEOP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">useEOP</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get/set Earth Orientation Parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        useEOP : bool</span>
<span class="sd">            If True, use Earth Orientation Parameters. Default False.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Currently Earth Orientation Parameters are all set to zero.</span>
<span class="sd">        Use is not yet supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useEOP</span><span class="p">:</span>
            <span class="c1"># DUT1 in seconds</span>
            <span class="c1"># xp, yp in arcseconds</span>
            <span class="c1"># ddPsi and ddEps in arcseconds</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">[</span><span class="s1">&#39;eop&#39;</span><span class="p">](</span><span class="n">DUT1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">xp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">yp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">ddPsi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">ddEps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: These case still be set manually by directly calling the</span>
            <span class="c1"># factory method.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s1">&#39;eop&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CTrans.calcTimes"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.calcTimes">[docs]</a>    <span class="k">def</span> <span class="nf">calcTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate time in systems required to set up coordinate transforms</span>

<span class="sd">        Sets Julian Date and Julian centuries in UTC, TAI, UT1, and TT systems.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recalc : bool, optional</span>
<span class="sd">            If True, recalculate the times for coordinate transformation. Default</span>
<span class="sd">            is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Set up various time systems required and variable shortcuts</span>
        <span class="n">eop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span>
        <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>

        <span class="c1"># UT1</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC_JD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">JD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC_JC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j2000_jd</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daycentury</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TAI_JD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">_days1958</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">TAI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">leaps</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2436205.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;useEOP&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">eop</span><span class="o">.</span><span class="n">DUT1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">JD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no EOP, so UT1 = UTC and we can save time recalculating times</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC_JD&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j2000_jd</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daycentury</span>

        <span class="c1"># Terrestrial Time in Julian centuries since J2000</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TAI_JD&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">32.184</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daysec</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j2000_jd</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daycentury</span>

        <span class="c1"># Greenwich Mean Sidereal Time</span>
        <span class="k">if</span> <span class="s1">&#39;from_gmst&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;timeInProgress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gmst</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;timeInProgress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CTrans.calcOrbitParams"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.calcOrbitParams">[docs]</a>    <span class="k">def</span> <span class="nf">calcOrbitParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Earth orbit parameters needed for coordinate transforms</span>

<span class="sd">        Calculates  Earth&#39;s orbital parameters required for defining coordinate</span>
<span class="sd">        system transformations, such as orbital eccentricity, the obliquity of</span>
<span class="sd">        the ecliptic, anomalies, and precession angles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recalc : bool, optional</span>
<span class="sd">            If True, recalculate the orbital parameters for coordinate transformation.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">recalc</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcTimes</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="n">recalc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;orbital&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recalc</span><span class="p">:</span>
            <span class="c1"># Don&#39;t recalculate unless it&#39;s asked for</span>
            <span class="k">return</span>
        <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span>

        <span class="c1"># Julian centuries with 1900 reference epoch</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;JulianCenturies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j1900_jd</span><span class="p">)</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daycentury</span>
        <span class="n">TU</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;JulianCenturies&#39;</span><span class="p">]</span>  <span class="c1"># since 1900</span>
        <span class="n">TU2</span> <span class="o">=</span> <span class="n">TU</span><span class="o">*</span><span class="n">TU</span>

        <span class="c1"># Orbital parameters required for later use</span>
        <span class="c1"># self[&#39;MeanEclipticLongitude&#39;] = np.deg2rad(279.6966778 + 36000.76892*TU</span>
        <span class="c1">#                                            + 0.0003025*TU2)</span>
        <span class="c1"># self[&#39;EclipticLongitudePerigee&#39;] = np.deg2rad(281.2208444 + 1.719175*TU</span>
        <span class="c1">#                                               + 0.000452778*TU2)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Eccentricity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01675104</span> <span class="o">-</span> <span class="mf">0.0000418</span><span class="o">*</span><span class="n">TU</span> <span class="o">-</span> <span class="mf">0.000000126</span><span class="o">*</span><span class="n">TU2</span>
        <span class="n">TT</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JC&#39;</span><span class="p">]</span>  <span class="c1"># in Julian century (J2000) format</span>
        <span class="n">TT2</span> <span class="o">=</span> <span class="n">TT</span><span class="o">*</span><span class="n">TT</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">84381.448</span> <span class="o">-</span> <span class="mf">46.8150</span><span class="o">*</span><span class="n">TT</span>\
            <span class="o">-</span> <span class="mf">0.00059</span><span class="o">*</span><span class="n">TT2</span> <span class="o">+</span> <span class="mf">0.001813</span><span class="o">*</span><span class="n">TT2</span><span class="o">*</span><span class="n">TT</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic&#39;</span><span class="p">]</span>

        <span class="c1"># Anomalies</span>
        <span class="n">days_since_1990</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j1990_jd</span>
        <span class="n">varep90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">279.403303</span><span class="p">)</span>
        <span class="n">varpi90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">282.768422</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">((</span><span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="o">/</span><span class="mf">365.242191</span><span class="o">*</span><span class="n">days_since_1990</span><span class="p">),</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;MeanAnomaly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">((</span><span class="n">M</span> <span class="o">+</span> <span class="n">varep90</span> <span class="o">-</span> <span class="n">varpi90</span><span class="p">),</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="p">)</span>
        <span class="n">ecc_anom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kepler</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;MeanAnomaly&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Eccentricity&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TrueAnomaly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Eccentricity&#39;</span><span class="p">])</span>
                                            <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Eccentricity&#39;</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">ecc_anom</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;LambdaSun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TrueAnomaly&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">varpi90</span><span class="p">),</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OmegaMoon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmod</span><span class="p">((</span><span class="mf">125.04455501</span> <span class="o">-</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">360</span> <span class="o">+</span> <span class="mf">134.1361851</span><span class="p">)</span><span class="o">*</span><span class="n">TT</span>
                                 <span class="o">+</span> <span class="mf">0.0020756</span><span class="o">*</span><span class="n">TT2</span> <span class="o">+</span> <span class="mf">2.139e-6</span><span class="o">*</span><span class="n">TT2</span><span class="o">*</span><span class="n">TT</span><span class="p">),</span> <span class="mf">360.0</span><span class="p">)</span>  <span class="c1"># degrees</span>

        <span class="c1"># Precession angles in degrees</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionZeta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.6406161</span><span class="o">*</span><span class="n">TT</span> <span class="o">+</span> <span class="mf">0.0000839</span><span class="o">*</span><span class="n">TT2</span> <span class="o">+</span> <span class="mf">5.0e-6</span><span class="o">*</span><span class="n">TT2</span><span class="o">*</span><span class="n">TT</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionZee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.6406161</span><span class="o">*</span><span class="n">TT</span> <span class="o">+</span> <span class="mf">0.0003041</span><span class="o">*</span><span class="n">TT2</span> <span class="o">+</span> <span class="mf">5.1e-6</span><span class="o">*</span><span class="n">TT2</span><span class="o">*</span><span class="n">TT</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionTheta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5567530</span><span class="o">*</span><span class="n">TT</span> <span class="o">-</span> <span class="mf">0.0001185</span><span class="o">*</span><span class="n">TT2</span> <span class="o">-</span> <span class="mf">1.16e-5</span><span class="o">*</span><span class="n">TT2</span><span class="o">*</span><span class="n">TT</span>

        <span class="c1"># Nutation terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcNutation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;orbital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_calcNutation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nTerms</span><span class="o">=</span><span class="mi">106</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate nutation-related quantities</span>

<span class="sd">        Calculates nutation parameters, equation of equinoxes,</span>
<span class="sd">        true obliquity of the ecliptic, and updates object values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get dPSi and dEps in arcsec</span>
        <span class="n">dPsi</span><span class="p">,</span> <span class="n">dEps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nutation</span><span class="p">(</span><span class="n">nTerms</span><span class="o">=</span><span class="n">nTerms</span><span class="p">)</span>  <span class="c1"># default 106-term nutation series</span>
        <span class="c1"># Now apply EOP corrections</span>
        <span class="n">dPsi</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ddPsi</span>
        <span class="n">dEps</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ddEps</span>
        <span class="c1"># Equation of the equinoxes</span>
        <span class="n">omegamoon_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OmegaMoon&#39;</span><span class="p">])</span>
        <span class="n">EquatEquin</span> <span class="o">=</span> <span class="n">dPsi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">])</span> \
            <span class="o">+</span> <span class="mf">0.00264</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omegamoon_rad</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">0.000063</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">omegamoon_rad</span><span class="p">)</span>  <span class="c1"># arcsec</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EquatEquin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EquatEquin</span>
        <span class="c1"># true obliquity of ecliptic</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityTrue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dEps</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic&#39;</span><span class="p">]</span>  <span class="c1"># arcsec</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityTrue_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityTrue&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dPsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dPsi</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dEps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dEps</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normVec</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalize input vector&quot;&quot;&quot;</span>
        <span class="n">tmpmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">/=</span> <span class="n">tmpmag</span>

    <span class="k">def</span> <span class="nf">_nutation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nTerms</span><span class="o">=</span><span class="mi">106</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate nutation terms dPsi and dEps&quot;&quot;&quot;</span>
        <span class="n">pnmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pnmodel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pnmodel</span> <span class="o">==</span> <span class="s1">&#39;IAU82&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Only the IAU1980 nutation model is currently implemented. &#39;</span>
                          <span class="o">+</span> <span class="s1">&#39;This will be used with the selected precession model.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">iau80n</span>
            <span class="n">dPsi</span><span class="p">,</span> <span class="n">dEps</span> <span class="o">=</span> <span class="n">iau80n</span><span class="o">.</span><span class="n">nutation</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JC&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">],</span> <span class="n">nTerms</span><span class="p">)</span>
        <span class="c1"># TODO: look at implementing IAU2000 as well</span>
        <span class="c1">#       See p88 onwards of USNO circular 179, for the coefficients.</span>
        <span class="c1">#       That has 1365 terms, and we&#39;ll likely want to have the default number evaluated</span>
        <span class="c1">#       set much lower.</span>
        <span class="c1">#       The equations are p45-48 of the same reference</span>
        <span class="k">return</span> <span class="n">dPsi</span><span class="p">,</span> <span class="n">dEps</span>

<div class="viewcode-block" id="CTrans.calcCoreTransforms"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.calcCoreTransforms">[docs]</a>    <span class="k">def</span> <span class="nf">calcCoreTransforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate core coordinate transform matrices</span>

<span class="sd">        These coordinate systems do not require information about</span>
<span class="sd">        Earth&#39;s magnetic field.</span>
<span class="sd">        The systems are:</span>
<span class="sd">        Earth-Centered Inertial, J2000 (ECI2000)</span>
<span class="sd">        Earth-Centered Inertial, Mean-of-date (ECIMOD)</span>
<span class="sd">        Earth-Centered Inertial, True-of-date (ECITOD)</span>
<span class="sd">        Geocentric Solar Ecliptic (GSE)</span>
<span class="sd">        Geocentric Geographic (GEO)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recalc : bool, optional</span>
<span class="sd">            If True, recalculate the core (non-magnetic) coordinate transformations.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;orbital&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">recalc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcOrbitParams</span><span class="p">(</span><span class="n">recalc</span><span class="o">=</span><span class="n">recalc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recalc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;transformCore&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
        <span class="c1"># ECI J2000 to ECI Mean of Date, and inverse</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionZeta&#39;</span><span class="p">])</span>
        <span class="n">cosZeta</span><span class="p">,</span> <span class="n">sinZeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zeta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span>
        <span class="n">zee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionZee&#39;</span><span class="p">])</span>
        <span class="n">cosZee</span><span class="p">,</span> <span class="n">sinZee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zee</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">zee</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PrecessionTheta&#39;</span><span class="p">])</span>
        <span class="n">cosTheta</span><span class="p">,</span> <span class="n">sinTheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">eci2000_ecimod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosZeta</span><span class="o">*</span><span class="n">cosTheta</span><span class="o">*</span><span class="n">cosZee</span><span class="o">-</span><span class="n">sinZeta</span><span class="o">*</span><span class="n">sinZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinZeta</span><span class="o">*</span><span class="n">cosTheta</span><span class="o">*</span><span class="n">cosZee</span><span class="o">-</span><span class="n">cosZeta</span><span class="o">*</span><span class="n">sinZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinTheta</span><span class="o">*</span><span class="n">cosZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosZeta</span><span class="o">*</span><span class="n">cosTheta</span><span class="o">*</span><span class="n">sinZee</span><span class="o">+</span><span class="n">sinZeta</span><span class="o">*</span><span class="n">cosZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinZeta</span><span class="o">*</span><span class="n">cosTheta</span><span class="o">*</span><span class="n">sinZee</span><span class="o">+</span><span class="n">cosZeta</span><span class="o">*</span><span class="n">cosZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinTheta</span><span class="o">*</span><span class="n">sinZee</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosZeta</span><span class="o">*</span><span class="n">sinTheta</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sinZeta</span><span class="o">*</span><span class="n">sinTheta</span>
        <span class="n">eci2000_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosTheta</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECI2000_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eci2000_ecimod</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_ECI2000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eci2000_ecimod</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># ECI Mean of Date to ECI True of Date, and inverse</span>
        <span class="n">ecitod_ecimod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">dpsi_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dPsi&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">sdps</span><span class="p">,</span> <span class="n">cdps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dpsi_rad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dpsi_rad</span><span class="p">)</span>
        <span class="n">sobl</span><span class="p">,</span> <span class="n">cobl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">])</span>
        <span class="n">sobt</span><span class="p">,</span> <span class="n">cobt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityTrue_rad&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityTrue_rad&#39;</span><span class="p">])</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdps</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdps</span><span class="o">*</span><span class="n">cobt</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sobt</span><span class="o">*</span><span class="n">sdps</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sdps</span><span class="o">*</span><span class="n">cobl</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cobt</span><span class="o">*</span><span class="n">cdps</span><span class="o">*</span><span class="n">cobl</span> <span class="o">+</span> <span class="n">sobt</span><span class="o">*</span><span class="n">sobl</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sobt</span><span class="o">*</span><span class="n">cdps</span><span class="o">*</span><span class="n">cobl</span> <span class="o">-</span> <span class="n">sobl</span><span class="o">*</span><span class="n">cobt</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sdps</span><span class="o">*</span><span class="n">sobl</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cobt</span><span class="o">*</span><span class="n">cdps</span><span class="o">*</span><span class="n">sobl</span> <span class="o">-</span> <span class="n">sobt</span><span class="o">*</span><span class="n">cobl</span>
        <span class="n">ecitod_ecimod</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sobt</span><span class="o">*</span><span class="n">sobl</span><span class="o">*</span><span class="n">cdps</span> <span class="o">+</span> <span class="n">cobt</span><span class="o">*</span><span class="n">cobl</span>
        <span class="c1"># TODO: if scipy version constraints allow, consider scipy.spatial.transform rotations</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECITOD_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecitod_ecimod</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_ECITOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecitod_ecimod</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Need to get Sun vector for subsequent transforms, but Sun vector requires</span>
        <span class="c1"># J2000 &lt;-&gt; MOD transforms to be set up already</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;coreInProgress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcSun</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;coreInProgress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ECI Mean of Date to Geocentric Solar Ecliptic, and reverse</span>
        <span class="c1"># First define axes for GSE coordinate system</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EclipticPole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># x-hat</span>
                                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">]),</span>  <span class="c1"># y-hat</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">])])</span>
        <span class="n">gse_y_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EclipticPole&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normVec</span><span class="p">(</span><span class="n">gse_y_vec</span><span class="p">)</span>
        <span class="n">gse_z_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">],</span> <span class="n">gse_y_vec</span><span class="p">)</span>
        <span class="c1"># Set up transformation matrices for MOD &lt;-&gt; GSE</span>
        <span class="n">ecimod_gse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ecimod_gse</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="n">ecimod_gse</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gse_y_vec</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">ecimod_gse</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gse_z_vec</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>

        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_GSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_gse</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;GSE_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_gse</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Pseudo Earth Fixed (PEF) to/from ECI TOD</span>
        <span class="c1"># Use PEF as a pass-through to get to GEO</span>
        <span class="c1"># See &quot;Revisiting Spacetrack Report #3&quot; [Vallado]</span>

        <span class="c1"># First, get apparent sidereal time</span>
        <span class="c1"># Uses GMST in degrees and Equation of Equinoxes in degrees (IAU82? Or general?)</span>
        <span class="n">gast_deg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">15.0</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EquatEquin&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.0</span>
        <span class="n">gast_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">gast_deg</span><span class="p">)</span>
        <span class="n">csga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gast_rad</span><span class="p">)</span>
        <span class="n">snga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gast_rad</span><span class="p">)</span>
        <span class="n">ecitod_pef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ecitod_pef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">csga</span>
        <span class="n">ecitod_pef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">snga</span>
        <span class="n">ecitod_pef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">snga</span>
        <span class="n">ecitod_pef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">csga</span>
        <span class="n">ecitod_pef</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># TEME (SGP4 coordinate system)</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span>
        <span class="n">teme_pef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">teme_pef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="n">teme_pef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sn</span>
        <span class="n">teme_pef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sn</span>
        <span class="n">teme_pef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="n">teme_pef</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># add TEME to transforms</span>
        <span class="n">pef_teme</span> <span class="o">=</span> <span class="n">teme_pef</span><span class="o">.</span><span class="n">T</span>
        <span class="n">ecitod_teme</span> <span class="o">=</span> <span class="n">pef_teme</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ecitod_pef</span><span class="p">)</span>
        <span class="n">ecimod_teme</span> <span class="o">=</span> <span class="n">ecitod_teme</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_ECITOD&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_TEME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_teme</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;TEME_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_teme</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># GEO (Geocentric geographic) to/from PEF (Psuedo Earth Fixed)</span>
        <span class="n">xprad</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xp</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">yprad</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthOrientationParameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">yp</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="n">sxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">xprad</span><span class="p">)</span>
        <span class="n">cxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">xprad</span><span class="p">)</span>
        <span class="n">syp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">yprad</span><span class="p">)</span>
        <span class="n">cyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">yprad</span><span class="p">)</span>
        <span class="n">pef_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cxp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sxp</span><span class="o">*</span><span class="n">syp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sxp</span><span class="o">*</span><span class="n">cyp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cyp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">syp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sxp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cxp</span><span class="o">*</span><span class="n">syp</span>
        <span class="n">pef_geo</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cxp</span><span class="o">*</span><span class="n">cyp</span>

        <span class="c1"># make/store ECIMOD&lt;-&gt;GEO transforms</span>
        <span class="n">ecitod_geo</span> <span class="o">=</span> <span class="n">pef_geo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ecitod_pef</span><span class="p">)</span>
        <span class="n">ecimod_geo</span> <span class="o">=</span> <span class="n">ecitod_geo</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_ECITOD&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_GEO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_geo</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;GEO_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_geo</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;transformCore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CTrans.calcMagTransforms"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.calcMagTransforms">[docs]</a>    <span class="k">def</span> <span class="nf">calcMagTransforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recalc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate geophysical coordinate systems</span>

<span class="sd">        Calculate transforms for coordinate systems requiring magnetic field</span>
<span class="sd">        information.</span>

<span class="sd">        These are:</span>
<span class="sd">        Solar Magnetic (SM)</span>
<span class="sd">        Geocentric Solar Magnetospheric (GSM)</span>
<span class="sd">        Geomagnetic, centered dipole (CDMAG)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recalc : bool, optional</span>
<span class="sd">            If True, recalculate the core (non-magnetic) coordinate transformations.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;transformCore&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">recalc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcCoreTransforms</span><span class="p">()</span>

        <span class="c1"># Call IGRF to calculate centered dipole</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;IGRF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">igrf</span><span class="o">.</span><span class="n">IGRF</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;IGRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Get dipole axis unit vector</span>
        <span class="n">glon</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;IGRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dipole</span><span class="p">[</span><span class="s1">&#39;cd_glon_rad&#39;</span><span class="p">]</span>
        <span class="n">gcolat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;IGRF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dipole</span><span class="p">[</span><span class="s1">&#39;cd_gcolat_rad&#39;</span><span class="p">]</span>
        <span class="n">dip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">glon</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gcolat</span><span class="p">)</span>
        <span class="n">dip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">glon</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gcolat</span><span class="p">)</span>
        <span class="n">dip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gcolat</span><span class="p">)</span>

        <span class="c1"># Convert dipole axis to MOD</span>
        <span class="n">dipmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dipmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">dip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">dip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dipmod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">dip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">dip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dipmod</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Compute Ygsm axis in MOD</span>
        <span class="n">gsm_y_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">dipmod</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normVec</span><span class="p">(</span><span class="n">gsm_y_vec</span><span class="p">)</span>

        <span class="c1"># Compute Zgsm axis in MOD system</span>
        <span class="n">gsm_z_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">],</span> <span class="n">gsm_y_vec</span><span class="p">)</span>

        <span class="c1"># Set up transformation matrices for MOD &lt;-&gt; GSM</span>
        <span class="n">ecimod_gsm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ecimod_gsm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="n">ecimod_gsm</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gsm_y_vec</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="n">ecimod_gsm</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">gsm_z_vec</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_GSM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_gsm</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;GSM_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecimod_gsm</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Compute the Dipole Tilt angle (psi). First convert dipmod into GSM.</span>
        <span class="c1"># Then psi is just the angle between dipgsm and Zgsm</span>
        <span class="n">dipgsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">dipmod</span><span class="p">,</span> <span class="s1">&#39;ECIMOD&#39;</span><span class="p">,</span> <span class="s1">&#39;GSM&#39;</span><span class="p">)</span>
        <span class="n">psidot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dipgsm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normVec</span><span class="p">(</span><span class="n">psidot</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">psidot</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">dipgsm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;DipoleTilt_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;DipoleTilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
        <span class="n">cos_psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
        <span class="n">sin_psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>

        <span class="c1"># Set up transformation matrices for GSM &lt;-&gt; SM</span>
        <span class="n">gsm_sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">gsm_sm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cos_psi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sin_psi</span><span class="p">])</span>
        <span class="n">gsm_sm</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">gsm_sm</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">sin_psi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cos_psi</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;GSM_SM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsm_sm</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;SM_GSM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsm_sm</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Get conversion to MOD for completeness</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_SM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsm_sm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_GSM&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;SM_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_SM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Set up transformation matrices for GEO &lt;-&gt; CDMAG</span>
        <span class="c1"># CDMAG is centered dipole geomagnetic</span>
        <span class="c1">#    Z: parallel to dipole axis.</span>
        <span class="c1">#    Y: perpendicular to both Z and rotation axis</span>
        <span class="c1">#    X: completes</span>
        <span class="n">zhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># GEO Z-axis in GEO</span>
        <span class="n">mag_y_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">zhat</span><span class="p">,</span> <span class="n">dip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normVec</span><span class="p">(</span><span class="n">mag_y_vec</span><span class="p">)</span>
        <span class="n">mag_x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">mag_y_vec</span><span class="p">,</span> <span class="n">dip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normVec</span><span class="p">(</span><span class="n">mag_x_vec</span><span class="p">)</span>
        <span class="n">geo_cdmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">geo_cdmag</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_x_vec</span>
        <span class="n">geo_cdmag</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_y_vec</span>
        <span class="n">geo_cdmag</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">dip</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;GEO_CDMAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_cdmag</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;CDMAG_GEO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_cdmag</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Get conversion to MOD for completeness</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_CDMAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo_cdmag</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_GEO&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;CDMAG_ECIMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="s1">&#39;ECIMOD_CDMAG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="CTrans.convert"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">sys_in</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an input vector between two coordinate systems</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vec : array-like</span>
<span class="sd">            Input 3-vector (can be an array of input 3-vectors) to convert.</span>
<span class="sd">            E.g., for 2D input the array must be like [[x1, y1, z1], [x2, y2, z2]]</span>
<span class="sd">        sys_in : str</span>
<span class="sd">            String name for initial coordinate system. For supported systems,</span>
<span class="sd">            see module level documentation.</span>
<span class="sd">        sys_out : str</span>
<span class="sd">            String name for target coordinate system. For supported systems,</span>
<span class="sd">            see module level documentation.</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        defaults : namedtuple or None</span>
<span class="sd">            Named tuple containing default settings passed from Coordinates module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># must be at least 2D for conversion methods</span>
        <span class="n">gvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="c1"># Needs 3xN vectors for a broadcast dot product</span>
        <span class="n">trvec</span> <span class="o">=</span> <span class="n">gvec</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Special case geodetic transforms</span>
        <span class="n">to_geodetic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">to_rll</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">sys_out</span> <span class="o">==</span> <span class="s1">&#39;GDZ&#39;</span><span class="p">:</span>
            <span class="n">sys_out</span> <span class="o">=</span> <span class="s1">&#39;GEO&#39;</span>
            <span class="n">to_geodetic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">sys_out</span> <span class="o">==</span> <span class="s1">&#39;RLL&#39;</span><span class="p">:</span>
            <span class="n">sys_out</span> <span class="o">=</span> <span class="s1">&#39;GEO&#39;</span>
            <span class="n">to_rll</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">sys_in</span> <span class="o">==</span> <span class="s1">&#39;GDZ&#39;</span><span class="p">:</span>
            <span class="n">trvec</span> <span class="o">=</span> <span class="n">gdz_to_geo</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">gdz_to_geo</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
            <span class="n">sys_in</span> <span class="o">=</span> <span class="s1">&#39;GEO&#39;</span>
        <span class="k">elif</span> <span class="n">sys_in</span> <span class="o">==</span> <span class="s1">&#39;RLL&#39;</span><span class="p">:</span>
            <span class="n">trvec</span> <span class="o">=</span> <span class="n">rll_to_geo</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rll_to_geo</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
            <span class="n">sys_in</span> <span class="o">=</span> <span class="s1">&#39;GEO&#39;</span>

        <span class="k">if</span> <span class="n">sys_in</span> <span class="o">!=</span> <span class="n">sys_out</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_in</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Construct requested transform via ECIMOD</span>
                    <span class="n">trans1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_in</span><span class="p">,</span> <span class="s1">&#39;ECIMOD&#39;</span><span class="p">)</span>
                    <span class="n">trans2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ECIMOD&#39;</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">trans1</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">trans2</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">]</span>
                    <span class="n">tmatr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="n">trans2</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="n">trans1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="n">transform</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmatr</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
                    <span class="c1"># Can&#39;t construct the transform requested</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Required transform stored already, just use it</span>
                <span class="n">tmatr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Transform&#39;</span><span class="p">][</span><span class="n">transform</span><span class="p">]</span>

            <span class="n">converted</span> <span class="o">=</span> <span class="n">tmatr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">trvec</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">converted</span> <span class="o">=</span> <span class="n">trvec</span>
        <span class="c1"># squeeze to fix return of 1D input vectors</span>
        <span class="c1"># squeeze returns either input array or a view, so this isn&#39;t wasteful</span>
        <span class="n">converted_squeezed</span> <span class="o">=</span> <span class="n">converted</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">to_geodetic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">converted_squeezed</span> <span class="o">=</span> <span class="n">geo_to_gdz</span><span class="p">(</span><span class="n">converted_squeezed</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">converted_squeezed</span> <span class="o">=</span> <span class="n">geo_to_gdz</span><span class="p">(</span><span class="n">converted_squeezed</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">to_rll</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">converted_squeezed</span> <span class="o">=</span> <span class="n">geo_to_rll</span><span class="p">(</span><span class="n">converted_squeezed</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">ellipsoid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">converted_squeezed</span> <span class="o">=</span> <span class="n">geo_to_rll</span><span class="p">(</span><span class="n">converted_squeezed</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">converted_squeezed</span></div>

<div class="viewcode-block" id="CTrans.gmst"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.CTrans.html#spacepy.ctrans.CTrans.gmst">[docs]</a>    <span class="k">def</span> <span class="nf">gmst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Greenwich Mean Sidereal Time</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The formulation used to calculate GMST is selected using the</span>
<span class="sd">        status of the &#39;pnmodel&#39; variable in the CTrans object attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;timeInProgress&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcTimes</span><span class="p">(</span><span class="n">from_gmst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pnmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pnmodel&#39;</span><span class="p">]</span>
        <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span>
        <span class="c1"># Greenwich Mean Sidereal Time</span>
        <span class="n">UT1_P1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JC&#39;</span><span class="p">]</span>
        <span class="n">coeffB</span> <span class="o">=</span> <span class="mf">8640184.812866</span>
        <span class="n">coeffC</span> <span class="o">=</span> <span class="mf">0.093104</span>
        <span class="n">coeffD</span> <span class="o">=</span> <span class="mf">6.2e-6</span>
        <span class="k">if</span> <span class="n">pnmodel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;IAU82&#39;</span><span class="p">:</span>
            <span class="c1"># total fractional part of UT1 Julian day</span>
            <span class="n">fts</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">daysec</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JD&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">const</span><span class="o">.</span><span class="n">j2000_jd</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">gmst_rad</span> <span class="o">=</span> <span class="p">((</span><span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">daysec</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="mf">19089.45159</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">coeffB</span> <span class="o">+</span> <span class="p">(</span><span class="n">coeffC</span> <span class="o">+</span> <span class="n">coeffD</span><span class="o">*</span><span class="n">UT1_P1</span><span class="p">)</span> <span class="o">*</span> <span class="n">UT1_P1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">UT1_P1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fts</span><span class="p">))</span> <span class="o">%</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">gmst_rad</span><span class="p">)</span><span class="o">/</span><span class="mi">15</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmst_rad</span>
        <span class="k">elif</span> <span class="n">pnmodel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;IAU00&#39;</span><span class="p">:</span>
            <span class="n">du</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;UT1_JD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">const</span><span class="o">.</span><span class="n">j2000_jd</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span><span class="o">*</span><span class="p">(</span><span class="mf">0.7790572732640</span> <span class="o">+</span> <span class="mf">0.00273781191135448</span><span class="o">*</span><span class="n">du</span> <span class="o">+</span> <span class="n">du</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TT_JC&#39;</span><span class="p">]</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.014506</span> <span class="o">+</span>
                     <span class="p">(</span><span class="mf">4612.15739966</span> <span class="o">+</span>
                      <span class="p">(</span><span class="mf">1.39667721</span> <span class="o">+</span>
                       <span class="p">(</span><span class="o">-</span> <span class="mf">0.00009344</span> <span class="o">+</span>
                        <span class="p">(</span><span class="mf">0.00001882</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">angle</span><span class="o">*</span><span class="n">const</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">%</span> <span class="n">const</span><span class="o">.</span><span class="n">twopi</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;GMST_rad&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">15</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span></div>

    <span class="k">def</span> <span class="nf">_calcSun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Sun vector.</span>

<span class="sd">        This should only be called from within calcCoreTransforms, after</span>
<span class="sd">        the ECI2000 &lt;-&gt; ECIMOD transforms have been defined</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validEntry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;orbital&#39;</span><span class="p">]</span>
        <span class="n">validEntry</span> <span class="o">=</span> <span class="n">validEntry</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;coreInProgress&#39;</span><span class="p">]</span>
                                     <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status</span><span class="p">[</span><span class="s1">&#39;transformCore&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validEntry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErr</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="s1">&#39;sun&#39;</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span>
        <span class="n">eccen</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;Eccentricity&#39;</span><span class="p">]</span>
        <span class="n">cos_epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">])</span>
        <span class="n">sin_epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ObliquityEcliptic_rad&#39;</span><span class="p">])</span>
        <span class="n">cos_lambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;LambdaSun&#39;</span><span class="p">])</span>
        <span class="n">sin_lambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;LambdaSun&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ephmodel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LGMDEFAULT&#39;</span><span class="p">:</span>
            <span class="n">earth_sun_distance</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">AU</span><span class="o">*</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">eccen</span> <span class="o">*</span> <span class="n">eccen</span><span class="p">)</span>
                                           <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">eccen</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;TrueAnomaly&#39;</span><span class="p">]))</span>
                                           <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">Re</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;EarthSunDistance_Re&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">earth_sun_distance</span>
            <span class="c1"># Direction of the Sun in MOD coords</span>
            <span class="n">sunVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">sunVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_lambda</span>
            <span class="n">sunVec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_epsilon</span><span class="o">*</span><span class="n">sin_lambda</span>
            <span class="n">sunVec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_epsilon</span><span class="o">*</span><span class="n">sin_lambda</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_MOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sunVec</span>
            <span class="c1"># Convert to ECI2000</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;SunVector_J2000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">sunVec</span><span class="p">,</span> <span class="s1">&#39;ECIMOD&#39;</span><span class="p">,</span> <span class="s1">&#39;ECI2000&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ephmodel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DE421&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="c1"># TODO: get Sun vector from DE421 (read HDF5 of coeffs from LGM github?)</span>
            <span class="c1">#       and use numpy chebyshev module for polynomials from coeffs</span>
            <span class="c1"># TODO: get Earth-Sun distance as magnitude of Sun vector (put in R_E)</span>
            <span class="c1"># TODO: normalize Sun vector (this is in ECIJ2000)</span>

    <span class="k">def</span> <span class="nf">_raiseErr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errtype</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Common error raising method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        errtype : Exception</span>
<span class="sd">            Exception to raise</span>
<span class="sd">        code : str</span>
<span class="sd">            Error category. Defines error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;ephmodel&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;No alternate models of ephemerides at this time&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;pnmodel&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;No alternate models of precession/nutation at this time&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;time_in&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Input time must be single-valued. Allowed types are datetime.datetime, &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;spacepy.time.Ticktock, or any valid input type for spacepy.time.Ticktock&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;eop&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Earth Oriention Parameters not found&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;sun&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Invalid entry into Sun vector routine. Not intended for direct use.&#39;</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;transform&#39;</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Requested coordinate transform not defined.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;Operation not defined&#39;</span>

        <span class="k">raise</span> <span class="n">errtype</span><span class="p">(</span><span class="s1">&#39;CTrans: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_kepler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_anom</span><span class="p">,</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve Kepler&#39;s equation for eccentric anomaly</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean_anom : float</span>
<span class="sd">            Mean anomaly in radians</span>
<span class="sd">        ecc : float</span>
<span class="sd">            Eccentricity of orbit</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ecc_anom : float</span>
<span class="sd">            Eccentric anomaly in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ecc_anom</span> <span class="o">=</span> <span class="n">mean_anom</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mean_anom</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="p">):</span>
            <span class="n">ecc_anom_old</span> <span class="o">=</span> <span class="n">ecc_anom</span>
            <span class="n">ecc_anom</span> <span class="o">=</span> <span class="n">ecc_anom_old</span> <span class="o">+</span> <span class="p">(</span><span class="n">mean_anom</span> <span class="o">-</span> <span class="n">ecc_anom_old</span> <span class="o">+</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ecc_anom_old</span><span class="p">))</span> \
                <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ecc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ecc_anom_old</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ecc_anom</span> <span class="o">-</span> <span class="n">ecc_anom_old</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Estimation of eccentric anomaly failed to converge&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ecc_anom</span></div>


<div class="viewcode-block" id="geo_to_gdz"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.geo_to_gdz.html#spacepy.ctrans.geo_to_gdz">[docs]</a><span class="k">def</span> <span class="nf">geo_to_gdz</span><span class="p">(</span><span class="n">geovec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">WGS84</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert geocentric geographic (cartesian GEO) to geodetic (spherical GDZ)</span>

<span class="sd">    Uses Heikkinen&#39;s exact solution [#Heikkinen]_, see Zhu et al. [#Zhu] for</span>
<span class="sd">    details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    geovec : array-like</span>
<span class="sd">        Nx3 array (or array-like) of geocentric geographic [x, y, z] coordinates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">        Nx3 array of geodetic altitude, latitude, and longitude</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. versionadded:: 0.3.0</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [#Heikkinen] Heikkinen, M., &quot;Geschlossene formeln zur berechnung raumlicher geodatischer</span>
<span class="sd">            koordinaten aus rechtwinkligen koordinaten&quot;, Z. Vermess., vol. 107, pp. 207-211,</span>
<span class="sd">            1982.</span>
<span class="sd">    .. [#Zhu] J. Zhu, &quot;Conversion of Earth-centered Earth-fixed coordinates to geodetic</span>
<span class="sd">            coordinates,&quot; in IEEE Transactions on Aerospace and Electronic Systems, vol. 30,</span>
<span class="sd">            no. 3, pp. 957-961, July 1994, doi: 10.1109/7.303772.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">geovec</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">x_geo</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">y_geo</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">z_geo</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;Re&#39;</span><span class="p">:</span>
        <span class="c1"># Make sure positions are in km</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">x_geo</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">y_geo</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">z_geo</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">x_geo</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">y_geo</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">z_geo</span>

    <span class="n">rad2</span> <span class="o">=</span> <span class="n">rx</span><span class="o">*</span><span class="n">rx</span> <span class="o">+</span> <span class="n">ry</span><span class="o">*</span><span class="n">ry</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad2</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">rz</span><span class="o">*</span><span class="n">rz</span>
    <span class="c1"># Heikkinen&#39;s method, as written in Zhu et al.</span>
    <span class="c1"># Each equation not explicitly in Zhu is marked with a trailing comment</span>
    <span class="n">F</span> <span class="o">=</span> <span class="mf">54.0</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z2</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">rad2</span> <span class="o">+</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;1mE2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z2</span> <span class="o">-</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A2mB2&#39;</span><span class="p">]</span>
    <span class="n">G2</span> <span class="o">=</span> <span class="n">G</span><span class="o">*</span><span class="n">G</span>  <span class="c1"># Square G for convenience</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E4&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">F</span><span class="o">*</span><span class="n">rad2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">G</span><span class="o">*</span><span class="n">G</span><span class="o">*</span><span class="n">G</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="p">))</span>
    <span class="n">denom_p</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Shorthand for term in P&#39;s denominator</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">F</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">denom_p</span><span class="o">*</span><span class="n">denom_p</span><span class="o">*</span><span class="n">G2</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E4&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">)</span>
    <span class="c1"># The second term in r0 can evaluate as negative...</span>
    <span class="n">sqrt_for_r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="mf">0.5</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">Q</span><span class="p">)</span> <span class="o">-</span>
                         <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;1mE2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="o">*</span><span class="n">z2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Q</span><span class="p">))</span> <span class="o">-</span>
                         <span class="mf">0.5</span><span class="o">*</span><span class="n">P</span><span class="o">*</span><span class="n">rad2</span><span class="p">)</span>
    <span class="c1"># Back to Heikinnen&#39;s method per Zhu</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="o">*</span><span class="n">rad</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Q</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqrt_for_r0</span><span class="p">)</span>
    <span class="n">brac_u</span> <span class="o">=</span> <span class="p">(</span><span class="n">rad</span> <span class="o">-</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">r0</span><span class="p">)</span>  <span class="c1"># Shorthand for term in U and V denominator</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">brac_u</span><span class="o">*</span><span class="n">brac_u</span> <span class="o">+</span> <span class="n">z2</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">brac_u</span><span class="o">*</span><span class="n">brac_u</span> <span class="o">+</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;1mE2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z2</span><span class="p">)</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">rz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>
    <span class="c1"># Heikkinen&#39;s solution has a singularity at the pole, so let&#39;s trap that here</span>
    <span class="n">polemask</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span>
    <span class="n">lati_gdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">ry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">polemask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="c1"># Make sure we assign the correct pole</span>
        <span class="n">zmask</span> <span class="o">=</span> <span class="n">rz</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">nhem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">polemask</span><span class="p">,</span> <span class="n">zmask</span><span class="p">)</span>
        <span class="n">shem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">polemask</span><span class="p">,</span> <span class="o">~</span><span class="n">zmask</span><span class="p">)</span>
        <span class="n">lati_gdz</span><span class="p">[</span><span class="n">nhem</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="n">lati_gdz</span><span class="p">[</span><span class="n">shem</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">90</span>
    <span class="n">lati_gdz</span><span class="p">[</span><span class="o">~</span><span class="n">polemask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">rz</span><span class="p">[</span><span class="o">~</span><span class="n">polemask</span><span class="p">]</span> <span class="o">+</span>
                                                <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;EP2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">z0</span><span class="p">[</span><span class="o">~</span><span class="n">polemask</span><span class="p">])</span> <span class="o">/</span>
                                                <span class="n">rad</span><span class="p">[</span><span class="o">~</span><span class="n">polemask</span><span class="p">]))</span>
                                                <span class="c1"># Geodetic latitude (phi in Zhu paper)</span>
    <span class="n">alti_gdz</span> <span class="o">=</span> <span class="n">U</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;B2&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">V</span><span class="p">))</span>  <span class="c1"># Geodetic altitude [km] (h in Zhu paper)</span>
    <span class="n">long_gdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span> <span class="n">rx</span><span class="p">))</span>  <span class="c1"># Geodetic longitude (same as GEO)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">alti_gdz</span><span class="p">,</span> <span class="n">lati_gdz</span><span class="p">,</span> <span class="n">long_gdz</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;Re&#39;</span><span class="p">:</span>
        <span class="c1"># Return in Re</span>
        <span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="gdz_to_geo"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.gdz_to_geo.html#spacepy.ctrans.gdz_to_geo">[docs]</a><span class="k">def</span> <span class="nf">gdz_to_geo</span><span class="p">(</span><span class="n">gdzvec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">WGS84</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert geodetic (GDZ) coordinates to geocentric geographic</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gdzvec : array-like</span>
<span class="sd">        Nx3 array of geodetic altitude, latitude, longitude (in specified units)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : numpy.ndarray</span>
<span class="sd">        Nx3 array of geocentric geographic x, y, z coordinates</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    units : str</span>
<span class="sd">        Units for input geodetic altitude. Options are &#39;km&#39; or &#39;Re&#39;. Default is &#39;km&#39;.</span>
<span class="sd">        Output units will be the same as input units.</span>
<span class="sd">    geoid : spacepy.ctrans.Ellipsoid</span>
<span class="sd">        Instance of a reference ellipsoid to use for geodetic conversion.</span>
<span class="sd">        Default is WGS84.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. versionadded:: 0.3.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">gdzvec</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;km&#39;</span> <span class="k">else</span> <span class="n">posarr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>  <span class="c1"># convert to km</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">posarr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">posarr</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lam</span><span class="p">))</span>

    <span class="c1"># Convert to GEO [km]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">chi</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">chi</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;E2&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">chi</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;km&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Return in Re</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">/</span><span class="n">geoid</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="geo_to_rll"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.geo_to_rll.html#spacepy.ctrans.geo_to_rll">[docs]</a><span class="k">def</span> <span class="nf">geo_to_rll</span><span class="p">(</span><span class="n">geovec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">WGS84</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate RLL from geocentric geographic (GEO) coordinates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    geovec : array-like</span>
<span class="sd">        Nx3 array of geographic radius, latitude, longitude (in specified units)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rllvec : numpy.ndarray</span>
<span class="sd">        Nx3 array of [distance from Earth&#39;s center, geodetic latitude, geodetic longitude]</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    units : str</span>
<span class="sd">        Units for input geodetic altitude. Options are &#39;km&#39; or &#39;Re&#39;. Default is &#39;km&#39;.</span>
<span class="sd">        Output units will be the same as input units.</span>
<span class="sd">    geoid : spacepy.ctrans.Ellipsoid</span>
<span class="sd">        Instance of a reference ellipsoid to use for geodetic conversion.</span>
<span class="sd">        Default is WGS84.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. versionadded:: 0.3.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rllvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">geo_to_gdz</span><span class="p">(</span><span class="n">geovec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">geoid</span><span class="p">))</span>
    <span class="c1"># Reolace altitude with norm of Cartesian position</span>
    <span class="n">rllvec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">geovec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rllvec</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="rll_to_geo"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.rll_to_geo.html#spacepy.ctrans.rll_to_geo">[docs]</a><span class="k">def</span> <span class="nf">rll_to_geo</span><span class="p">(</span><span class="n">rllvec</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">WGS84</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate geocentric geographic (GEO) from RLL coordinates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rllvec : array-like</span>
<span class="sd">        Nx3 array of geocentric radius, geodetic latitude, geodetic longitude</span>
<span class="sd">        (in specified units)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    geoarr : numpy.ndarray</span>
<span class="sd">        Nx3 array of [altitude, geodetic latitude, geodetic longitude]</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    units : str</span>
<span class="sd">        Units for input geocentric radii. Options are &#39;km&#39; or &#39;Re&#39;. Default is &#39;km&#39;.</span>
<span class="sd">        Output units will be the same as input units.</span>
<span class="sd">    geoid : spacepy.ctrans.Ellipsoid</span>
<span class="sd">        Instance of a reference ellipsoid to use for geodetic conversion.</span>
<span class="sd">        Default is WGS84.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. versionadded:: 0.3.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">rllvec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">posarr</span><span class="p">)</span>
    <span class="n">surf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">geoid_at_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">gdz_to_geo</span><span class="p">(</span><span class="n">surf</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">geoid</span><span class="p">))</span>
    <span class="n">gdz</span> <span class="o">=</span> <span class="n">posarr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># remove geoid height from geocentric radius at each location</span>
    <span class="n">gdz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">geoid_at_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">geoarr</span> <span class="o">=</span> <span class="n">gdz_to_geo</span><span class="p">(</span><span class="n">gdz</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">geoid</span><span class="o">=</span><span class="n">geoid</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">geoarr</span></div>


<div class="viewcode-block" id="convert_multitime"><a class="viewcode-back" href="../../autosummary/spacepy.ctrans.convert_multitime.html#spacepy.ctrans.convert_multitime">[docs]</a><span class="k">def</span> <span class="nf">convert_multitime</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">sys_in</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">itol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert coordinates for N times, where N &gt;= 1</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coords : array-like</span>
<span class="sd">        Coordinates as Nx3 array. Cartesian assumed unless input system is geodetic.</span>
<span class="sd">    ticks : spacepy.time.Ticktock</span>
<span class="sd">        Times for each element of coords. Must contain either N times or 1 time.</span>
<span class="sd">    sys_in : str</span>
<span class="sd">        Name of input coordinate system.</span>
<span class="sd">    sys_out : str</span>
<span class="sd">        Name of output coordinate system.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    defaults : namedtuple or None</span>
<span class="sd">        Named tuple with parameters from coordinates module</span>
<span class="sd">    itol : float</span>
<span class="sd">        Time tolerance, in seconds, for using a unique set of conversions.</span>
<span class="sd">        Default is 1. Supplying a defaults namedtuple (i.e., if routine is called</span>
<span class="sd">        by spacepy.cooordinates.Coords.convert) will override this value.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">itol</span> <span class="o">=</span> <span class="n">itol</span> <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">defaults</span><span class="o">.</span><span class="n">itol</span>
    <span class="c1"># Calculate a CTrans for each unique time</span>
    <span class="n">ctdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">ttused</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">tais</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">TAI</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tais</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctdict</span><span class="p">:</span>
            <span class="c1"># for speed, let&#39;s not recalculate transforms</span>
            <span class="c1"># for times very close to each other (defined</span>
            <span class="c1"># by the itol kwarg)</span>
            <span class="k">if</span> <span class="n">ttused</span><span class="p">:</span>
                <span class="n">usedlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ttused</span><span class="p">)</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tt</span> <span class="o">-</span> <span class="n">usedlist</span><span class="p">))</span>
                <span class="n">tdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tt</span> <span class="o">-</span> <span class="n">usedlist</span><span class="p">[</span><span class="n">closest</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tdiff</span> <span class="o">=</span> <span class="n">itol</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">tdiff</span> <span class="o">&lt;</span> <span class="n">itol</span> <span class="ow">and</span> <span class="n">ctdict</span><span class="p">:</span>
                <span class="n">ctdict</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctdict</span><span class="p">[</span><span class="n">usedlist</span><span class="p">[</span><span class="n">closest</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctdict</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTrans</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">ctdict</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">.</span><span class="n">calcCoreTransforms</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sys_in</span> <span class="ow">in</span> <span class="n">magsys</span> <span class="ow">or</span> <span class="n">sys_out</span> <span class="ow">in</span> <span class="n">magsys</span><span class="p">:</span>
                    <span class="n">ctdict</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">.</span><span class="n">calcMagTransforms</span><span class="p">()</span>
                <span class="n">ttused</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
    <span class="c1"># Unless speed becomes an issue, let&#39;s just loop over each value</span>
    <span class="c1"># except the spacial case of only 1 unique time</span>
    <span class="n">loopover</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctdict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">newcoords</span> <span class="o">=</span> <span class="n">ctdict</span><span class="p">[</span><span class="n">tais</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">loopover</span><span class="p">,</span> <span class="n">sys_in</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newcoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">loopover</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loopover</span><span class="p">):</span>
            <span class="n">newcoords</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctdict</span><span class="p">[</span><span class="n">tais</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">sys_in</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">defaults</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newcoords</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../spacepy.html" >spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.ctrans</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2022, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>