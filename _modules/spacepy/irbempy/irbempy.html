
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.irbempy.irbempy &#8212; SpacePy v0.2.2 Manual</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../spacepy.html" accesskey="U">spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.irbempy.irbempy</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.irbempy.irbempy</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">module wrapper for irbem_lib</span>
<span class="sd">Reference for this library</span>
<span class="sd">https://sourceforge.net/projects/irbem/</span>
<span class="sd">D. Boscher, S. Bourdarie, T. P. O&#39;Brien, T. Guild, IRBEM library V4.3, 2004-2008</span>


<span class="sd">Authors</span>
<span class="sd">-------</span>
<span class="sd">Josef Koller, Steve Morley </span>

<span class="sd">Copyright 2010 Los Alamos National Security, LLC.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">numbers</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">help</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">import</span> <span class="nn">spacepy.coordinates</span> <span class="k">as</span> <span class="nn">spc</span>
<span class="kn">import</span> <span class="nn">spacepy.datamodel</span> <span class="k">as</span> <span class="nn">dm</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">irbempylib</span> <span class="k">as</span> <span class="n">oplib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;sphinx&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not import irbempylib. &#39;</span>
                      <span class="s1">&#39;You appear to be building docs, so ignoring this error.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>
<span class="kn">import</span> <span class="nn">spacepy.toolbox</span> <span class="k">as</span> <span class="nn">tb</span>

<span class="c1">#check whether TS07_DATA_PATH is set, if not then set to spacepy&#39;s installed data directory</span>
<span class="k">if</span> <span class="s1">&#39;TS07_DATA_PATH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pkg_resources</span>
    <span class="n">dataTS07D</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;TS07D&#39;</span><span class="p">)</span>
    <span class="n">spdatapath</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;spacepy&#39;</span><span class="p">,</span> <span class="n">dataTS07D</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TS07_DATA_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spdatapath</span> <span class="c1">#set environment variable here</span>


<span class="n">SYSAXES_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GDZ&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="s1">&#39;GEO&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s1">&#39;GSM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="s1">&#39;GSE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s1">&#39;SM&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
    <span class="s1">&#39;GEI&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="s1">&#39;MAG&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
    <span class="s1">&#39;SPH&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="s1">&#39;RLL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="s1">&#39;TOD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="s1">&#39;J2000&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sph&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">}}</span>

<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">updateTS07Coeffs</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Update coefficients for TS07 magnetic field model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Base path for TS07 dynamic coefficients. If None (default)</span>
<span class="sd">        then the TS07_DATA_PATH environment variable is used.</span>
<span class="sd">    force : boolean</span>
<span class="sd">        If True (default is False) then missing paths will be created.</span>
<span class="sd">    verbose : boolean</span>
<span class="sd">        Print verbose output. Default is False.</span>
<span class="sd">    start : datetime.datetime or string</span>
<span class="sd">        Start time for archive retrieval. If start is a string then it should</span>
<span class="sd">        ISO8601 format (YYYY-MM-DDTHH:mm:SS). Defaults to 2007-01-01.</span>
<span class="sd">    end : datetime.datetime or string</span>
<span class="sd">        End time for archive retrieval. Required format same as start.</span>
<span class="sd">        Defaults to time of query (i.e. latest available).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">tarfile</span>
    <span class="kn">import</span> <span class="nn">spacepy.time</span> <span class="k">as</span> <span class="nn">spt</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">datetime</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">urllib</span> <span class="k">as</span> <span class="nn">u</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">urllib.request</span> <span class="k">as</span> <span class="nn">u</span>

    <span class="k">if</span> <span class="s1">&#39;user_agent&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;user_agent&#39;</span><span class="p">]:</span>
        <span class="k">class</span> <span class="nc">AppURLopener</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">FancyURLopener</span><span class="p">):</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;user_agent&#39;</span><span class="p">]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">_urlopener</span> <span class="o">=</span> <span class="n">AppURLopener</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="c1">#test for TS07_DATA_PATH</span>
        <span class="k">if</span> <span class="s1">&#39;TS07_DATA_PATH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TS07_DATA_PATH&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_str</span> <span class="o">=</span> <span class="s1">&#39;updateTS07Coeffs: Directory for TS07 data must be specified by </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;TS07_DATA_PATH environment variable or path keyword.&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>

    <span class="c1">#test that path exists, unless force keyword is set</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o777</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;updateTS07Coeffs: Specified path for TS07 is not valid - to force creation use &quot;force&quot; keyword&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">firstDate</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">firstDate</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#make sure it&#39;s a datetime</span>
    <span class="k">if</span> <span class="s1">&#39;end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">lastDate</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lastDate</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">baseURL</span> <span class="o">=</span> <span class="s1">&#39;http://rbspgway.jhuapl.edu/models/magneticfieldmodeling/ts07d/coeffs_v02/&#39;</span>

    <span class="c1">#make inventory of current TS07 data</span>
    <span class="n">current_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;Coeffs&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">)))</span>
    <span class="n">current_days</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dd</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">current_days</span> <span class="k">if</span> <span class="s1">&#39;tgz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">]</span>
    <span class="n">current_dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">current_days</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adddate</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">doy2date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1">#not a valid date format</span>
            <span class="k">continue</span>
        <span class="n">current_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adddate</span><span class="p">)</span>

    <span class="n">request_days</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">tickrange</span><span class="p">(</span><span class="n">firstDate</span><span class="p">,</span> <span class="n">lastDate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">timewant</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">request_days</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span>
    <span class="n">timegot</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_dates</span><span class="p">)</span>
    <span class="n">stillwant</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">timewant</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">timegot</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retrieving </span><span class="si">{2}</span><span class="s2"> requested files [</span><span class="si">{0}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">firstDate</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">lastDate</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stillwant</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">stillwant</span><span class="p">:</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">spt</span><span class="o">.</span><span class="n">Ticktock</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">DOY</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;Coeffs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">baseURL</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">{0}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.tgz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">targetfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.tgz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetching archive for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">day</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()))</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">,</span> <span class="n">reporthook</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">progressbar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
        <span class="c1">#if the file existed on the server then we won&#39;t get an HTML message back</span>
        <span class="k">if</span> <span class="s1">&#39;html&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]:</span>
            <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#now remove tgz file</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="get_Bfield"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_Bfield.html#spacepy.irbempy.get_Bfield">[docs]</a><span class="k">def</span> <span class="nf">get_Bfield</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    call get_bfield in irbem lib and return a dictionary with the B-field vector and </span>
<span class="sd">    strenght.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table</span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (dictionary) : containing keys: Bvec, and Blocal</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.time as spt</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.coordinates as spc</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.irbempy as ib</span>
<span class="sd">    &gt;&gt;&gt; t = spt.Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = spc.Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ib.get_Bfield(t,y)</span>
<span class="sd">    {&#39;Blocal&#39;: array([  976.42565251,  3396.25991675]),</span>
<span class="sd">       &#39;Bvec&#39;: array([[ -5.01738885e-01,  -1.65104338e+02,   9.62365503e+02],</span>
<span class="sd">       [  3.33497974e+02,  -5.42111173e+02,   3.33608693e+03]])}</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, find_Bmirror, find_magequator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[],</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">utsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bvec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTAI</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">BxyzGEO</span><span class="p">,</span> <span class="n">Blocal</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">get_field1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span><span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
            <span class="n">xin1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">magin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">Blocal</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">Blocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">BxyzGEO</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">BxyzGEO</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Blocal</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bvec&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">BxyzGEO</span>

    <span class="k">return</span> <span class="n">results</span></div>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="find_Bmirror"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.find_Bmirror.html#spacepy.irbempy.find_Bmirror">[docs]</a><span class="k">def</span> <span class="nf">find_Bmirror</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    call find_mirror_point from irbem library and return a dictionary with values for </span>
<span class="sd">    Blocal, Bmirr and the GEO (cartesian) coordinates of the mirror point</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    ticks : Ticktock class</span>
<span class="sd">        containing time information</span>
<span class="sd">    loci : Coords class</span>
<span class="sd">        containing spatial information</span>
<span class="sd">    alpha : array-like</span>
<span class="sd">        containing the pitch angles</span>
<span class="sd">    extMag : str</span>
<span class="sd">        optional; will choose the external magnetic field model </span>
<span class="sd">        possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">        OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">        &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">    options : array-like (optional)</span>
<span class="sd">        length=5 : explained in Lstar</span>
<span class="sd">    omnivals : dict (optional)</span>
<span class="sd">        if not provided, will use lookup table </span>
<span class="sd">        (see get_Lstar documentation for further explanation)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    results : dictionary</span>
<span class="sd">        containing keys: Blocal, Bmirr, GEOcar</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ib.find_Bmirror(t,y,[90,80,60,10])</span>
<span class="sd">    {&#39;Blocal&#39;: array([ 0.,  0.]),</span>
<span class="sd">     &#39;Bmirr&#39;: array([ 0.,  0.]),</span>
<span class="sd">     &#39;loci&#39;: Coords( [[ NaN  NaN  NaN]</span>
<span class="sd">     [ NaN  NaN  NaN]] ), dtype=GEO,car, units=[&#39;Re&#39;, &#39;Re&#39;, &#39;Re&#39;]}</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_magequator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>
    <span class="c1">#degalpha = d[&#39;degalpha&#39;]</span>
    <span class="c1">#nalp_max = d[&#39;nalp_max&#39;]</span>
    <span class="c1">#nalpha = d[&#39;nalpha&#39;]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTAI</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">blocal</span><span class="p">,</span> <span class="n">bmirr</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_mirror_point1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span> \
            <span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">magin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">blocal</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">blocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmirr</span><span class="p">,</span><span class="n">badval</span><span class="p">)</span> <span class="p">:</span> <span class="n">bmirr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span><span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocal</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmirr</span>	
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEOcoord</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">],</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="find_magequator"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.find_magequator.html#spacepy.irbempy.find_magequator">[docs]</a><span class="k">def</span> <span class="nf">find_magequator</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    call find_magequator from irbem library and return a dictionary with values for</span>
<span class="sd">    Bmin and the GEO (cartesian) coordinates of the magnetic equator</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (dictionary) : containing keys: Bmin, Coords instance with GEO coordinates of </span>
<span class="sd">            the magnetic equator</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; op.find_magequator(t,y)</span>
<span class="sd">    {&#39;Bmin&#39;: array([  945.63652413,  3373.64496167]),</span>
<span class="sd">        &#39;loci&#39;: Coords( [[ 2.99938371  0.00534151 -0.03213603]</span>
<span class="sd">        [ 2.00298822 -0.0073077   0.04584859]] ), dtype=GEO,car, units=[&#39;Re&#39;, &#39;Re&#39;, &#39;Re&#39;]}</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_Bmirr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[],</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTAI</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
            <span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmin&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEOcoord</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">],</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">find_LCDS</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">mlt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the last closed drift shell (LCDS) for a given equatorial pitch angle.</span>

<span class="sd">    Uses the IRBEM library to determine L* and searches via bisection to find LCDS</span>
<span class="sd">    to a given tolerance in R (radial distance along GSM equator at local midnight).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information **for a single time**</span>
<span class="sd">        - alpha (numeric) : equatorial pitch angle for search</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>
<span class="sd">        - tol (float) : tolerance for search in radial distance</span>
<span class="sd">        - bracket (list): X-GSM coordinates to bracket bisection search</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        results (SpaceData, dictionary-like): contains keys LCDS, K, AlphaEq and UTC</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = spacepy.time.Ticktock([&#39;2002-02-02T12:00:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.find_LCDS(t, 90, extMag=&#39;T89&#39;)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_Bmirr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

    <span class="c1">#First set inner bracket (default to R of 3)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bracket</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified initial bracket is invalid&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,])</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Last closed drift shell calculated with SpacePy&#39;s irbempy module&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UNITS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dimensionless&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MODEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (IRBEM implementation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extMag</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Modified 2nd adiabatic invariant at LCDS&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UNITS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;R_E.G^{1/2}&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AlphaEq&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MODEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (IRBEM implementation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extMag</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> 
                                    <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">:</span> <span class="s1">&#39;Equatorial pitch angle for LCDS calculation&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;UNITS&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">})</span>
    
    <span class="n">mlt</span> <span class="o">*=</span> <span class="mi">15</span> <span class="c1">#hours to degrees</span>
    <span class="n">mlt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idxt</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ticks</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">omnivals</span><span class="p">:</span>
            <span class="c1">#prep_irbem will get omni if not specified, but to save on repeated calls, do it once here</span>
            <span class="kn">import</span> <span class="nn">spacepy.omni</span> <span class="k">as</span> <span class="nn">omni</span>
            <span class="n">omnivals</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">get_omni</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idxa</span><span class="p">,</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">b1x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">b1y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">loci_brac1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">b1x</span><span class="p">,</span><span class="n">b1y</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial inner bracket: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac1</span><span class="p">))</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="n">pa</span><span class="p">],</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
            <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
            <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
            <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
            <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
            <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
            <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
            <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
            <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>
            <span class="n">nTtoG</span> <span class="o">=</span> <span class="mf">1.0e-5</span>

            <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="c1">#Now get Lstar at this location...</span>
            <span class="k">if</span> <span class="n">GEOcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
                <span class="n">pos1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                <span class="n">LS1</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified inner bracket (</span><span class="si">{0}</span><span class="s1">) is on an open drift shell&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac1</span><span class="p">))</span>
                <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified inner bracket (</span><span class="si">{0}</span><span class="s1">) is on an open drift shell&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac1</span><span class="p">))</span>
            <span class="c1">#print(&#39;L* at inner bracket: {0}&#39;.format(LS1[&#39;Lstar&#39;]))</span>
            <span class="n">LCDS</span><span class="p">,</span> <span class="n">LCDS_K</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                
            <span class="c1">#Set outer bracket (default to R of 12)</span>
            <span class="n">b2x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">b2y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">loci_brac2</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">b2x</span><span class="p">,</span><span class="n">b2y</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial outer bracket: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac2</span><span class="p">))</span>

            <span class="n">d2</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="n">pa</span><span class="p">],</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="n">badval</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
            <span class="n">kext</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
            <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
            <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
            <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
            <span class="n">xin1</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
            <span class="n">xin2</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
            <span class="n">xin3</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
            <span class="n">magin</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

            <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="c1">#Now get Lstar at this location...</span>
            <span class="k">if</span> <span class="n">GEOcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
                <span class="n">pos2</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                <span class="n">LS2</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS2</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified outer bracket is on a closed drift shell&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LS2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Lstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">}</span>
            <span class="c1">#print(&#39;L* at outer bracket: {0}; Xgsm = {1}&#39;.format(LS2[&#39;Lstar&#39;], loci_brac2.x))</span>
            
            <span class="c1">#now search by bisection</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">):</span>
                <span class="n">newdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span>
                <span class="n">newx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">newdist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
                <span class="n">newy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">newdist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
                <span class="n">pos_test</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>

                <span class="n">dtest</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos_test</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="n">pa</span><span class="p">],</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="n">badval</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
                <span class="n">kext</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
                <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
                <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
                <span class="n">idoysat</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
                <span class="n">xin1</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
                <span class="n">xin2</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
                <span class="n">xin3</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
                <span class="n">magin</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

                <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                    <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="c1">#print(&#39;bmin, GEOcoord = {0},{1}&#39;.format(bmin, GEOcoord))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bmin</span><span class="p">)):</span>
                    <span class="c1">#Now get Lstar at this location...</span>
                    <span class="n">postry</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                    <span class="n">LStry</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">postry</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                    <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LStry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Lstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L* at test point: </span><span class="si">{0}</span><span class="s1">; Xgsm = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">],</span> <span class="n">pos_test</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">loci_brac2</span> <span class="o">=</span> <span class="n">pos_test</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loci_brac1</span> <span class="o">=</span> <span class="n">pos_test</span>
                    <span class="n">LCDS</span><span class="p">,</span> <span class="n">LCDS_K</span> <span class="o">=</span> <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxa</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxa</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS_K</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS_K</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">find_LCDS_K</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="n">mlt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the last closed drift shell (LCDS) for a given equatorial pitch angle.</span>

<span class="sd">    Uses the IRBEM library to determine L* and searches via bisection to find LCDS</span>
<span class="sd">    to a given tolerance in R (radial distance along GSM equator at local midnight).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information **for a single time**</span>
<span class="sd">        - alpha (numeric) : equatorial pitch angle for search</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>
<span class="sd">        - tol (float) : tolerance for search in radial distance</span>
<span class="sd">        - bracket (list): X-GSM coordinates to bracket bisection search</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        results (SpaceData, dictionary-like): contains keys LCDS, K, AlphaEq and UTC</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = spacepy.time.Ticktock([&#39;2002-02-02T12:00:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.find_LCDS(t, 90, extMag=&#39;T89&#39;)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_Bmirr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">Aopt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Aopt</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1">#First set inner bracket (default to R of 3)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bracket</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified initial bracket is invalid&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span> <span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="n">K</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">)],</span> <span class="n">fillval</span><span class="o">=</span><span class="s1">&#39;Success&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S24&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,])</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmfilled</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,])</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Last closed drift shell calculated with SpacePy&#39;s irbempy module&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UNITS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dimensionless&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MODEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (IRBEM implementation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extMag</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Modified 2nd adiabatic invariant at LCDS&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;UNITS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;R_E.G^{1/2}&quot;</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;MODEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (IRBEM implementation)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extMag</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;UTC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">dmarray</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">:</span> <span class="s1">&#39;Equatorial pitch angle for LCDS calculation&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;UNITS&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">})</span>
    
    <span class="n">mlt</span> <span class="o">*=</span> <span class="mi">15</span> <span class="c1">#hours to degrees</span>
    <span class="n">mlt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idxt</span><span class="p">,</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ticks</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">omnivals</span><span class="p">:</span>
            <span class="c1">#prep_irbem will get omni if not specified, but to save on repeated calls, do it once here</span>
            <span class="kn">import</span> <span class="nn">spacepy.omni</span> <span class="k">as</span> <span class="nn">omni</span>
            <span class="n">omnivals</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">get_omni</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idxk</span><span class="p">,</span> <span class="n">k_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="n">b1x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">b1y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">loci_brac1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">b1x</span><span class="p">,</span><span class="n">b1y</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial inner bracket: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac1</span><span class="p">))</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
            <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
            <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
            <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
            <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
            <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
            <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
            <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
            <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>
            <span class="n">nTtoG</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

            <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="c1">#Now get Lstar at this location...</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">pos1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">AlphaOfK</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">Aopt</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="n">LS1</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid inner bracket&#39;</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid inner bracket&#39;</span>
                    <span class="k">continue</span>
                <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid inner bracket&#39;</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid inner bracket&#39;</span>
                <span class="k">continue</span>

            <span class="c1">#print(&#39;L* at inner bracket: {0}&#39;.format(LS1[&#39;Lstar&#39;]))</span>
            <span class="n">LCDS</span><span class="p">,</span> <span class="n">LCDS_PA</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pa</span>
                
            <span class="c1">#Set outer bracket (default to R of 12)</span>
            <span class="n">b2x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">b2y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">bracket</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
            <span class="n">loci_brac2</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">b2x</span><span class="p">,</span><span class="n">b2y</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial outer bracket: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loci_brac2</span><span class="p">))</span>

            <span class="n">d2</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="n">badval</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
            <span class="n">kext</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
            <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
            <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
            <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
            <span class="n">secs</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
            <span class="n">xin1</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
            <span class="n">xin2</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
            <span class="n">xin3</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
            <span class="n">magin</span> <span class="o">=</span> <span class="n">d2</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

            <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="c1">#Now get Lstar at this location...</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">pos2</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">AlphaOfK</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">Aopt</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="n">LS2</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS2</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid outer bracket&#39;</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid outer bracket&#39;</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LS2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Lstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">}</span>
            <span class="c1">#print(&#39;L* at outer bracket: {0}; Xgsm = {1}&#39;.format(LS2[&#39;Lstar&#39;], loci_brac2.x))</span>
            
            <span class="c1">#now search by bisection</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">):</span>
                <span class="n">newdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">tb</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">loci_brac1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">loci_brac1</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span>
                <span class="n">newx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">newdist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
                <span class="n">newy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">newdist</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
                <span class="n">pos_test</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">([</span><span class="n">newx</span><span class="p">,</span> <span class="n">newy</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;GSM&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>

                <span class="n">dtest</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">pos_test</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                <span class="n">badval</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
                <span class="n">kext</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
                <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
                <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
                <span class="n">idoysat</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
                <span class="n">xin1</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
                <span class="n">xin2</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
                <span class="n">xin3</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
                <span class="n">magin</span> <span class="o">=</span> <span class="n">dtest</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

                <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                    <span class="n">iyearsat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="c1">#print(&#39;bmin, GEOcoord = {0},{1}&#39;.format(bmin, GEOcoord))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bmin</span><span class="p">)):</span>
                    <span class="c1">#Now get Lstar at this location...</span>
                    <span class="n">postry</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
                    <span class="n">pa</span> <span class="o">=</span> <span class="n">AlphaOfK</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">postry</span><span class="p">,</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">Aopt</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                    <span class="n">LStry</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">postry</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
                    <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LStry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Lstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L* at test point: </span><span class="si">{0}</span><span class="s1">; Xgsm = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">],</span> <span class="n">pos_test</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">loci_brac2</span> <span class="o">=</span> <span class="n">pos_test</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loci_brac1</span> <span class="o">=</span> <span class="n">pos_test</span>
                    <span class="n">LCDS</span><span class="p">,</span> <span class="n">LCDS_PA</span> <span class="o">=</span> <span class="n">LStry</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pa</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">,</span> <span class="n">idxk</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS_PA</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">][</span><span class="n">idxt</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCDS_PA</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;LCDS&#39;</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;AlphaEq&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">AlphaOfK</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the equatorial pitch angle corresponding to a given second invariant K.</span>

<span class="sd">    Uses the IRBEM library to determine K and searches via bisection to find Alpha(K).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information **for a single time**</span>
<span class="sd">        - loci (Coords class) : containing position information **for a single point**</span>
<span class="sd">        - K (numeric) : value of second invariant (K) for search</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>
<span class="sd">        - tol (float) : tolerance for search in radial distance</span>
<span class="sd">        - bracket (list): X-GSM coordinates to bracket bisection search</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        AlphaEq : equatorial pitch angle corresponding to K</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = spacepy.time.Ticktock([&#39;2002-09-01T04:00:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; loci = spacepy.coordinates.Coords([-4,0,0], &#39;GSM&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.AlphaOfK(t, loci, 0.11, extMag=&#39;T89&#39;)</span>
<span class="sd">    48.984375</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_Bmirr, find_LCDS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>
    <span class="n">nTtoG</span> <span class="o">=</span> <span class="mf">1.0e-5</span>

    <span class="n">outvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">outvals</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">bmin</span><span class="p">,</span> <span class="n">GEOcoord</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_magequator1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">sysaxes</span><span class="p">,</span>\
                         <span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xin3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">magin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">GEOcoord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">pa0</span> <span class="o">=</span> <span class="mi">90</span> <span class="c1">#start with equatorially mirroring</span>
        <span class="c1">#Now get K for initial alpha at this location...</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">GEOcoord</span><span class="p">,</span> <span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span>
            <span class="n">LS1</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pa0</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&#39;i = {0}, skipping because of bad position&#39;.format(i))</span>
            <span class="k">continue</span>
        <span class="n">K0</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">K0</span><span class="o">-</span><span class="n">K</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">outvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa0</span>
            <span class="c1">#print(&#39;i= {0}, found alpha = {1}&#39;.format(i, pa0))</span>
            <span class="k">continue</span>

        <span class="n">Done</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">pa_upper</span><span class="p">,</span> <span class="n">pa_lower</span><span class="p">,</span> <span class="n">pa_test</span> <span class="o">=</span> <span class="n">pa0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">Done</span><span class="p">:</span>
            <span class="c1">#print(&#39;Testing PA={0}&#39;.format(pa_test))</span>
            <span class="c1">#Now get K for initial alpha at this location...</span>
            <span class="n">LS1</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pa_test</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTtoG</span><span class="p">)</span>
            <span class="c1">#print(&#39;L* at inner bracket: {0}&#39;.format(LS1[&#39;Lstar&#39;]))</span>
            <span class="n">K_test</span> <span class="o">=</span> <span class="n">LS1</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">K_test</span><span class="o">-</span><span class="n">K</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                <span class="c1">#print(&#39;***Found K={0} (Req. {1}) at Alpha={2}&#39;.format(K_test, K, pa_test))</span>
                <span class="n">outvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa_test</span>
                <span class="k">break</span>
            <span class="c1">#print(&#39;Not Done: Kfound = {0}, Kwant = {1}&#39;.format(K_test, K))</span>
            <span class="k">if</span> <span class="n">K_test</span> <span class="o">&gt;</span> <span class="n">K</span><span class="p">:</span> <span class="c1"># K is too large, hence alpha is too small, increase.</span>
                <span class="n">pa_lower</span> <span class="o">=</span> <span class="n">pa_test</span>
                <span class="c1">#print(&#39;Reset lower bound. U,L = {0},{1}&#39;.format(pa_upper, pa_lower))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># K is too small, hence alpha is too large, reduce</span>
                <span class="n">pa_upper</span> <span class="o">=</span> <span class="n">pa_test</span>
                <span class="c1">#print(&#39;Reset upper bound. U,L = {0},{1}&#39;.format(pa_upper, pa_lower))</span>
            <span class="n">pa_test</span> <span class="o">=</span> <span class="n">pa_lower</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pa_upper</span><span class="o">-</span><span class="n">pa_lower</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="c1">#print(&#39;Change alpha to {0}&#39;.format(pa_test))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span><span class="o">&gt;</span><span class="mi">20</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">outvals</span>
        

<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">find_footpoint</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    call find_foot_point1 from irbem library and return a dictionary with values for</span>
<span class="sd">    Bmin and the GEO (cartesian) coordinates of the magnetic equator</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained in Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - (see Lstar documentation for further explanation)</span>
<span class="sd">        - hemi (string) : optional (valid cases are &#39;same&#39;, &#39;other&#39;, &#39;north&#39; or &#39;south&#39;)</span>
<span class="sd">                          will set the target hemisphere for tracing the footpoint</span>
<span class="sd">        - alt (numeric) : optional keyword to set stop height [km] of fieldline trace (default 100km)</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (spacepy.datamodel.SpaceData) : containing keys</span>
<span class="sd">                   Bfoot    - Magnitude of B-field at footpoint [nT]</span>
<span class="sd">                   loci     - Coords instance with GDZ coordinates of the magnetic footpoint [alt, lat, lon]</span>
<span class="sd">                   Bfootvec - Components of B-field at footpoint in cartesian GEO coordinates [nT]</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = Coords([[3,0,0],[3,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.find_footpoint(t, y)</span>
<span class="sd">    {&#39;Bfoot&#39;: array([ 47559.04643444,  47542.84688657]),</span>
<span class="sd">     &#39;Bfootvec&#39;: array([[-38428.07217246,   4497.31549786, -27657.19291928],</span>
<span class="sd">           [-38419.08514332,   4501.45390964, -27641.14866517]]),</span>
<span class="sd">     &#39;loci&#39;: Coords( [[ 99.31443778  55.71415787 -10.21888955]</span>
<span class="sd">     [ 99.99397026  55.70716296 -10.22797462]] ), dtype=GDZ,sph, units=[&#39;km&#39;, &#39;deg&#39;, &#39;deg&#39;]}</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_Lstar, get_Bfield, find_Bmirr, find_magequator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># prepare input values for irbem call</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span>
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span>

    <span class="n">hemi_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;same&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">]:</span>
        <span class="n">hemi_flag</span> <span class="o">=</span> <span class="n">hemi_dict</span><span class="p">[</span><span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Option for hemisphere to trace to (</span><span class="si">{0}</span><span class="s1">) is invalid.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39;Valid options are: same, other, north and south&#39;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bfoot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nTAI</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bfootvec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nTAI</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nTAI</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">xfoot</span><span class="p">,</span> <span class="n">bfoot</span><span class="p">,</span> <span class="n">bfootmag</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">find_foot_point1</span><span class="p">(</span><span class="n">kext</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">sysaxes</span><span class="p">,</span>\
            <span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">secs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xin3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alt</span><span class="p">,</span> <span class="n">hemi_flag</span><span class="p">,</span> <span class="n">magin</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bfootmag</span><span class="p">,</span><span class="n">badval</span><span class="p">):</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">xfoot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xfoot</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">bfoot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bfoot</span><span class="p">,</span> <span class="n">badval</span><span class="p">))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bfoot&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfootmag</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfoot</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bfootvec&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bfoot</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;loci&#39;</span><span class="p">],</span> <span class="s1">&#39;GDZ&#39;</span><span class="p">,</span> <span class="s1">&#39;sph&#39;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">attrs</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="coord_trans"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.coord_trans.html#spacepy.irbempy.coord_trans">[docs]</a><span class="k">def</span> <span class="nf">coord_trans</span><span class="p">(</span><span class="n">loci</span><span class="p">,</span> <span class="n">returntype</span><span class="p">,</span> <span class="n">returncarsph</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    thin layer to call coor_trans1 from irbem lib</span>
<span class="sd">    this will convert between systems GDZ, GEO, GSM, GSE, SM, GEI, MAG, SPH, RLL</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - loci (Coords instance) : containing coordinate information, can contain n points</span>
<span class="sd">        - returntype (str) : describing system as GDZ, GEO, GSM, GSE, SM, GEI, MAG, SPH, RLL</span>
<span class="sd">        - returncarsph (str) : cartesian or spherical units &#39;car&#39;, &#39;sph&#39;</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - xout (ndarray) : values after transformation in (n,3) dimensions</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; c = Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; c.ticks = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; coord_trans(c, &#39;GSM&#39;, &#39;car&#39;)</span>
<span class="sd">    array([[ 2.8639301 , -0.01848784,  0.89306361],</span>
<span class="sd">    [ 1.9124434 ,  0.07209424,  0.58082929]])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    sph2car, car2sph</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sysaxesin</span> <span class="o">=</span> <span class="n">get_sysaxes</span><span class="p">(</span> <span class="n">loci</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">loci</span><span class="o">.</span><span class="n">carsph</span> <span class="p">)</span>
    <span class="n">sysaxesout</span> <span class="o">=</span> <span class="n">get_sysaxes</span><span class="p">(</span> <span class="n">returntype</span><span class="p">,</span> <span class="n">returncarsph</span> <span class="p">)</span>

    <span class="c1"># swap carsph if sysaxesout is None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sysaxesout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">returncarsph</span> <span class="o">==</span> <span class="s1">&#39;sph&#39;</span><span class="p">):</span>
        <span class="n">sysaxesout</span> <span class="o">=</span> <span class="n">get_sysaxes</span><span class="p">(</span> <span class="n">returntype</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span> <span class="p">)</span>
        <span class="n">aflag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">sysaxesout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">returncarsph</span> <span class="o">==</span> <span class="s1">&#39;car&#39;</span><span class="p">):</span>
        <span class="n">sysaxesout</span> <span class="o">=</span> <span class="n">get_sysaxes</span><span class="p">(</span> <span class="n">returntype</span><span class="p">,</span> <span class="s1">&#39;sph&#39;</span> <span class="p">)</span>
        <span class="n">aflag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aflag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">xout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">loci</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loci</span><span class="p">)):</span>
        <span class="n">iyear</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
        <span class="n">idoy</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="o">.</span><span class="n">DOY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="o">*</span><span class="mf">3600.</span> <span class="o">+</span> <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span><span class="o">*</span><span class="mf">60.</span> <span class="o">+</span> \
            <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">second</span>
            
        <span class="n">xout</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">coord_trans1</span><span class="p">(</span><span class="n">sysaxesin</span><span class="p">,</span> <span class="n">sysaxesout</span><span class="p">,</span> \
            <span class="n">iyear</span><span class="p">,</span> <span class="n">idoy</span><span class="p">,</span> <span class="n">secs</span><span class="p">,</span> <span class="n">loci</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
    <span class="c1"># add  sph to car or v/v convertion if initial sysaxesout was None</span>
    <span class="k">if</span>  <span class="n">aflag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">returncarsph</span> <span class="o">==</span> <span class="s1">&#39;sph&#39;</span><span class="p">:</span>
            <span class="n">xout</span> <span class="o">=</span> <span class="n">car2sph</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># &#39;car&#39; needs to be returned</span>
            <span class="n">xout</span> <span class="o">=</span> <span class="n">sph2car</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xout</span></div>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="car2sph"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.car2sph.html#spacepy.irbempy.car2sph">[docs]</a><span class="k">def</span> <span class="nf">car2sph</span><span class="p">(</span><span class="n">CARin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    coordinate transformation from cartesian to spherical</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - CARin (list or ndarray) : coordinate points in (n,3) shape with n coordinate points in</span>
<span class="sd">            units of [Re, Re, Re] = [x,y,z]</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (ndarray) : values after conversion to spherical coordinates in</span>
<span class="sd">            radius, latitude, longitude in units of [Re, deg, deg]</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; sph2car([1,45,0])</span>
<span class="sd">    array([ 0.70710678,  0.        ,  0.70710678])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    sph2car</span>
<span class="sd">    &quot;&quot;&quot;</span>	

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">CARin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">CAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">CARin</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">CAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">CARin</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">CAR</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CAR</span><span class="p">)):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">CAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">CAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">CAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
        <span class="n">sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># on the poles</span>
            <span class="n">longi</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lati</span> <span class="o">=</span> <span class="o">-</span><span class="mf">90.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lati</span> <span class="o">=</span> <span class="mf">90.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">longi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">lati</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">lati</span><span class="p">,</span> <span class="n">longi</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">CARin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span></div>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="sph2car"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.sph2car.html#spacepy.irbempy.sph2car">[docs]</a><span class="k">def</span> <span class="nf">sph2car</span><span class="p">(</span><span class="n">SPHin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    coordinate transformation from spherical to cartesian</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - SPHin (list or ndarray) : coordinate points in (n,3) shape with n coordinate points in</span>
<span class="sd">            units of [Re, deg, deg] = [r, latitude, longitude]</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (ndarray) : values after conversion to cartesian coordinates x,y,z</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; sph2car([1,45,45])</span>
<span class="sd">    array([ 0.5       ,  0.5       ,  0.70710678])</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    car2sph</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SPHin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">SPH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">SPHin</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">SPH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">SPHin</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">SPH</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SPH</span><span class="p">)):</span>
        <span class="n">r</span><span class="p">,</span><span class="n">lati</span><span class="p">,</span><span class="n">longi</span> <span class="o">=</span> <span class="n">SPH</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">SPH</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">SPH</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">colat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">lati</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">longi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">longi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">colat</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SPHin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span></div>

<span class="c1"># -----------------------------------------------    </span>
<div class="viewcode-block" id="get_sysaxes"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_sysaxes.html#spacepy.irbempy.get_sysaxes">[docs]</a><span class="k">def</span> <span class="nf">get_sysaxes</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">carsph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    will return the sysaxes according to the irbem library</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    - dtype (str) : coordinate system, possible values: GDZ, GEO, GSM, GSE, SM, </span>
<span class="sd">            GEI, MAG, SPH, RLL</span>
<span class="sd">    - carsph (str) : cartesian or spherical, possible values: &#39;sph&#39;, &#39;car&#39;</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    - sysaxes (int) : value after oner_desp library from 0-8 (or None if not available)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; get_sysaxes(&#39;GSM&#39;, &#39;car&#39;)</span>
<span class="sd">    2</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_dtype</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#typedict = {&#39;GDZ&#39;: {&#39;sph&#39;: 0, &#39;car&#39;: 10},</span>
        <span class="c1">#&#39;GEO&#39;: {&#39;sph&#39;: 1, &#39;car&#39;: 11}, &#39;GSM&#39;: {&#39;sph&#39;: 22, &#39;car&#39;: 2},</span>
        <span class="c1">#&#39;GSE&#39;: {&#39;sph&#39;: 23, &#39;car&#39;: 3}, &#39;SM&#39;: {&#39;sph&#39;: 24, &#39;car&#39;: 4},</span>
        <span class="c1">#&#39;GEI&#39;: {&#39;sph&#39;: 25, &#39;car&#39;: 5}, &#39;MAG&#39;: {&#39;sph&#39;: 26, &#39;car&#39;: 6},</span>
        <span class="c1">#&#39;SPH&#39;: {&#39;sph&#39;: 7, &#39;car&#39;: 17}, &#39;RLL&#39;: {&#39;sph&#39;: 8, &#39;car&#39;: 18}}</span>
        
    
    <span class="n">sysaxes</span> <span class="o">=</span> <span class="n">SYSAXES_TYPES</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="n">carsph</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sysaxes</span></div>
    
<span class="c1"># -----------------------------------------------    </span>
<div class="viewcode-block" id="get_dtype"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_dtype.html#spacepy.irbempy.get_dtype">[docs]</a><span class="k">def</span> <span class="nf">get_dtype</span><span class="p">(</span><span class="n">sysaxes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    will return the coordinate system type as string</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - sysaxes (int) : number according to the irbem, possible values: 0-8</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - dtype (str) : coordinate system GDZ, GEO, GSM, GSE, SM, GEI, MAG, SPH, RLL</span>
<span class="sd">        - carsph (str) : cartesian or spherical &#39;car&#39;, &#39;sph&#39;</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; get_dtype(3)</span>
<span class="sd">    (&#39;GSE&#39;, &#39;car&#39;)</span>

<span class="sd">    See Also</span>
<span class="sd">    ========</span>
<span class="sd">    get_sysaxes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SYSAXES_TYPES</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="n">SYSAXES_TYPES</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">SYSAXES_TYPES</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span> <span class="o">==</span> <span class="n">sysaxes</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">carsph</span> <span class="o">=</span> <span class="n">subkey</span>

    <span class="k">return</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">carsph</span></div>

<span class="c1"># -----------------------------------------------    </span>
<div class="viewcode-block" id="get_AEP8"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_AEP8.html#spacepy.irbempy.get_AEP8">[docs]</a><span class="k">def</span> <span class="nf">get_AEP8</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">fluxtype</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">particles</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    will return the flux from the AE8-AP8 model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - energy (float) : center energy in MeV; if fluxtype=RANGE, then needs to be a list [Emin, Emax]</span>
<span class="sd">        - loci (Coords)  : a Coords instance with the location inside the magnetosphere</span>
<span class="sd">             optional      instead of a Coords instance, one can also provide a list with [BBo, L] combination</span>
<span class="sd">        - model (str)    : MIN or MAX for solar cycle dependence</span>
<span class="sd">        - fluxtype (str) : DIFF, RANGE, INT are possible types</span>
<span class="sd">        - particles (str): e or p or electrons or protons</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - float : flux from AE8/AP8 model</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.get_aep8()</span>

<span class="sd">    &gt;&gt;&gt; import spacepy.time as spt</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.coordinates as spc</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.irbempy as ib</span>
<span class="sd">    &gt;&gt;&gt; t = spt.Ticktock([&#39;2017-02-02T12:00:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = spc.Coords([3,0,0], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y.ticks = t</span>
<span class="sd">    &gt;&gt;&gt; energy = 1.0 #MeV</span>
<span class="sd">    &gt;&gt;&gt; ib.get_AEP8(energy, y, model=&#39;max&#39;)</span>
<span class="sd">    1932209.4427359989</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># find bad values and dimensions</span>
    
    <span class="k">if</span> <span class="n">particles</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="c1"># then choose electron model</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MIN&#39;</span><span class="p">:</span>
            <span class="n">whichm</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MAX&#39;</span><span class="p">:</span>
            <span class="n">whichm</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: model=&#39;</span><span class="o">+</span><span class="n">model</span><span class="o">+</span><span class="s1">&#39; is not implemented: Choose MIN or MAX&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">particles</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="c1"># then choose proton model</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MIN&#39;</span><span class="p">:</span>
            <span class="n">whichm</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MAX&#39;</span><span class="p">:</span>
            <span class="n">whichm</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: model=&#39;</span><span class="o">+</span><span class="n">model</span><span class="o">+</span><span class="s1">&#39; is not implemented: Choose MIN or MAX&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: particles=&#39;</span><span class="o">+</span><span class="n">particles</span><span class="o">+</span><span class="s1">&#39; is not available: choose e or p&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fluxtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DIFF&#39;</span><span class="p">:</span>
        <span class="n">whatf</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">fluxtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;RANGE&#39;</span><span class="p">:</span>
        <span class="n">whatf</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">fluxtype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;INT&#39;</span><span class="p">:</span>
        <span class="n">whatf</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: fluxtype=&#39;</span><span class="o">+</span><span class="n">fluxtype</span><span class="o">+</span><span class="s1">&#39; is not implemented: Choose DIFF, INT or RANGE&#39;</span><span class="p">)</span>
    
    <span class="c1"># need range if whatf=2</span>
    <span class="n">Nene</span>  <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">whatf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Need energy range with this choice of fluxtype=RANGE&#39;</span>
    <span class="n">ntmax</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#build dummy OMNI dictionary for prep_irbem (AE/AP8 doesn&#39;t need these inputs)</span>
    <span class="n">dum_omni</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">magkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Kp&#39;</span><span class="p">,</span> <span class="s1">&#39;Dst&#39;</span><span class="p">,</span> <span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="s1">&#39;velo&#39;</span><span class="p">,</span> <span class="s1">&#39;Pdyn&#39;</span><span class="p">,</span> <span class="s1">&#39;ByIMF&#39;</span><span class="p">,</span> <span class="s1">&#39;BzIMF&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;G2&#39;</span><span class="p">,</span> <span class="s1">&#39;G3&#39;</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;W2&#39;</span><span class="p">,</span> <span class="s1">&#39;W3&#39;</span><span class="p">,</span> <span class="s1">&#39;W4&#39;</span><span class="p">,</span> <span class="s1">&#39;W5&#39;</span><span class="p">,</span> <span class="s1">&#39;W6&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magkeys</span><span class="p">:</span>
        <span class="n">dum_omni</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">loci</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loci</span><span class="p">,</span> <span class="n">spc</span><span class="o">.</span><span class="n">Coords</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="p">,</span> <span class="s1">&#39;Coords require time information with a Ticktock object&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">loci</span><span class="o">.</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="o">=</span><span class="n">loci</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">dum_omni</span><span class="p">)</span>
        <span class="n">E_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]))</span>
        <span class="n">E_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="c1"># now get the flux</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">fly_in_nasa_aeap1</span><span class="p">(</span><span class="n">ntmax</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">],</span> <span class="n">whichm</span><span class="p">,</span> <span class="n">whatf</span><span class="p">,</span> <span class="n">Nene</span><span class="p">,</span> <span class="n">E_array</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">],</span> \
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loci</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">BBo</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">loci</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">omnivals</span><span class="o">=</span><span class="n">dum_omni</span><span class="p">)</span>
        <span class="n">E_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]))</span>
        <span class="n">E_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">B_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ntime_max&#39;</span><span class="p">])</span>
        <span class="n">B_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BBo</span>
        <span class="n">L_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ntime_max&#39;</span><span class="p">])</span>
        <span class="n">L_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
        <span class="c1"># now get the flux</span>
        <span class="n">flux</span> <span class="o">=</span>  <span class="n">oplib</span><span class="o">.</span><span class="n">get_ae8_ap8_flux</span><span class="p">(</span><span class="n">ntmax</span><span class="p">,</span> <span class="n">whichm</span><span class="p">,</span> <span class="n">whatf</span><span class="p">,</span> <span class="n">Nene</span><span class="p">,</span> <span class="n">E_array</span><span class="p">,</span> <span class="n">B_array</span><span class="p">,</span> <span class="n">L_array</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: coords need to be either a spacepy.coordinates.Coords instance or a list of [BBo, L]&#39;</span><span class="p">)</span>
        
    
    <span class="n">flux</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    
    <span class="k">return</span> <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span></div>
    

<span class="c1"># -----------------------------------------------</span>
<span class="k">def</span> <span class="nf">_get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">landi2lstar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will call make_lstar1 or make_lstar_shell_splitting_1 from the irbem library</span>
<span class="sd">    and will lookup omni values for given time if not provided (optional). If pitch angles</span>
<span class="sd">    are provided, drift shell splitting will be calculated and &quot;Bmirr&quot; will be returned. If they</span>
<span class="sd">    are not provided, then no drift shell splitting is calculated and &quot;Blocal&quot; is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - alpha (list or ndarray) : pitch angles in degrees; if provided will </span>
<span class="sd">            calculate shell splitting; max 25 values</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained below</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - landi2lstar : if True, will use the faster landi2lstar routine if possible. This </span>
<span class="sd">            routine can only be used with OPQUIET+IGRF magnetic field models.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (dictionary) : containing keys: Lm, Lstar, Bmin, Blocal (or Bmirr), </span>
<span class="sd">            Xj (I - the 2nd invariant), MLT</span>
<span class="sd">            if pitch angles provided in &quot;alpha&quot; then drift shells are calculated and &quot;Bmirr&quot; </span>
<span class="sd">            is returned if not provided, then &quot;Blocal&quot; at spacecraft is returned.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.Lstar(t,y)</span>
<span class="sd">    {&#39;Blocal&#39;: array([ 1020.40493286,  3446.08845227]),</span>
<span class="sd">        &#39;Bmin&#39;: array([ 1019.98404311,  3437.63865243]),</span>
<span class="sd">        &#39;Lm&#39;: array([ 3.08948304,  2.06022102]),</span>
<span class="sd">        &#39;Lstar&#39;: array([ 2.97684043,  1.97868577]),</span>
<span class="sd">        &#39;MLT&#39;: array([ 23.5728333 ,  23.57287944]),</span>
<span class="sd">        &#39;Xj&#39;: array([ 0.00112884,  0.00286955])}</span>


<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    External Field</span>
<span class="sd">        - 0	   : no external field</span>
<span class="sd">        - MEAD	: Mead &amp; Fairfield [1975] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=17. Re)</span>
<span class="sd">        - T87SHORT: Tsyganenko short [1987] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=30. Re)</span>
<span class="sd">        - T87LONG : Tsyganenko long [1987] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=70. Re)</span>
<span class="sd">        - T89	 : Tsyganenko [1989] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=70. Re)</span>
<span class="sd">        - OPQUIET : Olson &amp; Pfitzer quiet [1977] (default - Valid for rGEO&lt;=15. Re)</span>
<span class="sd">        - OPDYN   : Olson &amp; Pfitzer dynamic [1988] (uses 5.&lt;=dens&lt;=50., 300.&lt;=velo&lt;=500., </span>
<span class="sd">            -100.&lt;=Dst&lt;=20. - Valid for rGEO&lt;=60. Re)</span>
<span class="sd">        - T96	 : Tsyganenko [1996] (uses -100.&lt;=Dst (nT)&lt;=20., 0.5&lt;=Pdyn (nPa)&lt;10., </span>
<span class="sd">            |ByIMF| (nT)&lt;1=0., |BzIMF| (nT)&lt;=10. - Valid for rGEO&lt;=40. Re)</span>
<span class="sd">        - OSTA	: Ostapenko &amp; Maltsev [1997] (uses dst,Pdyn,BzIMF, Kp)</span>
<span class="sd">            T01QUIET: Tsyganenko [2002a,b] (uses -50.&lt;Dst (nT)&lt;20., 0.5&lt;Pdyn (nPa)&lt;=5., </span>
<span class="sd">            |ByIMF| (nT)&lt;=5., |BzIMF| (nT)&lt;=5., 0.&lt;=G1&lt;=10., 0.&lt;=G2&lt;=10. - Valid for xGSM&gt;=-15. Re)</span>
<span class="sd">        - T01STORM: Tsyganenko, Singer &amp; Kasper [2003] storm  (uses Dst, Pdyn, ByIMF, BzIMF, G2, G3 - </span>
<span class="sd">            there is no upper or lower limit for those inputs - Valid for xGSM&gt;=-15. Re)</span>
<span class="sd">        - T05	 : Tsyganenko &amp; Sitnov [2005] storm  (uses Dst, Pdyn, ByIMF, BzIMF, </span>
<span class="sd">            W1, W2, W3, W4, W5, W6 - no upper or lower limit for inputs - Valid for xGSM&gt;=-15. Re)</span>
<span class="sd">        - TS07   : Tsyganenko and Sitnov [2007] model. Uses specially calculated coefficient files.</span>

<span class="sd">    OMNI contents</span>
<span class="sd">        - Kp: value of Kp as in OMNI2 files but has to be double instead of integer type</span>
<span class="sd">        - Dst: Dst index (nT)</span>
<span class="sd">        - dens: Solar Wind density (cm-3)</span>
<span class="sd">        - velo: Solar Wind velocity (km/s)</span>
<span class="sd">        - Pdyn: Solar Wind dynamic pressure (nPa)</span>
<span class="sd">        - ByIMF: GSM y component of IMF mag. field (nT)</span>
<span class="sd">        - BzIMF: GSM z component of IMF mag. field (nT)</span>
<span class="sd">        - G1:  G1=&lt; Vsw*(Bperp/40)2/(1+Bperp/40)*sin3(theta/2) &gt; where the &lt;&gt; mean an average over the </span>
<span class="sd">            previous 1 hour, Vsw is the solar wind speed, Bperp is the transverse IMF </span>
<span class="sd">            component (GSM) and theta it&#39;s clock angle.</span>
<span class="sd">        - G2: G2=&lt; a*Vsw*Bs &gt; where the &lt;&gt; mean an average over the previous 1 hour, </span>
<span class="sd">                Vsw is solar wind speed, Bs=|IMF Bz| when IMF Bz &lt; 0 and Bs=0 when IMF Bz &gt; 0, a=0.005.</span>
<span class="sd">        - G3:  G3=&lt; Vsw*Dsw*Bs /2000.&gt; where the &lt;&gt; mean an average over the previous 1 hour, </span>
<span class="sd">                Vsw is the solar wind speed, Dsw is the solar wind density, Bs=|IMF Bz| when IMF </span>
<span class="sd">                Bz &lt; 0 and Bs=0 when IMF Bz &gt; 0.</span>
<span class="sd">        - W1 - W6: see definition in (JGR-A, v.110(A3), 2005.) (PDF 1.2MB)</span>
<span class="sd">        - AL: the auroral index</span>

<span class="sd">    Options</span>
<span class="sd">        - 1st element: 0 - don&#39;t compute L* or phi ;  1 - compute L*; 2- compute phi</span>
<span class="sd">        - 2nd element: 0 - initialize IGRF field once per year (year.5);  </span>
<span class="sd">            n - n is the  frequency (in days) starting on January 1st of each year </span>
<span class="sd">            (i.e. if options(2nd element)=15 then IGRF will be updated on the following days of the </span>
<span class="sd">            year: 1, 15, 30, 45 ...)</span>
<span class="sd">        - 3rd element: resolution to compute L* (0 to 9) where 0 is the recomended value to ensure a </span>
<span class="sd">            good ratio precision/computation time</span>
<span class="sd">            (i.e. an error of ~2% at L=6). The higher the value the better will be the precision, the </span>
<span class="sd">            longer will be the computing time. Generally there is not much improvement for values </span>
<span class="sd">            larger than 4. Note that this parameter defines the integration step (theta) </span>
<span class="sd">            along the field line such as dtheta=(2pi)/(720*[options(3rd element)+1])</span>
<span class="sd">        - 4th element: resolution to compute L* (0 to 9). The higher the value the better will be </span>
<span class="sd">            the precision, the longer will be </span>
<span class="sd">            the computing time. It is recommended to use 0 (usually sufficient) unless L* is not </span>
<span class="sd">            computed on a LEO orbit. For LEO orbit higher values are recommended. Note that this </span>
<span class="sd">            parameter defines the integration step (phi) along the drift shell such as </span>
<span class="sd">            dphi=(2pi)/(25*[options(4th element)+1])</span>
<span class="sd">        - 5th element: allows to select an internal magnetic field model (default is set to IGRF)</span>
<span class="sd">            - 0 = IGRF</span>
<span class="sd">            - 1 = Eccentric tilted dipole</span>
<span class="sd">            - 2 = Jensen&amp;Cain 1960</span>
<span class="sd">            - 3 = GSFC 12/66 updated to 1970</span>
<span class="sd">            - 4 = User-defined model (Default: Centred dipole + uniform [Dungey open model] )</span>
<span class="sd">            - 5 = Centred dipole</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="p">)</span>
    <span class="n">nalpha</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalpha&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">landi2lstar</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">no_shell_splitting</span> <span class="o">=</span> <span class="p">(</span><span class="n">nalpha</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nalpha</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">90</span><span class="p">)</span>

    <span class="c1"># Arguments that are common to all flavors of L* functions</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">nTAI</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">],</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">],</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">no_shell_splitting</span><span class="p">:</span> <span class="c1"># no drift shell splitting</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">landi2lstar1</span> <span class="k">if</span> <span class="n">landi2lstar</span> <span class="k">else</span> <span class="n">oplib</span><span class="o">.</span><span class="n">make_lstar1</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># with drift shell splitting</span>
        <span class="c1"># Drift shell splitting requires pitch angle positional args</span>
        <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nalpha</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;degalpha&#39;</span><span class="p">])</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">oplib</span><span class="o">.</span><span class="n">landi2lstar_shell_splitting1</span> <span class="k">if</span> <span class="n">landi2lstar</span> \
               <span class="k">else</span> <span class="n">oplib</span><span class="o">.</span><span class="n">make_lstar_shell_splitting1</span>
    <span class="c1"># For a locally 90-degree particle, bmirr is blocal</span>
    <span class="n">lm</span><span class="p">,</span> <span class="n">lstar</span><span class="p">,</span> <span class="n">bmirr</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">mlt</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># take out all the odd &#39;bad values&#39; and turn them into NaN</span>
    <span class="n">lm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">lstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lstar</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">bmin</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">xj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xj</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">mlt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mlt</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">no_shell_splitting</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Lm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">bmirr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmirr</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmirr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Blocal&#39;</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MLT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>		
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Lm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lm</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nalpha</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Lstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstar</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nalpha</span><span class="p">]</span>
        <span class="n">bmirr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bmirr</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]))</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmirr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmirr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nalpha</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Bmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Xj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">nalpha</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MLT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="get_Lm"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_Lm.html#spacepy.irbempy.get_Lm">[docs]</a><span class="k">def</span> <span class="nf">get_Lm</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">intMag</span><span class="o">=</span><span class="s1">&#39;IGRF&#39;</span><span class="p">,</span> <span class="n">IGRFset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the MacIlwain L value for a given location, time and model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - alpha (list or ndarray) : pitch angles in degrees</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - intMag (string) : optional: select the internal field model</span>
<span class="sd">                            possible values [&#39;IGRF&#39;,&#39;EDIP&#39;,&#39;JC&#39;,&#39;GSFC&#39;,&#39;DUN&#39;,&#39;CDIP&#39;]</span>
<span class="sd">                            For full details see get_Lstar</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>

<span class="sd">        - results (dictionary) : containing keys: Lm, Bmin, Blocal (or Bmirr), Xj, MLT </span>
<span class="sd">            if pitch angles provided in &quot;alpha&quot; then drift shells are calculated and &quot;Bmirr&quot; </span>
<span class="sd">            is returned if not provided, then &quot;Blocal&quot; at spacecraft is returned. A negative</span>
<span class="sd">            value for Lm indicates the field line is closed but particles are lost to the</span>
<span class="sd">            atmosphere; the absolute value indicates the L value.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>


<span class="sd">    Notes</span>
<span class="sd">    =====</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intMaglookup</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IGRF&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;EDIP&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;JC&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;GSFC&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;DUN&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;CDIP&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">intMag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">intMaglookup</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid value of intMag: valid values are: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intMaglookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">IGRFset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">IGRFset</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="c1">##TODO: test for numeric type</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;IGRFset must be positive-valued and numeric&#39;</span><span class="p">)</span>
        
    <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">IGRFset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intMaglookup</span><span class="p">[</span><span class="n">intMag</span><span class="p">]]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="n">omnivals</span><span class="o">=</span><span class="n">omnivals</span><span class="p">)</span>
    <span class="n">dum</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Lstar&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="get_Lstar"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.get_Lstar.html#spacepy.irbempy.get_Lstar">[docs]</a><span class="k">def</span> <span class="nf">get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">landi2lstar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This will call make_lstar1 or make_lstar_shell_splitting_1 from the irbem library</span>
<span class="sd">    and will lookup omni values for given time if not provided (optional). If pitch angles</span>
<span class="sd">    are provided, drift shell splitting will be calculated and &quot;Bmirr&quot; will be returned. If they</span>
<span class="sd">    are not provided, then no drift shell splitting is calculated and &quot;Blocal&quot; is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">        - ticks (Ticktock class) : containing time information</span>
<span class="sd">        - loci (Coords class) : containing spatial information</span>
<span class="sd">        - alpha (list or ndarray) : optional pitch angles in degrees (default is 90);</span>
<span class="sd">            if provided will calculate shell splitting; max 25 values</span>
<span class="sd">        - extMag (string) : optional; will choose the external magnetic field model </span>
<span class="sd">                            possible values [&#39;0&#39;, &#39;MEAD&#39;, &#39;T87SHORT&#39;, &#39;T87LONG&#39;, &#39;T89&#39;, </span>
<span class="sd">                            &#39;OPQUIET&#39;, &#39;OPDYN&#39;, &#39;T96&#39;, &#39;OSTA&#39;, &#39;T01QUIET&#39;, &#39;T01STORM&#39;, </span>
<span class="sd">                            &#39;T05&#39;, &#39;ALEX&#39;, &#39;TS07&#39;]</span>
<span class="sd">        - options (optional list or array of integers length=5) : explained below</span>
<span class="sd">        - omni values as dictionary (optional) : if not provided, will use lookup table </span>
<span class="sd">        - landi2lstar : if True, will use the faster landi2lstar routine if possible. This </span>
<span class="sd">            routine can only be used with OPQUIET+IGRF magnetic field models.</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">        - results (dictionary) : containing keys: Lm, Lstar, Bmin, Blocal (or Bmirr), Xj, MLT </span>
<span class="sd">            if pitch angles provided in &quot;alpha&quot; then drift shells are calculated and &quot;Bmirr&quot; </span>
<span class="sd">            is returned if not provided, then &quot;Blocal&quot; at spacecraft is returned. A negative</span>
<span class="sd">            value for Lm indicates the field line is closed but particles are lost to the</span>
<span class="sd">            atmosphere; the absolute value indicates the L value. A negative value for Lstar</span>
<span class="sd">            indicates the field line is closed but particles are lost to the atmosphere</span>
<span class="sd">            before completing a drift orbit; the absolute value indicates the drift shell.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>
<span class="sd">    &gt;&gt;&gt; t = Ticktock([&#39;2002-02-02T12:00:00&#39;, &#39;2002-02-02T12:10:00&#39;], &#39;ISO&#39;)</span>
<span class="sd">    &gt;&gt;&gt; y = Coords([[3,0,0],[2,0,0]], &#39;GEO&#39;, &#39;car&#39;)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.irbempy.Lstar(t,y)</span>
<span class="sd">    {&#39;Blocal&#39;: array([ 1020.40493286,  3446.08845227]),</span>
<span class="sd">        &#39;Bmin&#39;: array([ 1019.98404311,  3437.63865243]),</span>
<span class="sd">        &#39;Lm&#39;: array([ 3.08948304,  2.06022102]),</span>
<span class="sd">        &#39;Lstar&#39;: array([ 2.97684043,  1.97868577]),</span>
<span class="sd">        &#39;MLT&#39;: array([ 23.5728333 ,  23.57287944]),</span>
<span class="sd">        &#39;Xj&#39;: array([ 0.00112884,  0.00286955])}</span>


<span class="sd">    Notes</span>
<span class="sd">    =====</span>
<span class="sd">    External Field</span>
<span class="sd">        - 0	   : no external field</span>
<span class="sd">        - MEAD	: Mead &amp; Fairfield [1975] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=17. Re)</span>
<span class="sd">        - T87SHORT: Tsyganenko short [1987] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=30. Re)</span>
<span class="sd">        - T87LONG : Tsyganenko long [1987] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=70. Re)</span>
<span class="sd">        - T89	 : Tsyganenko [1989] (uses 0&lt;=Kp&lt;=9 - Valid for rGEO&lt;=70. Re)</span>
<span class="sd">        - OPQUIET : Olson &amp; Pfitzer quiet [1977] (default - Valid for rGEO&lt;=15. Re)</span>
<span class="sd">        - OPDYN   : Olson &amp; Pfitzer dynamic [1988] (uses 5.&lt;=dens&lt;=50., 300.&lt;=velo&lt;=500., </span>
<span class="sd">            -100.&lt;=Dst&lt;=20. - Valid for rGEO&lt;=60. Re)</span>
<span class="sd">        - T96	 : Tsyganenko [1996] (uses -100.&lt;=Dst (nT)&lt;=20., 0.5&lt;=Pdyn (nPa)&lt;10., </span>
<span class="sd">            abs(ByIMF) (nT)&lt;1=0., abs(BzIMF) (nT)&lt;=10. - Valid for rGEO&lt;=40. Re)</span>
<span class="sd">        - OSTA	: Ostapenko &amp; Maltsev [1997] (uses dst,Pdyn,BzIMF, Kp)</span>
<span class="sd">            T01QUIET: Tsyganenko [2002a,b] (uses -50.&lt;Dst (nT)&lt;20., 0.5&lt;Pdyn (nPa)&lt;=5., </span>
<span class="sd">            abs(ByIMF) (nT)&lt;=5., abs(BzIMF) (nT)&lt;=5., 0.&lt;=G1&lt;=10., 0.&lt;=G2&lt;=10. - Valid for xGSM&gt;=-15. Re)</span>
<span class="sd">        - T01STORM: Tsyganenko, Singer &amp; Kasper [2003] storm  (uses Dst, Pdyn, ByIMF, BzIMF, G2, G3 - </span>
<span class="sd">            there is no upper or lower limit for those inputs - Valid for xGSM&gt;=-15. Re)</span>
<span class="sd">        - T05	 : Tsyganenko &amp; Sitnov [2005] storm  (uses Dst, Pdyn, ByIMF, BzIMF, </span>
<span class="sd">            W1, W2, W3, W4, W5, W6 - no upper or lower limit for inputs - Valid for xGSM&gt;=-15. Re)</span>

<span class="sd">    OMNI contents</span>
<span class="sd">        - Kp: value of Kp as in OMNI2 files but has to be double instead of integer type</span>
<span class="sd">        - Dst: Dst index (nT)</span>
<span class="sd">        - dens: Solar Wind density (cm-3)</span>
<span class="sd">        - velo: Solar Wind velocity (km/s)</span>
<span class="sd">        - Pdyn: Solar Wind dynamic pressure (nPa)</span>
<span class="sd">        - ByIMF: GSM y component of IMF mag. field (nT)</span>
<span class="sd">        - BzIMF: GSM z component of IMF mag. field (nT)</span>
<span class="sd">        - G1:  G1=&lt; Vsw*(Bperp/40)2/(1+Bperp/40)*sin3(theta/2) &gt; where the &lt;&gt; mean an average over the </span>
<span class="sd">            previous 1 hour, Vsw is the solar wind speed, Bperp is the transverse IMF </span>
<span class="sd">            component (GSM) and theta it&#39;s clock angle.</span>
<span class="sd">        - G2: G2=&lt; a*Vsw*Bs &gt; where the &lt;&gt; mean an average over the previous 1 hour, </span>
<span class="sd">                Vsw is solar wind speed, Bs=|IMF Bz| when IMF Bz &lt; 0 and Bs=0 when IMF Bz &gt; 0, a=0.005.</span>
<span class="sd">        - G3:  G3=&lt; Vsw*Dsw*Bs /2000.&gt; where the &lt;&gt; mean an average over the previous 1 hour, </span>
<span class="sd">                Vsw is the solar wind speed, Dsw is the solar wind density, Bs=|IMF Bz| when IMF </span>
<span class="sd">                Bz &lt; 0 and Bs=0 when IMF Bz &gt; 0.</span>
<span class="sd">        - W1 - W6: see definition in (JGR-A, v.110(A3), 2005.) (PDF 1.2MB)</span>
<span class="sd">        - AL: the auroral index</span>

<span class="sd">    Options</span>
<span class="sd">        - 1st element: 0 - don&#39;t compute L* or phi ;  1 - compute L*; 2- compute phi</span>
<span class="sd">        - 2nd element: 0 - initialize IGRF field once per year (year.5);  </span>
<span class="sd">            n - n is the  frequency (in days) starting on January 1st of each year </span>
<span class="sd">            (i.e. if options(2nd element)=15 then IGRF will be updated on the following days of the </span>
<span class="sd">            year: 1, 15, 30, 45 ...)</span>
<span class="sd">        - 3rd element: resolution to compute L* (0 to 9) where 0 is the recomended value to ensure a </span>
<span class="sd">            good ratio precision/computation time</span>
<span class="sd">            (i.e. an error of ~2% at L=6). The higher the value the better will be the precision, the </span>
<span class="sd">            longer will be the computing time. Generally there is not much improvement for values </span>
<span class="sd">            larger than 4. Note that this parameter defines the integration step (theta) </span>
<span class="sd">            along the field line such as dtheta=(2pi)/(720*[options(3rd element)+1])</span>
<span class="sd">        - 4th element: resolution to compute L* (0 to 9). The higher the value the better will be </span>
<span class="sd">            the precision, the longer will be </span>
<span class="sd">            the computing time. It is recommended to use 0 (usually sufficient) unless L* is not </span>
<span class="sd">            computed on a LEO orbit. For LEO orbit higher values are recommended. Note that this </span>
<span class="sd">            parameter defines the integration step (phi) along the drift shell such as </span>
<span class="sd">            dphi=(2pi)/(25*[options(4th element)+1])</span>
<span class="sd">        - 5th element: allows to select an internal magnetic field model (default is set to IGRF)</span>
<span class="sd">            - 0 = IGRF</span>
<span class="sd">            - 1 = Eccentric tilted dipole</span>
<span class="sd">            - 2 = Jensen&amp;Cain 1960</span>
<span class="sd">            - 3 = GSFC 12/66 updated to 1970</span>
<span class="sd">            - 4 = User-defined model (Default: Centred dipole + uniform [Dungey open model] )</span>
<span class="sd">            - 5 = Centred dipole</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">spacepy</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">config_dict</span>

    <span class="k">def</span> <span class="nf">get_ov</span><span class="p">(</span><span class="n">fullov</span><span class="p">,</span> <span class="n">stind</span><span class="p">,</span> <span class="n">enind</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Chop up omni data for multiprocessing&#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fullov</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">dum</span> <span class="o">=</span> <span class="n">keylist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Qbits&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullov</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">stind</span><span class="p">:</span><span class="n">enind</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fullov</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">]:</span>
            <span class="n">out</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullov</span><span class="p">[</span><span class="s1">&#39;Qbits&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">stind</span><span class="p">:</span><span class="n">enind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="k">def</span> <span class="nf">reassemble</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reassemble the results from the multiprocessing&#39;&#39;&#39;</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Bmin&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">,</span>
                 <span class="s1">&#39;Blocal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">,</span>
                 <span class="s1">&#39;Bmirr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">,</span>
                 <span class="s1">&#39;Lm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">,</span>
                 <span class="s1">&#39;Lstar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">,</span>
                 <span class="s1">&#39;MLT&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">,</span>
                 <span class="s1">&#39;Xj&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">SpaceData</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="c1">#not first chunk</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="n">key</span><span class="p">]([</span><span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">el</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#first chunk</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha</span><span class="p">]</span>

    <span class="n">ncpus</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;ncpus&#39;</span><span class="p">]</span>
    <span class="n">ncalc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">nalpha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ncalc</span> <span class="o">&lt;</span> <span class="n">ncpus</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#Don&#39;t multiprocess if not worth it</span>
        <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">__main__</span> <span class="k">as</span> <span class="nn">main</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#if pool setup fails, e.g. Wine, go single</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#won&#39;t multiprocess in interactive mode</span>

    <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nblocks</span> <span class="o">=</span> <span class="n">ncpus</span>
        <span class="n">blocklen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">ncalc</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">)</span>
        <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">omnivals</span><span class="p">:</span>
            <span class="n">ov</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nblocks</span><span class="p">):</span>
            <span class="n">startind</span> <span class="o">=</span> <span class="n">block</span><span class="o">*</span><span class="n">blocklen</span>
            <span class="k">if</span> <span class="n">block</span> <span class="o">!=</span> <span class="n">nblocks</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#not last block</span>
                <span class="n">endind</span> <span class="o">=</span> <span class="n">block</span><span class="o">*</span><span class="n">blocklen</span> <span class="o">+</span> <span class="n">blocklen</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endind</span> <span class="o">=</span> <span class="n">block</span><span class="o">*</span><span class="n">blocklen</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">blocklen</span> <span class="c1">#going past the end of an array in a slice is fine</span>
            <span class="n">tt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="n">startind</span><span class="p">:</span><span class="n">endind</span><span class="p">])</span> <span class="c1">#chunk time tags</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loci</span><span class="p">[</span><span class="n">startind</span><span class="p">:</span><span class="n">endind</span><span class="p">])</span> <span class="c1">#chunk positions</span>
            <span class="k">if</span> <span class="n">omnivals</span><span class="p">:</span>
                <span class="n">ov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_ov</span><span class="p">(</span><span class="n">omnivals</span><span class="p">,</span> <span class="n">startind</span><span class="p">,</span> <span class="n">endind</span><span class="p">))</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">tch</span><span class="p">,</span> <span class="n">cch</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="n">landi2lstar</span><span class="p">]</span> <span class="k">for</span> <span class="n">tch</span><span class="p">,</span> <span class="n">cch</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">cc</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_multi_get_Lstar</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">DALL</span> <span class="o">=</span> <span class="n">reassemble</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># single NCPU, no chunking</span>
        <span class="n">DALL</span> <span class="o">=</span> <span class="n">_get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="p">,</span> <span class="n">landi2lstar</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DALL</span></div>


<span class="k">def</span> <span class="nf">_multi_get_Lstar</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">loci</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">extMag</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">omnivals</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">landi2lstar</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">DALL</span> <span class="o">=</span> <span class="n">_get_Lstar</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loci</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">extMag</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">omnivals</span><span class="p">,</span> <span class="n">landi2lstar</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">DALL</span>

<span class="c1"># -----------------------------------------------</span>
<div class="viewcode-block" id="prep_irbem"><a class="viewcode-back" href="../../../autosummary/spacepy.irbempy.prep_irbem.html#spacepy.irbempy.prep_irbem">[docs]</a><span class="k">def</span> <span class="nf">prep_irbem</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">[],</span> <span class="n">extMag</span><span class="o">=</span><span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">omnivals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare inputs for direct IRBEM-LIB calls. Not expected to be called by the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># setup dictionary to return input values for irbem</span>
    <span class="n">d</span><span class="o">=</span> <span class="p">{}</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e31</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ntime_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>
    <span class="n">badval</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;badval&#39;</span><span class="p">]</span>
    <span class="n">nalp_max</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]</span>
    <span class="n">ntime_max</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ntime_max&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ticks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="n">UTC</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">UTC</span>
    <span class="n">DOY</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">DOY</span>
    <span class="n">eDOY</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">eDOY</span>
    <span class="n">nTAI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

    <span class="c1"># setup mag array and move omni values</span>
    <span class="n">magin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nalp_max</span><span class="p">,</span><span class="n">ntime_max</span><span class="p">),</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">magkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Kp&#39;</span><span class="p">,</span> <span class="s1">&#39;Dst&#39;</span><span class="p">,</span> <span class="s1">&#39;dens&#39;</span><span class="p">,</span> <span class="s1">&#39;velo&#39;</span><span class="p">,</span> <span class="s1">&#39;Pdyn&#39;</span><span class="p">,</span> <span class="s1">&#39;ByIMF&#39;</span><span class="p">,</span> <span class="s1">&#39;BzIMF&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;G1&#39;</span><span class="p">,</span> <span class="s1">&#39;G2&#39;</span><span class="p">,</span> <span class="s1">&#39;G3&#39;</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="s1">&#39;W2&#39;</span><span class="p">,</span> <span class="s1">&#39;W3&#39;</span><span class="p">,</span> <span class="s1">&#39;W4&#39;</span><span class="p">,</span> <span class="s1">&#39;W5&#39;</span><span class="p">,</span> <span class="s1">&#39;W6&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">fakeOMNI</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">mk</span><span class="p">):</span>
        <span class="n">fakeomni</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">magkeys</span><span class="p">:</span>
            <span class="n">fakeomni</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">npts</span>
        <span class="k">return</span> <span class="n">fakeomni</span>

    <span class="c1"># get omni values</span>
    <span class="k">if</span> <span class="n">omnivals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># No OMNI values provided so look up (requires data files)</span>
        <span class="k">if</span> <span class="n">extMag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;OPQUIET&#39;</span><span class="p">,</span><span class="s1">&#39;TS07&#39;</span><span class="p">]:</span>
            <span class="kn">import</span> <span class="nn">spacepy.omni</span> <span class="k">as</span> <span class="nn">omni</span>
            <span class="n">omnivals</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">get_omni</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="c1"># UNLESS we&#39;re asking for a static model... then we spoof the input as the numbers are irrelevant</span>
        <span class="c1"># OR TS07, which uses special files</span>
        <span class="k">elif</span> <span class="n">extMag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TS07&#39;</span><span class="p">:</span>
            <span class="n">omnivals</span> <span class="o">=</span> <span class="n">fakeOMNI</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">),</span> <span class="n">magkeys</span><span class="p">)</span> <span class="c1">#keep this separate, just in case TS07 params ever get passed in the usual way</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omnivals</span> <span class="o">=</span> <span class="n">fakeOMNI</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">),</span> <span class="n">magkeys</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;G&#39;</span> <span class="ow">in</span> <span class="n">omnivals</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dum</span><span class="p">])</span>
            <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;G</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dum</span>
        <span class="k">del</span> <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">omnivals</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dum</span><span class="p">])</span>
            <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;W</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dum</span>
        <span class="k">del</span> <span class="n">omnivals</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span>
        
    <span class="k">for</span> <span class="n">iTAI</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ikey</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">magkeys</span><span class="p">):</span>
            <span class="n">magin</span><span class="p">[</span><span class="n">ikey</span><span class="p">,</span> <span class="n">iTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">omnivals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">iTAI</span><span class="p">]</span>

    <span class="c1"># multiply Kp*10 to look like omni database</span>
    <span class="c1"># this is what irbem lib is looking for</span>
    <span class="n">magin</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">magin</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="mf">10.</span>
    
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;magin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magin</span>

    <span class="c1"># setup time array</span>
    <span class="n">iyearsat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">idoysat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">utsat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nTAI</span><span class="p">):</span>
        <span class="n">iyearsat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">UTC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
        <span class="n">idoysat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">DOY</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">utsat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eDOY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">eDOY</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="mf">86400.</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;iyearsat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iyearsat</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;idoysat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idoysat</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;utsat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utsat</span>

    <span class="c1"># copy coordinates into array</span>
    <span class="c1"># prepare coordinates</span>
    <span class="k">if</span> <span class="n">loci</span><span class="o">.</span><span class="n">sysaxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># System type not supported by IRBEM</span>
        <span class="c1"># Convert car -&gt; sph or vice versa as required</span>
        <span class="n">newcarsph</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">SYSAXES_TYPES</span><span class="p">[</span><span class="n">loci</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">posi</span> <span class="o">=</span> <span class="n">loci</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">loci</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">newcarsph</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">posi</span> <span class="o">=</span> <span class="n">loci</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sysaxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">sysaxes</span>
    <span class="n">xin1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">xin2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">xin3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntime_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">posi</span><span class="o">.</span><span class="n">carsph</span> <span class="o">==</span> <span class="s1">&#39;sph&#39;</span><span class="p">:</span>
        <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">radi</span><span class="p">[:]</span>
        <span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">lati</span><span class="p">[:]</span>
        <span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">long</span><span class="p">[:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xin1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">x</span><span class="p">[:]</span>
        <span class="n">xin2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">y</span><span class="p">[:]</span>
        <span class="n">xin3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nTAI</span><span class="p">]</span> <span class="o">=</span> <span class="n">posi</span><span class="o">.</span><span class="n">z</span><span class="p">[:]</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xin1</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xin2</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;xin3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xin3</span>

    <span class="c1"># convert external magnetic field flag</span>
    <span class="n">extkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;T87SHORT&#39;</span><span class="p">,</span> <span class="s1">&#39;T87LONG&#39;</span><span class="p">,</span> <span class="s1">&#39;T89&#39;</span><span class="p">,</span> <span class="s1">&#39;OPQUIET&#39;</span><span class="p">,</span> <span class="s1">&#39;OPDYN&#39;</span><span class="p">,</span> <span class="s1">&#39;T96&#39;</span><span class="p">,</span> \
                <span class="s1">&#39;OSTA&#39;</span><span class="p">,</span> <span class="s1">&#39;T01QUIET&#39;</span><span class="p">,</span> <span class="s1">&#39;T01STORM&#39;</span><span class="p">,</span> <span class="s1">&#39;T05&#39;</span><span class="p">,</span> <span class="s1">&#39;ALEX&#39;</span><span class="p">,</span> <span class="s1">&#39;TS07&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">extMag</span> <span class="ow">in</span>  <span class="n">extkeys</span><span class="p">,</span> <span class="s1">&#39;extMag not available: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">extMag</span>
    <span class="n">kext</span> <span class="o">=</span> <span class="n">extkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">extMag</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kext</span>

    <span class="c1"># calc at given pitch angles &#39;alpha&#39;?</span>
    <span class="n">degalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nalp_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">nalpha</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha</span><span class="p">]</span>
    <span class="n">nalpha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nalpha</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too many pitch angles requested; </span><span class="si">{}</span><span class="s1"> is maximum.&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalp_max&#39;</span><span class="p">]))</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nalpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nalpha</span>
    <span class="k">if</span> <span class="n">nalpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">degalpha</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nalpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;degalpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degalpha</span>
        
    <span class="k">return</span> <span class="n">d</span></div>





</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../spacepy.html" >spacepy</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.irbempy.irbempy</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0.
    </div>
  </body>
</html>