
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacepy.pycdf.istp &#8212; SpacePy v0.2.2 Manual</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    
    <link rel="shortcut icon" href="../../../_static/spacepy_favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../../index.html"><img src="../../../_static/spacepy_logo.jpg" border="0" alt="spacepy_logo"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../spacepy.html" >spacepy</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../pycdf.html" accesskey="U">spacepy.pycdf</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.pycdf.istp</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spacepy.pycdf.istp</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;Support for ISTP-compliant CDFs</span>

<span class="sd">The `ISTP metadata standard  &lt;https://spdf.gsfc.nasa.gov/sp_use_of_cdf.html&gt;`_</span>
<span class="sd">specifies the interpretation of the attributes in a CDF to describe</span>
<span class="sd">relationships between the variables and their physical interpretation.</span>

<span class="sd">This module supports that subset of CDFs.</span>

<span class="sd">Authors: Jon Niehof</span>

<span class="sd">Additional Contributors: Lorna Ellis, Asher Merrill</span>

<span class="sd">Institution: University of New Hampshire</span>

<span class="sd">Contact: Jonathan.Niehof@unh.edu</span>

<span class="sd">.. rubric:: Classes</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree:</span>
<span class="sd">    :template: clean_class.rst</span>

<span class="sd">    FileChecks</span>
<span class="sd">    VarBundle</span>
<span class="sd">    VariableChecks</span>

<span class="sd">.. rubric:: Functions</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree:</span>

<span class="sd">    fillval</span>
<span class="sd">    format</span>
<span class="sd">    nanfill</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">spacepy.datamodel</span>
<span class="kn">import</span> <span class="nn">spacepy.pycdf</span>
<span class="kn">import</span> <span class="nn">spacepy.pycdf.const</span>


<div class="viewcode-block" id="VariableChecks"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks">[docs]</a><span class="k">class</span> <span class="nc">VariableChecks</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ISTP compliance checks for a single variable.</span>

<span class="sd">    Checks a variable&#39;s compliance with ISTP standards. This mostly</span>
<span class="sd">    performs checks that are not currently performed by the `ISTP</span>
<span class="sd">    skeleton editor &lt;https://spdf.gsfc.nasa.gov/skteditor/&gt;`_.  All</span>
<span class="sd">    tests return a list, one error string for every noncompliance</span>
<span class="sd">    found (empty list if compliant). :meth:`all` will perform all</span>
<span class="sd">    tests and concatenate all errors.</span>

<span class="sd">    .. autosummary::</span>

<span class="sd">        all</span>
<span class="sd">        deltas</span>
<span class="sd">        depends</span>
<span class="sd">        depsize</span>
<span class="sd">        empty_entry</span>
<span class="sd">        fieldnam</span>
<span class="sd">        fillval</span>
<span class="sd">        recordcount</span>
<span class="sd">        validdisplaytype</span>
<span class="sd">        validrange</span>
<span class="sd">        validscale</span>
<span class="sd">        </span>
<span class="sd">    .. automethod:: all</span>
<span class="sd">    .. automethod:: deltas</span>
<span class="sd">    .. automethod:: depends</span>
<span class="sd">    .. automethod:: depsize</span>
<span class="sd">    .. automethod:: empty_entry</span>
<span class="sd">    .. automethod:: fieldnam</span>
<span class="sd">    .. automethod:: fillval</span>
<span class="sd">    .. automethod:: recordcount</span>
<span class="sd">    .. automethod:: validdisplaytype</span>
<span class="sd">    .. automethod:: validrange</span>
<span class="sd">    .. automethod:: validscale</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#When adding new tests, add to list above</span>
    <span class="c1">#Validation failures should be formatted as a sentence (initial cap,</span>
    <span class="c1">#closing period) and NOT include the variable name.</span>

<div class="viewcode-block" id="VariableChecks.all"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">catch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform all variable tests</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>
<span class="sd">        catch : bool</span>
<span class="sd">            Catch exceptions in tests (default False). If True, any</span>
<span class="sd">            exceptions in subtests will result in an addition to the</span>
<span class="sd">            validation failures of the form &quot;Test x did not complete.&quot;</span>
<span class="sd">            Calling the individual test will reveal the full traceback.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; f = spacepy.pycdf.CDF(&#39;foo.cdf&#39;, create=True)</span>
<span class="sd">        &gt;&gt;&gt; v = f.new(&#39;Var&#39;, data=[1, 2, 3])</span>
<span class="sd">        &gt;&gt;&gt; spacepy.pycdf.istp.VariableChecks.all(v)</span>
<span class="sd">        [&#39;No FIELDNAM attribute.&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callme</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                  <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">callme</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">catch</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Test </span><span class="si">{}</span><span class="s1"> did not complete.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="VariableChecks.depends"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.depends">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">depends</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that DELTA, DEPEND, and LABL_PTR variables exist</span>

<span class="sd">        Check that variables specified in the variable attributes for</span>
<span class="sd">        `DELTA</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DELTA&gt;`_,</span>
<span class="sd">        `DEPEND</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DEPEND_0&gt;`_,</span>
<span class="sd">        and `LABL_PTR</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#LABL_PTR_1&gt;`_</span>
<span class="sd">        exist in the CDF.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> variable </span><span class="si">{}</span><span class="s1"> missing.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">,))</span>
                    <span class="ow">or</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DELTA_PLUS_VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;DELTA_MINUS_VAR&#39;</span><span class="p">))</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">]</span></div>

<div class="viewcode-block" id="VariableChecks.deltas"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.deltas">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">deltas</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check DELTA variables</span>

<span class="sd">        Check that variables specified in the variable attributes for</span>
<span class="sd">        `DELTA</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DELTA&gt;`_</span>
<span class="sd">        match the type, size, and units of this variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">rv</span><span class="p">():</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">n_recs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">n_recs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DELTA_PLUS_VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;DELTA_MINUS_VAR&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delta</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">deltavar</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">delta</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">deltavar</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> type </span><span class="si">{}</span><span class="s1"> does not match variable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">delta</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">deltavar</span><span class="o">.</span><span class="n">type</span><span class="p">()],</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]))</span>
            <span class="k">if</span> <span class="n">deltavar</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;UNITS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;UNITS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> units do not match variable units.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">delta</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">deltavar</span><span class="o">.</span><span class="n">rv</span><span class="p">():</span>
                <span class="n">dshape</span> <span class="o">=</span> <span class="n">deltavar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">d_n_recs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">deltavar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dshape</span> <span class="o">=</span> <span class="n">deltavar</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">d_n_recs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dshape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> shape </span><span class="si">{}</span><span class="s1"> does not match variable shape </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">delta</span><span class="p">,</span> <span class="n">dshape</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">d_n_recs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_recs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
               <span class="ow">and</span> <span class="n">d_n_recs</span> <span class="o">!=</span> <span class="n">n_recs</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> record count </span><span class="si">{}</span><span class="s1"> does not match variable record&#39;</span>
                    <span class="s1">&#39; count </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">delta</span><span class="p">,</span> <span class="n">d_n_recs</span><span class="p">,</span> <span class="n">n_recs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="VariableChecks.depsize"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.depsize">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">depsize</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that DEPEND has same shape as that dim</span>

<span class="sd">        Compares the size of variables specified in the variable</span>
<span class="sd">        attributes for `DEPEND</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DEPEND_0&gt;`_</span>
<span class="sd">        and compares to the size of the corresponding dimension in</span>
<span class="sd">        this variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">rv</span><span class="p">())</span> <span class="c1">#RV is a leading dimension</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Check that don&#39;t have invalid DEPEND_1</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
            <span class="k">if</span> <span class="s1">&#39;DEPEND_1&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">or</span> <span class="s1">&#39;DEPEND_2&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Do not expect DEPEND_1 or DEPEND_2 in 1 dimensional variable.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span> <span class="c1">#This is index on shape (of var)</span>
            <span class="n">depidx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rv</span> <span class="c1">#This is x in  DEPEND_x</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;DEPEND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depidx</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depidx</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">:</span>
                <span class="n">dv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1">#this is a different error</span>
            <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="s1">&#39;DEPEND_0&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DEPEND_</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> is RV but has no DEPEND_0.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depidx</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1">#We hope the only weirdness is whether the dependency</span>
            <span class="c1">#is constant, or dependent on record. If it&#39;s dependent</span>
            <span class="c1">#on another dependency, this gets really weird really fast</span>
            <span class="c1"># If the dependency is dependent, remove the lower level</span>
            <span class="c1"># dependency size from consideration</span>
            <span class="c1"># eg. if counts [80,48], depends on energy [80,48],</span>
            <span class="c1"># depends on look [80], remove 80 from the view of energy</span>
            <span class="c1"># so that we accurately check 48==48.</span>
            <span class="c1"># NB: This assumes max of two layers of dependency</span>
            <span class="k">if</span> <span class="s1">&#39;DEPEND_2&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Do not expect three layers of dependency.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="s1">&#39;DEPEND_1&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_1&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">:</span>
                    <span class="n">ddv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1">#this is a different error</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ddv</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="n">actual</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;DEPEND_0&#39;</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># record varying</span>
                    <span class="n">dd</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Epoch&#39;</span><span class="p">:</span>
                        <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Expect DEPEND_0 to be Epoch.&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">:</span>
                        <span class="n">ddv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span> <span class="c1">#this is a different error</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ddv</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                            <span class="n">actual</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;More complicated double dependency than taken into account.&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">rv</span><span class="p">())]</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="n">actual</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Dim </span><span class="si">{}</span><span class="s1"> sized </span><span class="si">{}</span><span class="s1"> but DEPEND_</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> sized </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">depidx</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">actual</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="VariableChecks.empty_entry"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.empty_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for attributes with empty string</span>

<span class="sd">        Checks attributes for this variable for any entries consisting</span>
<span class="sd">        of an empty string. These should be replaced with a single space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_CHAR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UCHAR</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Empty CHAR entry for attribute </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="VariableChecks.fillval"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.fillval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fillval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for FILLVAL presence, type, value</span>

<span class="sd">        Checks variable for existence of `FILLVAL</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#FILLVAL&gt;`_</span>
<span class="sd">        attribute and makes sure it is the same type as variable and matches</span>
<span class="sd">        ISTP value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        spacepy.pycdf.istp.fillval : Automatic setting of this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;FILLVAL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;No FILLVAL attribute.&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;FILLVAL type </span><span class="si">{}</span><span class="s1"> does not match variable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">)],</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">fillval</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">timetype</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">in</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">timetypes</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="o">.</span><span class="n">raw_var</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">if</span> <span class="n">timetype</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>\
                 <span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span>
        <span class="c1"># isclose added in numpy 1.7, so fix this when go to 0.3.0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;isclose&#39;</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>\
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>\
                <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timetype</span><span class="p">:</span>
                <span class="n">converted_expected</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">v_epoch_to_datetime</span><span class="p">,</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">v_epoch16_to_datetime</span><span class="p">,</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">v_tt2000_to_datetime</span>
                <span class="p">}[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()](</span><span class="n">expected</span><span class="p">)</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;FILLVAL </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">), should be </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) for variable type </span><span class="si">{}</span><span class="s1">.&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">actual</span><span class="p">,</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">],</span>
                        <span class="n">expected</span><span class="p">,</span>
                        <span class="n">converted_expected</span><span class="p">,</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;FILLVAL </span><span class="si">{}</span><span class="s1">, should be </span><span class="si">{}</span><span class="s1"> for variable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="VariableChecks.recordcount"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.recordcount">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">recordcount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the DEPEND_0 has same record count as variable</span>

<span class="sd">        Checks the record count of the variable specified in the</span>
<span class="sd">        variable attribute for `DEPEND_0</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DEPEND_0&gt;`_</span>
<span class="sd">        and compares to the record count for this variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;DEPEND_0&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">dep0</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DEPEND_0&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dep0</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">:</span> <span class="c1">#This is a DIFFERENT error</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">dep0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> records; DEPEND_0 </span><span class="si">{}</span><span class="s1"> has </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">dep0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">cdf_file</span><span class="p">[</span><span class="n">dep0</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_validhelper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper function for checking SCALEMIN/MAX, VALIDMIN/MAX</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        rng : bool</span>
<span class="sd">            Do range check (True, default) or scale check (False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validscale</span> <span class="o">=</span> <span class="s1">&#39;VALID&#39;</span> <span class="k">if</span> <span class="n">rng</span> <span class="k">else</span> <span class="s1">&#39;SCALE&#39;</span>
        <span class="n">whichmin</span><span class="p">,</span> <span class="n">whichmax</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;VALIDMIN&#39;</span><span class="p">,</span> <span class="s1">&#39;VALIDMAX&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rng</span> \
                             <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;SCALEMIN&#39;</span><span class="p">,</span> <span class="s1">&#39;SCALEMAX&#39;</span><span class="p">)</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vshape</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">get_minmax</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">rng</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
            <span class="n">is_fill</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;FILLVAL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">filldtype</span> <span class="o">=</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">numpytypedict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">),</span> <span class="nb">object</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span> \
                   <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">filldtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                    <span class="n">is_fill</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]),</span>
                                    <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                    <span class="n">is_fill</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">(</span><span class="n">whichmin</span><span class="p">,</span> <span class="n">whichmax</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> type </span><span class="si">{}</span><span class="s1"> does not match variable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">which</span><span class="p">,</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">which</span><span class="p">)],</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]))</span>
            <span class="n">attrval</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
            <span class="n">multidim</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">attrval</span><span class="p">))</span> <span class="c1">#multi-dimensional</span>
            <span class="k">if</span> <span class="n">multidim</span><span class="p">:</span> <span class="c1">#Compare shapes, require only 1D var</span>
                <span class="c1">#Match attribute dim to first non-record var dim</span>
                <span class="n">firstdim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">rv</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">vshape</span><span class="p">[</span><span class="n">firstdim</span><span class="p">]</span> <span class="o">!=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">attrval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> element count </span><span class="si">{}</span><span class="s1"> does not match first data&#39;</span>
                                 <span class="s1">&#39; dimension size </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">which</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">attrval</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">firstdim</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vshape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">firstdim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#only one non-record dim</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Multi-element </span><span class="si">{}</span><span class="s1"> only valid with 1D variable.&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">firstdim</span><span class="p">:</span> <span class="c1">#Add pseudo-record dim</span>
                    <span class="n">attrval</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">attrval</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># min, max, variable data all same dtype</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">attrval</span><span class="p">),</span>
                                  <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">minval</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> type </span><span class="si">{}</span><span class="s1"> not comparable to variable type </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">which</span><span class="p">,</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">which</span><span class="p">)],</span>
                        <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]</span>
                    <span class="p">))</span>
                <span class="k">continue</span> <span class="c1"># Cannot do comparisons</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">minval</span> <span class="o">&gt;</span> <span class="n">attrval</span><span class="p">))</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">maxval</span> <span class="o">&lt;</span> <span class="n">attrval</span><span class="p">)):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) outside valid data range (</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">which</span><span class="p">,</span> <span class="n">attrval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">multidim</span> <span class="k">else</span> <span class="n">attrval</span><span class="p">,</span>
                    <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rng</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="c1">#nothing to compare</span>
                <span class="k">continue</span>
            <span class="c1">#Always put numpy array on the left so knows to do element compare</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">attrval</span><span class="p">)</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="n">whichmin</span> \
                  <span class="k">else</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">attrval</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">is_fill</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;under&#39;</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="n">whichmin</span> <span class="k">else</span> <span class="s1">&#39;over&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Scalar</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span>
                        <span class="n">attrval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">multidim</span> <span class="k">else</span> <span class="n">attrval</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">badidx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">badvals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">badidx</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#Multi-dimensional data</span>
                    <span class="n">badidx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">badidx</span><span class="p">)</span> <span class="c1">#Group by value not axis</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">badidx</span> <span class="o">=</span> <span class="n">badidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Just recover the index value</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badvals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">badvalstr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">badvals</span><span class="p">)</span>
                    <span class="n">badidxstr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">badidx</span><span class="p">)</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> at index </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">badvalstr</span><span class="p">,</span> <span class="n">badidxstr</span><span class="p">,</span>
                        <span class="n">direction</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span>
                        <span class="n">attrval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">multidim</span> <span class="k">else</span> <span class="n">attrval</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> values </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">badvals</span><span class="p">),</span> <span class="n">direction</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span>
                        <span class="n">attrval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">multidim</span> <span class="k">else</span> <span class="n">attrval</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">whichmin</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">whichmax</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">whichmin</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">whichmax</span><span class="p">]):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &gt; </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">whichmin</span><span class="p">,</span> <span class="n">whichmax</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span>

<div class="viewcode-block" id="VariableChecks.validrange"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.validrange">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validrange</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that all values are within VALIDMIN/VALIDMAX, or FILLVAL</span>

<span class="sd">        Compare all values of this variable to `VALIDMIN</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#VALIDMIN&gt;`_</span>
<span class="sd">        and ``VALIDMAX``; fails validation if any values are below</span>
<span class="sd">        VALIDMIN or above ``VALIDMAX`` unless equal to `FILLVAL</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#FILLVAL&gt;`_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_validhelper</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="VariableChecks.validscale"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.validscale">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validscale</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check SCALEMIN&lt;=SCALEMAX, and both in range for CDF datatype.</span>

<span class="sd">        Compares `SCALEMIN</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#SCALEMIN&gt;`_</span>
<span class="sd">        to ``SCALEMAX`` to make sure it isn&#39;t larger and both are</span>
<span class="sd">        within range of the variable CDF datatype.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_validhelper</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="VariableChecks.validdisplaytype"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.validdisplaytype">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validdisplaytype</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that plottype matches dimensions.</span>

<span class="sd">        Check `DISPLAYTYPE</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#DISPLAY_TYPE&gt;`_</span>
<span class="sd">        of this variable and makes sure it is reasonable for the</span>
<span class="sd">        variable dimensions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_st</span> <span class="o">=</span> <span class="s1">&#39;time_series&#39;</span>
        <span class="n">spec_st</span> <span class="o">=</span> <span class="s1">&#39;spectrogram&#39;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;DISPLAY_TYPE&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DISPLAY_TYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time_st</span><span class="p">):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;1 dim variable with </span><span class="si">{}</span><span class="s1"> display type.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DISPLAY_TYPE&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DISPLAY_TYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">spec_st</span><span class="p">):</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Multi dim variable with </span><span class="si">{}</span><span class="s1"> display type.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;DISPLAY_TYPE&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="VariableChecks.fieldnam"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VariableChecks.html#spacepy.pycdf.istp.VariableChecks.fieldnam">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fieldnam</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that FIELDNAM attribute matches variable name.</span>

<span class="sd">        Compare `FIELDNAM</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#FIELDNAM&gt;`_</span>
<span class="sd">        attribute to the variable name; fail validation if they don&#39;t</span>
<span class="sd">        match.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;FIELDNAM&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No FIELDNAM attribute.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FIELDNAM&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vname</span><span class="p">:</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FIELDNAM attribute </span><span class="si">{}</span><span class="s1"> does not match var name.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FIELDNAM&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">errs</span></div></div>


<div class="viewcode-block" id="FileChecks"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks">[docs]</a><span class="k">class</span> <span class="nc">FileChecks</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ISTP compliance checks for a CDF file.</span>

<span class="sd">    Checks a file&#39;s compliance with ISTP standards. This mostly</span>
<span class="sd">    performs checks that are not currently performed by the `ISTP</span>
<span class="sd">    skeleton editor &lt;https://spdf.gsfc.nasa.gov/skteditor/&gt;`_.  All</span>
<span class="sd">    tests return a list, one error string for every noncompliance</span>
<span class="sd">    found (empty list if compliant). :meth:`all` will perform all</span>
<span class="sd">    tests and concatenate all errors.</span>

<span class="sd">    .. autosummary::</span>

<span class="sd">        all</span>
<span class="sd">        empty_entry</span>
<span class="sd">        filename</span>
<span class="sd">        time_monoton</span>
<span class="sd">        times</span>
<span class="sd">        </span>
<span class="sd">    .. automethod:: all</span>
<span class="sd">    .. automethod:: empty_entry</span>
<span class="sd">    .. automethod:: filename</span>
<span class="sd">    .. automethod:: time_monoton</span>
<span class="sd">    .. automethod:: times</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#When adding new tests, add to list above.</span>
    <span class="c1">#Validation failures should be formatted as a sentence (initial cap,</span>
    <span class="c1">#closing period).</span>

<div class="viewcode-block" id="FileChecks.all"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks.all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">catch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform all variable and file-level tests</span>

<span class="sd">        In addition to calling every test in this class, will also call</span>
<span class="sd">        :meth:`VariableChecks.all` for every variable in the file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Open CDF file to check</span>
<span class="sd">        catch : bool</span>
<span class="sd">            Catch exceptions in tests (default False). If True, any</span>
<span class="sd">            exceptions in subtests will result in an addition to the</span>
<span class="sd">            validation failures of the form &quot;Test x did not complete.&quot;</span>
<span class="sd">            Calling the individual test will reveal the full traceback.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; f = spacepy.pycdf.CDF(&#39;foo.cdf&#39;, create=True)</span>
<span class="sd">        &gt;&gt;&gt; v = f.new(&#39;Var&#39;, data=[1, 2, 3])</span>
<span class="sd">        &gt;&gt;&gt; spacepy.pycdf.istp.FileChecks.all(f)</span>
<span class="sd">        [&#39;No Logical_source in global attrs.&#39;,</span>
<span class="sd">        &#39;No Logical_file_id in global attrs.&#39;,</span>
<span class="sd">        &#39;Cannot parse date from filename foo.cdf.&#39;,</span>
<span class="sd">        &#39;Var: No FIELDNAM attribute.&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Update this list when adding new test functions</span>
        <span class="n">callme</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                  <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">callme</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">catch</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Test </span><span class="si">{}</span><span class="s1"> did not complete.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">VariableChecks</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">catch</span><span class="o">=</span><span class="n">catch</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">errors</span></div>
                
<div class="viewcode-block" id="FileChecks.empty_entry"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks.empty_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for attributes with empty string</span>

<span class="sd">        Checks global attributes for this variable for any entries consisting</span>
<span class="sd">        of an empty string. These should be replaced with a single space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Open CDF file to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">max_idx</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">has_entry</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_CHAR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                         <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UCHAR</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Empty CHAR entry </span><span class="si">{}</span><span class="s1"> for attribute </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="FileChecks.filename"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks.filename">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare filename to global attributes</span>

<span class="sd">        Check global attribute `Logical_file_id</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/gattributes.html#Logical_file_id&gt;`_</span>
<span class="sd">        and `Logical_source</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/gattributes.html#Logical_source&gt;`_</span>
<span class="sd">        for consistency with CDF filename.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Open CDF file to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Logical_source&#39;</span><span class="p">,</span> <span class="s1">&#39;Logical_file_id&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">{}</span><span class="s1"> in global attrs.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">errs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">errs</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">pathname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Logical_source&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Logical_source </span><span class="si">{}</span><span class="s2"> doesn&#39;t match filename </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Logical_source&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Logical_file_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Logical_file_id </span><span class="si">{}</span><span class="s2"> doesn&#39;t match filename </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Logical_file_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="FileChecks.time_monoton"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks.time_monoton">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">time_monoton</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that times are monotonic</span>

<span class="sd">        Check that all `Epoch</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/variables.html#support_data_eg1&gt;`_</span>
<span class="sd">        variables are monotonically increasing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Open CDF file to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: Nonmonotonic time at record </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))))</span>
        <span class="k">return</span> <span class="n">errs</span></div>

<div class="viewcode-block" id="FileChecks.times"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.FileChecks.html#spacepy.pycdf.istp.FileChecks.times">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare filename to times</span>

<span class="sd">        Check that all `Epoch</span>
<span class="sd">        &lt;https://spdf.gsfc.nasa.gov/istp_guide/variables.html#support_data_eg1&gt;`_</span>
<span class="sd">        variables only contain times matching filename.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Open CDF file to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Description of each validation failure.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function assumes daily files and should be extended based on the</span>
<span class="sd">        File_naming_convention global attribute (which itself is another good</span>
<span class="sd">        check to have.)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">pathname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;\d</span><span class="si">{8}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Cannot parse date from filename </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)]</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                <span class="n">datestrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">((</span><span class="n">d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="o">...</span><span class="p">])))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datestrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">datestrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: multiple days </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">datestrs</span><span class="p">))))</span>
                <span class="k">elif</span> <span class="n">datestrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">datestr</span><span class="p">:</span>
                    <span class="n">errs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: date </span><span class="si">{}</span><span class="s1"> doesn</span><span class="se">\&#39;</span><span class="s1">t match file </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">v</span><span class="p">,</span> <span class="n">datestrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errs</span></div></div>


<div class="viewcode-block" id="fillval"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.fillval.html#spacepy.pycdf.istp.fillval">[docs]</a><span class="k">def</span> <span class="nf">fillval</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set ISTP-compliant FILLVAL on a variable</span>

<span class="sd">    Sets or returns a CDF variable&#39;s `FILLVAL</span>
<span class="sd">    &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#FILLVAL&gt;`_</span>
<span class="sd">    attribute to the value required by ISTP (based on variable type).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">        CDF variable to update</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    ret : boolean</span>
<span class="sd">        If True, return the value instead of setting it (Default False, set).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    various</span>
<span class="sd">        If ``ret`` is True, returns the correct value for variable type (which</span>
<span class="sd">        may be of various Python types).  Otherwise sets the value and returns</span>
<span class="sd">        ``None``.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">    &gt;&gt;&gt; f = spacepy.pycdf.CDF(&#39;foo.cdf&#39;, create=True)</span>
<span class="sd">    &gt;&gt;&gt; v = f.new(&#39;Var&#39;, data=[1, 2, 3])</span>
<span class="sd">    &gt;&gt;&gt; spacepy.pycdf.istp.fillval(v)</span>
<span class="sd">    &gt;&gt;&gt; v.attrs[&#39;FILLVAL&#39;]</span>
<span class="sd">    -128</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Fill value, indexed by the CDF type (numeric)</span>
    <span class="n">fillvals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#Integers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">fillvals</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="s1">&#39;CDF_INT</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> \
            <span class="o">-</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">fillvals</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="s1">&#39;CDF_UINT</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> \
            <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">fillvals</span><span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e31</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e31</span><span class="p">)</span>
    <span class="n">fillvals</span><span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL8</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e31</span>
    <span class="n">fillvals</span><span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL4</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e31</span>
    <span class="n">fillvals</span><span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_CHAR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="n">fillvals</span><span class="p">[</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UCHAR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="c1">#Equivalent pairs</span>
    <span class="k">for</span> <span class="n">cdf_t</span><span class="p">,</span> <span class="n">equiv</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT8</span><span class="p">),</span>
            <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL8</span><span class="p">),</span>
            <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_BYTE</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT1</span><span class="p">),</span>
            <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_FLOAT</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL4</span><span class="p">),</span>
            <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_DOUBLE</span><span class="p">,</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL8</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="n">fillvals</span><span class="p">[</span><span class="n">cdf_t</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">fillvals</span><span class="p">[</span><span class="n">equiv</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">fillvals</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="s1">&#39;FILLVAL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span>
    <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">())</span></div>


<div class="viewcode-block" id="format"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.format.html#spacepy.pycdf.istp.format">[docs]</a><span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">use_scaleminmax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set ISTP-compliant FORMAT on a variable</span>

<span class="sd">    Sets a CDF variable&#39;s `FORMAT</span>
<span class="sd">    &lt;https://spdf.gsfc.nasa.gov/istp_guide/vattributes.html#FORMAT&gt;`_</span>
<span class="sd">    attribute, which provides a Fortran-like format string that should</span>
<span class="sd">    be useable for printing any valid value in the variable. Sets</span>
<span class="sd">    according to the VALIDMIN/VALIDMAX attributes (or, optionally,</span>
<span class="sd">    SCALEMIN/SCALEMAX) if present, otherwise uses the full range of</span>
<span class="sd">    the type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">        Variable to update</span>
<span class="sd">    use_scaleminmax : bool, optional</span>
<span class="sd">        Use SCALEMIN/MAX instead of VALIDMIN/MAX (default False).</span>
<span class="sd">        Note: istpchecks may complain about result.</span>
<span class="sd">    dryrun : bool, optional</span>
<span class="sd">        Print the decided format to stdout instead of modifying</span>
<span class="sd">        the CDF (for use in command-line debugging) (default False).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">    &gt;&gt;&gt; f = spacepy.pycdf.CDF(&#39;foo.cdf&#39;, create=True)</span>
<span class="sd">    &gt;&gt;&gt; v = f.new(&#39;Var&#39;, data=[1, 2, 3])</span>
<span class="sd">    &gt;&gt;&gt; spacepy.pycdf.istp.format(v)</span>
<span class="sd">    &gt;&gt;&gt; v.attrs[&#39;FORMAT&#39;]</span>
<span class="sd">    &#39;I4&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_scaleminmax</span><span class="p">:</span>
        <span class="n">minn</span> <span class="o">=</span> <span class="s1">&#39;SCALEMIN&#39;</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="s1">&#39;SCALEMAX&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minn</span> <span class="o">=</span> <span class="s1">&#39;VALIDMIN&#39;</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="s1">&#39;VALIDMAX&#39;</span>
    <span class="n">cdftype</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cdftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT2</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT4</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_INT8</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT2</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT4</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                   <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_BYTE</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">minn</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="c1">#Just use validmin or scalemin</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">minn</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cdftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT2</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UINT4</span><span class="o">.</span><span class="n">value</span><span class="p">):</span> <span class="c1">#unsigned, easy</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">cdftype</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_BYTE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">7</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#Signed, harder</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="s1">&#39;CDF_INT</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">cdftype</span><span class="p">))</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">size</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxx</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="c1">#Just use max</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">maxx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cdftype</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_BYTE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">7</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="s1">&#39;CDF_UINT</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">cdftype</span><span class="p">),</span>
                        <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="s1">&#39;CDF_INT</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span>
                             <span class="n">cdftype</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#Two tricks:</span>
        <span class="c1">#-Truncate and add 1 rather than ceil so get</span>
        <span class="c1">#powers of 10 (log10(10) = 1 but needs two digits)</span>
        <span class="c1">#-Make sure not taking log of zero</span>
        <span class="k">if</span> <span class="n">minval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Need an extra space for the negative sign</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;I</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">maxval</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minval</span><span class="p">),</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;I</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span> <span class="k">if</span> <span class="n">maxval</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cdftype</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_TIME_TT2000</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;A</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;9999-12-31T23:59:59.999999999&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">cdftype</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;A</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;31-Dec-9999 23:59:59.999.999.000.000&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">cdftype</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;A</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;31-Dec-9999 23:59:59.999&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">cdftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL8</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_REAL4</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_FLOAT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_DOUBLE</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="c1"># Prioritize SCALEMIN/MAX to find the number of decimals to include</span>
        <span class="k">if</span> <span class="s1">&#39;SCALEMIN&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;SCALEMAX&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">range</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;SCALEMAX&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;SCALEMIN&#39;</span><span class="p">]</span>
        <span class="c1"># If not, use VALIDMIN/MAX</span>
        <span class="k">elif</span> <span class="s1">&#39;VALIDMIN&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;VALIDMAX&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">range</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMAX&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMIN&#39;</span><span class="p">]</span>
        <span class="c1"># If not, just use nothing.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Find how many spaces we need for the &#39;integer&#39; part of the number</span>
        <span class="c1"># (Use maxx-minn for this...effectively uses VALIDMIN/MAX for most</span>
        <span class="c1"># cases.)</span>
        <span class="k">if</span> <span class="nb">range</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minn</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">maxx</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">maxx</span><span class="p">])))</span> <span class="o">&gt;=</span>\
               <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">minn</span><span class="p">]))):</span>
                <span class="n">ln</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">maxx</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">minn</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">range</span> <span class="ow">and</span> <span class="n">ln</span> <span class="ow">and</span> <span class="nb">range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Cover all our bases:</span>
            <span class="c1"># raise ValueError(&#39;Range ({} - {}) cannot be negative:&#39;</span>
                <span class="c1"># &#39;\nVarname: {}\nRange: {}&#39;.format(maxx, minn, v, range))</span>
            <span class="c1">### Instead of throwing an error, just use None</span>
            <span class="c1"># There are old cases that for some reason have negative ranges, so</span>
            <span class="c1"># this is really more of a compatibility choice than a good</span>
            <span class="c1"># decision.</span>
            <span class="nb">range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># All of the lengths below (the +4, +3, +2, etc...) should be EXACTLY</span>
        <span class="c1"># enough.  Consider adding 1, (4+1=5, 3+1=4, etc...) to possibly make</span>
        <span class="c1"># this easier.</span>
        <span class="c1"># elif range and ln and range &lt;= 11: # If range &lt;= 11, we want 2 decimal places:</span>
        <span class="k">if</span> <span class="nb">range</span> <span class="ow">and</span> <span class="n">ln</span> <span class="ow">and</span> <span class="nb">range</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">:</span> <span class="c1"># If range &lt;= 11, we want 2 decimal places:</span>
            <span class="c1"># Need extra for &#39;.&#39;, and 3 decimal places (4 extra)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;F</span><span class="si">{}</span><span class="s1">.3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">range</span> <span class="ow">and</span> <span class="n">ln</span> <span class="ow">and</span> <span class="mi">11</span> <span class="o">&lt;</span> <span class="nb">range</span> <span class="o">&lt;=</span> <span class="mi">101</span><span class="p">:</span>
            <span class="c1"># Need extra for &#39;.&#39; (1 extra)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;F</span><span class="si">{}</span><span class="s1">.2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">range</span> <span class="ow">and</span> <span class="n">ln</span> <span class="ow">and</span> <span class="mi">101</span> <span class="o">&lt;</span> <span class="nb">range</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="c1"># Need extra for &#39;.&#39; (1 extra)</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;F</span><span class="si">{}</span><span class="s1">.1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No range, must not be populated, copied from REAL4/8(s) above</span>
            <span class="c1"># OR we don&#39;t care because it&#39;s a &#39;big&#39; number:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;G10.2E3&#39;</span>
    <span class="k">elif</span> <span class="n">cdftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_CHAR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_UCHAR</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;A</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">nelems</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find FORMAT for </span><span class="si">{}</span><span class="s2"> of type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cdftypenames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cdftype</span><span class="p">,</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;FORMAT&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FORMAT&#39;</span><span class="p">]</span>
        <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;FORMAT&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_CHAR</span><span class="p">)</span></div>


<div class="viewcode-block" id="nanfill"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.nanfill.html#spacepy.pycdf.istp.nanfill">[docs]</a><span class="k">def</span> <span class="nf">nanfill</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set fill values to NaN</span>

<span class="sd">    Finds all values which are equal to ``FILLVAL``, greater than</span>
<span class="sd">    ``VALIDMAX``, or less than ``VALIDMIN``, and replace with ``NaN``</span>
<span class="sd">    (not-a-number). This is an update-in-place operation; does not return</span>
<span class="sd">    a copy.</span>

<span class="sd">    Assumes a single value for ``VALIDMIN``, ``VALIDMAX``, ``FILLVAL``</span>
<span class="sd">    (although if the attribute is not present, will simply assume no</span>
<span class="sd">    restriction.)</span>

<span class="sd">    Only applicable to floating-point types. Best applied to a</span>
<span class="sd">    :class:`~spacepy.pycdf.VarCopy` or :class:`~spacepy.datamodel.dmarray`</span>
<span class="sd">    rather than :class:`~spacepy.pycdf.Var`. Updating a variable in a CDF</span>
<span class="sd">    requires one write per changed value, and also will result in a CDF</span>
<span class="sd">    that is no longer ISTP compliant.</span>

<span class="sd">    Because of floating-point comparison, the matching to ``FILLVAL`` may</span>
<span class="sd">    fail.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v : :class:`~spacepy.pycdf.Var` or :class:`~spacepy.datamodel.dmarray`</span>
<span class="sd">        CDF variable, data, or copy to update</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">    &gt;&gt;&gt; f = spacepy.pycdf.CDF(&#39;foo.cdf&#39;, create=True)</span>
<span class="sd">    &gt;&gt;&gt; v = f.new(&#39;Var&#39;, data=[1, 2, 3, -1e31])</span>
<span class="sd">    &gt;&gt;&gt; spacepy.pycdf.istp.fillval(v)</span>
<span class="sd">    &gt;&gt;&gt; data = v.copy()</span>
<span class="sd">    &gt;&gt;&gt; data</span>
<span class="sd">    VarCopy([1., 2., 3., -1.e31], dtype=float32)</span>
<span class="sd">    &gt;&gt;&gt; spacepy.pycdf.istp.nanfill(data)</span>
<span class="sd">    &gt;&gt;&gt; data</span>
<span class="sd">    VarCopy([1., 2., 3., nan], dtype=float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#If input is a zVar, read all the data; if not, this is a no-copy operation</span>
    <span class="n">indata</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="n">badidx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;FILLVAL&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">badidx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">indata</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;VALIDMIN&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">badidx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">indata</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMIN&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;VALIDMAX&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">badidx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">indata</span> <span class="o">&gt;</span> <span class="n">v</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;VALIDMAX&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
    <span class="c1">#Try a simple assignment with fancy indexing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v</span><span class="p">[</span><span class="n">badidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="c1">#success</span>
    <span class="c1">#Fancy indexing failed, do element-by-element assignment</span>
    <span class="n">badidx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">badidx</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">badidx</span><span class="p">:</span>
        <span class="n">v</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="VarBundle"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle">[docs]</a><span class="k">class</span> <span class="nc">VarBundle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collective handling of ISTP-compliant variable and its dependencies.</span>

<span class="sd">    Representation of an ISTP-compliant variable bundled together</span>
<span class="sd">    with its dependencies to enable aggregate operations. Normally</span>
<span class="sd">    used to copy a subset of data from one CDF to another by</span>
<span class="sd">    chaining operations.</span>

<span class="sd">    Unusual or indecipherable error messages may indicate an ISTP</span>
<span class="sd">    compliance issue; see :class:`VariableChecks` for some checks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">        Variable to process</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">    &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">    &gt;&gt;&gt; #https://rbsp-ect.newmexicoconsortium.org/data_pub/rbspa/hope/level3/pitchangle/2012/</span>
<span class="sd">    &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">    &gt;&gt;&gt; infile[&#39;FPDU&#39;]</span>
<span class="sd">    &lt;Var:</span>
<span class="sd">    CDF_FLOAT [3228, 11, 72]</span>
<span class="sd">    &gt;</span>
<span class="sd">    &gt;&gt;&gt; infile[&#39;FPDU&#39;].attrs</span>
<span class="sd">    &lt;zAttrList:</span>
<span class="sd">    CATDESC: HOPE differential proton flux [CDF_CHAR]</span>
<span class="sd">    DEPEND_0: Epoch_Ion [CDF_CHAR]</span>
<span class="sd">    DEPEND_1: PITCH_ANGLE [CDF_CHAR]</span>
<span class="sd">    DEPEND_2: HOPE_ENERGY_Ion [CDF_CHAR]</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;</span>
<span class="sd">    &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;FPDU&#39;])</span>
<span class="sd">    &gt;&gt;&gt; outfile = spacepy.pycdf.CDF(&#39;output.cdf&#39;, create=True)</span>
<span class="sd">    &gt;&gt;&gt; b.slice(1, 2, single=True).output(outfile)</span>
<span class="sd">    &lt;VarBundle:</span>
<span class="sd">    FPDU: CDF_FLOAT [3228, 72]</span>
<span class="sd">    Epoch_Ion: CDF_EPOCH [3228]</span>
<span class="sd">        Epoch_Ion_DELTA: CDF_REAL4 [3228]</span>
<span class="sd">    PITCH_ANGLE: CDF_FLOAT ---</span>
<span class="sd">        Pitch_LABL: CDF_CHAR*5 ---</span>
<span class="sd">    HOPE_ENERGY_Ion: CDF_FLOAT [3228, 72]</span>
<span class="sd">        ENERGY_Ion_DELTA: CDF_FLOAT [3228, 72]</span>
<span class="sd">        Energy_LABL: CDF_CHAR*3 [72] NRV</span>
<span class="sd">    &gt;</span>
<span class="sd">    &gt;&gt;&gt; outfile[&#39;FPDU&#39;]</span>
<span class="sd">    &lt;Var:</span>
<span class="sd">    CDF_FLOAT [3228, 72]</span>
<span class="sd">    &gt;</span>
<span class="sd">    &gt;&gt;&gt; outfile[&#39;FPDU&#39;].attrs</span>
<span class="sd">    &lt;zAttrList:</span>
<span class="sd">    CATDESC: HOPE differential proton flux [CDF_CHAR]</span>
<span class="sd">    DEPEND_0: Epoch_Ion [CDF_CHAR]</span>
<span class="sd">    DEPEND_1: HOPE_ENERGY_Ion [CDF_CHAR]</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;</span>
<span class="sd">    &gt;&gt;&gt; outfile.close()</span>
<span class="sd">    &gt;&gt;&gt; infile.close()</span>

<span class="sd">    .. autosummary::</span>

<span class="sd">        mean</span>
<span class="sd">        operations</span>
<span class="sd">        output</span>
<span class="sd">        slice</span>
<span class="sd">        sum</span>
<span class="sd">        variables</span>

<span class="sd">    .. automethod:: mean</span>
<span class="sd">    .. automethod:: output</span>
<span class="sd">    .. automethod:: operations</span>
<span class="sd">    .. automethod:: slice</span>
<span class="sd">    .. automethod:: sum</span>
<span class="sd">    .. automethod:: variables</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize variable bundle</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span> <span class="o">=</span> <span class="n">var</span>
        <span class="sd">&quot;&quot;&quot;The variable to operate on.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">cdf_file</span>
        <span class="sd">&quot;&quot;&quot;Input CDF file containing the main variable.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;Keyed by variable name. Values are also dicts, keys are</span>
<span class="sd">        ``dims``, list of the main variable dimensions corresponding</span>
<span class="sd">        to each dimension of the variable, ``slice``, the slice</span>
<span class="sd">        to apply when reading this variable from the input, ``postidx``,</span>
<span class="sd">        a numpy fancy index to apply after reading, ``thisdim``,</span>
<span class="sd">        the main dimension for which this var is a dep</span>
<span class="sd">        (and thus it should be removed if the dim is removed),</span>
<span class="sd">        ``vartype``, whether this variable is the main var (M),</span>
<span class="sd">        a dependency (D), or DELTA of the main (U, for uncertainty),</span>
<span class="sd">        ``sortorder``, the order in which it should be displayed (0 for</span>
<span class="sd">        the main variable, 1 for dependencies, 2 for all DELTAs, and 3 for</span>
<span class="sd">        labels).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Index by dim, is it degenerate, i.e. removed in a slice.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Index by dim, is this dim summed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Index by dim, is this dim averaged.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getvarinfo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mainvar</span><span class="p">,</span> <span class="n">deltaname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle DELTA_PLUS/DELTA_MINUS attributes</span>

<span class="sd">        A DELTA variable should be the same shape and the same</span>
<span class="sd">        dependencies as its referrer (except potentially NRV).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mainvar : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable that references the DELTA, i.e. it has a</span>
<span class="sd">            DELTA_PLUS_VAR/DELTA_MINUS_VAR attribute that references</span>
<span class="sd">            ``deltavar``.</span>

<span class="sd">        deltaname : str</span>
<span class="sd">            Name of the DELTA variable itself.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            dims/slice information suitable for inclusion in ``_varinfo``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thisvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">deltaname</span><span class="p">]</span>
        <span class="n">mainname</span> <span class="o">=</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="c1">#Check that all dependencies match</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: attribute </span><span class="si">{}</span><span class="s1"> mismatch with main var&#39;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deltaname</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mainname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: attribute </span><span class="si">{}</span><span class="s1"> not in main var&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deltaname</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">rv</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: Cannot handle RV DELTA with NRV variable.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deltaname</span><span class="p">))</span>
        <span class="n">thisshape</span> <span class="o">=</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">mainshape</span> <span class="o">=</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mainvar</span><span class="o">.</span><span class="n">rv</span><span class="p">():</span> <span class="c1">#Ignore record dim</span>
            <span class="n">mainshape</span> <span class="o">=</span> <span class="n">mainshape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">thisshape</span> <span class="o">!=</span> <span class="n">mainshape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: DELTA/main var shape mismatch.&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deltaname</span><span class="p">))</span>
        <span class="c1">#If this is NRV and main is RV, that&#39;s okay, the R dim will</span>
        <span class="c1">#get removed when actually slicing.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">mainname</span><span class="p">][</span><span class="n">k</span><span class="p">][:]</span>
                  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;postidx&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sortorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_getvarinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find dependency and dimension information</span>

<span class="sd">        For main variable and its dependencies, find how dimensions</span>
<span class="sd">        relate to the main variable, and find all DELTA variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="c1">#Every dim maps back to itself for the main variable</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                          <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">rv</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">rv</span><span class="p">():</span> <span class="c1">#Fake the 0-dim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1">#And every dimension is a full slice, to start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="n">dims</span><span class="p">,</span>
            <span class="s1">&#39;slice&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span>
            <span class="s1">&#39;postidx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span>
            <span class="s1">&#39;sortorder&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;vartype&#39;</span><span class="p">:</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mainattrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">attrs</span>
        <span class="c1">#Get the attributes that matter in the MAIN var</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">mainattrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mainattrs</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR&#39;</span><span class="p">))</span>
                <span class="ow">or</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DELTA_PLUS_VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;DELTA_MINUS_VAR&#39;</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span> <span class="c1">#Process DEPEND/LABL_PTR variables</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">thisname</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thisname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">:</span> <span class="c1">#Already handled</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">thisname</span><span class="p">][</span><span class="s1">&#39;sortorder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> \
                   <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">):</span>
                    <span class="c1">#Processed before as a LABL, but also is a DEPEND.</span>
                    <span class="c1">#Technically ISTP violation, but have the DEPEND take</span>
                    <span class="c1">#priority</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">thisname</span><span class="p">][</span><span class="s1">&#39;sortorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">thisvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">thisname</span><span class="p">]</span>
            <span class="c1">#Dimension of main var that corresponds to this var</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span> <span class="c1">#Record dim always matches</span>
            <span class="c1">#For every CDF (non-record) dim, match to the main variable</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">rv</span><span class="p">())):</span>
                <span class="c1">#DEPEND; LABL_PTR for this dimension</span>
                <span class="n">dim_dep</span> <span class="o">=</span> <span class="s1">&#39;DEPEND_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">labl_dep</span> <span class="o">=</span> <span class="s1">&#39;LABL_PTR_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dim_dep</span> <span class="ow">in</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1">#No depend on this dim, so it&#39;s the dim that&#39;s represented</span>
                    <span class="c1">#in this variable</span>
                    <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#Match to parent var</span>
                    <span class="n">dim_dep</span> <span class="o">=</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">dim_dep</span><span class="p">]</span>
                    <span class="n">parentdim</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">attrs</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">dim_dep</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">labl_dep</span><span class="p">)</span>
                    <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parentdim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot match dim </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">thisname</span><span class="p">))</span>
                    <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parentdim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dims</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find unique dimension for </span><span class="si">{}</span><span class="s1">&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisname</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">thisname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="n">dims</span><span class="p">,</span>
                <span class="s1">&#39;slice&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span>
                <span class="s1">&#39;postidx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">),</span>
                <span class="s1">&#39;sortorder&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;thisdim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span>
                <span class="s1">&#39;vartype&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1">#Process DELTAs of the DEPENDs</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DELTA_PLUS_VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;DELTA_MINUS_VAR&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">deltaname</span> <span class="o">=</span> <span class="n">thisvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">deltaname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">deltaname</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_delta</span><span class="p">(</span><span class="n">thisvar</span><span class="p">,</span> <span class="n">deltaname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">deltaname</span><span class="p">][</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span> <span class="c1">#just like other deps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">deltaname</span><span class="p">][</span><span class="s1">&#39;thisdim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DELTA_PLUS_VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;DELTA_MINUS_VAR&#39;</span><span class="p">):</span> <span class="c1">#Process DELTA vars</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">thisname</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thisname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">:</span>
                <span class="c1">#If DELTA_PLUS/DELTA_MINUS are same var, skip second one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">thisname</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="p">,</span> <span class="n">thisname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">thisname</span><span class="p">][</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>

<div class="viewcode-block" id="VarBundle.slice"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.slice">[docs]</a>    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Slice on a single dimension</span>

<span class="sd">        Selects subset of a dimension to include in the output. Slicing</span>
<span class="sd">        is done with reference to the dimensions of the main variable and</span>
<span class="sd">        the corresponding dimensions of all other variables are sliced</span>
<span class="sd">        similarly. The first non-record dimension of the variable is always</span>
<span class="sd">        1; 0 is the record dimension (and is ignored for NRV variables).</span>
<span class="sd">        Multiple slices can be applied to select subsets of multiple</span>
<span class="sd">        dimensions; however, if one dimension is indexed multiple</span>
<span class="sd">        times, only the last one in the chain takes effect.</span>

<span class="sd">        Interpretation of the slice parameters is like normal Python slicing,</span>
<span class="sd">        including the ability to use negative values, etc.</span>

<span class="sd">        Passing in only a dimension &quot;resets&quot; the slice to include the</span>
<span class="sd">        entire dimension.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : int</span>
<span class="sd">            CDF dimension to slice on. This is the dimension as specified</span>
<span class="sd">            in the CDF (0-base for RV variables, 1-base for NRV) and does</span>
<span class="sd">            not change with successive slicing. Each dimension can only be</span>
<span class="sd">            sliced once.</span>

<span class="sd">        single : bool</span>
<span class="sd">            Treat ``start`` as a single index and return only that index</span>
<span class="sd">            (reducing dimensionality of the data by one.)</span>

<span class="sd">        start : int</span>
<span class="sd">            Index of first element of ``dim`` to include in the output.</span>
<span class="sd">            This can also be a sequence of indices to include, in which</span>
<span class="sd">            case ``stop`` and ``step`` must not be specified. This can be</span>
<span class="sd">            substantially slower than specifying ``stop`` and ``step``.</span>

<span class="sd">        stop : int</span>
<span class="sd">            Index of first element of ``dim`` to exclude from the output.</span>

<span class="sd">        step : int</span>
<span class="sd">            Increment between elements to include in the output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VarBundle</span>
<span class="sd">            This bundle, for method chaining. This is not a copy: the</span>
<span class="sd">            original object is updated.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        See the :class:`VarBundle` examples for creating output from</span>
<span class="sd">        the slices.</span>

<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;FPDU&#39;])</span>
<span class="sd">        &gt;&gt;&gt; #Select index 2 from axis 1</span>
<span class="sd">        &gt;&gt;&gt; b.slice(1, 2, single=True)</span>
<span class="sd">        &gt;&gt;&gt; #Select from index 5 to end for axis 2, keeping index 2 from axis 1</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2, 5)</span>
<span class="sd">        &gt;&gt;&gt; #Select 10 through 15 on axis 2, but all of axis 1</span>
<span class="sd">        &gt;&gt;&gt; b.slice(1).slice(2, 10, 15)</span>
<span class="sd">        &gt;&gt;&gt; #Select just record 5 and 10</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2).slice(0, [5, 10])</span>
<span class="sd">        &gt;&gt;&gt; infile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">single</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot sum/average on a single-element slice.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">single</span>

        <span class="n">fancyidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">fancyidx</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]:</span>
                <span class="k">continue</span> <span class="c1">#This &quot;main&quot; var dimension isn&#39;t in this var</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="c1">#The slice to perform on read</span>
            <span class="n">v</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">sl</span>
            <span class="c1">#And the slice to perform after the fact</span>
            <span class="k">if</span> <span class="n">fancyidx</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="s1">&#39;postidx&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="VarBundle.sum"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.sum">[docs]</a>    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sum across a dimension.</span>

<span class="sd">        Total the main variable of the bundle across the given dimension.</span>
<span class="sd">        That dimension disappears from the output and dependencies</span>
<span class="sd">        (including their uncertainties) are assumed to be constant across</span>
<span class="sd">        the summed dimension. The uncertainty of the main variable, if</span>
<span class="sd">        any, is appropriately propagated (quadrature sum.)</span>

<span class="sd">        An invalid value for any element summed over will result in a fill</span>
<span class="sd">        value on the output. This does not work well for variables that</span>
<span class="sd">        define multiple VALIDMIN/VALIDMAX based on position within a</span>
<span class="sd">        dimension; the smallest VALIDMIN/largest VALIDMAX rather than the</span>
<span class="sd">        position-specific value.</span>

<span class="sd">        Summing occurs after slicing, to allow summing of a subset of</span>
<span class="sd">        a dimension. A single element slice (which removes the dimension)</span>
<span class="sd">        is incompatible with summing over that dimension.</span>

<span class="sd">        There is not currently a way to &quot;undo&quot; a sum; create a new</span>
<span class="sd">        bundle instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : int</span>
<span class="sd">            CDF dimension to total. This is the dimension as specified</span>
<span class="sd">            in the CDF (0-base for RV variables, 1-base for NRV) and does</span>
<span class="sd">            not change with successive slicing or summing. This must be a</span>
<span class="sd">            positive number (no support for e.g. -1 for last dimension.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VarBundle</span>
<span class="sd">            This bundle, for method chaining. This is not a copy: the</span>
<span class="sd">            original object is updated.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        See the :class:`VarBundle` examples for creating output.</span>

<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;Counts_P&#39;])</span>
<span class="sd">        &gt;&gt;&gt; #Total over dimension 1 (pitch angle)</span>
<span class="sd">        &gt;&gt;&gt; b.sum(1)</span>
<span class="sd">        &gt;&gt;&gt; #Get a new bundle (without the previous sum)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;Counts_P&#39;])</span>
<span class="sd">        &gt;&gt;&gt; #Total over first 10 elements of dimension 2 (energy bins)</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2, 0, 10).sum(2)</span>
<span class="sd">        &gt;&gt;&gt; infile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot sum on a single-element slice.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot sum and take mean of same dimension.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="VarBundle.mean"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take the mean of a dimension.</span>

<span class="sd">        Take mean of the main variable of the bundle across the given</span>
<span class="sd">        dimension. That dimension disappears from the output and dependencies</span>
<span class="sd">        (including their uncertainties) are assumed to be constant across</span>
<span class="sd">        the summed dimension. The uncertainty of the main variable, if</span>
<span class="sd">        any, is appropriately propagated.</span>

<span class="sd">        Invalid values are excluded fromthe mean. This does not work well</span>
<span class="sd">        for variables that define multiple VALIDMIN/VALIDMAX based on</span>
<span class="sd">        position within a dimension; the smallest VALIDMIN/largest VALIDMAX</span>
<span class="sd">        rather than the position-specific value.</span>

<span class="sd">        Averaging occurs after slicing, to allow averaging of a subset of</span>
<span class="sd">        a dimension. A single element slice (which removes the dimension)</span>
<span class="sd">        is incompatible with averaging over that dimension.</span>

<span class="sd">        There is not currently a way to &quot;undo&quot; a mean; create a new</span>
<span class="sd">        bundle instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : int</span>
<span class="sd">            CDF dimension to average. This is the dimension as specified</span>
<span class="sd">            in the CDF (0-base for RV variables, 1-base for NRV) and does</span>
<span class="sd">            not change with successive slicing or summing. This must be a</span>
<span class="sd">            positive number (no support for e.g. -1 for last dimension.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VarBundle</span>
<span class="sd">            This bundle, for method chaining. This is not a copy: the</span>
<span class="sd">            original object is updated.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        See the :class:`VarBundle` examples for creating output.</span>

<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;Counts_P&#39;])</span>
<span class="sd">        &gt;&gt;&gt; #Average over dimension 1 (pitch angle)</span>
<span class="sd">        &gt;&gt;&gt; b.mean(1)</span>
<span class="sd">        &gt;&gt;&gt; #Get a new bundle (without the previous sum)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;Counts_P&#39;])</span>
<span class="sd">        &gt;&gt;&gt; #Average over first 10 elements of dimension 2 (energy bins)</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2, 0, 10).mean(2)</span>
<span class="sd">        &gt;&gt;&gt; infile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot average on a single-element slice.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot sum and take mean of same dimension.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_tokeep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine which variables to keep for output</span>

<span class="sd">        Dependencies for dimensions which disappear after slicing, and</span>
<span class="sd">        other variables that they depend on, shouldn&#39;t be included in</span>
<span class="sd">        the output</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of str</span>
<span class="sd">            Names of variables to include in the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#What dims of main var disappear?</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">))</span>
                   <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thisdim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newvar</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if an existing variable matches a proposed new variable</span>

<span class="sd">        Does not compare DEPEND and LABL_PTR attributes (those are handled</span>
<span class="sd">        later.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        newvar : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Existing variable to compare to requirements</span>

<span class="sd">        invar : : class:`~spacepy.pycdf.Var`</span>
<span class="sd">            Variable to use as reference for attributes, RV, CDF type,</span>
<span class="sd">            number of elements.</span>

<span class="sd">        rv : bool</span>
<span class="sd">            Is the new variable record-varying</span>

<span class="sd">        dv : list of bool</span>
<span class="sd">            Data variance for each dimension.</span>

<span class="sd">        dims : list of int</span>
<span class="sd">            Size of each dimension.</span>

<span class="sd">        data : :class:`~numpy.ndarray`</span>
<span class="sd">            Data that should be in the variable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the existing variable is the same; False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check basic type, dimensions, etc.</span>
        <span class="k">if</span> <span class="n">newvar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="o">!=</span> <span class="n">rv</span> <span class="ow">or</span> <span class="n">newvar</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">invar</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> \
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="n">newvar</span><span class="o">.</span><span class="n">rv</span><span class="p">())</span> \
            <span class="ow">or</span> <span class="n">newvar</span><span class="o">.</span><span class="n">dv</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dv</span> <span class="ow">or</span> <span class="n">newvar</span><span class="o">.</span><span class="n">nelems</span><span class="p">()</span> <span class="o">!=</span> <span class="n">invar</span><span class="o">.</span><span class="n">nelems</span><span class="p">()</span> \
            <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">newvar</span><span class="o">.</span><span class="n">rv</span><span class="p">():]):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ia</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ia</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">))</span> \
               <span class="ow">or</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;FIELDNAM&#39;</span><span class="p">:</span>
                <span class="c1">#depends/LABL PTR shift around, and FIELDNAM may change,</span>
                <span class="c1">#so test outside of this function.</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">na</span> <span class="ow">or</span> <span class="n">ia</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">na</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> \
               <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">ia</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">na</span><span class="p">[</span><span class="n">a</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="c1">#Finally check the data</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">newvar</span><span class="p">[</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_namemap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map old variable names to new</span>

<span class="sd">        Helper for :meth:`output` that maps the variable name in the</span>
<span class="sd">        input CDF to variable name in the output CDF.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        suffix : str</span>
<span class="sd">            String to append to name of variables that are changed</span>
<span class="sd">            from input to output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Keyed by name in input, values are name in the output. No</span>
<span class="sd">            entry for names that don&#39;t change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">namemap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">):</span>
                    <span class="n">namemap</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">vname</span> <span class="o">+</span> <span class="n">suffix</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#Dependency. If any slice/sum, it&#39;s changed</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]])</span> \
                    <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                        <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">],</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;postidx&#39;</span><span class="p">])]):</span>
                        <span class="n">namemap</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span> <span class="o">=</span> <span class="n">vname</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">return</span> <span class="n">namemap</span>

    <span class="k">def</span> <span class="nf">_sum_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">vinfo</span><span class="p">,</span> <span class="n">degen</span><span class="p">,</span> <span class="n">summed</span><span class="p">,</span> <span class="n">averaged</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sum/average data</span>

<span class="sd">        Helper for :meth:`output` that performs summing and averaging</span>
<span class="sd">        of the data for a single variable. Note dimensionality of all</span>
<span class="sd">        input is before the removal of degenerate dimensions</span>
<span class="sd">        (this function does the translation using ``degen``), and it is</span>
<span class="sd">        by dimension not axis (so NRV variables have a vestigial 0th</span>
<span class="sd">        dimension that is not interpreted.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : :class:`numpy.ndarray`</span>
<span class="sd">            Data as read from input CDF and properly sliced.</span>

<span class="sd">        invar : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            CDF input variable from which ``data`` was read.</span>

<span class="sd">        vinfo : dict</span>
<span class="sd">            Value from instance variable ``_varinfo`` for this variable.</span>

<span class="sd">        degen : list of bool</span>
<span class="sd">            For each dimension of this variable, whether the dimension</span>
<span class="sd">            is degenerate (i.e. already gone at this point.)</span>

<span class="sd">        summed : list of bool</span>
<span class="sd">            For each dimension of this variable, whether the dimension</span>
<span class="sd">            should be summed over.</span>

<span class="sd">        averaged : list of bool</span>
<span class="sd">            For each dimension of this variable, whether the dimension</span>
<span class="sd">            should be averaged over.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">            Data summed/averaged over dimensions according to ``summed``</span>
<span class="sd">            and ``averaged`` inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Correction for NRV variables in the mapping between dim and axis</span>
        <span class="n">nrv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">invar</span><span class="o">.</span><span class="n">rv</span><span class="p">())</span>
        <span class="c1">#Degenerate slices have already been removed, so need</span>
        <span class="c1">#a map from old dim numbers to new ones. Note removing</span>
        <span class="c1">#the record dimension does not shift other dims!</span>
        <span class="n">newdims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">degen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">i</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">degen</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">degen</span><span class="p">))]</span>
        <span class="c1">#Axis numbers to sum, with degenerate removed</span>
        <span class="c1">#(NRV means dim 0 is axis 1, so correct for that,</span>
        <span class="c1">#and also don&#39;t do any actions on dim 0 for NRV)</span>
        <span class="n">summe</span> <span class="o">=</span> <span class="p">[</span><span class="n">newdims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">nrv</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrv</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">summed</span><span class="p">))</span> <span class="c1">#old dim</span>
                 <span class="k">if</span> <span class="n">newdims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">summed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">averaged</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="n">avgme</span> <span class="o">=</span> <span class="p">[</span><span class="n">newdims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">nrv</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrv</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">averaged</span><span class="p">))</span> <span class="c1">#old dim</span>
                 <span class="k">if</span> <span class="n">newdims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">averaged</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="c1">#Sum over axes in reverse order so axis renumbering</span>
        <span class="c1">#doesn&#39;t affect future sums</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">summe</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="c1">#If sum over DEPEND, must be constant over axis</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;VALIDMIN&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                    <span class="n">invalid</span><span class="p">,</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;VALIDMIN&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="s1">&#39;VALIDMAX&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                    <span class="n">invalid</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;VALIDMAX&#39;</span><span class="p">]))</span>
            <span class="n">data</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#avoids warning and helps with mean</span>
            <span class="k">if</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;vartype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="c1">#propagate error</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#Should not happen</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bad summation type.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">avgme</span><span class="p">:</span> <span class="c1">#divide out</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">invalid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">count</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#avoid warning</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#Sum, so any fill on axis means value is fill</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="n">invalid</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;FILLVAL&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_repoint_depend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">newvar</span><span class="p">,</span> <span class="n">preexist</span><span class="p">,</span> <span class="n">namemap</span><span class="p">,</span> <span class="n">degen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change DEPEND for new dimensionality of one variable.</span>

<span class="sd">        Slicing/summing might change variable dimensionality and thus</span>
<span class="sd">        the relationship with its DEPENDs, and the DEPENDs themselves</span>
<span class="sd">        may have a new name. This updates the DEPEND attributes for</span>
<span class="sd">        these changes, or verifies they are correct if the output</span>
<span class="sd">        variable already exists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        invar : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            The input variable (opened in raw mode).</span>

<span class="sd">        newvar : :class:`~spacepy.pycdf.Var`</span>
<span class="sd">            The output variable (opened in raw mode).</span>

<span class="sd">        preexist : bool</span>
<span class="sd">            True if ``newvar`` existed and doing a consistency check;</span>
<span class="sd">            False if ``newvar`` was newly created and should be edited.</span>

<span class="sd">        namemap : dict</span>
<span class="sd">            Map from name in input variable (key) to name in output</span>
<span class="sd">            variable (value). No entry if name didn&#39;t change.</span>

<span class="sd">        degen : list of bool</span>
<span class="sd">            For each dimension of this variable, whether the dimension</span>
<span class="sd">            is degenerate (i.e. already gone at this point.) This</span>
<span class="sd">            includes any degeneracy from summing/averaging as well as</span>
<span class="sd">            slicing.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Index by old dim; returns the new dim (None if went away)</span>
        <span class="c1">#Note slicing away DEPEND_0 (record dimension) does NOT change</span>
        <span class="c1">#subsequent depends!</span>
        <span class="n">newdims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">degen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">i</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">degen</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">degen</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="c1">#Editing in loop!</span>
            <span class="c1">#Handle a suffixed DELTA if necessary</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DELTA_&#39;</span><span class="p">):</span>
                <span class="n">olddelta</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">olddelta</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">olddelta</span> <span class="o">=</span> <span class="n">olddelta</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">namemap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">olddelta</span><span class="p">,</span> <span class="n">olddelta</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;DEPEND_&#39;</span><span class="p">,</span> <span class="s1">&#39;LABL_PTR_&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">newdim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">oldval</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#Sentinel value</span>
            <span class="k">if</span> <span class="n">newdim</span> <span class="ow">in</span> <span class="n">newdims</span><span class="p">:</span> <span class="c1">#An old value that belongs in this dim</span>
                <span class="n">olddim</span> <span class="o">=</span> <span class="n">newdims</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">newdim</span><span class="p">)</span>
                <span class="n">old_a</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                       <span class="n">olddim</span><span class="p">)</span>
                <span class="n">oldval</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldval</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">oldval</span> <span class="o">=</span> <span class="n">oldval</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">oldval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#Check for variable renaming from the input to output</span>
                <span class="n">newval</span> <span class="o">=</span> <span class="n">namemap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oldval</span><span class="p">,</span> <span class="n">oldval</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">preexist</span><span class="p">:</span>
                    <span class="n">existingval</span> <span class="o">=</span> <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bytes</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existingval</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">existingval</span> <span class="o">=</span> <span class="n">existingval</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">existingval</span> <span class="o">!=</span> <span class="n">newval</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s1">&#39;Incompatible </span><span class="si">{}</span><span class="s1"> already exists in output.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Either there&#39;s no corresponding old dim, or it didn&#39;t have</span>
                <span class="c1">#a DEPEND. Either way, shouldn&#39;t be a DEPEND in the new dim.</span>
                <span class="k">if</span> <span class="n">preexist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s1">&#39;Incompatible </span><span class="si">{}</span><span class="s1"> already exists in output.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newvar</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_outshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate shape of the variable on output</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vname : str</span>
<span class="sd">            Name of the variable to check the shape of.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The shape of the variable after all slicing, etc. applied, or</span>
<span class="sd">            None of the variable is not included in output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokeep</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">vinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
        <span class="n">invar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">]</span>
        <span class="n">postidx</span> <span class="o">=</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;postidx&#39;</span><span class="p">]</span>
        <span class="c1">#no dimension has BOTH a slice and a postindex, so combine</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span>
                  <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">pi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">postidx</span><span class="p">)]</span>
        <span class="c1">#And any dim that is summed/averaged is degenerate, so</span>
        <span class="c1">#slice with a single index to make it go away</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
                <span class="n">slices</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="p">:</span> <span class="c1">#Remove record dimension</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c1">#Make a fake array the size of the input, and slice it</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span>

<div class="viewcode-block" id="VarBundle.variables"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.variables">[docs]</a>    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Description of variable output from the bundle</span>

<span class="sd">        Provides information describing the variables output</span>
<span class="sd">        from the bundle</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Each element is a list-of-tuples. The list corresponds to a</span>
<span class="sd">            dimension of the master var: first the master var itself, then the</span>
<span class="sd">            uncertainties and labels associated with each dimension. Each</span>
<span class="sd">            element of these sublists is then a tuple of variable name and</span>
<span class="sd">            shape on the output (itself a tuple). If a variable isn&#39;t</span>
<span class="sd">            included in the output (sliced away), its shape will be ``None``.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;FPDU&#39;])</span>
<span class="sd">        &gt;&gt;&gt; b.slice(1, 2, single=True).variables()</span>
<span class="sd">        [[(&#39;FPDU&#39;, (100, 72))],</span>
<span class="sd">         [(&#39;Epoch_Ion&#39;, (100,)), (&#39;Epoch_Ion_DELTA&#39;, (100,))],</span>
<span class="sd">         [(&#39;PITCH_ANGLE&#39;, None), (&#39;Pitch_LABL&#39;, None)],</span>
<span class="sd">         [(&#39;HOPE_ENERGY_Ion&#39;, (100, 72)),</span>
<span class="sd">          (&#39;ENERGY_Ion_DELTA&#39;, (100, 72)),</span>
<span class="sd">          (&#39;Energy_LABL&#39;, (72,))]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#List of every variable in each dimension</span>
        <span class="n">v_by_dim</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">vname</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thisdim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">v_by_dim</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;sortorder&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outshape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_by_dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[])]]</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]:</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outshape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_by_dim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="k">return</span> <span class="n">variables</span></div>

<div class="viewcode-block" id="VarBundle.operations"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.operations">[docs]</a>    <span class="k">def</span> <span class="nf">operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Operations of this bundle</span>

<span class="sd">        Provides information describing the operations this bundle</span>
<span class="sd">        would perform.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Each element is a tuple: first element is a string with</span>
<span class="sd">            the name of the operation (i.e. method of</span>
<span class="sd">            :class:`VarBundle`), next is also a tuple of positional</span>
<span class="sd">            arguments, and finally a dict of keyword arguments.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;FPDU&#39;])</span>
<span class="sd">        &gt;&gt;&gt; b.slice(1, 2, single=True).operations()</span>
<span class="sd">          [(&#39;slice&#39;, (1, 2), {&#39;single&#39;: True})]</span>
<span class="sd">        &gt;&gt;&gt; #Apply same operations to a different variable</span>
<span class="sd">        &gt;&gt;&gt; b2 = spacepy.pycdf.istp.VarBundle(infile[&#39;FEDU&#39;])</span>
<span class="sd">        &gt;&gt;&gt; for op, args, kwargs in b2.operations():</span>
<span class="sd">        ...     getattr(b2, op)(*args, **kwargs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mainvar</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]:</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
            <span class="n">postidx</span> <span class="o">=</span> <span class="n">vi</span><span class="p">[</span><span class="s1">&#39;postidx&#39;</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sl</span> <span class="o">!=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="c1">#simple slice</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span> <span class="c1">#slice</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="s1">&#39;slice&#39;</span><span class="p">,</span>
                        <span class="nb">tuple</span><span class="p">((</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)),</span>
                        <span class="p">{}))</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1">#single index</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">sl</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;single&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span>
            <span class="k">elif</span> <span class="n">postidx</span> <span class="o">!=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="c1">#fancy index</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">postidx</span><span class="p">,),</span> <span class="p">{}))</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">dim</span><span class="p">]:</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">dim</span><span class="p">,),</span> <span class="p">{}))</span>
        <span class="k">return</span> <span class="n">ops</span></div>

<div class="viewcode-block" id="VarBundle.output"><a class="viewcode-back" href="../../../autosummary/spacepy.pycdf.istp.VarBundle.html#spacepy.pycdf.istp.VarBundle.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output the variables as modified</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : :class:`~spacepy.pycdf.CDF`</span>
<span class="sd">            Output CDF to receive the new data.</span>

<span class="sd">        suffix : str</span>
<span class="sd">            Suffix to append to the name of any variables that are changed</span>
<span class="sd">            for the output. This allows the output to contain multiple</span>
<span class="sd">            variables derived from the same input variable. The main variable</span>
<span class="sd">            and its DELTA variables will always have the suffix applied.</span>
<span class="sd">            Any dependencies will have the suffix applied only if they have</span>
<span class="sd">            changed from the input CDF (e.g. from slicing.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VarBundle</span>
<span class="sd">            This bundle, for method chaining.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf</span>
<span class="sd">        &gt;&gt;&gt; import spacepy.pycdf.istp</span>
<span class="sd">        &gt;&gt;&gt; infile = spacepy.pycdf.CDF(&#39;rbspa_rel04_ect-hope-PA-L3_20121201_v7.1.0.cdf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; b = spacepy.pycdf.istp.VarBundle(infile[&#39;FPDU&#39;])</span>
<span class="sd">        &gt;&gt;&gt; outfile = spacepy.pycdf.CDF(&#39;output.cdf&#39;, create=True)</span>
<span class="sd">        &gt;&gt;&gt; #Output the low energy half in one variable</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2, 0, 36).output(outfile, suffix=&#39;_LoE&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #And the high energy half in another variable</span>
<span class="sd">        &gt;&gt;&gt; b.slice(2, 36, 72).output(outfile, suffix=&#39;_HiE&#39;)</span>
<span class="sd">        &gt;&gt;&gt; outfile.close()</span>
<span class="sd">        &gt;&gt;&gt; infile.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokeep</span><span class="p">()</span>
        <span class="n">namemap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namemap</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">tokeep</span><span class="p">:</span>
            <span class="n">vinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
            <span class="c1">#Dim of main var that depends on this (None if main var or delta)</span>
            <span class="n">maindim</span> <span class="o">=</span> <span class="n">vinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thisdim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1">#Degeneracy of dimensions in this variable&#39;s &quot;frame&quot;</span>
            <span class="n">degen</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]]</span>
            <span class="c1">#And whether the dim was summed</span>
            <span class="n">summed</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]]</span>
            <span class="c1">#And averaged</span>
            <span class="n">averaged</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]]</span>
            <span class="n">invar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="o">.</span><span class="n">raw_var</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">]</span> <span class="c1">#including 0th dim</span>
            <span class="n">postidx</span> <span class="o">=</span> <span class="n">vinfo</span><span class="p">[</span><span class="s1">&#39;postidx&#39;</span><span class="p">]</span>
            <span class="c1">#Dimension size/variance for original variable</span>
            <span class="c1">#(0 index is CDF dimension 1)</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">dv</span><span class="p">()</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">invar</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="c1">#and record variance</span>
            <span class="c1">#Scrub degenerate dimensions from the post-indexing</span>
            <span class="c1">#(record is never degenerate)</span>
            <span class="n">postidx</span> <span class="o">=</span> <span class="p">[</span><span class="n">postidx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">postidx</span><span class="p">))</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">degen</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1">#Now get the data, and sum/average it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="p">:</span> <span class="c1">#Remove fake record dimension</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">postidx</span> <span class="o">=</span> <span class="n">postidx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1">#Forces array scalars, makes the rest work better</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">invar</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">postidx</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">postidx</span><span class="p">)]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_avg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">vinfo</span><span class="p">,</span> <span class="n">degen</span><span class="p">,</span> <span class="n">summed</span><span class="p">,</span> <span class="n">averaged</span><span class="p">)</span>
            <span class="c1">#Summed/averaged dimensions are now also degenerate</span>
            <span class="n">degen</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">degen</span><span class="p">,</span> <span class="n">summed</span><span class="p">,</span> <span class="n">averaged</span><span class="p">)]</span>

            <span class="c1">#Get shape of output variable from actual data</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="c1">#Raw Epoch16 have a trailing (2,)</span>
            <span class="k">if</span> <span class="n">invar</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">spacepy</span><span class="o">.</span><span class="n">pycdf</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">CDF_EPOCH16</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#Cut out any degenerate dimensions from DV (skipping record dim)</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="p">[</span><span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">degen</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="c1">#Change record variance for the output if sliced away 0th</span>
            <span class="k">if</span> <span class="n">rv</span> <span class="ow">and</span> <span class="n">degen</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">rv</span><span class="p">:</span> <span class="c1">#remove record dimension from size IF output is RV</span>
                <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1">#Rename the variable if necessary</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="n">namemap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">vname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outname</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">preexist</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">newvar</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">raw_var</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_same</span><span class="p">(</span><span class="n">newvar</span><span class="p">,</span> <span class="n">invar</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s1">&#39;Incompatible </span><span class="si">{}</span><span class="s1"> already exists in output.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outname</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preexist</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">newvar</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
                    <span class="n">outname</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">invar</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">recVary</span><span class="o">=</span><span class="n">rv</span><span class="p">,</span>
                    <span class="n">dimVarys</span><span class="o">=</span><span class="n">dv</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
                    <span class="n">n_elements</span><span class="o">=</span><span class="n">invar</span><span class="o">.</span><span class="n">nelems</span><span class="p">())</span>
                <span class="n">newvar</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">raw_var</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>
                <span class="c1">#Must create it empty so can change compression</span>
                <span class="n">newvar</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="o">*</span><span class="n">invar</span><span class="o">.</span><span class="n">compress</span><span class="p">())</span>
                <span class="n">newvar</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">invar</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vname</span> <span class="o">!=</span> <span class="n">outname</span><span class="p">:</span> <span class="c1">#renamed</span>
                    <span class="n">newvar</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;FIELDNAM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outname</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_repoint_depend</span><span class="p">(</span><span class="n">invar</span><span class="p">,</span> <span class="n">newvar</span><span class="p">,</span> <span class="n">preexist</span><span class="p">,</span> <span class="n">namemap</span><span class="p">,</span> <span class="n">degen</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation of the bundle</span>

<span class="sd">        Returns a string representation of the bundle, which is all the</span>
<span class="sd">        variables that are involved on the input. Variables which are</span>
<span class="sd">        not included on the output are in []</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Brief string description of the bundle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varinfo</span><span class="p">[</span><span class="n">vname</span><span class="p">][</span><span class="s1">&#39;sortorder&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">vname</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">vname</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c1">#Grab type from Var str</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;---&#39;</span><span class="p">,</span>
                <span class="c1">#RV vars always have dim 0 as axis 0, so they become</span>
                <span class="c1">#NRV iff dim 0 of the main var goes away</span>
                <span class="s1">&#39; NRV&#39;</span> <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">rv</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_degenerate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">dimvars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span> <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">dimvars</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Representation of bundle</span>

<span class="sd">        Cannot return anything that can be evaluated to create a copy</span>
<span class="sd">        of the CDF, so this is just the informal str representation in</span>
<span class="sd">        angle brackets.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Informal representation of bundle contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;VarBundle:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="https://spacepy.github.io/"">homepage</a>|&nbsp;</li>
        <li><a href="https://github.com/spacepy/spacepy">development</a>|&nbsp;</li>
        <li><a href="../../../search.html">search</a>|&nbsp;</li>
       <li><a href="../../../index.html">documentation </a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../spacepy.html" >spacepy</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../pycdf.html" >spacepy.pycdf</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spacepy.pycdf.istp</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2020, The SpacePy Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.0.
    </div>
  </body>
</html>